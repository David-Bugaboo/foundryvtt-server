var __esm=(fn,res)=>()=>(fn&&(res=fn(fn=0)),res);var CFG,templates;var init_config=__esm(()=>{CFG={id:"mkah-pf1-item-hints",CSS:{branding:"koboldworks",common:"item-hints",props:"hint-item-properties"},SETTING:{customHint:"itemHints",iconizeSetting:"iconize",showAllValues:"allValued",glow:"glow",maxLabelLength:"maxLabelLength",aura:"aura",combo:"combo",schoolAura:"iconizeAura",showChanges:"changes",sanity:"sanity",homebrew:"homebrew",unlang:"nonstandardLang"}};templates={"item-hints-editor":`modules/${CFG.id}/templates/editor.hbs`};Hooks.once("setup",()=>loadTemplates(templates))});class Hint{label;icon;image;hint;additionalClasses;combo;inBuiltTag;constructor(label,classes=[],{hint=null,icon=null,image=null,inbuilt=false,combo=false}={}){this.label=label;this.hint=hint;this.icon=icon;this.image=image;this.additionalClasses=classes;this.inBuiltTag=inbuilt;this.combo=combo}clone(){return new this.constructor(this.label,[...this.additionalClasses],{hint:this.hint,icon:this.icon,image:this.image,inbuilt:this.inBuiltTag})}static create(label,classes=[],{hint=null,icon=null,image=null,inbuilt=false,combo=false}={}){const comboType=game.settings.get(CFG.id,CFG.SETTING.combo);switch(comboType){case"always":combo=true;break;case"never":combo=false;break}return new Hint(label,classes,{hint,icon,image,inbuilt,combo})}element(iconize=false){const IMAGE=2,ICON=1;const isIcon=iconize&&(this.icon||this.image)||this.combo&&this.icon;const type=isIcon?this.image?IMAGE:ICON:0;if(this.icon&&!Array.isArray(this.icon))this.icon=this.icon?.split(" ");let hint;const el=document.createElement("span");el.classList.add(this.inBuiltTag?"tag":"item-hint");switch(type){case IMAGE:{const img=document.createElement("img");img.src=this.image;el.append(img);break}case ICON:{const icon=document.createElement("i");icon.classList.add(...this.icon);el.append(icon);break}}if(this.combo||!isIcon){const text=document.createElement("span");text.innerHTML=this.label;if(isIcon)el.append(" ");el.append(text);if(this.hint)hint=this.hint;el.classList.add("text-hint")}else{el.classList.add("iconized")}if(this.combo)el.classList.add("combo");if(isIcon){const tip=this.hint??this.label;if(tip)hint=tip}if(hint){el.dataset.tooltip=hint.replace(/\n/g,"<br>");el.dataset.tooltipDirection="UP"}el.classList.add(...this.additionalClasses);return el}}var init_hint=__esm(()=>{init_config()});function renderIHTemplate(id,data){const handlebarsOptions={allowProtoMethodsByDefault:true,allowProtoPropertiesByDefault:true,preventIndent:true};const d=document.createElement("div");d.innerHTML=Handlebars.partials[id](data,handlebarsOptions);return d.firstElementChild}async function migrateHints(item){if(!item.isOwner)return;const pack=game.packs.get(item.pack);if(pack?.locked)return;const key=CFG.SETTING.customHint;const hint=item.getItemDictionaryFlag(key);if(hint){console.log("Item Hints \uD83C\uDF9F | Migration |",item.name,item.id);const itemUpdate={system:{flags:{dictionary:{[`-=${key}`]:null}}},flags:{world:{[key]:hint}}};return item.update(itemUpdate,{render:false})}}function getHint(item){let customHints=item.getItemDictionaryFlag(CFG.SETTING.customHint);if(customHints)migrateHints(item);customHints||=item.getFlag("world",CFG.SETTING.customHint);return customHints}function createNode(node="span",text="",classes=[],{tooltip=null}={}){const n=document.createElement(node);n.textContent=text;if(classes.length)n.classList.add(...classes);if(tooltip)n.dataset.tooltip=tooltip;return n}var itemHandlers,exItemHandlers,descriptorIcons;var init_common=__esm(()=>{init_config();init_hint();itemHandlers=[];exItemHandlers=[];descriptorIcons={material:new Hint("",["material"],{icon:"fa-solid fa-coins"}),value:new Hint("",["value"],{icon:"fa-solid fa-coins"}),inconsistency:new Hint("",["inconsistency"],{icon:"fa-solid fa-exclamation-circle"})}});class i18n{static has=(string)=>game.i18n.has(string);static get=(string,mapping)=>mapping?game.i18n.format(string,mapping):game.i18n.localize(string)}var exports_gm_notes_handler={};function gmNotesHandler(options,hints){if(!game.user.isGM)return;const item=options.item;const notes=item.getFlag("gm-notes","notes");if(notes===undefined)return;hints.append(Hint.create(i18n.get("GMNote.label"),["module","gm-notes"],{hint:i18n.get("Koboldworks.Module.GMNotes.NotesFound"),icon:"fa-solid fa-clipboard-check"}).element(options.iconize))}var init_gm_notes_handler=__esm(()=>{init_hint();init_common();itemHandlers.push(gmNotesHandler)});Hooks.once("ready",()=>{if(game.modules.get("gm-notes")?.active)Promise.resolve().then(() => (init_gm_notes_handler(),exports_gm_notes_handler)).then(()=>console.log("Item Hints \uD83C\uDF9F | Compatibility | GM Notes"))});init_config();init_hint();init_common();Hooks.once("init",()=>{game.settings.register(CFG.id,CFG.SETTING.iconizeSetting,{name:"Koboldworks.ItemHint.IconizeLabel",hint:"Koboldworks.ItemHint.IconizeHint",type:Boolean,default:true,config:true,scope:"client"});game.settings.register(CFG.id,CFG.SETTING.aura,{name:"Koboldworks.ItemHint.AuraLabel",hint:"Koboldworks.ItemHint.AuraHint",type:Boolean,default:true,config:true,scope:"client"});game.settings.register(CFG.id,CFG.SETTING.schoolAura,{name:"Koboldworks.ItemHint.IconizeSchoolLabel",hint:"Koboldworks.ItemHint.IconizeSchoolHint",type:String,choices:{letters:"Koboldworks.ItemHint.Icons.Letters",letterswcl:"Koboldworks.ItemHint.Icons.LettersWithCL",custom:"Koboldworks.ItemHint.Icons.Custom",runes:"Koboldworks.ItemHint.Icons.Runes"},default:"letters",config:true,scope:"client"});game.settings.register(CFG.id,CFG.SETTING.showChanges,{name:"Koboldworks.ItemHint.ChangeLabel",hint:"Koboldworks.ItemHint.ChangeHint",type:Boolean,default:true,config:true,scope:"client"});game.settings.register(CFG.id,CFG.SETTING.showAllValues,{name:"Koboldworks.ItemHint.ValueLabel",hint:"Koboldworks.ItemHint.ValueHint",type:String,choices:{tradegoods:"Koboldworks.ItemHint.Value.TradeGoodsOnly",containers:"Koboldworks.ItemHint.Value.TradeGoodsAndContainers",expanded:"Koboldworks.ItemHint.Value.Expanded",all:"Koboldworks.ItemHint.Value.All",none:"Koboldworks.ItemHint.Value.None"},default:"expanded",config:true,scope:"client"});game.settings.register(CFG.id,CFG.SETTING.maxLabelLength,{name:"Koboldworks.ItemHint.MaxLabelLength",hint:"Koboldworks.ItemHint.MaxLabelLengthHint",type:Number,range:{min:8,max:80,step:1},default:42,config:true,scope:"client"});game.settings.register(CFG.id,CFG.SETTING.combo,{name:"Koboldworks.ItemHint.Combo.Label",hint:"Koboldworks.ItemHint.Combo.Hint",type:String,choices:{always:"Koboldworks.ItemHint.Combo.Always",explicit:"Koboldworks.ItemHint.Combo.Explicit",never:"Koboldworks.ItemHint.Combo.Never"},default:"explicit",config:true,scope:"client"});game.settings.register(CFG.id,CFG.SETTING.glow,{name:"Koboldworks.ItemHint.Glow.Label",hint:"Koboldworks.ItemHint.Glow.Hint",type:Boolean,default:true,config:true,scope:"client"});game.settings.register(CFG.id,CFG.SETTING.sanity,{name:"Koboldworks.ItemHint.SanityLabel",hint:"Koboldworks.ItemHint.SanityHint",type:Boolean,default:true,config:true,scope:"client"});game.settings.register(CFG.id,CFG.SETTING.homebrew,{name:"Koboldworks.ItemHint.HomebrewLabel",hint:"Koboldworks.ItemHint.HomebrewHint",type:Boolean,default:false,config:true,scope:"world"});game.settings.register(CFG.id,CFG.SETTING.unlang,{name:"Koboldworks.ItemHint.LangLabel",hint:"Koboldworks.ItemHint.LangHint",type:Boolean,default:true,config:true,scope:"client"});const module=game.modules.get(CFG.id);module.api={HintClass:Hint,addHandler:(callback)=>exItemHandlers.push(callback)};console.log(`Item Hints \uD83C\uDF9F | ${module.version} | READY`)});init_config();init_common();init_config();init_hint();init_common();async function handleCustomHints(o,hints){try{if(o.actor?.sheet?.__modItemHintsDisableCustom)return;let customHints=getHint(o.item);if(customHints===undefined)return;if(typeof customHints!=="string")customHints=customHints.toString();for(const h of customHints.split(";")){const[label,hint,instructions]=h.split("|",3);const css=["custom"];if(instructions){const re=instructions.match(/css=(?<css>.*)/);if(re?.groups.css)css.push(...re.groups.css.split(/\s+/))}try{hints.append(Hint.create(await pf1.utils.enrichHTMLUnrolled(label.trim(),{rollData:o.rollData,async:true}),css,{hint:hint?.trim()??null}).element(false))}catch(err){console.error(err,{label,hint,instructions},o)}}}catch(err){console.error("⚠️ ITEM HINTS | Custom |",o.actor?.name,o.item?.name,{actor:o.actor,item:o.item},`
`,err);if(o.actor){console.debug("ITEM HINTS | Custom | Error detected; Temporarily disabling for actor:",o.actor.name);if(o.actor.sheet)o.actor.sheet.__modItemHintsDisableCustom=true}}}init_config();init_common();init_hint();init_hint();function handleAction(o,hints){const item=o.item;if(!["attack","weapon","spell"].includes(item.type))return;const itemData=o.itemData;if(itemData.actions!==undefined&&!item.hasAction)hints.append(Hint.create(i18n.get("Koboldworks.Generic.NoAction"),["warning","no-action"]).element());if(itemData.actions?.some((a)=>a.usesAmmo&&!a.ammoType))hints.append(Hint.create(i18n.get("Koboldworks.Generic.NoAmmoType"),["warning","no-ammo-type"]).element())}init_hint();function handleAttack(o,hints){const itemData=o.itemData;const fa=o.defaultAction;if(!fa)return;if(itemData.subType==="natural"){if(!fa?.naturalAttack?.primary)hints.append(Hint.create(i18n.get("Koboldworks.Generic.Secondary"),["natural","secondary"]).element())}if(["mcman","rcman"].includes(fa.actionType)){hints.append(Hint.create(i18n.get("PF1.CMBAbbr"),["combat-maneuver"]).element())}}init_hint();function handleDamage(o,hints){const item=o.item;if(!item.hasDamage)return;if(o.itemData.nonlethal){hints.append(Hint.create(i18n.get("Koboldworks.Generic.Nonlethal"),["nonlethal"],{icon:"far fa-hand-peace"}).element(o.iconize))}}init_hint();function handleChangeFlags(opt,hints){if(!opt.changes)return;if(!opt.isIdentified)return;const flags=opt.itemData.changeFlags;if(!flags)return;if(flags.heavyArmorFullSpeed&&flags.mediumArmorFullSpeed)hints.append(Hint.create("+ArmorSpd",["change"]).element());else if(flags.heavyArmorFullSpeed)hints.append(Hint.create("+ArmorSpd (Hvy)",["change"]).element());else if(flags.mediumArmorFullSpeed)hints.append(Hint.create("+ArmorSpd (Med)",["change"]).element());if(flags.loseDexToAC)hints.append(Hint.create(`-${i18n.get("Koboldworks.Short.DexterityToAC")}`,["change","penalty"]).element());if(flags.noEncumbrance)hints.append(Hint.create(`-${i18n.get("PF1.Encumbrance")}`,["change"]).element())}init_config();init_hint();init_config();var coreLang={bab:"PF1.BABAbbr",flySpeed:"PF1.Movement.Mode.fly",burrowSpeed:"PF1.Movement.Mode.burrow",landSpeed:"PF1.Movement.Mode.land",climbSpeed:"PF1.Movement.Mode.climb",swimSpeed:"PF1.Movement.Mode.swim",wdamage:CONFIG.Item.typeLabels.weapon,sdamage:CONFIG.Item.typeLabels.spell,cmb:"PF1.CMBAbbr",cmd:"PF1.CMDAbbr",allSpeeds:"PF1.All",attack:"PF1.All",mattack:"PF1.Melee",rattack:"PF1.Ranged",damage:"PF1.All",spellEffect:"TYPES.Item.spell",allSavingThrows:"Koboldworks.Short.AllSaves",mhp:"PF1.HPShort",str:"PF1.AbilityShortStr",dex:"PF1.AbilityShortDex",con:"PF1.AbilityShortCon",int:"PF1.AbilityShortInt",wis:"PF1.AbilityShortWis",cha:"PF1.AbilityShortCha",mwdamage:"Koboldworks.Short.MeleeWeapon",rwdamage:"Koboldworks.Short.RangedWeapon",twdamage:"Koboldworks.Short.ThrownWeapon",mdamage:"Koboldworks.Short.Melee",rdamage:"Koboldworks.Short.Ranged",ndamage:"Koboldworks.Short.Natural",strMod:"Koboldworks.Short.StrMod",dexMod:"Koboldworks.Short.DexMod",conMod:"Koboldworks.Short.ConMod",intMod:"Koboldworks.Short.IntMod",wisMod:"Koboldworks.Short.WisMod",chaMod:"Koboldworks.Short.ChaMod",bonusSkillRanks:"Koboldworks.Short.SkillRanks",carryMult:"Koboldworks.Short.CarryMult"};var moduleLangExtensions={nac:"Koboldworks.Short.NaturalAC",tac:"Koboldworks.Short.TouchAC",mDexA:"Koboldworks.Short.ArmorMaxDex",mDexS:"Koboldworks.Short.ShieldMaxDex",ffac:"Koboldworks.Short.FlatfootedAC",ffcmd:"Koboldworks.Short.FlatfootedCMD",spellResist:"Koboldworks.Short.SpellResistance",allChecks:"Koboldworks.Short.AllAblChecks",strSkills:"Koboldworks.Short.StrSkills",dexSkills:"Koboldworks.Short.DexSkills",conSkills:"Koboldworks.Short.ConSkills",intSkills:"Koboldworks.Short.IntSkills",wisSkills:"Koboldworks.Short.WisSkills",chaSkills:"Koboldworks.Short.ChaSkills",strChecks:"Koboldworks.Short.StrChecks",dexChecks:"Koboldworks.Short.DexChecks",conChecks:"Koboldworks.Short.ConChecks",intChecks:"Koboldworks.Short.IntChecks",wisChecks:"Koboldworks.Short.WisChecks",chaChecks:"Koboldworks.Short.ChaChecks",tattack:"Koboldworks.Short.Thrown",tdamage:"Koboldworks.Short.Thrown",init:"Koboldworks.Short.Initiative",ref:"Koboldworks.Short.Reflex",fort:"Koboldworks.Short.Fortitude",will:"Koboldworks.Short.Will"};var disableUnlang=()=>game.i18n.lang!=="en"&&!game.settings.get(CFG.id,CFG.SETTING.unlang);var simplifications={};Hooks.once("init",()=>simplifications=Object.assign({},coreLang,disableUnlang()?{}:moduleLangExtensions));class UniformObject{target;parts;isChange;formula;constructor(ch,actor=null,item=null){this.target=ch.target;this.isChange=ch instanceof pf1.components.ItemChange;this.formula=ch.formula;this.#change=new WeakRef(ch);this.#actor=new WeakRef(actor);this.#item=new WeakRef(item);this.parts=ch.target?.split(".")??[]}#change;get change(){return this.#change.deref()}#actor;get actor(){return this.#actor?.deref()}#item;get item(){return this.#item.deref()}#source;get source(){if(!this.#source){const sources=this.isChange?pf1.config.buffTargets:pf1.config.contextNoteTargets;this.#source=sources[this.target];if(!this.#source){if(this.isSkill)this.#source=sources.skills;else if(this.isConcentration)this.#source=sources.concentration;else if(this.isCL)this.#source=sources.cl;else if(this.isSpellDC)this.#source=sources.dc;else console.error("No Source",this)}}return this.#source}get isCL(){return this.parts[0]==="cl"}get isSpellDC(){return this.parts[0]==="dc"}get isConcentration(){return this.parts[0]==="concn"||this.target==="concentration"}static SPELL_TARGETS=new Set(["cl","concn","concentration"]);get isSpell(){const cat=this.parts[0];return this.constructor.SPELL_TARGETS.has(cat)}get isSkill(){return this.parts[0]==="skill"}#category;get category(){if(!this.#category){this.#category=this.source?.category;if(this.isSkill)return this.#category="skill";if(this.isConcentration)return this.#category="spell";if(this.isSpell)return this.#category="spell";const[cat]=this.parts;if(this.isChange){if(cat in pf1.config.buffTargets)return this.#category=cat}else if(cat in pf1.config.contextNoteTargets)return this.#category=cat;if(!this.#category)console.error("ITEM HINTS | No Category",this)}return this.#category}#skill;_skillId;get skill(){if(this.isSkill&&this.#skill===undefined){this._skillId??=this.target.slice(6);try{this.#skill=this.actor.getSkillInfo(this._skillId)}catch{this.#skill=null}}return this.#skill}#label;get label(){this.#label??=this._generateLabel();return this.#label}_generateLabel(){if(this.isSkill)return this.#skill?.name;if(this.isCL)return i18n.get("PF1.CasterLevelAbbr");if(this.isConcentration)return i18n.get("Koboldworks.Missing.PF1.ConcentrationAbbr");if(this.isSpellDC)return i18n.get("PF1.SpellDC");if(this.target in simplifications)return i18n.get(simplifications[this.target]);return(this.isChange?pf1.config.buffTargets:pf1.config.contextNoteTargets)[this.target]?.label??this.target}}class ChangeLabel{label;optional;symbolic;constructor(label,{optional=true,symbolic=true}={}){this.label=label;this.optional=optional;this.symbolic=symbolic}}var OPTIONAL_CATEGORIES=new Set(["senses","defense"]);function generateChangeLabel(k,o,isChange){switch(k){case"str":case"con":case"dex":case"int":case"cha":case"wis":case"ability":case"strChecks":case"dexChecks":case"conChecks":case"wisChecks":case"intChecks":case"chaChecks":case"abilityChecks":return new ChangeLabel(i18n.get("Koboldworks.Short.Ability"));case"attack":case"attacks":return new ChangeLabel(i18n.get("Koboldworks.Short.Attack"),{optional:false});case"damage":return new ChangeLabel(i18n.get("Koboldworks.Short.Damage"),{optional:false});case"allSavingThrows":case"ref":case"will":case"fort":case"savingThrows":return new ChangeLabel(i18n.get("Koboldworks.Short.SavingThrow"));case"skill":case"reach":case"skills":return new ChangeLabel(i18n.get("Koboldworks.Short.Skill"));case"speed":return new ChangeLabel(i18n.get("Koboldworks.Short.Speed"),{optional:false});case"spell":return new ChangeLabel(i18n.get("Koboldworks.Short.Spell"));case"size":case"bonusFeats":case"init":case"carryStr":case"carryMult":case"misc":return new ChangeLabel(i18n.get("Koboldworks.Short.Misc"),{optional:true});case"health":return new ChangeLabel(i18n.get("Koboldworks.Short.Health"));case"ac":case"cmd":case"defense":return new ChangeLabel(i18n.get("Koboldworks.Short.Defense"));case"dc":return new ChangeLabel(i18n.get("Koboldworks.Short.SpellDC"));default:try{const t=isChange?pf1.config.buffTargets[k]:pf1.config.contextNoteTargets[k];if(t){const optional=OPTIONAL_CATEGORIES.has(t.category);return new ChangeLabel(pf1.config.buffTargetCategories[t.category]?.label,{optional})}else{const cat=pf1.config.buffTargetCategories[k];if(cat!==undefined)return new ChangeLabel(cat?.label,{optional:false})}}catch(err){console.log("⚠️ ITEM HINTS | Unrecognized key:",k,"in",o.item.name,err);return new ChangeLabel(i18n.get("Koboldworks.Generic.BadSource"),{optional:false,symbolic:false})}}return new ChangeLabel(i18n.get("Koboldworks.Generic.UnknownSource"),{optional:false,symbolic:false})}function createUniformObject(o,obj,ch){const isChange=ch instanceof pf1.components.ItemChange;const change=isChange?ch:null;const contextNote=!isChange?ch:null;const{problems,commonTargets}=o;const item=ch.parent;let cto;try{cto=new UniformObject(ch,o.actor,item);if(!(cto.target?.length>0)){if(!("noTarget"in problems)){console.log("⚠️ ITEM HINTS | Missing Target | Item:",item.name,"; Change:",ch,item);problems["noTarget"]={label:i18n.get("Koboldworks.Sanity.Change.TargetlessLabel"),hint:i18n.get("Koboldworks.Sanity.Change.TargetlessHint")}}return obj}if(cto.label===ch.target){if(!("badTarget"in problems)){console.log("⚠️ ITEM HINTS | Bad Target |",item.name,{item,change,contextNote});problems["badTarget"]={label:i18n.get("Koboldworks.Sanity.Change.BadTargetLabel"),hint:i18n.get("Koboldworks.Sanity.Change.BadTargetHint",{target:ch.target})}}return obj}if(isChange&&!(ch.formula?.length>0)){if(!("noFormula"in problems)){console.log("⚠️ ITEM HINTS | Missing Formula |",item.name,{item,change,contextNote});problems["noFormula"]={label:i18n.get("Koboldworks.Sanity.Change.FormulalessLabel"),hint:i18n.get("Koboldworks.Sanity.Change.FormulalessHint")}}return obj}if(!isChange&&!(ch.text?.trim().length>0)){if(!("noText"in problems)){console.log("⚠️ ITEM HINTS | Missing Text |",item.name,{item,change:ch});problems["noText"]={label:i18n.get("Koboldworks.Sanity.Change.TextlessLabel"),hint:i18n.get("Koboldworks.Sanity.Change.TextlessHint",{target:ch.target})}}return obj}if(cto.isSkill&&!cto.skill){if(!("badSkill"in problems)){problems["badSkill"]={label:i18n.get("Koboldworks.Sanity.Change.MissingSkillLabel"),hint:i18n.get("Koboldworks.Sanity.Change.MissingSkillHint",{skillId:cto._skillId})}}return obj}const category=cto.category;if(category){obj[category]??={};obj[category][cto.target]??=cto;commonTargets[category]??={};commonTargets[category][cto.target]??=cto;return obj}else{console.error("ITEM HINTS | No Key",{obj,ch,item,cto})}}catch(err){console.error("ITEM HINTS | Error:",err,{change:ch,object:cto,item,uniform:obj});return obj}}function handleChanges(o,hints){if(!o.changes)return;if(!o.isIdentified)return;const itemData=o.itemData;if(!(itemData.changes?.length>0||itemData.contextNotes?.length>0))return;const commonTargets={},problems={};o.commonTargets=commonTargets;o.problems=o;const transformChanges=(list)=>list?.reduce((obj,ch)=>createUniformObject(o,obj,ch),{})??{};const ctargets=transformChanges(o.item.changes),ntargets=transformChanges(itemData.contextNotes);const maxLabelLength=game.settings.get(CFG.id,CFG.SETTING.maxLabelLength);function formatLabel(key,isChange=true){const ct=commonTargets[key],ck=Object.keys(ct),b=new Set(ck.filter((x)=>ct[x].isChange===isChange).map((x)=>ct[x].label)),lb=generateChangeLabel(key,o,isChange),sym=lb.symbolic?"±":"";if(b.size===0)return`${sym}${lb.label}`;const label=[sym];let subLabel;if(lb.optional){subLabel=[...b].join(";")}else{label.push(lb.label,":");subLabel=[...b].join(",")}if(subLabel?.length>maxLabelLength)subLabel=i18n.get("Koboldworks.Hints.Many");label.push(subLabel);return label.join("")}function makeChangeHint(key){const cC=[];let cN=[];for(const x of Object.keys(commonTargets[key])){if(ctargets[key]?.[x]){const cto=ctargets[key][x];if(!cto.isChange)continue;let total;try{const f=new RollPF(cto.change.formula,o.rollData).evaluateSync({minimize:true});total=f.total}catch{continue}const label=[cto.label," = ",total!==undefined?`~${total}`:cto.change.formula];cC.push(label.join(""))}if(ntargets[key]?.[x]){const cto=ntargets[key][x];if(cto.isChange)continue;cN.push(cto.label)}}let changeHint,noteHint;if(cC.length>0){const title=i18n.get(cC.length==1?"PF1.Change":"PF1.Changes")+": ";cC.unshift(title);const sep=cC.length==2?"":`
`;changeHint=Hint.create(formatLabel(key,true),["change"],{hint:cC.join(sep)})}if(cN.length>0){const title=i18n.get(cN.length==1?"Koboldworks.Hints.Contextual":"PF1.ContextNotes")+": ";cN=[...new Set(cN)];cN.unshift(title);const sep=cN.length==2?"":`
`;noteHint=Hint.create(formatLabel(key,false),["contextual"],{hint:cN.join(sep)})}return[changeHint,noteHint]}for(const ch of Object.keys(commonTargets)){const[changes,notes]=makeChangeHint(ch);if(changes)hints.append(changes.element());if(notes)hints.append(notes.element())}for(const problem of Object.values(problems)){hints.prepend(Hint.create(problem.label,["change","error"],{hint:problem.hint}).element())}}init_hint();init_common();function handleClass(o,hints){const itemData=o.itemData,hp=itemData.fc.hp.value,skill=itemData.fc.skill.value,alt=itemData.fc.alt.value;if(hp>0)hints.append(Hint.create(`${i18n.get("PF1.FavouredClassBonus.HP")} ×${hp}`,["fcb","hp"]).element());if(skill>0)hints.append(Hint.create(`${i18n.get("PF1.FavouredClassBonus.Skill")} ×${skill}`,["fcb","skill"]).element());if(alt>0)hints.append(Hint.create(`${i18n.get("PF1.FavouredClassBonus.Alt")} ×${alt}`,["fcb","alt"]).element());if(o.sanity){const total=hp+skill+alt;if(total>0&&itemData.level!==total){const shint=descriptorIcons.inconsistency.clone();shint.hint=i18n.get("Koboldworks.Sanity.FCBInequal",{diff:total-itemData.level});shint.additionalClasses.push("fcb");hints.append(shint.element(true))}}}init_hint();function handleContainer(o,hints){const item=o.item,count=item.items.contents.length,subItems=item.items.find((i)=>i.type==="container"),coins=o.itemData.currency??{},haveCoins=coins.pp>0||coins.gp>0||coins.sp>0||coins.cp>0,more=subItems||haveCoins;const label=more?i18n.get("Koboldworks.Hints.ContentsIndefinite",{quantity:count}):i18n.get("Koboldworks.Hints.Contents",{quantity:count});const h=[label];if(subItems)h.push(i18n.get("PF1.InventoryContainers"));if(haveCoins)h.push(i18n.get("PF1.Currency.Label"));hints.append(Hint.create(label,["item-count"],{hint:h.join(" + ")}).element())}init_config();init_hint();init_common();var descriptors={masterwork:new Hint("PF1.Masterwork",["masterwork"],{icon:"fa-solid fa-gem"}),broken:new Hint("PF1.Broken",["broken"],{icon:"fa-solid fa-heart-broken"}),unidentified:new Hint("PF1.Unidentified",["unidentified"],{icon:"fa-solid fa-eye-slash"})};Hooks.once("ready",()=>{for(const value of Object.values(descriptors))value.label=i18n.get(value.label)});var sizeMap={fine:0,dim:1,tiny:2,sm:3,med:4,lg:5,huge:6,grg:7,col:8};var sizeMapInvert=foundry.utils.invertObject(sizeMap);var auraIconsGI={abj:"img/game-icons/magic-shield.svg",con:"img/game-icons/portal.svg",div:"img/game-icons/crystal-ball.svg",enc:"img/game-icons/brain-tentacle.svg",evo:"img/game-icons/energy-arrow.svg",ill:"img/game-icons/magic-trick.svg",nec:"img/game-icons/death-juice.svg",trs:"img/game-icons/frog-prince.svg",uni:"img/game-icons/sparkles.svg"};var auraIconsTh={abj:"img/thassilonian/envy.svg",con:"img/thassilonian/sloth.svg",div:"img/thassilonian/truth.svg",enc:"img/thassilonian/lust.svg",evo:"img/thassilonian/wrath.svg",ill:"img/thassilonian/pride.svg",nec:"img/thassilonian/gluttony.svg",trs:"img/thassilonian/greed.svg",uni:"img/thassilonian/diligence.svg"};function getAuraIcon(school,type){const a=type==="runes"?auraIconsTh:auraIconsGI;return`modules/${CFG.id}/${a[school]??a.uni}`}function handleItem(o,hints){const item=o.item;const itemData=o.itemData;if(!o.homebrew&&o.sanity&&o.showSecrets&&o.casterLevel>0&&o.enhancement>0){const clDiff=o.casterLevel-o.enhancement*3;if(clDiff<0){const underLevel=descriptorIcons.inconsistency.clone();underLevel.hint=i18n.get("Koboldworks.Sanity.InsufficientCL",{diff:clDiff});hints.append(underLevel.element(true))}}const{value:currentHp,max:maxHp}=itemData.hp??{};if(itemData.broken){const h=descriptors.broken.clone();if(maxHp>0)h.hint=`${h.label}<br>${currentHp}/${maxHp} HP`;hints.append(h.element(o.iconize))}else if(currentHp<maxHp){const h=new Hint(`${currentHp}/${maxHp} HP`,["damaged"],{icon:"fa-solid fa-heart-pulse"});hints.append(h.element(o.iconize))}if(itemData.masterwork&&!(o.enhancement>0&&o.showSecrets))hints.append(descriptors.masterwork.clone().element(o.iconize));if(o.showSecrets){if(o.enhancement>0)hints.append(Hint.create(`+${o.enhancement}`,["enhancement"],{hint:i18n.get("Koboldworks.Hints.Enhancement",{enh:o.enhancement})}).element());if(!o.isIdentified)hints.append(descriptors.unidentified.clone().element(o.iconize));if(o.casterLevel>0&&o.showSecrets){if(game.settings.get(CFG.id,CFG.SETTING.aura)){const auraKey=itemData.aura.school,aura=itemData.aura.custom?auraKey:pf1.config.spellSchools[auraKey];const hint=Hint.create(`${aura} (${o.casterLevel})`,["aura"]);const auraD=game.settings.get(CFG.id,CFG.SETTING.schoolAura);const asKeys=["letters","letterswcl"].includes(auraD);if(o.iconize){if(asKeys){hint.hint=hint.label;hint.label=auraKey.length<=3?i18n.get(`Koboldworks.School.${auraKey||"Unknown"}`):i18n.get("Koboldworks.School.odd");if(auraD==="letterswcl")hint.label+=` (${o.casterLevel})`}else{hint.image=getAuraIcon(auraKey,auraD)}}hints.append(hint.element(!asKeys?o.iconize:false))}const glowLevel=Math.clamp(Math.ceil((o.casterLevel+1)/6),1,3);if(!o.simulation&&o.glow){o.element.querySelector(".item-name h4").classList.add(`enhancement-${glowLevel}`)}}}if(!itemData.resizing){if(!["loot","attack","consumable"].includes(item.type)){const itemSize=sizeMap[itemData.size||"med"];const actorSize=o.actorData?.traits?.size?.value;if(itemSize&&actorSize!==itemSize){const sizeLabel=pf1.config.actorSizes[sizeMapInvert[itemSize]];hints.append(Hint.create(sizeLabel.capitalize(),["size"]).element())}}}}init_hint();function handleProficiency(o,hints){const actor=o.actor;if(!actor)return;const item=o.item;if(!["equipment","attack","weapon","equipment"].includes(item.type))return;if(item.type==="equipment"&&!["armor","shield"].includes(item.subType))return;if(item.type==="attack"&&item.subType!=="weapon")return;let proficient=true;try{if(item.type==="equipment")proficient=actor.hasArmorProficiency(item);else{const override=item.type==="attack";proficient=actor.hasWeaponProficiency(item,{override})}}catch{return}if(proficient)return;const cssClasses=["nonproficient"];const forced=item.system.proficient??false;if(forced)cssClasses.push("forced-proficiency");hints.append(Hint.create(forced?i18n.get("Koboldworks.Missing.PF1.ForcedProficiency"):i18n.get("Koboldworks.Missing.PF1.Nonproficient"),cssClasses,{icon:"fa-solid fa-book-dead"}).element(o.iconize))}init_hint();async function handleSaves(o,hints){const item=o.item;if(!item.hasSave)return;const itemData=o.itemData,itemFormula=itemData.save.dc,bookFormula=item.spellbook?.baseDCFormula??"",dcFormula=[bookFormula,itemFormula].map((f)=>f?.trim()).filter((f)=>!!f).join(" + ");const rollData=o.rollData;if(dcFormula){const idc=RollPF.safeRoll(itemFormula,rollData);if(item.type!=="spell"||idc.total!==0){const rd=RollPF.safeRoll(dcFormula,rollData);const dc=!rd.err?rd.total:"Error";const dcHint=Hint.create(`${i18n.get("PF1.DC")} ${dc}`,["dc"],{hint:rd.formula});hints.append(dcHint.element(o.iconize))}}const save=itemData.save?.description;if(save?.length&&!/harmless/i.test(save))hints.append(Hint.create(await pf1.utils.enrichHTMLUnrolled(save,{rollData}),["save"]).element())}init_config();init_common();init_hint();async function handleSpell(o,hints){const itemData=o.itemData,materials=itemData.materials,material=materials.value;const nEl=Array.from(o.element.getElementsByClassName("spell-components")).at(-1);if(material&&materials.gpValue>0&&nEl){const mCost=descriptorIcons.material.clone();const mHints=createNode("div",null,[CFG.CSS.branding,CFG.CSS.common]);mHints.append(mCost.element(true));nEl.append(mHints)}const atWill=itemData.atWill??false;const spellbook=o.item.spellbook??{};const isBasicPrepared=spellbook.spellPreparationMode==="prepared";const usesSpellpoints=spellbook.spellPoints?.useSystem??false;const action=o.item.defaultAction;const actionCost=!atWill?await action?.getChargeCost({interactive:false,maximize:true}):0,castCost=!atWill?actionCost?.total??0:0;if(atWill||castCost==0){const label=i18n.get("Koboldworks.ItemHint.Description.Slotless"),hint=!usesSpellpoints?i18n.get("Koboldworks.ItemHint.Description.SlotlessHint"):i18n.get("Koboldworks.ItemHint.Description.SpellpointlessHint");const slHint=Hint.create(label,["slotcost","free"],{icon:"fa-solid fa-infinity",hint});hints.append(slHint.element(o.iconize))}else if(usesSpellpoints){const slHint=Hint.create(i18n.get("Koboldworks.ItemHint.Description.SpellpointCostShort",{cost:castCost,hint:i18n.get("Koboldworks.ItemHint.Description.SpellpointCost",{cost:castCost})}),["pointcost"]);hints.append(slHint.element(false))}else if(!isBasicPrepared&&castCost>1){const slHint=Hint.create(i18n.get("Koboldworks.ItemHint.Description.SlotCost",{cost:castCost}),["castcost"]);hints.append(slHint.element(false))}if(!usesSpellpoints&&isBasicPrepared){const slotCost=itemData.slotCost;if(slotCost>1){const slHint=Hint.create(i18n.get("Koboldworks.ItemHint.Description.SlotCost",{cost:slotCost}),["slotcost"]);hints.append(slHint.element(false))}}if(action?.hasSave){const rollData=action.getRollData();const dcOffFormula=action.save.dc||"0";const dcOff=RollPF.safeRollSync(dcOffFormula,rollData);if(dcOff.total!==0){const dc=action.getDC(rollData);const formula=o.item.spellbook.baseDCFormula+" + "+dcOffFormula;const dcHint=Hint.create(i18n.get("PF1.DCThreshold",{threshold:dc}),["dc"],{hint:formula});hints.append(dcHint.element(false))}}}init_common();function handleValue(o,hints,inContainer){if(o.values==="none")return;const{item,itemData}=o,quantity=itemData.quantity;if(!(quantity>0))return;const isContainer=item.type==="container",isTradeGoods=itemData.subType==="tradeGoods";let showValue=false;switch(o.values){case"all":showValue=true;case"expanded":if(inContainer)showValue=true;case"containers":if(isContainer)showValue=true;case"tradegoods":if(isTradeGoods)showValue=true;break;case"none":return}if(!showValue)return;const tCost=descriptorIcons.value.clone(),cpSelf=item.getValue({sellValue:1,recursive:false,single:true,inLowestDenomination:true}),cpTotal=item.getValue({sellValue:1,recursive:true,inLowestDenomination:true});const{standard,rate:rates}=pf1.config.currency;const rate=rates[standard]??1;const formatNumber=Intl.NumberFormat().format;const gpNum=(n)=>formatNumber(n/rate);const gpStr=`PF1.Currency.Inline.${standard}`;const gpLabel=i18n.get(gpStr,{value:gpNum(cpTotal)});tCost.label=gpLabel;if(isContainer){tCost.hint=i18n.get("Koboldworks.Hints.ContentsValue",{value:i18n.get(gpStr,{value:gpNum(cpSelf)}),contents:i18n.get(gpStr,{value:gpNum(cpTotal-cpSelf)})})}else{tCost.hint=quantity>1?i18n.get("Koboldworks.Hints.ValueMult",{value:gpNum(cpSelf),quantity,total:gpLabel}):gpLabel}hints.append(tCost.element(o.iconize))}init_hint();function handleScripts(o,hints){const itemData=o.itemData;if(itemData.scriptCalls?.length){const scHint=Hint.create(i18n.get("Koboldworks.ItemHint.Description.ScriptCall"),["script-call"],{icon:"fa-solid fa-file-prescription",hint:i18n.get("Koboldworks.ItemHint.Description.ScriptCallHint")});hints.append(scHint.element(o.iconize))}}var Manager={action:handleAction,attack:handleAttack,damage:handleDamage,changeFlags:handleChangeFlags,changes:handleChanges,class:handleClass,container:handleContainer,customHints:handleCustomHints,item:handleItem,proficiency:handleProficiency,saves:handleSaves,spell:handleSpell,value:handleValue,scripts:handleScripts};class AppContext{isContainer=false;constructor(sheet,html){this.#sheet=new WeakRef(sheet);this.#html=new WeakRef(html);let actor,item;const doc=sheet.document;if(doc instanceof Actor){actor=doc}else{item=doc}if(item){this.#item=new WeakRef(item);actor??=item.actor;this.isContainer=item.type==="container"}if(actor){this.#actor=new WeakRef(actor)}}#actor;get actor(){return this.#actor?.deref()}#item;get item(){return this.#item?.deref()}#sheet;get sheet(){return this.#sheet.deref()}#html;get html(){return this.#html.deref()}get items(){if(this.isContainer){return this.item.items}else{return this.actor.items}}}init_config();class HandlerOptions{#element;get element(){return this.#element.deref()}#actor;get actor(){return this.#actor?.deref()}#item;get item(){return this.#item.deref()}get actorData(){return this.actor?.system}get itemData(){return this.item?.system}get defaultAction(){return this.item?.defaultAction}get isWeapon(){return this.item.type==="weapon"}get isIdentified(){return this.itemData.identified??true}get enhancement(){return this.itemData.enh??this.itemData.armor?.enh}get casterLevel(){return this.itemData.cl}get showSecrets(){return this.isIdentified||game.user.isGM}#rollData;get rollData(){this.#rollData??=this.item.getRollData({forceRefresh:false});return this.#rollData}iconize=false;sanity=false;homebrew=false;changes=false;values=false;constructor(item,element,context){if(!(item instanceof Item))throw new Error("`item` is not an Item");if(!(element instanceof HTMLElement))throw new Error("`element` is not a HTMLElement");if(!(context instanceof AppContext))throw new Error("`context` is not AppContext");this.#item=new WeakRef(item);this.#actor=item.actor?new WeakRef(item.actor):null;this.#element=new WeakRef(element);this.context=context;this.iconize=game.settings.get(CFG.id,CFG.SETTING.iconizeSetting);this.sanity=game.settings.get(CFG.id,CFG.SETTING.sanity);this.homebrew=game.settings.get(CFG.id,CFG.SETTING.homebrew);this.changes=game.settings.get(CFG.id,CFG.SETTING.showChanges);this.values=game.settings.get(CFG.id,CFG.SETTING.showAllValues);this.glow=game.settings.get(CFG.id,CFG.SETTING.glow)}}async function createHints(opts){const context=opts.context;const hints=createNode("div",null,[CFG.CSS.branding,CFG.CSS.common]);const{item}=opts;try{switch(item.type){case"feat":Manager.damage(opts,hints);await Manager.saves(opts,hints);Manager.changes(opts,hints);Manager.changeFlags(opts,hints);break;case"spell":Manager.damage(opts,hints);await Manager.saves(opts,hints);await Manager.spell(opts,hints);break;case"consumable":case"equipment":case"loot":case"weapon":Manager.proficiency(opts,hints);Manager.damage(opts,hints);Manager.attack(opts,hints);Manager.item(opts,hints);Manager.changes(opts,hints);Manager.changeFlags(opts,hints);await Manager.saves(opts,hints);break;case"attack":Manager.proficiency(opts,hints);Manager.damage(opts,hints);Manager.attack(opts,hints);Manager.item(opts,hints);await Manager.saves(opts,hints);break;case"buff":Manager.changes(opts,hints);Manager.changeFlags(opts,hints);break;case"class":Manager.class(opts,hints);Manager.changes(opts,hints);Manager.changeFlags(opts,hints);break;case"container":Manager.container(opts,hints);break;default:break}Manager.action(opts,hints);Manager.value(opts,hints,context.isContainer);Manager.scripts(opts,hints);await Manager.customHints(opts,hints);for(const itemHandler of itemHandlers){itemHandler(opts,hints)}const actor=context.actor;let handlerErrors=0;for(const exItemHandler of exItemHandlers){let error=false;try{const exHints=exItemHandler(actor,item,opts)??[];for(const xh of exHints){if(xh instanceof Hint)hints.append(xh.element(opts.iconize));else{console.error("ITEM HINTS | Bad return value",xh,"from external handler:",exItemHandler,"for",item.name,item);error=true;break}}}catch(err){console.error(`ITEM HINTS | Error in external handler:
`,{actor,item,uuid:item.uuid,handler:exItemHandler},`
`,err,`
HANDLER REMOVED!`);error=true}finally{if(error){handlerErrors++;exItemHandler.__ih_needsDelete=true}}}if(handlerErrors){for(let i=0;i<exItemHandlers.length;i++){if(exItemHandlers[i].__ih_needsDelete){exItemHandlers.splice(i,1);i--}}}}catch(err){console.error("⚠️ ITEM HINTS | FAILURE | ITEM:",item?.name,{item,element:context.html},`
`,err)}return hints}async function renderCustomHintEditor(sheet,html){if(html instanceof jQuery)html=html[0];const{item,actor}=sheet;if(sheet.__modItemHintsDisableCustom)return;async function _onCustomHintChange(ev){const newValue=ev.target.value.trim();return newValue?.length>0?item.setFlag("world",CFG.SETTING.customHint,newValue):item.unsetFlag("world",CFG.SETTING.customHint)}const advTab=html.querySelector('.tab[data-tab="advanced"]');if(!advTab)return;try{const value=getHint(item);const templateData={value};const node=renderIHTemplate("item-hints-editor",templateData);const input=node.querySelector("input");if(sheet.isEditable)input.addEventListener("change",_onCustomHintChange);else{node.disabled=true;node.ariaReadOnly=true}const context=new AppContext(sheet,node);const opts=new HandlerOptions(item,node,context);opts.simulation=true;const hints=node.querySelector(".item-hints.koboldworks");createHints(opts).then((actualHints)=>{if(actualHints.childElementCount==0)hints.closest("fieldset.example-output").remove();else hints.replaceWith(actualHints)});advTab.append(node)}catch(err){console.error(`⚠️ ITEM HINTS | Editor | ${item.name}:`,item,`
`,err);sheet.item.__modItemHintsDisableCustom=true}}async function itemListElementHandler(el,context){const id=el.dataset.itemId;const item=context.items.get(id);if(!item)return;const nEl=el.querySelector(".item-name");if(!nEl)return;const opts=new HandlerOptions(item,el,context);const hints=await createHints(opts);nEl.querySelector("h4").after(hints)}async function injectHints(context){const iEls=context.html.querySelectorAll(".item-list .item");const ps=[];for(const el of iEls){const p=itemListElementHandler(el,context);ps.push(p)}await Promise.all(ps)}function renderDocumentSheet(sheet,html){if(sheet.item&&sheet.item.type!=="container")return;if(html instanceof jQuery)html=html[0];if(html.tagName!=="FORM")html=html.querySelector("form");if(!html)return;injectHints(new AppContext(sheet,html))}Hooks.on("renderItemSheet",renderCustomHintEditor);Hooks.once("ready",()=>{const hid0=Hooks.on("renderActorSheetPF",renderDocumentSheet);const hid1=Hooks.on("renderItemSheetPF",renderDocumentSheet);const events0=Hooks.events.renderActorSheetPF;const idx0=events0.findIndex((h)=>h.id===hid0);const[handler0]=events0.splice(idx0,1);events0.unshift(handler0);const events1=Hooks.events.renderItemSheetPF;const idx1=events1.findIndex((h)=>h.id===hid1);const[handler1]=events1.splice(idx1,1);events1.unshift(handler1)});

//# debugId=94F588A188E0168A64756E2164756E21
//# sourceMappingURL=item-hints.mjs.map
