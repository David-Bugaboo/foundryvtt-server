var A$=Object.defineProperty;var h$=(J,Z)=>{for(var Q in Z)A$(J,Q,{get:Z[Q],enumerable:!0,configurable:!0,set:(Y)=>Z[Q]=()=>Y})};class Z1{constructor(){this.packLookup={},this.packData={},this.packProcessing=!1}get defaultCompendia(){return[...game.packs.keys()].filter((J)=>J.startsWith("pf1.")||J.startsWith("pf1e-archetypes")||J.startsWith("pf-content")||J.startsWith("pf1-statblock-converter"))}async registerDefaultCompendia(){W.log("Registering default compendia..."),await this.processCompendiums(this.defaultCompendia,{bypassLock:!0})}async processCompendiums(J=[],{reset:Z=!1,bypassLock:Q=!1}={}){if(this.packProcessing&&!Q)return;if(!Array.isArray(J))J=[J];if(J.length===0)return;if(this.packProcessing=!0,this.packData&&Z)this.packData={},this.packLookup={},await this.registerDefaultCompendia();for(let Y of J){let H=await game.packs.get(Y);if(H){await H.getIndex(),H.fuzzyIndex=W.sortArrayByName([...H.index].map((X)=>({...X,name:X.flags?.babele?.originalName??X.name}))),this.packData[Y]=H;for(let X of H.fuzzyIndex){let G=X.type,z=X.system?.subType??null;if(G==="feat"&&!z)z="feat";let _={name:X.name,uuid:X.uuid,classes:X.system?.associations?.classes??[],tags:X.system?.tags??[],subType:z};if(!this.packLookup[Y])this.packLookup[Y]={};if(!this.packLookup[Y][G])this.packLookup[Y][G]={items:[]};if(this.packLookup[Y][G].items.push(_),z){if(!(z in this.packLookup[Y][G]))this.packLookup[Y][G][z]=[];this.packLookup[Y][G][z].push(_)}}}}this.packProcessing=!1}isKnownCompendium(J){return!!this.packLookup[J]||!1}uniquePermutations(J){let Z=new Set;if(J.length>7)return console.warn("Array too large. Not attempting.",J),!1;for(let Q=0;Q<J.length;Q=Q+1){let Y=this.uniquePermutations(J.slice(0,Q).concat(J.slice(Q+1)));if(!Y.length)Z.add([J[Q]]);else for(let H=0;H<Y.length;H=H+1)Z.add([J[Q]].concat(Y[H]))}return[...Z]}async findInCompendia(J,Z){if(!J)return;let Q;if(Z?.packs&&Z.packs.length)Q=Z.packs.flatMap((_)=>game.packs.get(_)??[]);else Q=game.packs.filter((_)=>!Z?.type||_.metadata.type==Z.type);J=J.toLocaleLowerCase();let Y,H,X=Z.itemTypes,G=[];for(let _ of Q){let q=_.metadata.id,K=this.packData[q];if(!K)W.log(`Pack ${q} not found in cache. Processing...`),await this.processCompendiums(q),K=this.packData[q];for(let V of X){if(!this.packLookup[q]?.[V])continue;let j=Z.itemSubTypes??Object.keys(this.packLookup[q][V]);for(let P of j){let O=this.packLookup[q][V][P]??[];O=O.filter((L)=>{let E=L.classes?.length>0?Z.classes?.length!==void 0?L.classes.some((N)=>{try{return Z.classes.includes(pf1.utils.createTag(N))}catch(M){return console.log(`There was an error in creating a class tag for "${N}".`),console.error(M),!1}}):!0:!0,B=L.tags?.length>0&&V==="feat"&&L.subType==="racial"?Z?.race?.length>0?L.tags.some((N)=>pf1.utils.createTag(N)===Z.race):!1:!0;return E&&B}),G=G.concat(O)}}}if(G=W.sortArrayByName(G),G.length>0){if(Y=pf1.utils.binarySearch(G,J,(_,q)=>{return _.localeCompare(q.name,void 0,{ignorePunctuation:!0})}),Y>-1)H=G[Y].uuid}if(H)return H;let z=this.uniquePermutations(J.split(/[ _-]/));if(z)z=z.map((_)=>_.join(" "));else z=[null],z.push(J.split(/[ _-]/).reverse().join(" ")),z.push(J.split(/[,;] ?/).reverse().flatMap((_)=>_.split(" ")).join(" "));for(let _=1;_<z.length;_++)if(Y=pf1.utils.binarySearch(G,z[_],(q,K)=>q.localeCompare(K.name,void 0,{ignorePunctuation:!0})),Y>-1)H=G[Y].uuid;if(H)return H;return null}async searchCompendia(J,Z={}){if(!J)return null;let Q,Y={};if(Z=Object.assign({packs:[],type:"Item",itemTypes:[],itemSubTypes:null,classes:void 0},Z),!J.search)J.search=new Set;else if(typeof J.search==="string")J.search=new Set([J.search]);else if(Array.isArray(J.search))J.search=new Set(J.search);let H=J.search;if(H.add(J.name).add(J.shortName).add(J.altName).add(J.altName2),H=[...H].filter((z)=>!!z),J.item==="Scribe Scroll")console.log(Z);for(let z of H)if(W.log(`Searching compendium for "${z}" (item: ${J.item}) in packs:`,Z.packs),Q=await this.findInCompendia(z,Z),Q)break;if(W.log(`Search Result for "${J.item}": `,Q||"<none>"),!Q)return null;Y=await fromUuid(Q);let X=Y.toObject();return X.flags.core={sourceId:Q},new Item.implementation(X)}async findEntityInCompendia(J,Z={}){if(Z.itemType)Z.itemTypes=Array.isArray(Z.itemType)?Z.itemType:[Z.itemType],delete Z.itemType;if(Z.itemSubType)Z.itemSubTypes=Array.isArray(Z.itemSubType)?Z.itemSubType:[Z.itemSubType],delete Z.itemSubType;let Q=Object.values(this.packData),Y=new Set,H=new Set,X=new Set;Q.forEach((_)=>{switch(_.metadata.package){case"pf1":Y.add(_.metadata.id);break;case"pf1e-archetypes":case"pf-content":case"pf1-statblock-converter":H.add(_.metadata.id);break;default:X.add(_.metadata.id);break}});let G=game.settings.get(SBC.config.modData.mod,"customCompendiums")?.split(/[,;]/g).filter((_)=>!this.packData[_])??[];return await this.processCompendiums(G),(await Promise.all([await this.searchCompendia(J,foundry.utils.mergeObject(Z,{packs:X})),await this.searchCompendia(J,foundry.utils.mergeObject(Z,{packs:H})),await this.searchCompendia(J,foundry.utils.mergeObject(Z,{packs:Y}))])).reduce((_,q)=>_||q,null)}}var g$={hooves:{img:"systems/pf1/icons/items/inventory/monster-hoof.jpg",isPrimaryAttack:!1,damageTypes:"B"},tail:{img:"systems/pf1/icons/items/inventory/monster-tail.jpg",isPrimaryAttack:!1,damageTypes:"B"},other:{img:"systems/pf1/icons/items/inventory/monster-cat.jpg",isPrimaryAttack:!1,damageTypes:"P, B or S"}},R0=g$;var b$=["Jotund Troll","Troll"],E1=b$;var D$={"Agent of the Grave":{hd:8,bab:"low",fort:"high",ref:"low",will:"high",skillsPerLevel:4,classSkills:["blf","hea","int","kar","khi","kre","lin","spl","umd"],img:"systems/pf1/icons/skills/affliction_08.jpg",offset:"@classes.agentOfTheGrave.level - 1"},"Aldori Swordlord":{hd:10,bab:"high",fort:"low",ref:"high",will:"low",skillsPerLevel:2,classSkills:["acr","blf","dip","int","kno","prf","sen"],img:"systems/pf1/icons/skills/weapon_25.jpg"},"Arcane Archer":{hd:10,bab:"high",fort:"high",ref:"high",will:"low",skillsPerLevel:4,classSkills:["per","rid","ste","sur"],img:"systems/pf1/icons/skills/weapon_03.jpg",offset:"@classes.arcaneArcher.level - ceil(@classes.arcaneArcher.level / 4)",castingType:["arcane"]},"Arcane Trickster":{hd:6,bab:"low",fort:"low",ref:"high",will:"high",skillsPerLevel:4,classSkills:["acr","apr","blf","clm","dip","dev","dis","esc","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","per","sen","slt","spl","ste","swm"],img:"systems/pf1/icons/skills/violet_28.jpg",offset:"@classes.arcaneTrickster.level",castingType:["arcane"]},"Arclord of Nex":{hd:6,bab:"low",fort:"low",ref:"low",will:"high",skillsPerLevel:2,classSkills:["dip","lin","sen","umd"],img:"systems/pf1/icons/skills/red_09.jpg",offset:"@classes.arclordOfNex.level",castingType:["arcane"]},"Argent Dramaturge":{hd:6,bab:"low",fort:"low",ref:"high",will:"high",skillsPerLevel:4,classSkills:["blf","dip","esc","fly","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","prf","per","sen","spl","umd"],img:"systems/pf1/icons/items/inventory/lute.jpg",offset:"@classes.argentDramaturge.level"},Asavir:{hd:10,bab:"high",fort:"high",ref:"low",will:"high",skillsPerLevel:4,classSkills:["blf","crf","han","int","kna","kre","per","rid","sen","sur"],img:"systems/pf1/icons/feats/ride-by-attack.jpg"},"Ashavic Dancer":{hd:8,bab:"med",fort:"low",ref:"high",will:"high",skillsPerLevel:4,classSkills:["acr","dip","fly","kpl","kre","per","prf","sen","spl","sur"],img:"systems/pf1/icons/spells/wind-grasp-magenta-2.jpg",offset:"@classes.ashavicDancer.level - 1"},"Aspis Agent":{hd:8,bab:"med",fort:"low",ref:"high",will:"low",skillsPerLevel:4,classSkills:["blf","dis","kar","khi","sen","slt","umd"],img:"systems/pf1/icons/skills/yellow_41.jpg"},Assassin:{hd:8,bab:"med",fort:"low",ref:"high",will:"low",skillsPerLevel:4,classSkills:["acr","blf","clm","dev","dip","dis","esc","int","lin","per","sen","slt","ste","swm","umd"],img:"systems/pf1/icons/skills/weapon_43.jpg"},"Battle Herald":{hd:10,bab:"high",fort:"high",ref:"low",will:"high",skillsPerLevel:4,classSkills:["blf","crf","dip","han","hea","int","ken","khi","klo","kno","per","prf","rid","sen"],img:"systems/pf1/icons/skills/red_05.jpg"},"Bellflower Tiller":{hd:8,bab:"med",fort:"low",ref:"high",will:"low",skillsPerLevel:6,classSkills:["acr","blf","dip","dis","esc","hea","int","kge","klo","per","sen","slt","ste","sur"],img:"systems/pf1/icons/skills/red_06.jpg"},"Blackfire Adept":{hd:6,bab:"low",fort:"low",ref:"low",will:"high",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.blackfireAdept.level - ceil(@classes.blackfireAdept.level / 4)"},Bloatmage:{hd:6,bab:"low",fort:"low",ref:"low",will:"high",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.bloatmage.level",castingType:["arcane"]},Brewkeeper:{hd:8,bab:"med",fort:"high",ref:"high",will:"low",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.brewkeeper.level - 1",castingType:["alchemy"]},"Brother of the Seal":{hd:8,bab:"med",fort:"high",ref:"high",will:"high",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Champion of Irori":{hd:8,bab:"high",fort:"high",ref:"high",will:"high",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Chernasardo Warden":{hd:8,bab:"med",fort:"low",ref:"high",will:"high",skillsPerLevel:6,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Crimson Templar":{hd:10,bab:"high",fort:"high",ref:"high",will:"low",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},Cyphermage:{hd:6,bab:"low",fort:"low",ref:"low",will:"high",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.cyphermage.level",castingType:["arcane"]},"Daggermark Poisoner":{hd:8,bab:"med",fort:"high",ref:"low",will:"low",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},Daivrat:{hd:6,bab:"low",fort:"low",ref:"low",will:"high",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.daivrat.level - 1",castingType:["arcane"]},Darechaser:{hd:10,bab:"high",fort:"high",ref:"high",will:"low",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Dawnflower Anchorite":{hd:8,bab:"med",fort:"low",ref:"high",will:"high",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.dawnflowerAnchorite.level - 1"},"Dawnflower Dissident":{hd:8,bab:"med",fort:"low",ref:"high",will:"high",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.dawnflowerDissident.level",castingType:["divine"]},"Death Slayer":{hd:8,bab:"med",fort:"high",ref:"low",will:"high",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.deathSlayer.level - ceil(@classes.deathSlayer.level / 5)"},Demoniac:{hd:8,bab:"med",fort:"high",ref:"low",will:"low",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.demoniac.level - 1"},"Devoted Muse":{hd:10,bab:"high",fort:"low",ref:"high",will:"low",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},Diabolist:{hd:6,bab:"low",fort:"low",ref:"low",will:"high",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.diabolist.level - 1"},"Divine Scion":{hd:8,bab:"med",fort:"low",ref:"low",will:"high",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.divineScion.level",castingType:["divine"]},"Dragon Disciple":{hd:12,bab:"med",fort:"high",ref:"low",will:"high",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.dragonDisciple.level - ceil(@classes.dragonDisciple.level / 4)",castingType:["arcane"]},Duelist:{hd:10,bab:"high",fort:"low",ref:"high",will:"low",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Eldritch Knight":{hd:10,bab:"high",fort:"high",ref:"low",will:"low",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.eldritchKnight.level - 1",castingType:["arcane"]},"Enchanting Courtesan":{hd:6,bab:"low",fort:"high",ref:"low",will:"high",skillsPerLevel:6,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.enchantingCourtesan.level - 1"},"Envoy of Balance":{hd:6,bab:"low",fort:"low",ref:"low",will:"high",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.envoyOfBalance.level"},"Esoteric Knight":{hd:10,bab:"high",fort:"high",ref:"low",will:"high",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"floor(@classes.esotericKnight.level / 2)",castingType:["psychic"]},Evangelist:{hd:8,bab:"med",fort:"low",ref:"high",will:"low",skillsPerLevel:6,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},Exalted:{hd:8,bab:"med",fort:"low",ref:"low",will:"high",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.exalted.level",castingType:["divine"]},Feysworn:{hd:8,bab:"med",fort:"low",ref:"low",will:"high",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.feysworn.level - 1"},"Genie Binder":{hd:6,bab:"low",fort:"low",ref:"low",will:"high",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"floor(@classes.genieBinder.level / 2) + floor(@classes.genieBinder.level / 5)"},"Golden Legionnaire":{hd:10,bab:"high",fort:"high",ref:"low",will:"low",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Gray Corsair":{hd:8,bab:"med",fort:"low",ref:"low",will:"high",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Gray Gardener":{hd:8,bab:"med",fort:"high",ref:"low",will:"high",skillsPerLevel:6,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.grayGardener.level - ceil(@classes.grayGardener.level / 4)",castingType:["divine"]},"Green Faith Acolyte":{hd:8,bab:"med",fort:"low",ref:"low",will:"high",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.greenFaithAcolyte.level",castingType:["divine"]},"Halfling Opportunist":{hd:8,bab:"med",fort:"low",ref:"high",will:"high",skillsPerLevel:6,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},Harrower:{hd:6,bab:"low",fort:"low",ref:"low",will:"high",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.harrower.level"},"Hellknight Signifer":{hd:8,bab:"med",fort:"low",ref:"low",will:"high",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.hellknightSignifer.level"},Hellknight:{hd:10,bab:"high",fort:"high",ref:"low",will:"low",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Heritor Knight":{hd:10,bab:"high",fort:"high",ref:"low",will:"high",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},Hinterlander:{hd:10,bab:"med",fort:"low",ref:"low",will:"high",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.hinterlander.level - 1"},"Holy Vindicator":{hd:10,bab:"high",fort:"high",ref:"low",will:"high",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.holyVindicator.level - ceil(@classes.holyVindicator.level / 4)",castingType:["divine"]},"Horizon Walker":{hd:10,bab:"high",fort:"high",ref:"low",will:"low",skillsPerLevel:6,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Inheritor's Crusader":{hd:10,bab:"high",fort:"high",ref:"low",will:"high",skillsPerLevel:1,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.inheritorsCrusader.level",castingClass:["cleric","paladin"]},"Inner Sea Pirate":{hd:8,bab:"med",fort:"low",ref:"high",will:"low",skillsPerLevel:6,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Knight of Ozem":{hd:10,bab:"high",fort:"high",ref:"low",will:"low",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Lantern Bearer":{hd:10,bab:"high",fort:"high",ref:"high",will:"low",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Lion Blade":{hd:8,bab:"med",fort:"low",ref:"high",will:"high",skillsPerLevel:6,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Living Monolith":{hd:8,bab:"med",fort:"high",ref:"low",will:"low",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},Loremaster:{hd:6,bab:"low",fort:"low",ref:"low",will:"high",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.loremaster.level"},"Low Templar":{hd:10,bab:"high",fort:"high",ref:"low",will:"low",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Magaambyan Arcanist":{hd:6,bab:"low",fort:"low",ref:"low",will:"high",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.magaambyanArcanist.level",castingType:["arcane"]},"Mammoth Rider":{hd:12,bab:"high",fort:"high",ref:"low",will:"high",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Master Chymist":{hd:10,bab:"high",fort:"high",ref:"high",will:"low",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.masterChymist.level - floor(@classes.masterChymist.level / 4) - 1",castingType:["alchemy"]},"Master Spy":{hd:8,bab:"med",fort:"low",ref:"high",will:"high",skillsPerLevel:6,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Mortal Usher":{hd:8,bab:"med",fort:"high",ref:"low",will:"high",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Mystery Cultist":{hd:8,bab:"med",fort:"low",ref:"low",will:"low",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.mysteryCultist.level - 1"},"Mystic Theurge":{hd:6,bab:"low",fort:"low",ref:"low",will:"high",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.mysticTheurge.level",castingType:["arcane","divine"]},"Nature Warden":{hd:8,bab:"med",fort:"high",ref:"low",will:"high",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.natureWarden.level - ceil(@classes.natureWarden.level / 4)",castingType:["divine"]},"Noble Scion":{hd:8,bab:"med",fort:"low",ref:"low",will:"high",skillsPerLevel:6,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Pain Taster":{hd:10,bab:"high",fort:"high",ref:"low",will:"low",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Pathfinder Chronicler":{hd:8,bab:"med",fort:"low",ref:"high",will:"high",skillsPerLevel:8,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Pathfinder Delver":{hd:8,bab:"med",fort:"low",ref:"high",will:"low",skillsPerLevel:8,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Pathfinder Field Agent":{hd:8,bab:"med",fort:"low",ref:"high",will:"high",skillsPerLevel:6,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Pathfinder Savant":{hd:6,bab:"low",fort:"low",ref:"low",will:"high",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.pathfinderSavant.level - 1"},"Pit Fighter":{hd:10,bab:"high",fort:"high",ref:"low",will:"low",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},Proctor:{hd:8,bab:"med",fort:"high",ref:"low",will:"low",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.proctor.level - 1"},"Prophet of Kalistrade":{hd:8,bab:"med",fort:"low",ref:"low",will:"high",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Pure Legion Enforcer":{hd:10,bab:"high",fort:"high",ref:"low",will:"high",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Rage Prophet":{hd:10,bab:"med",fort:"high",ref:"low",will:"high",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.rageProphet.level - (floor((@classes.rageProphet.level + 3) / 8) + floor(@classes.rageProphet.level / 8) + 1)"},"Razmiran Priest":{hd:8,bab:"med",fort:"low",ref:"low",will:"high",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.razmiranPriest.level - ceil(@classes.razmiranPriest.level / 4)",castingType:["arcane"]},"Red Mantis Assassin":{hd:8,bab:"med",fort:"low",ref:"high",will:"high",skillsPerLevel:6,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},Riftwarden:{hd:8,bab:"med",fort:"high",ref:"low",will:"high",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.riftwarden.level - ceil(@classes.riftwarden.level / 4)"},Ritualist:{hd:6,bab:"low",fort:"low",ref:"low",will:"high",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.ritualist.level"},"Rivethun Emissary":{hd:8,bab:"med",fort:"low",ref:"low",will:"high",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.rivethunEmissary.level - ceil(@classes.rivethunEmissary.level / 4)"},"Rose Warden":{hd:8,bab:"med",fort:"low",ref:"high",will:"low",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},Runeguard:{hd:6,bab:"low",fort:"low",ref:"low",will:"high",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.runeguard.level - 1"},"Sacred Sentinel":{hd:10,bab:"high",fort:"high",ref:"low",will:"high",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Sanguine Angel":{hd:10,bab:"high",fort:"high",ref:"low",will:"high",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Scar Seeker":{hd:10,bab:"high",fort:"high",ref:"low",will:"high",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"floor(@classes.scarSeeker.level / 2)"},Sentinel:{hd:10,bab:"high",fort:"high",ref:"low",will:"low",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},Shadowdancer:{hd:8,bab:"med",fort:"low",ref:"high",will:"low",skillsPerLevel:6,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},Shieldmarshal:{hd:10,bab:"high",fort:"low",ref:"high",will:"high",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},Skyseeker:{hd:10,bab:"high",fort:"high",ref:"low",will:"high",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.skyseeker.level - ceil(@classes.skyseeker.level / 4)",castingType:["divine"]},"Sleepless Detective":{hd:8,bab:"med",fort:"low",ref:"high",will:"high",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Soul Warden":{hd:8,bab:"low",fort:"low",ref:"low",will:"high",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.soulWarden.level"},Souldrinker:{hd:6,bab:"low",fort:"low",ref:"low",will:"high",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.souldrinker.level - ceil(@classes.souldrinker.level / 5)"},"Sphere Singer":{hd:8,bab:"med",fort:"low",ref:"high",will:"high",skillsPerLevel:6,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.sphereSinger.level - floor((@classes.sphereSinger.level + 7) / 8)"},"Stalwart Defender":{hd:12,bab:"high",fort:"high",ref:"low",will:"high",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},Stargazer:{hd:6,bab:"med",fort:"low",ref:"high",will:"high",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.stargazer.level"},"Steel Falcon":{hd:10,bab:"high",fort:"high",ref:"low",will:"low",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Storm Kindler":{hd:8,bab:"med",fort:"high",ref:"low",will:"high",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.stormKindler.level - ceil(@classes.stormKindler.level / 4)"},"Student of Perfection":{hd:10,bab:"high",fort:"high",ref:"high",will:"low",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Student of War":{hd:10,bab:"high",fort:"low",ref:"low",will:"high",skillsPerLevel:6,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Tattooed Mystic":{hd:6,bab:"low",fort:"low",ref:"low",will:"high",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.tattooedMystic.level - ceil(@classes.tattooedMystic.level / 4)"},Technomancer:{hd:6,bab:"low",fort:"low",ref:"low",will:"high",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.technomancer.level - 1",castingType:["arcane"]},"Thuvian Alchemist":{hd:6,bab:"low",fort:"low",ref:"low",will:"high",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.thuvianAlchemist.level",castingType:["arcane"]},"Twilight Talon":{hd:8,bab:"med",fort:"low",ref:"low",will:"high",skillsPerLevel:6,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Ulfen Guard":{hd:10,bab:"high",fort:"high",ref:"low",will:"high",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Umbral Court Agent":{hd:8,bab:"med",fort:"high",ref:"low",will:"high",skillsPerLevel:4,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.umbralCourtAgent.level - ceil(@classes.umbralCourtAgent.level / 4)"},"Veiled Illusionist":{hd:6,bab:"low",fort:"low",ref:"low",will:"high",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.veiledIllusionist.level"},"Westcrown Devil":{hd:8,bab:"med",fort:"low",ref:"high",will:"low",skillsPerLevel:6,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg"},"Winter Witch":{hd:6,bab:"low",fort:"low",ref:"low",will:"high",skillsPerLevel:2,classSkills:["acr","apr","art","blf","clm","crf","dev","dip","dis","esc","fly","han","hea","int","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","lin","lor","per","prf","pro","rid","sen","slt","spl","ste","sur","swm","umd"],img:"systems/pf1/icons/items/inventory/monster-eyes.jpg",offset:"@classes.winterWitch.level - 1",castingClass:["witch"]}},Q1=D$;var y$=["all-around vision","carrion sense","deepsight","deathwatch","dragon senses","greensight","lifesense","minesight","water sense"],N1=y$;var d$=["Abjurer","Conjurer","Diviner","Enchanter","Evoker","Illusionist","Necromancer","Transmuter","Universalist"],Y1=d$;var k$=["Apocalyptic","Aquatic","Ascendant","Authoritative","Benthic","Blissful","Bouncing","Brackish","Brisk","Burning","Centered","Cherry Blossom","Coaxing","Concussive","Conditional","Consecrate","Contagious","Contingent","Crypt","Dazing","Delayed","Disruptive","Echoing","Eclipsed","Ectoplasmic","Elemental","Empower","Empowered","Encouraging","Enlarge","Enlarged","Extend","Extended","Familiar","Fearsome","Flaring","Fleeting","Focused","Furious","Heighten","Heightened","Intensified","Intuitive","Jinxed","Latent Curse","Lingering","Logical","Maximize","Maximized","Merciful","Murky","Persistent","Piercing","Quicken","Quickened","Reach","Rime","Scarring","Scouting Summons","Seeking","Selective","Shadow Grasp","Sickening","Silent","Snuffing","Solar","Solid Shadows","Stable","Steam","Still","Stilled","Studied","Stygian","Stylized","Tenacious","Tenebrous","Thanatopic","Threatening Illusion","Threnodic","Thundering","Toppling","Toxic","Traumatic","Trick","Tumultuous","Umbral","Ursurping","Vast","Verdant","Widen","Widened","Yai-Mimic"],P0=k$;var m$=["Black","Blue","Brown","Gray","Green","Orange","Prismatic","Red","White"],M1=m$;var H1={};h$(H1,{Prefixes:()=>u$,Auras:()=>F,Abilities:()=>p$});var F=Object.freeze({Abjuration:"abj",Conjuration:"con",Divination:"div",Enchantment:"enc",Evocation:"evo",Illusion:"ill",Necromancy:"nec",Transmutation:"trs",Universal:"uni"}),u$=["Normal","Lesser","Improved","Greater","Light","Moderate","Heavy"],p$={Concealed:{staticCost:7500,cl:10,available:{lightWeapon:!0,oneHanded:!0},aura:F.Transmutation},Dueling:{staticCost:14000,cl:5,available:{melee:!0},aura:F.Transmutation},LesserConcealed:{staticCost:3000,cl:5,available:{lightWeapon:!0,oneHanded:!0},aura:F.Transmutation},Prehensile:{staticCost:2500,cl:7,available:{specific:"whip"},aura:F.Enchantment},Shrinking:{staticCost:1000,cl:5,available:{melee:!0},aura:F.Transmutation},Sneaky:{staticCost:5000,cl:7,available:{melee:!0},aura:F.Necromancy},Transformative:{staticCost:1e4,cl:10,available:{melee:!0},aura:F.Transmutation},Agile:{bonus:1,cl:7,available:{melee:!0},aura:F.Transmutation},Answering:{bonus:1,cl:7,available:{melee:!0},aura:F.Enchantment},BloodSong:{bonus:1,cl:6,available:{melee:!0,damageTypes:["slashing","piercing"]},aura:F.Transmutation},Countering:{bonus:1,cl:5,available:{melee:!0},aura:F.Transmutation},Courageous:{bonus:1,cl:3,available:{melee:!0},aura:F.Enchantment},DazzlingRadiance:{bonus:1,cl:7,available:{melee:!0},aura:"misc"},Deadly:{bonus:1,cl:5,available:{melee:!0,damage:["nonlethal"]},aura:F.Necromancy},Defending:{bonus:1,cl:8,available:{melee:!0},aura:F.Abjuration},Disjoining:{bonus:1,cl:7,available:{melee:!0},aura:F.Necromancy},FateStealing:{bonus:1,cl:5,available:{melee:!0},aura:F.Necromancy},Flamboyant:{bonus:1,cl:8,available:{lightWeapon:!0,oneHanded:!0,damageTypes:["piercing"]},aura:F.Transmutation},Fortuitous:{bonus:1,cl:8,available:{melee:!0},aura:F.Transmutation},Furious:{bonus:1,cl:8,available:{melee:!0},aura:F.Enchantment},GrayFlame:{bonus:1,cl:6,available:{melee:!0},aura:F.Transmutation},Grounding:{bonus:1,cl:5,available:{melee:!0},aura:F.Transmutation},Growing:{bonus:1,cl:6,available:{melee:!0},aura:F.Transmutation},Guardian:{bonus:1,cl:8,available:{melee:!0},aura:F.Abjuration},Guided:{bonus:1,cl:7,available:{weapon:!0},aura:F.Evocation},HeartSeeker:{bonus:1,cl:7,available:{melee:!0},aura:F.Necromancy},Injecting:{bonus:1,cl:5,available:{melee:!0},aura:F.Conjuration},Keen:{bonus:1,cl:10,available:{melee:!0,damage:["piercing","slashing"]},aura:F.Transmutation},KiFocus:{bonus:1,cl:8,available:{melee:!0},aura:F.Transmutation},Leveraging:{bonus:1,cl:6,available:{melee:!0},aura:F.Transmutation},Menacing:{bonus:1,cl:10,available:{melee:!0},aura:"misc"},MightyCleaving:{bonus:1,cl:8,available:{melee:!0},aura:F.Evocation},Mimetic:{bonus:1,cl:5,available:{melee:!0},aura:F.Abjuration},Neutralizing:{bonus:1,cl:5,available:{melee:!0},aura:F.Transmutation},Ominous:{bonus:1,cl:5,available:{melee:!0},aura:F.Evocation},Pitfall:{bonus:1,cl:5,available:{melee:!0},aura:F.Transmutation},Quenching:{bonus:1,cl:5,available:{melee:!0},aura:F.Transmutation},Sapping:{bonus:1,cl:5,available:{weapon:!0,damage:["nonlethal"]},aura:F.Enchantment},Seaborne:{bonus:1,cl:7,available:{melee:!0},aura:F.Transmutation},Skewering:{bonus:1,cl:5,available:{lightWeapon:!0,oneHanded:!0,damageTypes:["piercing"]},aura:F.Divination},Slithering:{bonus:1,cl:11,available:{melee:!0},aura:F.Transmutation},Smashing:{bonus:1,cl:10,available:{melee:!0,damage:["bludgeoning"]},aura:F.Conjuration},Sticky:{bonus:1,cl:8,available:{melee:!0,special:["reach"]},aura:F.Transmutation},Thawing:{bonus:1,cl:5,available:{melee:!0},aura:F.Transmutation},Throwing:{bonus:1,cl:5,available:{melee:!0},aura:F.Transmutation},Underwater:{bonus:1,cl:5,available:{melee:!0,damage:["bludgeoning","slashing"]},aura:F.Divination},Valiant:{bonus:1,cl:5,available:{melee:!0},aura:F.Divination},Vampiric:{bonus:1,cl:5,available:{melee:!0,damage:["slashing","piercing"]},aura:F.Necromancy},Vicious:{bonus:1,cl:9,available:{melee:!0},aura:F.Necromancy},Culling:{bonus:2,cl:8,available:{melee:!0,damage:["slashing"]},aura:F.Evocation},Disruption:{bonus:2,cl:14,available:{melee:!0,damage:["bludgeoning"]},aura:F.Conjuration},Furyborn:{bonus:2,cl:7,available:{melee:!0},aura:F.Enchantment},Glorious:{bonus:2,cl:5,available:{melee:!0},aura:F.Evocation},GreaterVampiric:{bonus:2,cl:8,available:{weapon:!0},aura:F.Necromancy},Harvesting:{bonus:2,cl:9,available:{melee:!0},aura:F.Necromancy},Impact:{bonus:2,cl:9,available:{oneHanded:!0,twoHanded:!0},aura:F.Transmutation},Invigorating:{bonus:2,cl:5,available:{melee:!0},aura:F.Enchantment},KiIntensifying:{bonus:2,cl:12,available:{melee:!0},aura:F.Transmutation},LegBreaker:{bonus:2,cl:7,available:{melee:!0,damage:["bludgeoning"]},aura:F.Transmutation},Liberating:{bonus:2,cl:12,available:{melee:!0},aura:F.Abjuration},LifeSurge:{bonus:2,cl:8,available:{melee:!0},aura:F.Conjuration},Negating:{bonus:2,cl:5,available:{melee:!0},aura:F.Abjuration},Obliviating:{bonus:2,cl:10,available:{melee:!0,damageTypes:["bludgeoning"]},aura:F.Enchantment},Quaking:{bonus:2,cl:6,available:{melee:!0,damageTypes:["bludgeoning"]},aura:F.Evocation},Truthful:{bonus:2,cl:11,available:{melee:!0},aura:F.Abjuration},Unseen:{bonus:2,cl:7,available:{melee:!0},aura:"misc"},Wounding:{bonus:2,cl:10,available:{melee:!0},aura:F.Evocation},Exhausting:{bonus:3,cl:12,available:{melee:!0},aura:F.Necromancy},GreaterFlamboyant:{bonus:3,cl:5,available:{lightWeapon:!0,oneHanded:!0,damageTypes:["piercing"]},aura:F.Transmutation},Nullifying:{bonus:3,cl:12,available:{melee:!0},aura:F.Abjuration},Repositioning:{bonus:3,cl:10,available:{melee:!0},aura:F.Enchantment},SpellStealing:{bonus:3,cl:13,available:{melee:!0},aura:F.Divination},Umbral:{bonus:3,cl:9,available:{melee:!0},aura:F.Evocation},Dancing:{bonus:4,cl:15,available:{melee:!0},aura:F.Transmutation},Flying:{bonus:5,cl:16,available:{melee:!0},aura:F.Transmutation},SpellSiphon:{bonus:5,cl:15,available:{melee:!0},aura:F.Transmutation},Vorpal:{bonus:5,cl:18,available:{melee:!0,damageTypes:["slashing"]},aura:"misc"},Adaptive:{staticCost:1000,cl:1,available:{specific:"composite bow"},aura:F.Transmutation},GreaterTransformative:{staticCost:15000,cl:15,available:{weapon:!0},aura:F.Transmutation},LiberatingWMH:{staticCost:7000,cl:10,available:{weapon:!0},aura:F.Abjuration},Resizing:{staticCost:4000,cl:5,available:{weapon:!0},aura:F.Transmutation},Sacrosanct:{staticCost:5000,cl:8,available:{weapon:!0},aura:F.Evocation},GreaterSniping:{staticCost:16875,cl:15,available:{ranged:!0},aura:"misc"},ImprovedSniping:{staticCost:7500,cl:10,available:{ranged:!0},aura:"misc"},NormalSniping:{staticCost:1875,cl:5,available:{ranged:!0},aura:"misc"},Ambushing:{bonus:1,cl:7,available:{ranged:!0},aura:F.Transmutation},Beaming:{bonus:1,cl:10,available:{ranged:!0},aura:F.Evocation},Conserving:{bonus:1,cl:7,available:{firearm:!0},aura:F.Conjuration},Distance:{bonus:1,cl:6,available:{ranged:!0},aura:F.Divination},Driving:{bonus:1,cl:10,available:{ranged:!0},aura:F.Evocation},Huntsman:{bonus:1,cl:7,available:{ranged:!0},aura:F.Divination},Inspired:{bonus:1,cl:7,available:{simple:!0,specific:["hand crossbow","rapier","shortbow","short sword","sword cane"]},aura:F.Enchantment},Jurist:{bonus:1,cl:4,available:{weapon:!0},aura:F.Transmutation},Lucky:{bonus:1,cl:8,available:{firearm:!0},aura:F.Transmutation},Plummeting:{bonus:1,cl:7,available:{ranged:!0},aura:F.Transmutation},Reliable:{bonus:1,cl:8,available:{firearm:!0},aura:F.Transmutation},Returning:{bonus:1,cl:7,available:{thrown:!0},aura:F.Transmutation},Sacred:{bonus:1,cl:16,available:{weapon:!0},aura:F.Transmutation},Seeking:{bonus:1,cl:12,available:{ranged:!0},aura:F.Divination},ShadowShooting:{bonus:1,cl:8,available:{ranged:!0},aura:F.Conjuration},SpellHurling:{bonus:1,cl:8,available:{thrown:!0},aura:F.Evocation},Training:{bonus:1,cl:3,available:{weapon:!0},aura:F.Transmutation},Unaligned:{bonus:1,cl:5,available:{weapon:!0},aura:F.Abjuration},Veering:{bonus:1,cl:5,available:{ranged:!0},aura:F.Evocation},Anchoring:{bonus:2,cl:10,available:{melee:!0,thrown:!0},aura:F.Transmutation},EndlessAmmunition:{bonus:2,cl:9,available:{bow:!0,crossbow:!0},aura:F.Conjuration},GlitterWake:{bonus:2,cl:12,available:{ranged:!0},aura:F.Conjuration},Potent:{bonus:2,cl:12,available:{weapon:!0},aura:F.Transmutation},Sharding:{bonus:2,cl:10,available:{melee:!0,thrown:!0},aura:F.Conjuration},Sniping:{bonus:2,cl:7,available:{ranged:!0},aura:F.Transmutation},Stalking:{bonus:2,cl:10,available:{weapon:!0},aura:F.Divination},GreaterLucky:{bonus:3,cl:12,available:{firearm:!0},aura:F.Enchantment},GreaterReliable:{bonus:3,cl:12,available:{firearm:!0},aura:F.Enchantment},Speed:{bonus:3,cl:7,available:{weapon:!0},aura:F.Transmutation},Tailwind:{bonus:3,cl:12,available:{ranged:!0},aura:F.Evocation},NimbleShot:{bonus:4,cl:11,available:{ranged:!0},aura:F.Abjuration},SecondChance:{bonus:4,cl:11,available:{bow:!0},aura:F.Abjuration},HeartPiercing:{bonus:5,cl:10,available:{ranged:!0,damageTypes:["piercing"]},aura:F.Evocation},Interfering:{bonus:5,cl:18,available:{ranged:!0},aura:F.Transmutation},DryLoad:{staticCost:1500,cl:3,available:{firearm:!0},aura:F.Abjuration},Exclusionary:{staticCost:3750,cl:1,available:{weapon:!0},aura:F.Necromancy},PhantomAmmunition:{staticCost:2000,cl:7,available:{ammunition:!0},aura:F.Transmutation},Allying:{bonus:1,cl:5,available:{weapon:!0},aura:F.Transmutation},Bane:{bonus:1,cl:8,hasSpecialTerm:!0,available:{weapon:!0},aura:F.Conjuration},Bewildering:{bonus:1,cl:7,available:{weapon:!0},aura:F.Transmutation},BloodHunting:{bonus:1,cl:8,available:{weapon:!0},aura:F.Conjuration},Breaking:{bonus:1,cl:5,available:{weapon:!0},aura:F.Evocation},Called:{bonus:1,cl:9,available:{weapon:!0},aura:F.Conjuration},Catalytic:{bonus:1,cl:12,available:{weapon:!0},aura:F.Evocation},ClusterShot:{bonus:1,cl:5,available:{ranged:!0},aura:F.Transmutation},Compassionate:{bonus:1,cl:7,available:{weapon:!0},aura:F.Conjuration},Conductive:{bonus:1,cl:8,available:{weapon:!0},aura:F.Necromancy},Confounding:{bonus:1,cl:5,available:{weapon:!0},aura:F.Transmutation},Corrosive:{bonus:1,cl:10,available:{weapon:!0},aura:F.Evocation},Cruel:{bonus:1,cl:5,available:{weapon:!0},aura:F.Necromancy},Cunning:{bonus:1,cl:6,available:{weapon:!0},aura:F.Divination},Debilitating:{bonus:1,cl:7,available:{weapon:!0},aura:F.Necromancy},Deceptive:{bonus:1,cl:9,available:{weapon:!0},aura:"misc"},Dispelling:{bonus:1,cl:10,available:{weapon:!0},aura:F.Abjuration},Distracting:{bonus:1,cl:5,available:{weapon:!0},aura:F.Enchantment},DrowScourge:{bonus:1,cl:8,available:{weapon:!0},aura:F.Conjuration},DuelingPSFG:{bonus:1,cl:7,available:{weapon:!0},aura:F.Transmutation},Fervent:{bonus:1,cl:8,available:{weapon:!0},aura:F.Conjuration},Flaming:{bonus:1,cl:10,available:{weapon:!0},aura:F.Evocation},Frost:{bonus:1,cl:8,available:{weapon:!0},aura:F.Evocation},HealersSorrow:{bonus:1,cl:5,available:{weapon:!0},aura:F.Necromancy},KinSlayer:{bonus:1,cl:8,available:{weapon:!0},aura:F.Conjuration},Limning:{bonus:1,cl:5,available:{weapon:!0},aura:F.Evocation},Merciful:{bonus:1,cl:5,available:{weapon:!0},aura:F.Conjuration},Miserable:{bonus:1,cl:8,hasSpecialTerm:!0,available:{weapon:!0},aura:F.Conjuration},MythicBane:{bonus:1,cl:8,available:{weapon:!0},aura:F.Evocation},Patriotic:{bonus:1,cl:10,available:{weapon:!0},aura:F.Conjuration},Planar:{bonus:1,cl:9,available:{weapon:!0},aura:F.Conjuration},Rusting:{bonus:1,cl:7,available:{weapon:!0},aura:F.Transmutation},Shock:{bonus:1,cl:8,available:{weapon:!0},aura:F.Evocation},SparkflyCrystalArrow:{bonus:1,cl:3,available:{ammunition:!0},aura:F.Evocation},SpiritHunting:{bonus:1,cl:8,available:{weapon:!0},aura:F.Conjuration},SummonBane:{bonus:1,cl:8,available:{weapon:!0},aura:F.Conjuration},Thundering:{bonus:1,cl:5,available:{weapon:!0},aura:F.Necromancy},Virulent:{bonus:1,cl:5,available:{weapon:!0},aura:F.Necromancy},Anarchic:{bonus:2,cl:7,available:{weapon:!0},aura:F.Evocation},Axiomatic:{bonus:2,cl:7,available:{weapon:!0},aura:F.Evocation},Burning:{bonus:2,cl:12,available:{weapon:!0},aura:F.Evocation},CorrosiveBurst:{bonus:2,cl:12,available:{weapon:!0},aura:F.Evocation},Cyclonic:{bonus:2,cl:12,available:{ranged:!0},aura:F.Conjuration},Dazzling:{bonus:2,cl:8,available:{firearm:!0},aura:F.Evocation},LesserDesignating:{bonus:2,cl:7,available:{ranged:!0},aura:F.Enchantment},DispellingBurst:{bonus:2,cl:12,available:{weapon:!0},aura:F.Abjuration},FlamingBurst:{bonus:2,cl:12,available:{weapon:!0},aura:F.Evocation},GreaterDistracting:{bonus:2,cl:8,available:{weapon:!0},aura:F.Enchantment},Heretical:{bonus:2,cl:9,available:{weapon:!0},aura:F.Evocation},Holy:{bonus:2,cl:7,available:{weapon:!0},aura:F.Evocation},IcyBurst:{bonus:2,cl:10,available:{weapon:!0},aura:F.Evocation},Igniting:{bonus:2,cl:12,available:{weapon:!0},aura:F.Evocation},Peaceful:{bonus:2,cl:8,available:{weapon:!0},aura:F.Enchantment},Penetrating:{bonus:2,cl:9,available:{ammunition:!0},aura:F.Evocation},PhaseLocking:{bonus:2,cl:7,available:{weapon:!0},aura:F.Abjuration},Planestriking:{bonus:2,cl:9,available:{weapon:!0},aura:F.Abjuration},RuneForged:{bonus:2,cl:13,available:{weapon:!0},aura:"misc"},Shattering:{bonus:2,cl:8,available:{weapon:!0},aura:F.Evocation},ShockingBurst:{bonus:2,cl:10,available:{weapon:!0},aura:F.Evocation},Silencing:{bonus:2,cl:8,available:{weapon:!0},aura:"misc"},Toxic:{bonus:2,cl:7,available:{weapon:!0},aura:F.Transmutation},Treasonous:{bonus:2,cl:12,available:{weapon:!0},aura:F.Conjuration},Unholy:{bonus:2,cl:7,available:{weapon:!0},aura:F.Evocation},Gory:{bonus:3,cl:15,available:{weapon:!0},aura:F.Necromancy},Redeemed:{bonus:3,cl:12,available:{weapon:!0},aura:"misc"},SonicBoom:{bonus:3,cl:8,available:{firearm:!0},aura:F.Evocation},BrilliantEnergy:{bonus:4,cl:16,available:{weapon:!0},aura:F.Transmutation},GreaterDesignating:{bonus:4,cl:12,available:{ranged:!0},aura:F.Enchantment},Adhesive:{staticCost:7000,cl:10,available:{armor:!0},aura:F.Transmutation},Amorphous:{staticCost:4500,cl:8,available:{armor:!0},aura:F.Transmutation},AquaDynamic:{staticCost:3750,cl:5,available:{armor:!0},aura:"misc"},BuoyantLight:{staticCost:1000,cl:5,available:{lightArmor:!0},aura:F.Transmutation},BuoyantMediumHeavy:{staticCost:2000,cl:5,available:{mediumArmor:!0,heavyArmor:!0},aura:F.Transmutation},Burdenless:{staticCost:4000,cl:5,available:{armor:!0},aura:F.Transmutation},Cloudburst:{staticCost:5000,cl:5,available:{armor:!0},aura:"misc"},Comfort:{staticCost:5000,cl:5,available:{armor:!0},aura:F.Transmutation},Corsair:{staticCost:5000,cl:5,available:{armor:!0},aura:F.Transmutation},Creeping:{staticCost:5000,cl:7,available:{armor:!0},aura:"misc"},Cushioned:{staticCost:1000,cl:1,available:{armor:!0},aura:F.Transmutation},Deceiving:{staticCost:5000,cl:7,available:{armor:!0},aura:F.Evocation},Delving:{staticCost:1e4,cl:5,available:{armor:!0},aura:F.Transmutation},Etherealness:{staticCost:49000,cl:13,available:{armor:!0},aura:F.Transmutation},Expeditious:{staticCost:4000,cl:5,available:{armor:!0},aura:F.Transmutation},Fitting:{staticCost:2000,cl:5,available:{armor:!0,shield:!0},aura:F.Transmutation},Glamered:{staticCost:2700,cl:10,available:{armor:!0},aura:"misc"},GreaterAquaDynamic:{staticCost:33750,cl:5,available:{armor:!0},aura:"misc"},GreaterShadow:{staticCost:33750,cl:15,available:{armor:!0},aura:"misc"},GreaterSlick:{staticCost:33750,cl:15,available:{armor:!0},aura:F.Conjuration},Harmonizing:{staticCost:15000,cl:7,available:{armor:!0},aura:"misc"},ImprovedAquaDynamic:{staticCost:15000,cl:5,available:{armor:!0},aura:"misc"},ImprovedShadow:{staticCost:15000,cl:10,available:{armor:!0},aura:"misc"},ImprovedSlick:{staticCost:15000,cl:10,available:{armor:!0},aura:F.Conjuration},Jousting:{staticCost:3750,cl:5,available:{armor:!0},aura:F.Transmutation},Locksmith:{staticCost:6500,cl:3,available:{lightArmor:!0},aura:F.Transmutation},Malevolent:{staticCost:5000,cl:7,available:{armor:!0},aura:F.Evocation},Martyring:{staticCost:18000,cl:9,available:{armor:!0},aura:F.Conjuration},MentalFocus:{staticCost:3000,cl:5,available:{armor:!0},aura:F.Evocation},PhaseLurching:{staticCost:9100,cl:13,available:{lightArmor:!0},aura:F.Conjuration},Putrid:{staticCost:1e4,cl:5,available:{armor:!0},aura:F.Conjuration},RadiantFlight:{staticCost:15000,cl:10,available:{heavyArmor:!0},aura:F.Transmutation},Restful:{staticCost:4500,cl:5,available:{armor:!0},aura:F.Necromancy},Righteous:{staticCost:27000,cl:10,available:{armor:!0},aura:F.Transmutation},Shadow:{staticCost:3750,cl:5,available:{armor:!0},aura:"misc"},Slick:{staticCost:3750,cl:4,available:{armor:!0},aura:F.Conjuration},SpiritBonded:{staticCost:6000,cl:9,available:{mediumArmor:!0},aura:F.Conjuration},Spiteful:{staticCost:7000,cl:7,available:{armor:!0},aura:F.Enchantment},Trackless:{staticCost:7500,cl:5,available:{armor:!0},aura:F.Transmutation},Unbound:{staticCost:27000,cl:10,available:{armor:!0},aura:F.Transmutation},Unrighteous:{staticCost:27000,cl:10,available:{armor:!0},aura:F.Transmutation},VenomEating:{staticCost:15000,cl:5,available:{armor:!0},aura:F.Transmutation},Vigilant:{staticCost:27000,cl:10,available:{armor:!0},aura:F.Transmutation},Advancing:{bonus:1,cl:5,available:{heavyArmor:!0},aura:F.Necromancy},Balanced:{bonus:1,cl:3,available:{mediumArmor:!0},aura:F.Evocation},Benevolent:{bonus:1,cl:5,available:{armor:!0},aura:F.Enchantment},Billowing:{bonus:1,cl:3,available:{armor:!0},aura:F.Conjuration},Bitter:{bonus:1,cl:5,available:{armor:!0},aura:F.Transmutation},Bolstering:{bonus:1,cl:5,available:{mediumArmor:!0,heavyArmor:!0,shield:!0},aura:F.Enchantment},Calming:{bonus:1,cl:5,available:{armor:!0},aura:F.Enchantment},Champion:{bonus:1,cl:5,available:{armor:!0},aura:F.Abjuration},Cocooning:{bonus:1,cl:9,available:{armor:!0},aura:F.Transmutation},Crusading:{bonus:1,cl:5,available:{armor:!0},aura:F.Abjuration},Dastard:{bonus:1,cl:5,available:{armor:!0},aura:F.Abjuration},Deathless:{bonus:1,cl:7,available:{armor:!0},aura:F.Abjuration},Evolving:{bonus:1,cl:7,available:{armor:!0},aura:F.Transmutation},Poisoning:{bonus:1,cl:7,available:{armor:!0},aura:F.Necromancy},Resonating:{bonus:1,cl:7,available:{armor:!0},aura:F.Abjuration},SpellStoring:{bonus:1,cl:12,available:{armor:!0},aura:F.Evocation},SpellSink:{bonus:1,cl:6,available:{armor:!0,shield:!0},aura:F.Abjuration},Stanching:{bonus:1,cl:7,available:{armor:!0},aura:F.Transmutation},TerrainStriding:{bonus:1,cl:13,available:{armor:!0},aura:F.Enchantment},TrapWarding:{bonus:1,cl:5,available:{armor:!0},aura:F.Transmutation},VouchSafing:{bonus:1,cl:9,available:{armor:!0},aura:F.Abjuration},Warding:{bonus:1,cl:12,available:{armor:!0},aura:F.Abjuration},Withstanding:{bonus:1,cl:10,available:{armor:!0},aura:F.Enchantment},Adamant:{bonus:2,cl:9,available:{heavyArmor:!0},aura:F.Conjuration},Bloodthirsty:{bonus:2,cl:7,available:{lightArmor:!0,mediumArmor:!0},aura:F.Enchantment},Frosted:{bonus:2,cl:3,available:{armor:!0,shield:!0},aura:F.Transmutation},GhostSpike:{bonus:2,cl:10,available:{armor:!0},aura:F.Evocation},Jarring:{bonus:2,cl:6,available:{armor:!0,shield:!0},aura:F.Evocation},MindButtressing:{bonus:2,cl:12,available:{mediumArmor:!0,heavyArmor:!0},aura:F.Abjuration},Phantasmal:{bonus:2,cl:7,available:{lightArmor:!0},aura:"misc"},Rampaging:{bonus:2,cl:3,available:{heavyArmor:!0},aura:"misc"},ShadowBlending:{bonus:2,cl:11,available:{armor:!0},aura:"misc"},SpellDodging:{bonus:2,cl:4,available:{armor:!0},aura:F.Abjuration},Steaming:{bonus:2,cl:3,available:{mediumArmor:!0,heavyArmor:!0},aura:F.Evocation},Volcanic:{bonus:2,cl:14,available:{heavyArmor:!0},aura:F.Evocation},ArrowCollecting:{bonus:3,cl:11,available:{mediumArmor:!0},aura:"misc"},Brawling:{bonus:3,cl:5,available:{lightArmor:!0},aura:F.Transmutation},Cotraveling:{bonus:3,cl:14,available:{armor:!0},aura:F.Conjuration},Invulnerability:{bonus:3,cl:18,available:{armor:!0},aura:"misc"},Sensing:{bonus:3,cl:14,available:{armor:!0},aura:F.Divination},Titanic:{bonus:3,cl:7,available:{armor:!0},aura:F.Transmutation},Denying:{bonus:4,cl:13,available:{armor:!0},aura:F.Abjuration},DreadWing:{bonus:5,cl:15,available:{armor:!0,specific:["full plate","hellknight plate"]},aura:F.Transmutation},Unbowed:{bonus:5,cl:9,available:{armor:!0},aura:"misc"},BuoyantShield:{staticCost:1000,cl:5,available:{shield:!0},aura:F.Transmutation},Channeling:{staticCost:18000,cl:8,available:{shield:!0},aura:F.Conjuration},Determination:{staticCost:30000,cl:10,available:{shield:!0,armor:!0},aura:F.Conjuration},EnergyResistance:{staticCost:18000,cl:3,available:{shield:!0,armor:!0},aura:F.Abjuration},GreaterEnergyResistance:{staticCost:66000,cl:11,available:{shield:!0,armor:!0},aura:F.Abjuration},Hosteling:{staticCost:7500,cl:9,available:{shield:!0,armor:!0},aura:F.Conjuration},ImprovedEnergyResistance:{staticCost:42000,cl:7,available:{shield:!0,armor:!0},aura:F.Abjuration},PoisonResistant:{staticCost:2250,cl:7,available:{shield:!0,armor:!0},aura:F.Conjuration},Radiant:{staticCost:7500,cl:6,available:{shield:!0,armor:!0},aura:F.Evocation},Rallying:{staticCost:5000,cl:5,available:{shield:!0,armor:!0},aura:F.Abjuration},UndeadControlling:{staticCost:49000,cl:13,available:{shield:!0,armor:!0},aura:F.Necromancy},WyrmsBreath:{staticCost:5000,cl:5,available:{shield:!0},aura:F.Evocation},ArrowCatching:{bonus:1,cl:8,available:{shield:!0},aura:F.Abjuration},Assiduous:{bonus:1,cl:1,available:{shield:!0},aura:"misc"},Bashing:{bonus:1,cl:8,available:{shield:!0},aura:F.Transmutation},Blinding:{bonus:1,cl:7,available:{shield:!0},aura:F.Evocation},Clangorous:{bonus:1,cl:7,available:{shield:!0,armor:!0},aura:F.Evocation},Defiant:{bonus:1,cl:8,hasSpecialTerm:!0,available:{shield:!0,armor:!0},aura:F.Conjuration},Folding:{bonus:1,cl:13,available:{shield:!0},aura:"misc"},LightFortification:{bonus:1,cl:13,available:{shield:!0,armor:!0},aura:F.Abjuration},Grinding:{bonus:1,cl:5,available:{shield:!0,armor:!0},aura:F.Transmutation},Guarding:{bonus:1,cl:8,available:{shield:!0},aura:F.Abjuration},Heraldric:{bonus:1,cl:13,available:{shield:!0},aura:F.Enchantment},Impervious:{bonus:1,cl:7,available:{shield:!0,armor:!0},aura:F.Transmutation},Mirrored:{bonus:1,cl:8,available:{shield:!0,armor:!0},aura:F.Abjuration},Ramming:{bonus:1,cl:5,available:{shield:!0},aura:F.Evocation},Rebounding:{bonus:1,cl:5,available:{shield:!0},aura:F.Abjuration},Singing:{bonus:1,cl:10,available:{shield:!0},aura:F.Evocation},Spellrending:{bonus:1,cl:9,available:{shield:!0},aura:F.Abjuration},Animated:{bonus:2,cl:12,available:{shield:!0},aura:F.Transmutation},ArrowDeflection:{bonus:2,cl:5,available:{shield:!0},aura:F.Abjuration},GreaterGuarding:{bonus:2,cl:12,available:{shield:!0},aura:F.Abjuration},Jawbreaker:{bonus:2,cl:9,available:{shield:!0},aura:F.Necromancy},Mastering:{bonus:2,cl:13,available:{shield:!0},aura:"misc"},Merging:{bonus:2,cl:10,available:{shield:!0},aura:F.Transmutation},SpellResistance13:{bonus:2,cl:15,available:{armor:!0,shield:!0},aura:F.Abjuration},Weeping:{bonus:2,cl:10,available:{shield:!0},aura:F.Enchantment},Deflecting:{bonus:3,cl:13,available:{shield:!0},aura:F.Abjuration},ModerateFortification:{bonus:3,cl:13,available:{armor:!0,shield:!0},aura:F.Abjuration},GhostTouch_:{bonus:1,cl:9,available:{weapon:!0},aura:F.Conjuration},GhostTouch:{bonus:3,cl:15,available:{armor:!0,shield:!0},aura:F.Transmutation},SpellResistance15:{bonus:3,cl:15,available:{armor:!0,shield:!0},aura:F.Abjuration},Wild:{bonus:3,cl:9,available:{armor:!0},aura:F.Transmutation},Bastion:{bonus:4,cl:15,available:{shield:!0},aura:F.Abjuration},SpellResistance17:{bonus:4,cl:15,available:{armor:!0,shield:!0},aura:F.Abjuration},HeavyFortification:{bonus:5,cl:13,available:{armor:!0,shield:!0},aura:F.Abjuration},Reflecting:{bonus:5,cl:14,available:{shield:!0},aura:F.Abjuration},SpellResistance19:{bonus:5,cl:15,available:{armor:!0,shield:!0},aura:F.Abjuration}};var o$=["A(?:[AM]|A2|SoL|[CPR]G)","AP:?(?:CC|CoT|CotCT|JR|K|LoF|RotR|S[DS])","BotD[123]","BM","C(?:o[GS]|RB|C[TH]R|EoD)","D(?:E|ou?)G","D(?:HB|DR)","EoG","F[FG]","G(?:aM|MG|n?oG|ttRK)","H(?:uo?G|otJ|[AH])","IS(?:WG|[MPBGCR])","L(?:otLK|CoG)","M:?(?:AoS|CH?|CoGD|CotED?|CotRS|FoR|FStS|G?H|GoD|Mot(?:LG|FF)|M[MR]?|RotFQ|RPT|TotIM|WBG|WL)","NPCG","O(?:oG|LoP|[AO])","P(?:A|otIS|&P|FSG)","QGttE","R(?:G|oF)","S(?:tLC|D|oS)","T(?:EoG|G)","U(?:[CEMRIW]|SH)","(!STATISTICS)CS"],R1=o$;var c$=["aberration","animal","construct","dragon","fey","magical beast","monstrous humanoid","humanoid","ooze","outsider","plant","undead","vermin"],v1=c$;var l$=["adlet","aeon","aether","agathion","air","android","angel","aquatic","archon","astomoi","asura","augmented","azata","behemoth","blight","catfolk","changeling","chaotic","clockwork","cold","colossus","daemon","darkfolk","deepone","demodand","demon","derro","devil","div","dwarf","earth","elemental","elf","evil","extraplanar","fire","giant","gnome","goblinoid","good","gray","greatoldone","grippli","halfling","hive","human","incorporeal","inevitable","kaiju","kami","kasatha","kitsune","kyton","lawful","leshy","manasaputra","mortic","munavri","mythic","native","nightshade","oni","orc","phantom","protean","psychopomp","qlippoth","rakshasa","ratfolk","reptilian","robot","sahkil","samsaran","sasquatch","shapechanger","skinwalker","spawnofrovagug","swarm","troop","vanara","vishkanya","water","wayang","wildhunt"],U1=l$;var n$=["Brutally weighted","Dual-balanced","Jagged hooks?","Razor-Sharp","Serrated Edge","Tactically Adapted","Verstaille Design","Burnished","Deflecting","Double-plated","Jarring","Nimble","Razored","Slumbering","Throwing Shield","Vitalguard","With Armor Spikes?","Spiked(?! Chain(?:\b|$)| Gauntlet)"],x1=n$;var i$={construct:{damage:["nonlethal"],conditions:["mindAffecting","bleed","disease","deathEffects","paralyze","poison","sleep","stun","fatigue","exhausted","energyDrain"],custom:["Necromancy Effects","Effects that require a Fort. save","Ability Damage","Ability Drain","Massive Damage"]},dragon:{conditions:["paralyze","sleep"]},ooze:{damage:["precision"],condition:["mindAffecting","poison","sleep","paralyze","polymorph","stun"],custom:["Gaze Attacks","Visual Effects","Illusions","Attack forms that rely on sight","Flanking","Critical Hits"]},plant:{condition:["mindAffecting","paralyze","polymorph","poison","sleep","stun"]},undead:{damage:["nonlethal"],condition:["mindAffecting","bleed","deathEffects","disease","paralyze","poison","sleep","stun","exhausted","fatigue"],custom:["Ability Drain","Energy Drain","Damage to phys. Ability Scores","Effects that require a Fort. save","Massive Damage","Raise Dead","Reincarnate"]},vermin:{condition:["mindAffecting"]}},I1=i$;var r$={"sandals of elvenkind":"Boots of Elvenkind","sawtooth sabre":"Sawtoothed Sabre","resist (?:fire|cold|acid|electric(?:ity)?|sonic)":"Resist Energy","^backpack$":"Backpack, common","pale lavender ioun stone":"pale lavender ellipsoid ioun stone","robes of the archmagi":"robe of the archmagi","^ambrosia$":"Ambrosia (Vial)","^Rations \\((\\d+) days\\)$":"Trail Rations","Winter Blanket":"Blanket","spherewalker staff":"Spherewalker's Staff","coat of resistance":"Cloak of Resistance"},S1=r$;var o1={actorSizes:"PF1.ActorSize.",languages:"PF1.Language.",weaponGroups:"PF1.WeaponGroup.",damageResistances:"PF1.Alignments.",conditionTypes:"PF1.Condition.",skills:"PF1.Skill",senses:"PF1.Sense.",weaponProperties:"PF1.WeaponProperty.",flyManeuverabilities:"PF1.Movement.FlyManeuverability.Quality."},s$={damageResistances:{lawful:"l",chaotic:"c",good:"g",evil:"e"},skills:{acr:"Acr",apr:"Apr",art:"Art",blf:"Blf",clm:"Clm",crf:"Crf",dip:"Dip",dev:"Dev",dis:"Dis",esc:"Esc",fly:"Fly",han:"Han",hea:"Hea",int:"Int",kar:"KAr",kdu:"KDu",ken:"KEn",kge:"KGe",khi:"KHi",klo:"KLo",kna:"KNa",kno:"KNo",kpl:"KPl",kre:"KRe",lin:"Lin",lor:"Lor",per:"Per",prf:"Prf",pro:"Pro",rid:"Rid",sen:"Sen",slt:"Slt",spl:"Spl",ste:"Ste",sur:"Sur",swm:"Swm",umd:"UMD"},senses:{bs:"blindsight",bse:"blindsense",dv:"darkvision",ts:"tremorsense",tr:"trueseeing",ll:"lowlight",ls:"lifesense",si:"seeInvis",sid:"seeInDark",sc:"scent"},weaponProperties:{ato:"Automatic",blc:"Blocking",brc:"Brace",dea:"Deadly",dst:"Distracting",dbl:"Double",dis:"Disarm",fin:"Finesse",frg:"Fragile",grp:"Grapple",imp:"Improvised",mnk:"Monk",nnl:"NonLethal",prf:"Performance",rch:"Reach",sct:"Scatter",sma:"SemiAutomatic",slf:"SlowFiring",snd:"Sunder",spc:"Special",thr:"Thrown",trp:"Trip"}},n=(J)=>{let Z=pf1.config[J];if(!Z)throw new Error(`Config "${J}" does not exist`);if(!o1[J])throw new Error(`Config "pf1.config.${J}" does not have a localization base string.
Please add it.`);return Object.fromEntries(Object.entries(Z).map(([Q,Y])=>{if(typeof Y!=="string")throw new Error(`getConfig() called with non-string value for key "${Q}"`);let H=s$[J]?.[Q]??Q,X=`${o1[J]}${H}`;if(!foundry.utils.getProperty(game.i18n.translations,X))return[Q,Y];return[Q,game.i18n.localize(X)]}))},z0=(J)=>{return game.i18n.localize(J._source.name)};function $0(J,Z={}){if(Z=Object.assign({pluralize:!1,matchStart:!1,matchEnd:!1,wordBoundary:!0,capture:!0,escape:!0,append:"",prepend:"",flags:"gi",appendMatch:""},Z),!Array.isArray(J))J=Object.values(J);return J=J.filter((Q,Y,H)=>H.indexOf(Q)===Y).sort((Q,Y)=>Y.length-Q.length).map((Q)=>Z.escape?J0(Q):Q).map((Q)=>Z.appendMatch?Q+Z.appendMatch:Q).filter((Q)=>Q.length>0),new RegExp((Z.matchStart?"^":"")+Z.prepend+(Z.wordBoundary?"\\b":"")+(Z.capture?typeof Z.capture==="string"?`(?<${Z.capture}>`:"(":"(?:")+(J.length?J.join(Z.pluralize?"s?|":"|"):"_")+(Z.pluralize?"s?":"")+")"+(Z.wordBoundary?"\\b":"")+Z.append+(Z.matchEnd?"$":""),Z.flags)}function J0(J){return J.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&")}function v0(J=!0){let Z=SBC.config.classes.concat(SBC.config.prestigeClasses).concat(SBC.config.mythicPaths).concat(Y1);return $0(Z,{capture:"class",prepend:J?"(?<exClass>Ex-)?":"",append:J?"(\\s+of\\s+(?<deity>[a-z- ]+))?\\s*(?: \\((?<archetype>.*)\\))?\\s+(?<level>\\d+)":""})}function c1(){return $0(SBC.config.classes)}function l1(){return $0(SBC.config.prestigeClasses)}function C0(){return $0(Y1)}function n1(){return $0(SBC.config.mythicPaths)}function i1(){return $0(SBC.config.armorBonusTypes)}function Y0(J=!1){let Z=Object.values(pf1.registry.damageTypes.getLabels()).concat(Object.values(pf1.registry.materials.getLabels())).concat(Object.values(n("damageResistances")));return $0(Z,J?{matchStart:!0,matchEnd:!0}:{})}function X1(){return $0(n("conditionTypes"))}function r1(){return $0(pf1.registry.conditions.getLabels())}function G1(){let J=SBC.config.naturalAttacks.concat(Object.keys(R0));return $0(J,{pluralize:!0,wordBoundary:!1})}function s1(){return $0(pf1.registry.materials.contents.filter((J)=>J.addon===!1).map(z0))}function a1(){return $0(pf1.registry.materials.contents.filter((J)=>J.basic).map(z0))}function A0(){return $0(pf1.registry.materials.contents.filter((J)=>J.addon===!1&&J.basic===!1).map(z0))}function U0(){return $0(pf1.registry.materials.contents.filter((J)=>J.addon===!0).map(z0))}function w1(){return $0(n("skills"),{wordBoundary:!1})}function t1(){return $0(n("skills"),{capture:"name",prepend:"\\+?(?<value>-?\\d*)\\s*",append:"(?<context>.*)",flags:"i",wordBoundary:!1})}function e1(){return/\d+d\d+|\d+\s?(?:hp|damage|minutes?)|[AD]C\s?\d+|\d+\s*(?:rounds)?\/(?:day|week|month|year)|at[ -]will|constant|\d+-ft|\d+\s*natural|(lesser|greater|minor|major)|[-+]?\d/i}function B0(){return/(?<uses>\d+(?!\d*,\s*))\s*(?<useTerm>.*?)?\/(?<period>day|week|month|year)/i}function $$(){let J=Object.values(n("languages")).map((Z)=>Z.toLowerCase());return $0(J)}function W1(){return/(potion|wand|scroll|oil)s?\s+of\s+(.+)/i}function _1(){return $0(SBC.config.techColors,{append:"(?!\\s+Powder)"})}function J$(){return $0(SBC.config.techTiers,{escape:!1})}function Z$(){return/^(Vial|Keg|Dose|Cup)s? of (.*)$/gi}function f1(){let J=Object.keys(SBC.config.magicalAbilities.Abilities).map((Q)=>{return Q.replace("_","").replace(/([A-Z])/g," $1").trim().replaceAll(" ","[ -]?")}),Z=SBC.config.magicalAbilities.Prefixes;return $0(J,{escape:!1,capture:"ability",prepend:`(?<prefix>(?:${Z.join("|")})\\s+)?`,append:`(?<postfix>(?:\\s+\\(|,\\s+)(?:${Z.join("|")})\\)?)?`})}function Q$(){return $0(SBC.config.itemModifications,{escape:!1})}function Y$(){return/(?:(?<pp>\d+)\s*pp)?\s*(?:(?<gp>\d+)\s*gp)?\s*(?:(?<sp>\d+)\s*sp)?\s*(?:(?<cp>\d+)\s*cp)?/i}function H$(){return/\((--|S[UP]|EX)\)/i}function X$(){return/^(?<name>.+?)\s*\((?<type>--|S[UP]|EX)\)\s*(?<description>.+?)$/i}function G$(){return/(?<type>Fort|Ref|Will)\s*(?<value>[+-]?\d+)/i}function x0(){return $0(n("actorSizes"))}function T1(){return/\b(?:fe)?male\b/i}function z1(){return/^(Any Alignment|\\*A|[LNC][GE]|[LC]?N)\b/i}function W$(){return $0(SBC.config.creatureTypes)}function C1(){return new RegExp("\\b(?:"+Object.values(n("actorSizes")).join("|")+")\\b\\s*\\b("+Object.values(SBC.config.creatureTypes).join(".*|")+")\\b","i")}function q1(){return/(?<type>Fortitude|Reflex|Will)?\s*DC\s*(?<dc>\d+)?\s*(?<effect>.*)?/i}function K1(){return/(?<formula>\d+d\d+\s*\+?\s*\d*)\s*(?<type>.*damage?)?\s*(?<effect>.*)/i}function V1(){return/(?<range>\d+).*?ft.*\s*(?<type>cone|ray|radius|diameter)/i}function _$(){return $0(["battered","ragged and torn","tattered"],{matchStart:!0,wordBoundary:!1})}class h{constructor(J){this.app=J}get parserGroup(){return"Parser"}get parserType(){return"base"}async _parse(J,Z,Q){return!0}throwError(J,Z,Q,Y,...H){J&&SBC.settings.getSetting("debug")&&console.error(J);let X=W.translate(Z,{value:Q,line:Y,...H}),G=new f(f.ERRORLEVELS.ERROR,this.parserGroup,X,Y,Q);this.app.processData.errors.push(G)}logInfo(J,Z,Q,Y){let H=W.translate(J,{value:Z,line:Q,...Y}),X=new f(f.ERRORLEVELS.INFO,this.parserGroup,H,Q,Z);this.app.processData.errors.push(X)}throwParseError(J,Z,Q,Y){this.throwError(J,`parser.${this.parserType}.error`,Z,Q,Y)}async parse(J,Z,Q=void 0){try{return W.log(W.translate(`parser.${this.parserType}.status`,{value:J,line:Z,type:Q})),await this._parse(J,Z,Q)}catch(Y){return this.throwParseError(Y,J,Z,Q),!1}}splitText(J,Z=!0){let Q=[],Y=J.replace(/(\d)(,)(\d)/g,"$1$3").trim();if(Y.search(/[,;]/g)===-1)Q=Y.replace(/\)\s/,");").split(/;/);else if(Y.match(/([^,;]+\([^(]+?[,;][^(]+?\))+?/gi)===null)Q=Y.split(/[,;]/g);else{let H=Y.match(/([^,;]+\([^(]+?[,;][^(]+?\)[^,]*)+?/gi),X=Object.keys(H);for(let z=0;z<X.length;z++){let _=X[z],q=H[_].trim();if(Z){let V=/^(?<name>.*?)(?:\s\((?<parens>.*)\)(?<bonus>.*))?$/g.exec(q),{name:j,parens:P,bonus:O}=V.groups;if(["change shape","witch's familiar","hex","hexes","bardic performances","rogue talents"].includes(j.toLowerCase()))Q.push(q);else{let L=P.split(", "),E=0;for(let B=1;B<L.length;B++){let N=L[B].trim();if(!e1().test(N)){E=0;continue}let M=(L[B-++E]+`, ${N}`).replace(/,\s*,/g,",");L[B-E]=M,L[B]=""}L=L.filter((B)=>B!==""),L.forEach((B)=>{B=B.trim(),B=`${j} (${B})${O}`,Q.push(B)})}}else Q.push(q);let K=new RegExp(J0(q),"i");Y=Y.replace(K,"").replace(/,\s*,/,",").replace(/^,/,"").trim()}let G=[];if(Y!=="")G=Y.replace(/,\s*,/,",").replace(/[;,]\s*$/,"").split(/[,;]/g);if(G.length>0){for(let z=0;z<G.length;z++)G[z]=G[z].trim();Q=G.concat(...Q)}}return Q.map((H)=>H.trim())}fixSplitGroup(J){let Z=J.reverse();return Z.map((Q,Y)=>{if(Y>0&&Z[Y-1].startsWith("+"))return`${Q} ${Z[Y-1]}`;if(!Q.startsWith("+"))return Q}).filter((Q)=>!!Q).reverse()}}class E0 extends h{get parserGroup(){return"Parser/Offense"}get parserType(){return"attack"}async _parse(J,Z,Q){if(!J)return!1;let H=J.replace(/, or/g," or").replace(/, \band\b /g," and ").replace(/\band\b (?![^(]*\)|\()/g,",").split(/\bor\b/g),X=Object.keys(H),G=SBC.actor.itemTypes.feat.find((V)=>V.name==="Multiattack"||V.system.tag==="multiAttack"),z=SBC.actor.itemTypes.class.find((V)=>{return V.system.tag==="monkUnchained"||V.flags.core?.sourceId==="Compendium.pf1.classes.Item.5mQIOIw4hDhlREPo"}),_=SBC.actor.itemTypes.class.find((V)=>{return V.system.tag==="monk"||V.flags.core?.sourceId==="Compendium.pf1.classes.Item.W8dxwZ1CZiwLKsqr"}),q=z?!0:!1,K=z?z:_;console.log("FS| Unchained Monk",z,_,q,K);for(let V=0;V<X.length;V++){let j=this.fixSplitGroup(this.splitText(H[V]));console.log("FS| Attack Group",j,this.splitText(H[V]));for(let P=0;P<j.length;P++)console.log(j[P],P,Z,Q),await this._processAttack(j[P].trim(),P,Z,Q,G,q,K)}return!0}fixSplitGroup(J){let Z=J.reverse();return Z.map((Q,Y)=>{if(Y>0&&Z[Y-1].startsWith("+"))return`${Q} ${Z[Y-1]}`;if(!/^[\d+-]+\//.test(Q))return Q}).filter((Q)=>!!Q).reverse()}async _processAttack(J,Z,Q,Y,H,X,G){console.log("FS| Processing Attack",J,Z,Q,Y,H,X,G);let z=SBC.actor,_={attackName:"",formattedAttackName:"",actions:[],img:"",subType:"weapon",attackNotes:"",effectNotes:[],specialEffects:"",isMasterwork:!1,enhancementBonus:null,isPrimaryAttack:!0,held:"normal",isTouch:!1,isNonlethal:!1,isNatural:!1,isBroken:!1,baseTypes:[],weaponGroups:{standard:[]},material:null,addons:{}},q={numberOfAttacks:1,numberOfIterativeAttacks:0,iterativeFormula:"",attackParts:[],formulaicAttacksCountFormula:"",formulaicAttacksBonusFormula:"",inputAttackModifier:0,calculatedAttackBonus:0,attackAbilityType:"",attackAbilityModifier:0,defaultAttackAbility:"",damage:"",damageAbilityType:"",numberOfDamageDice:0,damageDie:0,damageBonus:0,damageModifier:0,damageParts:[],nonCritParts:[],defaultDamageType:"",damageTypes:new Set,specialDamageType:"",hasSpecialDamageType:!1,weaponSpecial:"-",critRange:20,critMult:2,damageMult:1,attackRangeUnits:"",attackRangeIncrement:"",useOriginalDamage:!1,featAttackBonus:0,featDamageBonus:0,featAttackBonusString:"",featDamageBonusString:"",hasMultiattack:H,isUnchainedMonk:X,flurryClass:G,isFlurryOfBlows:!1,flurryOfBlowsType:null},K,V,j,P={attackName:"",weaponGroups:{value:[],custom:""},isMasterwork:!1,attackAbilityType:"",attackAbilityModifier:0,damageAbilityType:"",damageAbilityMax:null,damageBonus:0,damageMult:1,critRange:20,critMult:2,iterativeFormula:"",damageFormula:"",originalDamageFormula:"",featAttackBonus:0,featDamageBonus:0,featAttackBonusString:"",featDamageBonusString:"",baseMaterial:null,material:null,addons:[]},O={statblockIterativeFormula:"",statblockDamageFormula:"",statblockDamageBonus:0,statblockFullFormula:"",statblockEnhancementBonus:0,itemExists:!1,itemIterativeFormula:"",itemDamageFormula:"",itemDamageBonus:0,itemFullFormula:"",itemEnhancementBonus:0};if(console.log("FS| Input Attack",J),J=this._processFlurryOfBlows(J,_),J=this._processAttackProperties(J,_,Z),this._processEnhancementBonus(J,_,O),[K,V,j]=this._processMaterialsAndAddons(J,_),!j)j="steel",_.baseMaterial="steel";this._processAttackName(J,_,K,V,j,Q);let L=await this._acquireWeapon(_,K);if(!L)L=await this._acquireWeapon(_,K,!1);console.log("FS| Weapon",L);let E=null;if(L){if(!_.isNatural){let M=pf1.documents.item.ItemAttackPF.fromItem(L);E=(await z.createEmbeddedDocuments("Item",[M]))[0]}else E=(await g(L))[1];_.attackName=L.name.replace(/^\+\d/,_.enhancementBonus?`+${_.enhancementBonus}`:"").trim();let N=null;if((N=L.name.match(new RegExp("\\b"+n("actorSizes")[SBC.actor.system.traits.size.base]+"\\b")))!==null)_.attackName=L.name.replace(N[0],"").trim();_.formattedAttackName=_.attackName}console.log("FS| New Attack",E);let B=_.isNatural;if(E)Y=await this._processWeaponDetails(O,_,P,L,E,Y);if(console.log("FS| Weapon Attack Details",P),this._processAttackModifier(J,q,_,Q),this._processNumberOfIterativeAttacks(J,q,_,O),this._processAttackDamage(J,_,q,O),O.itemExists){if(W.log(`FS| Comparing statblock data to attack item:
Iterative Formula: ${O.statblockIterativeFormula} vs ${O.itemIterativeFormula}
Damage Formula: ${O.statblockDamageFormula} vs ${O.itemDamageFormula}
Damage Bonus: ${O.statblockDamageBonus} vs ${O.itemDamageBonus}
Enhancement Bonus: ${O.statblockEnhancementBonus} vs ${O.itemEnhancementBonus}
Full Formula: ${O.statblockFullFormula} vs ${O.itemFullFormula}
`),O.statblockIterativeFormula===O.itemIterativeFormula&&O.statblockDamageFormula===O.itemDamageFormula&&O.statblockDamageBonus===O.itemDamageBonus&&O.statblockEnhancementBonus===O.itemEnhancementBonus&&O.statblockFullFormula===O.itemFullFormula)B=!0}if(O.itemExists&&B&&!_.isNatural){if(!SBC.settings.getSetting("createAttacks"))console.log("FS| Attack already exists and is identical to the statblock. Skipping creation."),await SBC.actor.deleteEmbeddedDocuments("Item",[E?.id].filter((N)=>!!N))}else{if(O.itemExists)Object.assign(q,{attackAbilityType:P.attackAbilityType,attackAbilityModifier:P.attackAbilityModifier,damageAbilityType:P.damageAbilityType,featAttackBonus:P.featAttackBonus,featDamageBonus:P.featDamageBonus,featAttackBonusString:P.featAttackBonusString,featDamageBonusString:P.featDamageBonusString,useOriginalDamage:O.statblockDamageFormula===O.itemDamageFormula}),Object.assign(_,{weaponGroups:P.weaponGroups});switch(Y){case"mwak":this._processMeleeAttackData(E,q,_);break;case"rwak":this._processRangedAttackData(E,q,_,J);break;case"twak":this._processThrownAttackData(E,q,_,J);break;default:if(_.isNatural)this._processNaturalAttackData(E,q,_);break}if(_.attackName.search(/\bSwarm\b/i)!==-1)Y="other";if(J.match(/^\d+/)!==null)q.numberOfAttacks=parseInt(J.match(/(^\d+)/)[1]),_.attackNotes=q.numberOfAttacks+" "+_.attackNotes;if(this._processBaseTypes(E,_,q),!O.itemExists)await this._processFeatBonuses(_,q);this._calculateAttackBonus(q,_);let N=this._calculateDamageBonus(q,_,P);this._processDamageTypes(E,L,_,q),q.damageParts.push({formula:N,types:q.damageTypes});for(let x=1;x<q.numberOfAttacks;x++){let p=x+1+SBC.config.const.suffixMultiples[Math.min(3,x)];q.attackParts.push({formula:"",name:p+" "+_.attackName.replace(/e?s$/,"").capitalize()})}let M=null,T=null;[M,T]=this._prepareNewAttackData(E,M,_,q,Y,T),console.log("FS| New Attack Data",M),console.log("FS| Attack Updates",T);let S=null;S=await this._prepareNewAction(E,S,q,_,Y),console.log("FS| New Action Data",S);let w=await this._createFinalAttack(E,M,S,_,T,Y);if(L&&L.isOwned)console.log(w),L.createItemLink("children",w)}}_processFlurryOfBlows(J,Z){let Q=J.match(/flurry of blows\s*\((.*?)\)/i);if(Q)console.log("FS| Flurry of Blows 0",J),J=J.replace(/flurry of blows\s*\((.*?)\)/i,Q[1]).trim(),Z.isFlurryOfBlows=!0,console.log("FS| Flurry of Blows 1",Q,J);else if(J.search(/flurry of blows/i)!==-1)J=J.replace(/flurry of blows/i,"unarmed strike"),Z.isFlurryOfBlows=!0;return J}_processAttackProperties(J,Z,Q){if(J.search(/\d+\s*.*((?:ranged|melee|\+\d+)?\s+touch)\b\s+\(/i)!==-1){if(Z.isTouch=!0,J=J.replace(/((?:ranged|melee|(\+\d+))?\s+touch)\b/i,"$2"),!/[a-z](?![^(]*\))/i.test(J))Z.attackName="Attack "+(Q+1)}if(J.search(/\d+\s*((?:(?:ranged|melee)\s*)?nonlethal)/i)!==-1){if(Z.isNonlethal=!0,J=J.replace(/((?:(?:ranged|melee)\s*)?nonlethal)/i,""),!/[a-z](?![^(]*\))/i.test(J))Z.attackName="Attack "+(Q+1)}if(J.search(/\bbroken\b/i)!==-1){if(Z.isBroken=!0,!/[a-z](?![^(]*\))/i.test(J))Z.attackName="Attack "+(Q+1)}return J}_processEnhancementBonus(J,Z,Q){let Y=J.match(/(?:\W\+|^\+)(\d+)\s+(?!\(|(?:ranged |melee )?touch)/);if(Y)Z.enhancementBonus=parseInt(Y[1]),Z.attackNotes="+"+Z.enhancementBonus+" "+Z.attackNotes,Q.statblockEnhancementBonus=+Z.enhancementBonus;if(J.match(/\bmwk\b/i)!==null)Z.isMasterwork=!0,Z.attackNotes="mwk "+Z.attackNotes}_processMaterialsAndAddons(J,Z){let Q=[],Y="",H="",X=J.match(a1());if(X)Z.baseMaterial=X[0],H=Z.baseMaterial;let G=J.match(A0());if(G)Z.material=G[0],Y=Z.material,Z.material=pf1.registry.materials.contents.find((_)=>z0(_)===Z.material.capitalize()||_.id===Z.material)?.id??null;let z=J.match(U0());if(z)Q=z,Q.forEach((_,q)=>{Q[q]=pf1.registry.materials.contents.find((K)=>z0(K)===_.capitalize()||K.id===_.toLowerCase().replace(/\s/,""))?.id??null}),Q=Q.filter((_)=>!!_),Z.addons={},Q.forEach((_)=>{_=_.toLowerCase().replace(/\s/,""),Z.addons[_]=_});return[Q,Y,H]}_processAttackName(J,Z,Q,Y,H,X){if(/((?:[+1-5a-zA-Z']| (?=[+1-5a-zA-Z'])|\*)+)[ +0-9(/]+\(*/.test(J)&&!Z.attackName){if(console.log("FS| Attack Name 1",J),Z.attackName=J.match(/((?:[+1-5a-zA-Z'-]| (?=[+1-5a-zA-Z'-])|\*)+)[ +0-9(/]+\(*/)[1].replace(/^ | $|\bmwk\b |\*|\+$/gi,"").replace(/\+[1-5]$/,"").replace(/^\d+/,"").trim().replace(/(^\+[1-5])|(\+[1-5]+$)/g,"").trim().replace(new RegExp(`(?<!Magic\\s)${Y}`,"i"),"").replace(new RegExp(`(?<!Magic\\s)${H}`,"i"),"").replace(new RegExp(`\\b(${Q.join("|")})\\b`),""),(Y.toLowerCase()==="stone"||H.toLowerCase()==="stone")&&Q.includes("magic"))Z.attackName=Z.attackName.replace(/stone/i,"Magic Stone").trim();Z.attackNotes+=Z.attackName+" "}Z.attackName=Z.attackName.trim(),Z.formattedAttackName=Z.attackNotes.trim()}async _acquireWeapon(J,Z,Q=!0){let Y=SBC.compendiumSearch,H=SBC.actor.itemTypes.weapon.find((X)=>{let G=X.flags?.babele?.originalName??X.name.replace(`+${X.system.enh}`,"").replace(pf1.registry.materials.get(X.system.material.normal.value)?.name??"","").replace(/\s{2,}/g," ").replace("Masterwork ","").trim().toLowerCase(),z=J.attackName.toLowerCase(),_=W.stringSimilarity(z,G);if(console.log("Comparing weapon:",G,"item:",z,"similarity:",_),_<0.65){let q=G.replace(`${n("actorSizes")[SBC.actor.system.traits.size.base].toLowerCase()} `,"");if(W.stringSimilarity(z,q)<0.65)return!1}if(console.log("Comparing weapon properties..."),J.isMasterwork&&!X.system.masterwork)return console.log("Masterwork status did not match."),!1;if(J.isBroken&&!X.system.broken)return console.log("Broken status did not match."),!1;if(Q&&J.enhancementBonus&&+J.enhancementBonus!==X.system.enh)return console.log("Enhancement bonus did not match."),!1;if(Z.length>0){let q=X.system.material.addon;for(let K of Z)if(!q.includes(K))return console.log("Addon did not match."),!1}return!0});if(!H){if(G1().test(J.attackName)){J.isNatural=!0,J.subType="natural";let X="";X=J.attackName.match(G1())[0].split(" ").map((z)=>z.capitalize()).join(" ");let G=X.replace(/s$/,"");if(Object.values(SBC.config.naturalAttacks).find((z)=>z===X||z===G))H=await Y.findEntityInCompendia({name:X,altName:X.replace(/s$/,""),item:X},{itemType:"attack"})}}return H}async _processWeaponDetails(J,Z,Q,Y,H,X){if(J.itemExists=!0,Q.attackName=H.name,Q.weaponGroups=Y.system.weaponGroups,!Z.isBroken&&Y.system.broken)Q.isBroken=!0;if(Y.system.material)Q.material=Y.system.material.normal.value,Q.addons=Y.system.material.addon;for(let B of Q.weaponGroups.standard)if(this.app.processData.characterData.weaponGroups[B])Q.featAttackBonus=this.app.processData.characterData.weaponGroups[B],Q.featDamageBonus=this.app.processData.characterData.weaponGroups[B],Q.featAttackBonusString=`${Q.featAttackBonus}[${W.translate("feat.weaponTrainingBonus",{bonus:B})}]`,Q.featDamageBonusString=`${Q.featDamageBonus}[${W.translate("feat.weaponTrainingBonus",{bonus:B})}]`;for(let B of Y.system.baseTypes??[]){B=B.toLowerCase();let N=this._parseWeaponBonuses("attack",B),M=this._parseWeaponBonuses("damage",B);if(N[0])Q.featAttackBonus+=+N[0],Q.featAttackBonusString+=Q.featAttackBonusString.length===0?N[1]:` + ${N[1]}`;if(M[0])Q.featDamageBonus+=+M[0],Q.featDamageBonusString+=Q.featDamageBonusString.length===0?M[1]:` + ${M[1]}`}let G=H.actionTypes.indexOf(X);if(G===-1&&X==="rwak")if(G=H.actionTypes.indexOf("twak"),G!==-1)X="twak";else G=0;else G=0;let z=H.actions.contents[G];Q.attackAbilityType=z.ability.attack,Q.attackAbilityModifier=+W.getModifier(this.app.processData.notes.statistics[Q.attackAbilityType]),Q.damageAbilityType=z.ability.damage,Q.damageAbilityMax=z.ability.max??-100,Q.damageBonus=Q.damageAbilityMax>=0?Math.min(Q.damageAbilityMax,+W.getModifier(this.app.processData.notes.statistics[Q.damageAbilityType])):+W.getModifier(this.app.processData.notes.statistics[Q.damageAbilityType]),Q.damageMult=z.ability.damageMult,Q.critMult=z.ability?.critMult,Q.critRange=z.ability?.critRange;let _=z.getAttacks().map((B)=>B.bonus),q="";_.forEach((B,N)=>{if(isNaN(B))B=0;if(Y.system.masterwork)B++;if(Y.system.masterwork&&Y.system.enh)B--;if(B>-1)q+="+";if(q+=B,N!==_.length-1)q+="/"}),Q.iterativeFormula=q,J.itemIterativeFormula=q;let K=H.getAllDamageSources(z.id),V=Math.floor(Q.damageBonus*Q.damageMult),j="";if(Q.critRange!==20)j+=`/${Q.critRange}-20`;if(Q.critMult!==2)j+=`/x${Q.critMult}`;K.forEach((B)=>{if(B.modifier==="enh")V+=B.value,J.itemEnhancementBonus=B.value;else if(B.flavor==="Broken")V+=B.value;else j+=` plus ${B.formula}`}),J.itemDamageBonus=+V;let P=z.damage.parts[0]?.formula,O=null,L=null,E=SBC.actor.system.traits.size.base;if(P){let B=P.match(/sizeRoll\((?<num>\d+),\s?(?<size>\d+),?.*\)/);if(B){O=B.groups.num,L=B.groups.size,E=Object.keys(pf1.config.sizeChart).indexOf(E);let N=pf1.utils.roll.sizeRoll(+O,+L,+E),M=Roll.fromTerms(N).formula;console.log(`Results for ${H.name}: `,"Real Formula: ",P,"Results: ",B,"Processed Roll: ",N,"Formula: ",M),J.itemDamageFormula=M;let T=V>-1?"+":"";j=`${M} ${T}${V}${j}`,J.itemFullFormula=j,Q.originalDamageFormula=P}}return delete H.img,delete H.subType,delete H.held,X}_processAttackDamage(J,Z,Q,Y){let H=J.match(/\(([^)]*)\)(?=[^(]*$)/);if(H!==null){let X=H[1].match(/(\d+)d(\d+)/);if(X!==null)Q.numberOfDamageDice=parseInt(X[1]),Q.damageDie=parseInt(X[2]),Z.attackNotes+=" ("+Q.numberOfDamageDice+"d"+Q.damageDie,Y.statblockDamageFormula=`${Q.numberOfDamageDice}d${Q.damageDie}`;else if((X=H[1].match(/^(\d+)/))!==null)Q.numberOfDamageDice=1,Q.damageDie=parseInt(X[1]),Z.attackNotes+=" ("+Q.damageDie,Y.statblockDamageFormula=`${Q.damageDie}`;else Q.numberOfDamageDice=0,Q.damageDie=0;let G=J.match(/d\d+(\+\d+|-\d+)/);if(G!==null)Q.damageBonus=parseInt(G[1]),Z.attackNotes+=`${Q.damageBonus>=0?"+":"-"}${Q.damageBonus}`,Y.statblockDamageBonus=+Q.damageBonus;else Q.damageAbilityType="";let z=J.match(/\/(\d+)-\d+/);if(z!==null)Q.critRange=parseInt(z[1]),Z.attackNotes+="/"+Q.critRange+"-20";let _=J.match(/\/x(\d+)/);if(_!==null)Q.critMult=parseInt(_[1]),Z.attackNotes+="/x"+Q.critMult;let q=X?H[0].match(/\(\d+d\d+[+\d/\-x\s]*([^)\n]*)(?:$|\))/):[null,H[1]];if(q!==null){let j=q[1];if(Z.specialEffects=j,j=j.replace(/(\s+\b(?:and|plus)\b\s+)/gi,",").replace(/(^,|,$)/g,"").split(","),j.length>0){for(let P=0;P<j.length;P++){let O=j[P];if(O!=="")Z.effectNotes.push(O)}if(Z.effectNotes.length>0&&Q.damageDie>0)Z.attackNotes+=(Q.damageDie>0?" plus ":"")+Z.effectNotes.join(", ")}}if(Q.damageDie>0)Z.attackNotes+=")";let K="";if(Q.critRange!==20)K+=`/${Q.critRange}-20`;if(Q.critMult!==2)K+=`/x${Q.critMult}`;if(Z.specialEffects)K+=` ${Z.specialEffects}`;let V=Y.statblockDamageBonus>-1?"+":"";Y.statblockFullFormula=`${Y.statblockDamageFormula} ${V}${Y.statblockDamageBonus}${K}`}else if(J.match(/\(([^)]*)\)/)!==null){let X=J.replace(/\s+/g," ").match(/\(([^)]*)\)/)[1];Z.attackNotes+=" ("+X+")",Z.effectNotes.push(X)}else W.log("Kind of embarrassing, but this should never happen.")}_processNumberOfIterativeAttacks(J,Z,Q,Y){let H=J.match(/(\/\+\d+)/);if(H!==null){Z.numberOfIterativeAttacks=H.length;for(let X=Z.numberOfIterativeAttacks;X>1;X--){let G=+Z.numberOfIterativeAttacks+1-X,z=+Z.inputAttackModifier-5*G>-1?`/+${+Z.inputAttackModifier-5*G}`:`/${+Z.inputAttackModifier-5*G}`;Z.iterativeFormula+=z,Q.attackNotes+=z}}Y.statblockIterativeFormula=Z.iterativeFormula}_processAttackModifier(J,Z,Q,Y){if(J.match(/(\+\d+|-\d+)[+0-9/ ]*\(*/)!==null){if(J.match(/(?!^)(\+\d+|-\d+)[+0-9/ ]*\(+/)!==null)Z.inputAttackModifier=parseInt(J.match(/(?!^)(\+\d+|-\d+)[+0-9/ ]*\(+/)[1]);else if(J.match(/(?!^)(\+\d+|-\d+)[+0-9/ ]*/)!==null)Z.inputAttackModifier=parseInt(J.match(/(?!^)(\+\d+|-\d+)[+0-9/ ]*/)[1]);else{let H="Failed to find a usable attack modifier",X=new f(f.ERRORLEVELS.ERROR,"Parse/Offense",H,Y);this.app.processData.errors.push(X)}Z.iterativeFormula=`${Z.inputAttackModifier>0?"+":""}`+Z.inputAttackModifier,Q.attackNotes+=Z.inputAttackModifier}}_processMeleeAttackData(J,Z,Q){if(!J)Q.img="systems/pf1/icons/items/weapons/elven-curve-blade.PNG",Z.damageAbilityType="str",Z.attackRangeUnits="melee";if(!this.app.processData.flags.noStr){if(Z.attackAbilityModifier=+W.getModifier(this.app.processData.notes.statistics.str),!J)Z.attackAbilityType=SBC.actor.system.attributes?.attack?.meleeAbility||"str"}else if(!J)Z.attackAbilityType="dex",Z.attackAbilityModifier=+W.getModifier(this.app.processData.notes.statistics.dex);if(this.app.processData.flags.hasWeaponFinesse)Z.attackAbilityModifier=+W.getModifier(this.app.processData.notes.statistics.dex),Z.attackAbilityType="dex"}_processRangedAttackData(J,Z,Q,Y){if(!J)Q.img="systems/pf1/icons/items/weapons/thorn-bow.PNG";if(!this.app.processData.flags.noDex){if(Z.attackAbilityModifier=+W.getModifier(this.app.processData.notes.statistics.dex),Z.attackAbilityType=SBC.actor.system.attributes?.attack?.rangedAbility||"dex",!J){if(Y.search(/(bow\b)/i)!==-1&&Y.search(/\bcomposite\b/i)===-1)Z.damageAbilityType="";else Z.damageAbilityType="str";Z.attackRangeUnits="ft",Z.attackRangeIncrement="5"}}}_processThrownAttackData(J,Z,Q,Y){if(!J)Q.img="systems/pf1/icons/items/weapons/thorn-bow.PNG";if(!this.app.processData.flags.noDex){if(Z.attackAbilityModifier=+W.getModifier(this.app.processData.notes.statistics.dex),Z.attackAbilityType=SBC.actor.system.attributes?.attack?.rangedAbility||"dex",Z.damageAbilityType="str",Z.damageMult=1,!J){if(Y.search(/(bow\b)/i)!==-1&&Y.search(/\bcomposite\b/i)===-1)Z.damageAbilityType="";else Z.damageAbilityType="str";Z.attackRangeUnits="ft",Z.attackRangeIncrement="5"}}}_processNaturalAttackData(J,Z,Q){let Y=Q.attackName.match(G1())[0];if(Object.keys(R0).find((H)=>H===Y)){let H=R0[Y.replace(/s$/,"").toLowerCase()];Q.subType="natural",Q.isPrimaryAttack=H.isPrimaryAttack,Q.img=H.img}}_processBaseTypes(J,Z,Q){if(J&&J.type!=="attack")Z.baseTypes=J.system.baseTypes;else Z.baseTypes=[Z.formattedAttackName.replace(/(^\+[1-5])|(\+[1-5]$)/g,"").trim()];if(Z.isNatural)Z.baseTypes.push("natural")}async _processFeatBonuses(J,Z){for(let Q of J.weaponGroups.standard)if(this.app.processData.characterData.weaponGroups[Q])Z.featAttackBonus=this.app.processData.characterData.weaponGroups[Q],Z.featDamageBonus=this.app.processData.characterData.weaponGroups[Q],Z.featAttackBonusString=`${Z.featAttackBonus}[${W.translate("feat.weaponTrainingBonus",{bonus:Q})}]`,Z.featDamageBonusString=`${Z.featDamageBonus}[${W.translate("feat.weaponTrainingBonus",{bonus:Q})}]`;for(let Q of J.baseTypes??[]){let Y=this._parseWeaponBonuses("attack",Q.toLowerCase()),H=this._parseWeaponBonuses("damage",Q.toLowerCase());if(Y[0])Z.featAttackBonus+=Y[0],Z.featAttackBonusString+=Y[1];if(H[0])Z.featDamageBonus+=H[0],Z.featDamageBonusString+=H[1]}}_calculateAttackBonus(J,Z){let Q=+this.app.processData.characterData.conversionValidation.attributes.bab;if(Z.isFlurryOfBlows)if(Q+=+J.flurryClass.system.level-+J.flurryClass.system.babBase,J.isUnchainedMonk)J.flurryOfBlowsType="unflurry";else J.flurryOfBlowsType="flurry",Q-=2;let Y=Q+ +pf1.config.sizeMods[SBC.actor.system.traits.size.base]+ +J.attackAbilityModifier+ +J.featAttackBonus+(Z.isBroken?-2:0);if(Z.isMasterwork)Y++;else if(Z.enhancementBonus>0)Y+=+Z.enhancementBonus;let H=J.hasMultiattack?2:5;if(Z.isNatural&&Y-J.inputAttackModifier===H)Z.isPrimaryAttack=!1;if(!Z.isPrimaryAttack)Y-=5;if(+Y!==+J.inputAttackModifier)J.calculatedAttackBonus=+J.inputAttackModifier-+Y}_calculateDamageBonus(J,Z,Q){let Y=0;if(J.damageAbilityType==="str")Y=Q.damageAbilityMax>=0?Math.min(Q.damageAbilityMax,+W.getModifier(this.app.processData.notes.statistics.str)):+W.getModifier(this.app.processData.notes.statistics.str);let H=+Y+ +Z.enhancementBonus+ +J.featDamageBonus+(Z.isBroken?-2:0);if(+J.damageBonus-+H===Math.floor(Y/2)&&Y>0)H+=Math.floor(Y/2),J.damageMult=1.5,Z.held="2h";else if(+J.damageBonus-+H===-Math.ceil(Y/2)&&Y>0)H-=Math.ceil(Y/2),J.damageMult=0.5,Z.held="oh";J.damageModifier=+J.damageBonus-+H;let G;if(!J.useOriginalDamage){if(G=`sizeRoll(${J.numberOfDamageDice}, ${J.damageDie}, @size, ${SBC.actor.system.traits.size.value})`,J.featDamageBonusString&&!SBC.settings.getSetting("rollBonusesIntegration"))G+=" + "+J.featDamageBonusString}else if(G=Q.originalDamageFormula,Q.featDamageBonus&&!SBC.settings.getSetting("rollBonusesIntegration"))G+=" + "+Q.featDamageBonusString;if(J.damageModifier!==0)if(J.damageModifier>0)G+=" + "+J.damageModifier+"[adjusted by sbc]";else G+=+J.damageModifier+"[adjusted by sbc]";return G=G.replace(/\+ \+/g,"+ ").replace(/\s\s/," "),G}_processDamageTypes(J,Z,Q,Y){if(J){let H=J.actions.contents[0]?.damage?.parts[0]?.types;if(H?.first())H.forEach((G)=>{Y.damageTypes.add(G)});Object.keys(Z?.system.properties??{}).forEach((G)=>{if(Z?.system?.properties?.[G])Q.attackNotes+=`, ${pf1.config.weaponProperties[G]}`})}else{if(Q.isNonlethal)Y.damageTypes.add("nonlethal");Y.damageTypes.add("untyped")}for(let H=0;H<Q.effectNotes.length;H++){let X=Q.effectNotes[H].replaceAll(" energy","").trim(),G=Object.values(pf1.registry.damageTypes.getLabels()).map((_)=>_.toLowerCase()),z=new RegExp("\\b("+G.join("|")+")\\b","gi");if(X.match(/\d+d\d+/)===null){let _=X.match(z);if(_){let q=_[0].replace("electricity","electric").trim();Q.effectNotes.splice(H,1),Y.damageTypes=new Set(q)}}else{let _=X.match(/(\d+d\d+\s*\+*\s*\d*)/)[0],q=X.replace(_,"").replace("plus","").trim();if(q!==""){let K=X.match(z);if(K)q=K[0].replace("electricity","electric").trim()}else q="untyped";Y.nonCritParts.push({formula:_,types:new Set([q])}),Q.effectNotes.splice(H,1)}}}_prepareNewAttackData(J,Z,Q,Y,H,X){let G=Q.isFlurryOfBlows?Y.flurryClass.system.tag:null;if(!J)Z=new Item.implementation({name:W.capitalize(Q.formattedAttackName)||"Undefined",type:"attack",img:Q.img,system:{attackNotes:this.splitText(Q.attackNotes).slice(1),effectNotes:Q.effectNotes,masterwork:Q.isMasterwork||(Q.enhancementBonus??0)>0,broken:Q.isBroken,enh:+Q.enhancementBonus,proficient:!0,held:Q.held,showInQuickbar:!0,subType:Q.subType,identifiedName:W.capitalize(Q.formattedAttackName)||"Undefined",baseTypes:Q.baseTypes,material:{base:{value:Q.baseMaterial},normal:{value:Q.material},addon:Object.keys(Q.addons)},class:G}}),Z.prepareData();else X={_id:J.id,"system.enh":+Q.enhancementBonus,"system.masterwork":Q.isMasterwork||(Q.enhancementBonus??0)>0,"system.held":Q.held,"system.attackNotes":this.splitText(Q.attackNotes).slice(1),"system.effectNotes":Q.effectNotes,"system.broken":Q.isBroken,name:W.capitalize(Q.formattedAttackName)||"Undefined","system.material.base.value":Q.baseMaterial,"system.material.normal.value":Q.material,"system.material.addon":Object.keys(Q.addons),"system.class":G},Z=J;return[Z,X]}async _prepareNewAction(J,Z,Q,Y,H){let X=Q.calculatedAttackBonus!==0?Y.isNatural&&Q.hasMultiattack&&Q.calculatedAttackBonus===3?null:Q.calculatedAttackBonus.toString()+"[adjusted by sbc]":null;if(Q.featAttackBonusString&&!SBC.settings.getSetting("rollBonusesIntegration"))X=X?`${X} + ${Q.featAttackBonusString}`:Q.featAttackBonusString;if(X)X=X.replace(/\+(\s+\+)+/g,"+ ").replace(/\s+/g," ").replace(/^\+\s+/,"").replace(/\s+\+$/,"");let G=Y.isFlurryOfBlows?Q.flurryOfBlowsType:Q.attackParts.length>0&&Q.numberOfIterativeAttacks>0?"advanced":Q.numberOfIterativeAttacks>0&&Q.attackParts.length===0?"standard":"custom",z=Y.isFlurryOfBlows?Q.flurryOfBlowsType==="flurry"?(+this.app.processData.characterData.conversionValidation.attributes.bab+(Q.flurryClass.system.level-Q.flurryClass.system.babBase)).toString():null:null;if(!J)Z={...new pf1.components.ItemAction().toObject(void 0,!1),name:Y.attackName.capitalize(),img:Y.img,activation:{cost:1,type:"attack"},bab:z,unchainedAction:{activation:{cost:1,type:"attack"}},range:{value:Q.attackRangeIncrement,units:Q.attackRangeUnits,maxIncrements:1},attackName:Y.attackName.replace(/((?!Blows|blows)e?s)$/,"").capitalize(),actionType:H,attackBonus:X,critConfirmBonus:"",damage:{critParts:[],nonCritParts:Q.nonCritParts,parts:Q.damageParts},extraAttacks:{type:G,manual:Q.attackParts},formulaicAttacks:{count:{formula:Q.formulaicAttacksCountFormula},bonus:{formula:"@formulaicAttack * -5"}},ability:{attack:Q.attackAbilityType,damage:Q.damageAbilityType,damageMult:Q.damageMult,critRange:Q.critRange,critMult:Q.critMult},naturalAttack:{primaryAttack:Y.isPrimaryAttack,["secondary.attackBonus"]:Q.hasMultiattack?"-2":"-5",["secondary.damageMult"]:Q.damageMult&&Y.isNatural?Q.damageMult:0.5},nonlethal:Y.isNonlethal,touch:Y.isTouch};else{let _=J.actionTypes.indexOf(H);if(_===-1&&H==="rwak")if(_=J.actionTypes.indexOf("twak"),_!==-1)H="twak";else _=0;else _=0;let q=J.actions.get(J.actions.contents[_].id),K={attackBonus:X,damage:{critParts:[],nonCritParts:Q.nonCritParts,parts:Q.damageParts},["extraAttacks.type"]:G,["extraAttacks.manual"]:Q.attackParts,["ability.attack"]:Q.attackAbilityType,["ability.critRange"]:Q.critRange,["ability.critMult"]:Q.critMult,["ability.damageMult"]:Q.damageMult,nonlethal:Y.isNonlethal,touch:Y.isTouch,bab:z,actionType:H};if(J.system.subType==="natural")K["naturalAttack.primaryAttack"]=Y.isPrimaryAttack,K["naturalAttack.secondary.attackBonus"]=Q.hasMultiattack?"-2":"-5",K["naturalAttack.secondary.damageMult"]=Q.damageMult&&Y.isNatural?Q.damageMult:0.5;await q.update(K)}return Z}async _createFinalAttack(J,Z,Q,Y,H,X){let G=(J?J.name:Z.name).toLowerCase(),z=J?J.id:Z.id;console.log(`Looking for existing attack with name ${G} and id ${z}`);let _=SBC.actor.itemTypes.attack.find((K)=>K.name.toLowerCase()===G&&K.id!==z),q=_;if(_){let K={enh:J?H["system.enh"]??J.system.enh:Y.enhancementBonus,masterwork:J?H["system.masterwork"]??J.system.masterwork:Y.isMasterwork,broken:J?H["system.broken"]??J.system.broken:Y.isBroken};if(!K.enh)K.enh=0;if(_.system.enh===K.enh&&_.system.masterwork===K.masterwork&&_.system.broken===K.broken){let V=new Set(_.system.attackNotes.concat(this.splitText(Y.attackNotes).slice(1))),j=new Set(_.system.effectNotes.concat(Y.effectNotes));await SBC.actor.updateEmbeddedDocuments("Item",[{_id:_.id,"system.attackNotes":Array.from(V),"system.effectNotes":Array.from(j)}]);let P=_.actionTypes.indexOf(X);if(P===-1&&X==="rwak"){if(P=_.actionTypes.indexOf("twak"),P!==-1)X="twak"}let O=J?J.actions.contents[0]:Q,L=pf1.utils.deepClone(O);if(L){if(Y.isFlurryOfBlows)L.name="Flurry of Blows";if(!Y.isPrimaryAttack&&Y.isNatural)L.name+=" (Secondary)";else if(L.name!=="Attack"){if(X==="mwak")L.name="Melee";else if(X==="rwak")L.name="Ranged";else if(X==="twak")L.name="Thrown"}else if(X==="mwak")L.name+=" (Melee)";else if(X==="rwak")L.name+=" (Ranged)";else if(X==="twak")L.name+=" (Thrown)";delete L._id}else{if(Y.isFlurryOfBlows)L.name="Flurry of Blows";if(!Y.isPrimaryAttack&&Y.isNatural)L.name+=" (Secondary)";else if(L.name!=="Attack"){if(X==="mwak")L.name="Melee";else if(X==="rwak")L.name="Ranged";else if(X==="twak")L.name="Thrown"}else if(X==="mwak")L.name+=" (Melee)";else if(X==="rwak")L.name+=" (Ranged)";else if(X==="twak")L.name+=" (Thrown)";delete L._id}await pf1.components.ItemAction.create([L],{parent:_});let E=[],B=_.toObject().system.actions;for(let N=0;N<B.length;N++)if(N!==P)E.push(B[N]);if(await _.update({"system.actions":E}),H?.["system.class"])await _.update({"system.class":H["system.class"]});if(J)await SBC.actor.deleteEmbeddedDocuments("Item",[J.id])}}else if(!J)await Z.updateSource({"system.actions":[Q]}),Z.prepareData(),q=(await g(Z))[1];else await SBC.actor.updateEmbeddedDocuments("Item",[H]),Z.prepareData(),q=Z;return q}_parseWeaponBonuses(J,Z){let Q=0,Y="",H=this.app.processData.characterData;switch(J){case"attack":if(H.weaponFocus.includes(Z))Q++,Y+=`+ 1[${W.translate("feat.weaponFocus")}]`;if(H.weaponFocusGreater.includes(Z))Q++,Y+=`+ 1[${W.translate("feat.greaterWeaponFocus")}]`;if(Object.values(H.weaponGroups).includes(Z))Q+=H.weaponGroups[Z],Y+=`+ 1[${W.translate("feat.weaponTrainingBonus",{bonus:Z})}]`;break;case"damage":if(H.weaponSpecialization.includes(Z))Q+=2,Y+=`+ 2[${W.translate("feat.weaponSpecialization")}]`;if(H.weaponSpecializationGreater.includes(Z))Q+=2,Y+=`+ 2[${W.translate("feat.greaterWeaponSpecialization")}]`;if(Object.values(H.weaponGroups).includes(Z))Q+=H.weaponGroups[Z],Y+=`+ 1[${W.translate("feat.weaponTrainingBonus",{bonus:Z})}]`;break;default:break}return[Q,Y]}static reverseCritRange(J){return{19:20,17:19,15:18}[+J]}}class m{static flagKey="ckl-roll-bonuses";static allTargets=["armorFocus","improvedArmorFocus","elementalFocus","greaterElementalFocus","mythicElementalFocus","furiousFocus","martialFocus","snakeSidewind","spellFocus","greaterSpellFocus","mythicSpellFocus","spellSpecialization","vitalStrike","improvedVitalStrike","greaterVitalStrike","weaponFocus","weaponSpecialization","greaterWeaponFocus","greaterWeaponSpecialization","mythicWeaponFocus","fighterWeaponTraining","versatilePerformance","improvedCritical","ammunition"];static flagSetup={armorFocus:{boolean:"armor-focus",module:"armor-focus"},improvedArmorFocus:{boolean:"armor-focus-improved",module:"armor-focus-improved"},weaponFocus:{boolean:"weapon-focus",module:"weapon-focus"},greaterWeaponFocus:{boolean:"weapon-focus-greater",module:"weapon-focus-greater"},mythicWeaponFocus:{boolean:"weapon-focus-mythic",module:"weapon-focus-mythic"},weaponSpecialization:{boolean:"weapon-specialization",module:"weapon-specialization"},greaterWeaponSpecialization:{boolean:"weapon-specialization-greater",module:"weapon-specialization-greater"},martialFocus:{boolean:"martial-focus",module:"martial-focus"},elementalFocus:{boolean:"elemental-focus",module:"elemental-focus"},spellFocus:{boolean:"spell-focus",module:"spell-focus"},greaterSpellFocus:{boolean:"spell-focus-greater",module:"spell-focus-greater"},mythicSpellFocus:{boolean:"spell-focus-mythic",module:"spell-focus-mythic"},spellSpecialization:{boolean:"spell-specialization",module:"spell-specialization"},furiousFocus:{boolean:"furious-focus",module:"furious-focus"},snakeSidewind:{boolean:"snake-sidewind",module:"snake-sidewind"},vitalStrike:{boolean:"vital-strike",module:"vital-strike"},improvedVitalStrike:{boolean:"vital-strike-improved",module:"vital-strike-improved"},greaterVitalStrike:{boolean:"vital-strike-greater",module:"vital-strike-greater"},mythicVitalStrike:{boolean:"vital-strike-mythic",module:"vital-strike-mythic"},devastatingStrike:{boolean:"devastating-strike",module:"devastating-strike"},improvedDevastatingStrike:{boolean:"devastating-strike-improved",module:"devastating-strike-improved"},versatilePerformance:{boolean:"versatile-performance",module:"versatile-performance"}};static targets=[];static addTarget(J){if(!m.targets.includes(J))m.targets.push(J)}static versatilePerformanceOptions={act:["blf","dis"],comedy:["blf","int"],dance:["acr","fly"],keyboard:["dip","int"],oratory:["blf","sen"],percussion:["han","int"],sing:["blf","sen"],string:["blf","dip"],wind:["dip","han"]};static favoredEnemyPlurals={aberrations:"aberration",animals:"animal",constructs:"construct",dragons:"dragon",humanoids:"humanoid","magical beasts":"magical beast","monstrous humanoids":"monstrous humanoid",oozes:"ooze",outsiders:"outsider",plants:"plant",dwarves:"dwarf",elves:"elf",giants:"giant",goblinoids:"goblinoid",gnolls:"gnoll",gnomes:"gnome",halfings:"halfling",humans:"human",orcs:"orc",reptilians:"reptilian"};static async processTargets(J){for(let Z of J)if(Z.subType==="feat"){let Q=W.parseSubtext(Z.name)[1];if(Z.name.match(/^(?!.*Greater|Mythic).*Weapon Focus/i))await m.addSpecificBonus(Z,"weaponFocus",Q);else if(Z.name.match(/^(?!.*Greater).*Weapon Focus/i))await m.addSpecificBonus(Z,"mythicWeaponFocus",Q);else if(Z.name.match(/Weapon Focus/i))await m.addSpecificBonus(Z,"greaterWeaponFocus",Q);else if(Z.name.match(/^(?!.*Greater).*Weapon Specialization/i))await m.addSpecificBonus(Z,"weaponSpecialization",Q);else if(Z.name.match(/Weapon Specialization/i))await m.addSpecificBonus(Z,"greaterWeaponSpecialization",Q);else if(Z.name.match(/^(?!.*Improved).*Armor Focus/i))await m.addSpecificBonus(Z,"armorFocus",Q);else if(Z.name.match(/Armor Focus/i))await m.addSpecificBonus(Z,"improvedArmorFocus",Q);else if(Z.name.match(/^(?!.*Greater|Mythic).*Elemental Focus/i))await m.addSpecificBonus(Z,"elementalFocus",Q);else if(Z.name.match(/^(?!.*Greater).*Elemental Focus/i))await m.addSpecificBonus(Z,"mythicElementalFocus",Q);else if(Z.name.match(/Elemental Focus/i))await m.addSpecificBonus(Z,"greaterElementalFocus",Q);else if(Z.name.match(/Martial Focus/i))await m.addSpecificBonus(Z,"martialFocus",Q);else if(Z.name.match(/^(?!.*Greater|Mythic).*Spell Focus/i))await m.addSpecificBonus(Z,"spellFocus",Q);else if(Z.name.match(/^(?!.*Greater).*Spell Focus/i))await m.addSpecificBonus(Z,"mythicSpellFocus",Q);else if(Z.name.match(/Spell Focus/i))await m.addSpecificBonus(Z,"greaterSpellFocus",Q);else if(Z.name.match(/^(?!.*Greater).*Spell Specialization/i))await m.addSpecificBonus(Z,"spellSpecialization",Q);else if(Z.name.match(/Furious Focus/i))await m.addSpecificBoolean(Z,"furiousFocus");else if(Z.name.match(/Snake Sidewind/i))await m.addSpecificBoolean(Z,"snakeSidewind");else if(Z.name.match(/Improved Critical/i))await m.addImprovedCritical(Z,Q);else if(Z.name.match(/^(?!.*Greater|Improved|Mythic).*Vital Strike/i))await m.addSpecificBoolean(Z,"vitalStrike");else if(Z.name.match(/^(?!.*Greater|Mythic).*Vital Strike/i))await m.addSpecificBoolean(Z,"improvedVitalStrike");else if(Z.name.match(/^(?!.*Mythic).*Vital Strike/i))await m.addSpecificBoolean(Z,"greaterVitalStrike");else if(Z.name.match(/Vital Strike/i))await m.addSpecificBoolean(Z,"mythicVitalStrike");else if(Z.name.match(/^(?!.*Improved).*Devastating Strike/i))await m.addSpecificBoolean(Z,"devastatingStrike");else if(Z.name.match(/Devastating Strike/i))await m.addSpecificBoolean(Z,"improvedDevastatingStrike")}else if(Z.subType==="classFeat"){let Q=W.parseSubtext(Z.name)[1];if(Z.name.match(/Versatile Performance/i)&&Q)await m.addVersatilePerformance(Z,Q.toLowerCase());else if(Z.name.match(/Weapon Training/i)&&Q)await m.addWeaponTraining(Z,Q);else if(Z.name.match(/Favored Enemy/i)&&Q)await m.addFavoredEnemy(Z,Q);else if(Z.name.match(/Favored Terrain/i)&&Q);}else if(Z.system.subType==="ammo")await m.addAmmoProperties(Z)}static async addAmmoProperties(J){let Z={},Q=J.name.toLowerCase(),[Y,H]=W.extractCreatureTypeInfo(Q),X=[];if(J.name.match(/bane/i))Object.assign(Z,{"ammo-bane-creature-type":[Y],"ammo-bane-creature-subtype":H?[H]:[]});let z=Q.match(/\+[12345]/)?.[0]||0;if(z)Object.assign(Z,{"ammo-enhancement":`${z.replace("+","")}`});if(Q.match(/flaming/i)){if(X.push({formula:"1d6[Flaming]",types:["fire"],crit:"nonCrit"}),Q.match(/flaming burst/i))X.push({formula:"1d10[Flaming Burst]",types:["fire"],crit:"crit"})}if(Q.match(/frost/i)){if(X.push({formula:"1d6[Frost]",types:["cold"],crit:"nonCrit"}),Q.match(/icy burst/i))X.push({formula:"1d10[Icy Burst]",types:["cold"],crit:"crit"})}if(Q.match(/shock/i)){if(X.push({formula:"1d6[Shock]",types:["electricit"],crit:"nonCrit"}),Q.match(/shocking burst/i))X.push({formula:"1d10[Shocking Burst]",types:["electricit"],crit:"crit"})}if(Q.match(/corrosive/i)){if(X.push({formula:"1d6[Corrosive]",types:["acid"],crit:"nonCrit"}),Q.match(/corrosive burst/i))X.push({formula:"1d10[Corrosive Burst]",types:["acid"],crit:"crit"})}if(X.length>0)Object.assign(Z,{"ammo-damage":X});await J.update({flags:{[m.flagKey]:Z}})}static async addSpecificBonus(J,Z,Q){try{if(m.allTargets.includes(Z)){if(!Q){console.warn(`SBC: ${Z} doesn not have a valid target.`);return}await J.addItemBooleanFlag(m.flagSetup[Z].boolean),await J.setFlag(m.flagKey,m.flagSetup[Z].module,Q)}else console.warn(`SBC: ${Z} is not a valid bonus.`)}catch(Y){console.log(Y)}}static async addSpecificBoolean(J,Z){if(m.allTargets.includes(Z))await J.addItemBooleanFlag(m.flagSetup[Z].boolean);else console.warn(`SBC: ${Z} is not a valid bonus.`)}static async addImprovedCritical(J,Z){if(!Z){console.warn("SBC: Improved Critical does not have a valid target.");return}await J.update({system:{flags:{boolean:{bonus_crit:!0,"target_weapon-type":!0}}},flags:{[m.flagKey]:{"bonus_crit-keen":!0,"target_weapon-type":[Z]}}});let Q=J.actor.itemTypes.attack.filter((H)=>H.system.baseTypes.includes(Z)),Y=[];for(let H of Q){let G=H.toObject().system.actions??[];G.forEach((z)=>setProperty(z,"ability.critRange",E0.reverseCritRange(z.ability.critRange))),Y.push({_id:H.id,"system.actions":G})}await J.actor.updateEmbeddedDocuments("Item",Y)}static async addVersatilePerformance(J,Z){if(!Z){console.warn("SBC: Versatile Performance doesn not have a valid target.");return}let Q=m.versatilePerformanceOptions[Z];if(Q){let Y=J.actor,H=Y.allSkills.find((X)=>X.startsWith("prf.")&&Y.getSkillInfo(X).name.toLowerCase()===Z.toLowerCase());if(!H){console.warn(`SBC: Perform (${Z}) skill could not be found.`);return}await J.addItemBooleanFlag(m.flagSetup.versatilePerformance.boolean),await J.setFlag(m.flagKey,m.flagSetup.versatilePerformance.module,[{base:H,choice1:Q[0],choice2:Q[1],expanded:""}])}}static async addWeaponTraining(J,Z){if(!Z){console.warn("SBC: Weapon Training doesn not have a valid target.");return}let Q=Z.match(/\+(\d+)/)[1],Y=Z.match(/(.*)\s\+\d+/)[1].toLowerCase().replace("heavy blades","bladesHeavy").replace("light blades","bladesLight");await J.update({system:{flags:{boolean:{bonus_attack:!0,bonus_damage:!0,"target_weapon-group":!0}}},flags:{[m.flagKey]:{bonus_attack:Q,"bonus_attack-type":"untyped",bonus_damage:[],"bonus_damage-change":[{formula:Q,type:"untyped"}],"target_weapon-group":[Y]}}})}static async addFavoredEnemy(J,Z){if(!Z){console.warn("SBC: Weapon Training doesn not have a valid target.");return}let[Q,Y]=Z.split("+").map((G)=>G.trim());Q=Q.toLowerCase();for(let[G,z]of Object.entries(m.favoredEnemyPlurals))if(Q.includes(G)){Q=Q.replace(G,z);break}let[H,X]=W.extractCreatureTypeInfo(Q);await J.update({system:{flags:{boolean:{bonus_attack:!0,bonus_damage:!0,"target_creature-type":!0,"target_creature-subtype":!0}}},flags:{[m.flagKey]:{bonus_attack:Y,"bonus_attack-type":"untyped",bonus_damage:[],"bonus_damage-change":[{formula:Y,type:"untyped"}],"target_creature-type":[H],"target_creature-subtype":X?[X]:[],target_toggle:"all"}}})}}class f{static ERRORLEVELS=Object.freeze({FATAL:Symbol("0"),ERROR:Symbol("1"),WARNING:Symbol("2"),INFO:Symbol("3")});static levels={[f.ERRORLEVELS.FATAL]:"FATAL",[f.ERRORLEVELS.ERROR]:"ERROR",[f.ERRORLEVELS.WARNING]:"WARNING",[f.ERRORLEVELS.INFO]:"INFO"};constructor(J=f.ERRORLEVELS.FATAL,Z="Default Error Keyword",Q="Default Error Message",Y=-1,H=void 0){this.level=J,this.keyword=Z,this.message=Q,this.line=Y,this.value=H}get errorLabel(){return f.levels[this.level]}}class I0 extends h{async parse(J,Z,Q,Y=null,H=null,X=!0){let G=SBC.compendiumSearch;W.log(W.translate("parser.entity.status",{value:J,pack:Q}));let z=[];try{let _=[];if(typeof Q==="string")_.push("pf1."+Q);else Q.forEach((K)=>{_.push("pf1."+K)});let q=this.splitText(J,X);q=this.fixSplitGroup(q);for(let K=0;K<q.length;K++){let V=q[K].trim().replaceAll(/\*/g,"").trim(),j=B0().exec(V);if(j)if(V=V.replace(` ${j[0]}`,""),V.indexOf("("))V=V.replace("(",`(${j[0]}, `).replace(/,\s\)/g,")");else V+=` (${j[0]})`;if(/(?!\()\)$/.test(V))V=V.replace(/\)$/,"");if(/\((?!\))/.test(V))V+=")";if(V=V.replace(/\[/g,"(").replace(/]/g,")").replaceAll(/,\s+,/g,","),/sneak attack \+\d+d\d+ plus \d+ bleed/i.test(V))V=V.replace(/ plus \d+ bleed/i,"");let P=V.split(/\s/);if(console.log(`Looking at ${V}.`),/\+?\d+(d\d+)?/.test(P[P.length-1]))P.splice(P.length-1,1);if(Y==="feat")if(V.replace(/B$/,""),V.endsWith("M")){V=V.substring(0,V.length-1);let I=`${V} (Mythic)`;if(!q.find((r)=>r===I))q.push(I);if(q.slice(0,Math.max(0,K-1)).find((r)=>r===V))continue}else{let I=V.match(/(.*)M \((.*)\)/);if(I){V=`${I[1]} (${I[2]})`;let r=`${I[1]} (Mythic) (${I[2]})`;if(!q.find((u)=>u===r))q.push(r);if(q.slice(0,Math.max(0,K-1)).find((u)=>u===I[1]))continue}}let O=W.parseSubtext(`${V.replace(/\+*\d+$/g,"").trim()}`)[0].replace(/(\d+[ -]ft\.$)/i,"").trim(),L=`${P.join(" ").trim()}`,E=`${V.match(/\((.*)\)/)?V.match(/\((.*)\)/)[1]:""}`;if(j)L=L.replace(j[0],"").replace(/,\s*/,"").trim(),E=E.replace(j[0],"").replace(/,\s*/,"").trim();let B=E.replace(/(\+?\d+?)$/,"").trim().replace(/^(.*?action;)/i,"").trim();if(E.match(/^Mythic\) \(/i))O+=" (Mythic)";let N={search:new Set,type:Q,item:V};if(N.search=W.createSearchSet([B,E,L,V,O],!0),/channel\s*(positive|negative)\s*energy/i.test(V))N.search.add("channel energy");let M=null;if(typeof Y!=="string"){if(M=await G.findEntityInCompendia(N,{itemTypes:Y,itemSubTypes:Array.isArray(H)?H:[H],classes:this.app.processData.characterData.classes,race:this.app.processData.characterData.race}),!M)M=await G.findEntityInCompendia(N,{itemTypes:Y,itemSubTypes:["classFeat","misc"],classes:this.app.processData.characterData.classes,race:this.app.processData.characterData.race})}else M=await G.findEntityInCompendia(N,{itemType:Y,itemSubTypes:Array.isArray(H)?H:[H],classes:this.app.processData.characterData.classes,race:this.app.processData.characterData.race});let T=(M?.name||V).capitalize(),S=W.parseSubtext(V),w=S[0],x=S[1]?.replace(/^(.*?action;)/i,"").trim(),p=x?.replace(/(\+?\d+?)$/,"").trim(),b=S[1]?.match(/(?:^|,)\s*(\d+)\s*(?:,|$)/);if(b)b=b[1];else b=1;if(M!==null){if(!x)await M.updateSource({name:W.capitalize(V)});else if(x&&new RegExp(`(^${J0(x)}|^${J0(p)})`,"i").test(M.name)===!1||O==="weapon training")await M.updateSource({name:W.capitalize(w+(x?` (${x})`:""))});else if(x&&M.name!==W.capitalize(x)&&M.name!==W.capitalize(p))await M.updateSource({name:W.capitalize(V.trim())});if(/\*$/g.test(V))await M.updateSource({name:M.name+"*"});await W.addAssociatedClass(M,SBC.actor.itemTypes.class)}else{if(typeof Q==="object")switch(Q[0]){case"monster-abilities":Object.assign(N,{name:W.translate("parser.entity.placeholderSpecialAbilityName",{input:V}),type:"misc",desc:W.translate("parser.entity.placeholderSpecialAbilityDescription")});break;case"special-attacks":Object.assign(N,{name:W.translate("parser.entity.placeholderSpecialAttackName",{input:V}),type:"attack",desc:W.translate("parser.entity.placeholderSpecialAttackDescription")});break}if(N.type==="class-abilities"||N.type==="classFeat")N.type="misc";M=await W.generatePlaceholderEntity(N,Z)}if(b>1){let I=M.name;I=I.replace(/(?<![+-]\s*\d*\s*|DC\s*)\b(\d+)\b(?!\s*d\s*\d*\s*[+-])/i,"").replace(/\(\s*\)/,"").trim(),await M.updateSource({name:I})}let[s,C,e]=[null,null,T+(x?` (${x})`:"")];if(typeof Q==="string"&&(Q==="class-abilities"||Q==="monster-abilities")||typeof Q==="object"&&Q.length>0){let I=W.checkForDuplicateItem(SBC.actor,"feat","classFeat",e,M);if(!I)I=W.checkForDuplicateItem(SBC.actor,"feat",null,e,M);if(I&&!Q.includes("special-attacks")){if(x&&new RegExp(`(^${J0(x)}|^${J0(p)})`,"i").test(I.name)===!1||!x&&new RegExp(`(^${J0(w)})`,"i").test(I.name)===!1)await I.update({name:W.capitalize(V)});else if(x&&x!==p&&I.name.toLowerCase()===p.toLowerCase())await I.update({name:W.capitalize(x)});C=I}else if([s,C]=await g(M),b>1)for(let r=1;r<b;r++)await g(M)}else{let I=W.checkForDuplicateItem(SBC.actor,Y,H,e,M);if(!I){if([s,C]=await g(M),b>1)for(let r=1;r<b;r++)await g(M)}else C=I}if(C){let I=W.parseSubtext(V);if(new RegExp(`(^${J0(C.name)})`,"i").test(V)===!1)I[0]=C.name.replace(/^Special (.*?):/,"").trim(),I[1]="",await C.update({name:I[0]+(I[1]?` (${I[1]})`:"")});if(b>1){let v=I[1];v=v.replace(/(?<![+-]\s*\d*\s*|DC\s*)\b(\d+)\b(?!\s*d\s*\d*\s*[+-])[,)]?/i,"").replace(/\(\s*\)/,"").trim(),I[1]=v}let y=I[1],R=y?.split(/[;,]\s?/);if(R){let v={attack:null,damageFormula:null,damageType:null,damageEffect:[],saveDC:null,saveType:null,saveEffect:null,templateRange:null,templateType:null,uses:null,usesPeriod:null},U=null;if(R.forEach((d)=>{if((U=d.match(K1()))!==null&&v.damageFormula===null)v.damageFormula=U.groups.formula,v.damageType=U.groups.type?.replace(" damage","").trim(),v.damageEffect.push(U.groups.effect),y=y.replace(U[0],"").trim();else if(/([+|-]\d+)/.test(d))v.attack=d.match(/([+|-]\d+)/)[0].replace("+","");else if((U=d.match(q1()))!==null&&v.saveDC===null)v.saveDC=U.groups.dc,v.saveType=U.groups.type,v.saveEffect=U.groups.effect,y=y.replace(U[0],"").trim();else if((U=d.match(B0()))!==null)v.uses=U.groups.uses,v.usesPeriod=U.groups.period,y=y.replace(U[0],"").trim();else if((U=d.match(V1()))!==null)v.templateRange=U.groups.range,v.templateType=U.groups.type,y=y.replace(U[0],"").trim();else if(d.match(/useable/i))v.damageEffect.push(d),y=y.replace(d,"").trim()}),y=y.replace(/^\s*,|,\s*$/g,"").trim(),R=y?.split(/[;,]\s?/),R.length>0&&R[0]!=="")R=R.map((d)=>W.capitalize(d));else R=null;let t=[];if(Object.keys(v).length>0&&C.actions.size>0)await W.runParallelOps(C.actions.contents,async(d,o,c)=>{let k=C.actions.get(d.id),D={};if(v.damageEffect.length>0){let l=k.notes.effect??[];l=l.concat(v.damageEffect),D["notes.effect"]=l,y=y.replace(v.damageEffect.join(""),"").trim()}if(v.damageFormula&&k.damage.parts.length>0){let l=k.damage.parts[0].types;if(pf1.registry.damageTypes.get(v.damageType)===void 0)l.values=[],l.custom=v.damageType??"";else l.values=[v.damageType],l.custom="";if((await W.processFormula(k.damage.parts[0].formula,SBC.actor,C)).formula!==v.damageFormula)D["damage.parts"]=[{formula:v.damageFormula,type:l}]}if(v.attack&&["spellsave","save","heal","other"].includes(k.actionType)===!1)D.attackBonus=v.attack;if(k.save.dc){if(v.saveDC){let l=(await W.processFormula(k.save.dc,SBC.actor,C)).total;if(l!==v.saveDC){let Q0=v.saveDC-l;if(+Q0>0)D["save.dc"]=k.save.dc+` + ${+Q0}`}}if(v.saveType)switch(v.saveType){case"Fortitude":D["save.type"]="fort";break;case"Reflex":D["save.type"]="ref";break;case"Will":D["save.type"]="will";break;default:D["save.type"]=null;break}if(v.saveEffect)D["save.description"]=(v.saveType?`${v.saveType} `:"")+v.saveEffect}if(v.templateRange)D["measureTemplate.size"]=v.templateRange;if(v.templateType)switch(v.templateType){case"cone":D["measureTemplate.type"]="cone";break;case"ray":D["measureTemplate.type"]="ray";break;default:D["measureTemplate.type"]="circle";break}if(Object.keys(D).length>0)await k.update(D),c.push(k)},[t]);if(await C.update({"system.actions":t}),v.uses){let d=C.system.uses.maxFormula?(await W.processFormula(C.system.uses.maxFormula,SBC.actor,C)).total:0;if(d!==v.uses){let o=C.system.uses.maxFormula,c=(v.uses-d).toString(),k=C.system.uses.per?C.system.uses.per:"charges";switch(k){case"round":k="round";break;case"hour":k="hour";break;case"day":k="day";break;case"week":k="week";break;default:break}let D={"system.uses.maxFormula":o?+c>0?o+` + ${+c}`:o:c,"system.uses.per":k,"system.uses.value":C.system.uses.value+ +c};if(C.actions.size===0){let Q0={...new pf1.components.ItemAction().toObject(void 0,!1),name:game.i18n.localize("PF1.Use")};D["system.actions"]=[Q0]}if(await C.update(D),y=y.replace(/(\d+)\/(day|week|month|year)/i,"").trim().replace(/^,|,$/g,"").trim(),R=y?.split(/[;,]\s?/)??[],R.length>0&&R[0]!=="")R=R.map((l)=>W.capitalize(l));else R=null;await C.update({name:W.capitalize(I[0])+(R?.length>0?` (${R.join(", ")})`:"")})}}}if(E.match(/^Mythic\) \(/i)){let v=E.indexOf("("),U=E.substring(v+1).replace(")","");R?.push(U)}if(b>1)if(R)R.unshift(b);else R=[b];z.push({name:I[0],kind:C.system.abilityType,description:C.system.description.value,subParts:R})}if(V.toLowerCase()==="weapon finesse"&&Q==="feats")this.app.processData.flags.hasWeaponFinesse=!0}return[!0,z]}catch(_){return this.throwError(_,"parser.entity.error",J,Z,{type:Y}),[!1,[]]}}}class H0 extends h{constructor(J,Z){super(J);if(!Z)throw Error(W.translate("parser.errors.missingArgument",{arg:"targetField"}));this.targetField=Z}async parse(J,Z){if(J===void 0)throw Error(W.translate("parser.errors.missingArgument",{arg:"value"}));if(Z===void 0)throw Error(W.translate("parser.errors.missingArgument",{arg:"line"}));W.log(W.translate("parser.notes.status",{value:J,targetField:this.targetField})),this.app.processData.notes[J]=J;try{for(let Q of this.targetField)await z$(this.app.processData.notes,Q,J);return!0}catch(Q){return this.throwError(Q,"parser.notes.error",J,Z,{targetField:this.targetField}),!1}}}class a extends h{constructor(J,Z,Q){super(J);if(!Z)throw new Error(W.translate("parser.simple.missingArgument",{arg:"targetFields"}));if(this.targetFields=Z,!Q)throw new Error(W.translate("parser.simple.missingArgument",{arg:"supportedType"}));if(!["number","string"].includes(Q))throw new Error(W.translate("parser.simple.invalidArgumentType"));this.supportedType=Q}async parse(J,Z,Q=void 0){if(J===void 0)throw new Error(W.translate("parser.simple.missingArgument",{arg:"value"}));if(Z===void 0)throw new Error(W.translate("parser.simple.missingArgument",{arg:"line"}));if(J==="")return!1;if(W.log(W.translate("parser.simple.status",{value:J,targetFields:this.targetFields.join(", ")})),typeof J===this.supportedType||J==="NaN")try{for(let Y of this.targetFields)await j0(SBC.actor,Y,J==="NaN"?null:J);return!0}catch(Y){return this.throwError(Y,"parser.simple.error",J,Z,{targetFields:this.targetFields.join(", ")}),!1}else return this.throwError(void 0,"parser.simple.inputNotOfSupportedType",J,Z,{supportedType:this.supportedType}),!1}}class S0 extends h{async parse(J,Z,Q,Y=null,H=null,X=!0){let G=SBC.compendiumSearch;W.log(W.translate("parser.entity.status",{value:J,pack:Q}));let z=[];try{let _=[];if(typeof Q==="string")_.push("pf1."+Q);else Q.forEach((K)=>{_.push("pf1."+K)});let q=this.splitText(J,X);q=this.fixSplitGroup(q),this.processForChoices(q);for(let K=0;K<q.length;K++){let V=q[K].trim().replaceAll(/\*/g,"").trim(),j=B0().exec(V);if(j)if(V=V.replace(` ${j[0]}`,""),V.indexOf("("))V=V.replace("(",`(${j[0]}, `).replace(/,\s\)/g,")");else V+=` (${j[0]})`;if(/(?!\()\)$/.test(V))V=V.replace(/\)$/,"");if(/\((?!\))/.test(V))V+=")";if(V=V.replace(/\[/g,"(").replace(/]/g,")").replaceAll(/,\s+,/g,","),/sneak attack \+\d+d\d+ plus \d+ bleed/i.test(V))V=V.replace(/ plus \d+ bleed/i,"");let P=V.split(/\s/);if(console.log(`Looking at ${V}.`),/\+?\d+(d\d+)?/.test(P[P.length-1]))P.splice(P.length-1,1);if(Y==="feat")if(V.replace(/B$/,""),V.endsWith("M")){V=V.substring(0,V.length-1);let I=`${V} (Mythic)`;if(!q.find((r)=>r===I))q.push(I);if(q.slice(0,Math.max(0,K-1)).find((r)=>r===V))continue}else{let I=V.match(/(.*)M \((.*)\)/);if(I){V=`${I[1]} (${I[2]})`;let r=`${I[1]} (Mythic) (${I[2]})`;if(!q.find((u)=>u===r))q.push(r);if(q.slice(0,Math.max(0,K-1)).find((u)=>u===I[1]))continue}}let O=W.parseSubtext(`${V.replace(/\+*\d+$/g,"").trim()}`)[0].replace(/(\d+[ -]ft\.$)/i,"").trim(),L=`${P.join(" ").trim()}`,E=`${V.match(/\((.*)\)/)?V.match(/\((.*)\)/)[1]:""}`;if(j)L=L.replace(j[0],"").replace(/,\s*/,"").trim(),E=E.replace(j[0],"").replace(/,\s*/,"").trim();let B=E.replace(/(\+?\d+?)$/,"").trim().replace(/^(.*?action;)/i,"").trim();if(E.match(/^Mythic\) \(/i))O+=" (Mythic)";let N={search:new Set,type:Q,item:V};if(N.search=W.createSearchSet([B,E,L,V,O],!0),/channel\s*(positive|negative)\s*energy/i.test(V))N.search.add("channel energy");let M=null;if(typeof Y!=="string"){if(M=await G.findEntityInCompendia(N,{itemTypes:Y,itemSubTypes:Array.isArray(H)?H:[H],classes:this.app.processData.characterData.classes,race:this.app.processData.characterData.race}),!M)M=await G.findEntityInCompendia(N,{itemTypes:Y,itemSubTypes:["classFeat","misc"],classes:this.app.processData.characterData.classes,race:this.app.processData.characterData.race})}else M=await G.findEntityInCompendia(N,{itemType:Y,itemSubTypes:Array.isArray(H)?H:[H],classes:this.app.processData.characterData.classes,race:this.app.processData.characterData.race});let T=(M?.name||V).capitalize(),S=W.parseSubtext(V),w=S[0],x=S[1]?.replace(/^(.*?action;)/i,"").trim(),p=x?.replace(/(\+?\d+?)$/,"").trim(),b=S[1]?.match(/(?:^|,)\s*(\d+)\s*(?:,|$)/);if(b)b=b[1];else b=1;if(M!==null){if(!x)await M.updateSource({name:W.capitalize(V)});else if(x&&new RegExp(`(^${J0(x)}|^${J0(p)})`,"i").test(M.name)===!1||O==="weapon training")await M.updateSource({name:W.capitalize(w+(x?` (${x})`:""))});else if(x&&M.name!==W.capitalize(x)&&M.name!==W.capitalize(p))await M.updateSource({name:W.capitalize(V.trim())});if(/\*$/g.test(V))await M.updateSource({name:M.name+"*"});await W.addAssociatedClass(M,SBC.actor.itemTypes.class)}else{if(typeof Q==="object")switch(Q[0]){case"monster-abilities":Object.assign(N,{name:W.translate("parser.entity.placeholderSpecialAbilityName",{input:V}),type:"misc",desc:W.translate("parser.entity.placeholderSpecialAbilityDescription")});break;case"special-attacks":Object.assign(N,{name:W.translate("parser.entity.placeholderSpecialAttackName",{input:V}),type:"attack",desc:W.translate("parser.entity.placeholderSpecialAttackDescription")});break}if(N.type==="class-abilities"||N.type==="classFeat")N.type="misc";M=await W.generatePlaceholderEntity(N,Z)}if(b>1){let I=M.name;I=I.replace(/(?<![+-]\s*\d*\s*|DC\s*)\b(\d+)\b(?!\s*d\s*\d*\s*[+-])/i,"").replace(/\(\s*\)/,"").trim(),await M.updateSource({name:I})}let[s,C,e]=[null,null,T+(x?` (${x})`:"")];if(typeof Q==="string"&&(Q==="class-abilities"||Q==="monster-abilities")||typeof Q==="object"&&Q.length>0){let I=W.checkForDuplicateItem(SBC.actor,"feat","classFeat",e,M);if(!I)I=W.checkForDuplicateItem(SBC.actor,"feat",null,e,M);if(I&&!Q.includes("special-attacks")){if(x&&new RegExp(`(^${J0(x)}|^${J0(p)})`,"i").test(I.name)===!1||!x&&new RegExp(`(^${J0(w)})`,"i").test(I.name)===!1)await I.update({name:W.capitalize(V)});else if(x&&x!==p&&I.name.toLowerCase()===p.toLowerCase())await I.update({name:W.capitalize(x)});C=I}else if([s,C]=await g(M),b>1)for(let r=1;r<b;r++)await g(M)}else{let I=W.checkForDuplicateItem(SBC.actor,Y,H,e,M);if(!I){if([s,C]=await g(M),b>1)for(let r=1;r<b;r++)await g(M)}else C=I}if(C){let I=W.parseSubtext(V);if(new RegExp(`(^${J0(C.name)})`,"i").test(V)===!1)I[0]=C.name.replace(/^Special (.*?):/,"").trim(),I[1]="",await C.update({name:I[0]+(I[1]?` (${I[1]})`:"")});if(b>1){let v=I[1];v=v.replace(/(?<![+-]\s*\d*\s*|DC\s*)\b(\d+)\b(?!\s*d\s*\d*\s*[+-])[,)]?/i,"").replace(/\(\s*\)/,"").trim(),I[1]=v}let y=I[1],R=y?.split(/[;,]\s?/);if(R){let v={attack:null,damageFormula:null,damageType:null,damageEffect:[],saveDC:null,saveType:null,saveEffect:null,templateRange:null,templateType:null,uses:null,usesPeriod:null},U=null;if(R.forEach((d)=>{if((U=d.match(K1()))!==null&&v.damageFormula===null)v.damageFormula=U.groups.formula,v.damageType=U.groups.type?.replace(" damage","").trim(),v.damageEffect.push(U.groups.effect),y=y.replace(U[0],"").trim();else if(/([+|-]\d+)/.test(d))v.attack=d.match(/([+|-]\d+)/)[0].replace("+","");else if((U=d.match(q1()))!==null&&v.saveDC===null)v.saveDC=U.groups.dc,v.saveType=U.groups.type,v.saveEffect=U.groups.effect,y=y.replace(U[0],"").trim();else if((U=d.match(B0()))!==null)v.uses=U.groups.uses,v.usesPeriod=U.groups.period,y=y.replace(U[0],"").trim();else if((U=d.match(V1()))!==null)v.templateRange=U.groups.range,v.templateType=U.groups.type,y=y.replace(U[0],"").trim();else if(d.match(/useable/i))v.damageEffect.push(d),y=y.replace(d,"").trim()}),y=y.replace(/^\s*,|,\s*$/g,"").trim(),R=y?.split(/[;,]\s?/),R.length>0&&R[0]!=="")R=R.map((d)=>W.capitalize(d));else R=null;let t=[];if(Object.keys(v).length>0&&C.actions.size>0)await W.runParallelOps(C.actions.contents,async(d,o,c)=>{let k=C.actions.get(d.id),D={};if(v.damageEffect.length>0){let l=k.notes.effect??[];l=l.concat(v.damageEffect),D["notes.effect"]=l,y=y.replace(v.damageEffect.join(""),"").trim()}if(v.damageFormula&&k.damage.parts.length>0){let l=k.damage.parts[0].types;if(pf1.registry.damageTypes.get(v.damageType)===void 0)l.values=[],l.custom=v.damageType??"";else l.values=[v.damageType],l.custom="";if((await W.processFormula(k.damage.parts[0].formula,SBC.actor,C)).formula!==v.damageFormula)D["damage.parts"]=[{formula:v.damageFormula,type:l}]}if(v.attack&&["spellsave","save","heal","other"].includes(k.actionType)===!1)D.attackBonus=v.attack;if(k.save.dc){if(v.saveDC){let l=(await W.processFormula(k.save.dc,SBC.actor,C)).total;if(l!==v.saveDC){let Q0=v.saveDC-l;if(+Q0>0)D["save.dc"]=k.save.dc+` + ${+Q0}`}}if(v.saveType)switch(v.saveType){case"Fortitude":D["save.type"]="fort";break;case"Reflex":D["save.type"]="ref";break;case"Will":D["save.type"]="will";break;default:D["save.type"]=null;break}if(v.saveEffect)D["save.description"]=(v.saveType?`${v.saveType} `:"")+v.saveEffect}if(v.templateRange)D["measureTemplate.size"]=v.templateRange;if(v.templateType)switch(v.templateType){case"cone":D["measureTemplate.type"]="cone";break;case"ray":D["measureTemplate.type"]="ray";break;default:D["measureTemplate.type"]="circle";break}if(Object.keys(D).length>0)await k.update(D),c.push(k)},[t]);if(await C.update({"system.actions":t}),v.uses){let d=C.system.uses.maxFormula?(await W.processFormula(C.system.uses.maxFormula,SBC.actor,C)).total:0;if(d!==v.uses){let o=C.system.uses.maxFormula,c=(v.uses-d).toString(),k=C.system.uses.per?C.system.uses.per:"charges";switch(k){case"round":k="round";break;case"hour":k="hour";break;case"day":k="day";break;case"week":k="week";break;default:break}let D={"system.uses.maxFormula":o?+c>0?o+` + ${+c}`:o:c,"system.uses.per":k,"system.uses.value":C.system.uses.value+ +c};if(C.actions.size===0){let Q0={...new pf1.components.ItemAction().toObject(void 0,!1),name:game.i18n.localize("PF1.Use")};D["system.actions"]=[Q0]}if(await C.update(D),y=y.replace(/(\d+)\/(day|week|month|year)/i,"").trim().replace(/^,|,$/g,"").trim(),R=y?.split(/[;,]\s?/)??[],R.length>0&&R[0]!=="")R=R.map((l)=>W.capitalize(l));else R=null;await C.update({name:W.capitalize(I[0])+(R?.length>0?` (${R.join(", ")})`:"")})}}}if(E.match(/^Mythic\) \(/i)){let v=E.indexOf("("),U=E.substring(v+1).replace(")","");R?.push(U)}if(b>1)if(R)R.unshift(b);else R=[b];z.push({name:I[0],kind:C.system.abilityType,description:C.system.description.value,subParts:R})}if(V.toLowerCase()==="weapon finesse"&&Q==="feats")this.app.processData.flags.hasWeaponFinesse=!0}return[!0,z]}catch(_){return this.throwError(_,"parser.entity.error",J,Z,{type:Y}),[!1,[]]}}processForChoices(J){let Z=["bardic performance","versatile performance","rogue talent","hexes","rage power","ki power","discoveries","exploit","deed","investigator talent","infusion","mesmerist trick","ninja trick","investigator talent","magus arcana","revelation","mercies","cruelties","slayer talent","vigilante trick","weapon training","favored terrain","favored enemy","raging song"];J.forEach((Q)=>{let Y=[],H=null;if(Z.find((X)=>{if(Q.toLowerCase().startsWith(X))return H=X,!0;return!1})){let X=W.parseSubtext(Q),G=B0().exec(X[0])?.[0];if(G)X[0]=X[0].replace(G,"").replace(/\s{2,}/,"").trim();if(X[1])X[1]=X[1].replaceAll("[","(").replaceAll("]",")"),this.splitText(X[1],!0).forEach((_)=>{if(["favored enemy","favored terrain","versatile performance","weapon training"].includes(H))Y.push(`${X[0]} (${_})`);else Y.push(`${_}`)});if(Y.length>0){if(Y[0].toLowerCase().includes("action")){let z=Y[0].replace(`${X[0]} `,"").trim();if(G)X[0]=`${X[0]} ${G}`;X[0]+=` (${z})`,Y.shift()}switch(H){case"hexes":X[0]=X[0].replace(/hexes/i,"Hex");break;case"discoveries":X[0]=X[0].replace(/discoveries/i,"Discovery");break;case"cruelties":X[0]=X[0].replace(/cruelties/i,"Cruelty");break;case"mercies":X[0]=X[0].replace(/mercies/i,"Mercy");break;default:break}if(J[J.indexOf(Q)]=X[0],Y.length>0)J.push(...Y)}}})}}class h0 extends h{get parserGroup(){return"Parser/Base"}get parserType(){return"aura"}async _parse(J,Z,Q=void 0){let Y=SBC.compendiumSearch;this.app.processData.notes.aura=[],await j0(SBC.actor,"system.traits.aura.custom",J);let H=this.splitText(J,!1);console.log(W.translate("parser.aura.parseInfo",{value:J}),H);let X=0;for(let G of H){if(G===""||G===",")continue;let z=G.replace(/(\(.*\)|\d.*)/,"").trim(),_=z.toLowerCase(),q=W.translate("parser.aura.testName",{value:_}).toLowerCase(),K=SBC.actor.itemTypes.feat.find((S)=>S.name.toLowerCase()===_||S.name.toLowerCase()===q),V={raw:G,name:z},j=G.match(/([^(,;a-zA-Z]+)ft./i),P=0;if(j){P=parseInt(j[1].trim());let S=pf1.utils.convertDistance(P);V.range=`${S[0]} ${S[1]}`}let O="",L="",E="",B=null;if(/\bDC\b/.test(G)){if(L=G.match(/DC\s*(\d+)/)[1],B="save",V.dc=L,/DC\s*\d+\s*([^)(,;0-9]+)/.test(G))E=G.match(/DC\s*\d+\s*([^)(,;0-9]+)/)[1],V.dcNotes=E;if(/\s+([^)(,;]+)DC\s*\d+/.test(G))O=G.match(/\s+([^)(,;]+)DC\s*\d+/)[1].trim().toLowerCase(),V.saveType=W.translate(`preview.${O.capitalize()}`)}let N="(\\b"+[z,P,O,L,E,"DC"].filter((S)=>!!S).join("\\b|\\b")+"\\b|ft\\.|[(),])",M=new RegExp(N,"gi"),T=G.replace(M,"").trim();if(V.effect=T,K)this.app.processData.notes.aura.push(V);else{let S={search:new Set([z,`Aura of ${z}`]),item:G},w=await Y.findEntityInCompendia(S,{itemType:"feat",classes:this.app.processData.characterData.classes,race:this.app.processData.characterData.race});if(w)await W.addAssociatedClass(w,SBC.actor.itemTypes.class),await g(w),this.app.processData.notes.aura.push(V);else{let x=W.makeValueRollable(T),b={...new pf1.components.ItemAction().toObject(void 0,!1),actionType:B,activation:{cost:null,type:"passive",unchained:{cost:null,type:"passive"}},duration:{units:"perm"},effectNotes:x,measureTemplate:{type:"circle",size:P},name:W.translate("parser.aura.placeholderActionName"),range:{value:P,units:"ft"},save:{dc:L,type:O,description:E},target:{value:W.translate("parser.aura.placeholderTarget")}},s=new Item.implementation({name:W.translate("parser.aura.placeholderName",{value:z.capitalize()}),type:"feat",system:{abilityType:"na",actions:[b],subType:"racial",tag:`aura${X}`},img:"systems/pf1/icons/spells/runes-blue-3.jpg"});await g(s),this.app.processData.notes.aura.push(V),X++}}}return this.app.processData.notes.aura=this.app.processData.notes.aura.sort((G,z)=>G.name.localeCompare(z.name)),!0}}var w0=Object.freeze({PrestigeClass:"PrestigeClass",WizardClass:"WizardClass",SupportedClass:"SupportedClass",MythicPath:"MythicPath"});class g0 extends h{get parserGroup(){return"Parser/Base"}get parserType(){return"class"}async _parse(J,Z,Q=void 0){let Y=SBC.compendiumSearch;this.app.processData.notes.base.classes=[],J=J.replaceAll(/\sArchetype|\sPrestige Class/gi,"");let H=J.split(/\//).map((X)=>X.trim());for(let X of H){let G=v0().exec(X).groups,z=!!G.exClass,_=null;if(X.match(l1()))_=w0.PrestigeClass;else if(X.match(c1()))_=w0.SupportedClass;else if(X.match(C0()))_=w0.WizardClass;else if(X.match(n1()))_=w0.MythicPath;if(!_){this.throwError(void 0,"parser.class.failedToCreate",{class:X});continue}W.log(W.translate("parser.class.parseInfo",{classType:_}));let q=W.parseSubtext(X.trim());if(q.length>2)q[0]+=" "+q[2][0];let K={name:_===w0.WizardClass?"wizard":G.class,deity:G.deity,wizardClass:_===w0.WizardClass?G.class:"",archetype:G.archetype?.match(/\d+/)?"":G.archetype||"",level:parseInt(G.level),item:q[0].replaceAll(/[0-9]/g,"").trim()};console.log(K);let V=await Y.findEntityInCompendia(K,{itemType:"class",classes:this.app.processData.characterData.classes});if(!V){W.log(W.translate("parser.class.notFound",{className:K.name}));continue}if(V&&V.system.subType!=="racial"&&K.level===0)continue;let j=K.name,P={};if(K.deity)K.name+=` of ${K.deity}`,await SBC.actor.update({"system.details.deity":K.deity});if(K.archetype){let N=this.splitText(K.archetype,!1).map((M)=>M.trim().capitalize()).filter((M)=>M!=="");await W.runParallelOps(N,async(M)=>{let T=`${K.name.capitalize()} (${M})`,S=await Y.findEntityInCompendia({name:T,item:T},{itemType:"feat",itemSubType:"misc"});if(S)await g(S)}),j=K.name.capitalize()+" ("+N.join(", ")+")",SBC.app.processData.characterData.archetypes.push(...N)}else if(K.wizardClass)j=W.translate(`wizardSchools.${K.wizardClass.toLowerCase()}`),Object.assign(P,{"system.tag":"wizard","system.useCustomTag":!0});else j=K.name.capitalize();let O=V.system.subType;if(O!=="mythic"){let N=this.app.processData.characterData.hdMaximized,M=W.getDiceAverage(+V.system.hd);if(K.hp=!N&&O==="base"?+V.system.hd+ +Math.floor(M*(K.level-1)):M*K.level,!N&&O==="base")this.app.processData.characterData.hdMaximized=!0}else K.hp=+V.system.hd*K.level;Object.assign(P,{name:(z?"Ex-":"")+j,"system.level":K.level,"system.hp":K.hp});let L=[];if(V.system.links?.classAssociations&&!SBC.settings.getSetting("createAssociations"))L=V.system.links.classAssociations,Object.assign(P,{"system.links.-=classAssociations":null});await V.updateSource(P);let[E,B]=await g(V);if(this.app.processData.notes.base.classes.push(`${z?"Ex-":""}${j} ${K.level}`),B.name.match(/\bExpert\b/i))SBC.app.processData.characterData.isExpert=!0,SBC.app.processData.characterData.expertSkills=Object.keys(B.system.classSkills).filter((N)=>B.system.classSkills[N]),SBC.app.processData.characterData.expertId=B._id;if(!this.app.processData.characterData.classes.includes(B.system.tag))this.app.processData.characterData.classes.push(B.system.tag);if(L.length>0)await B.update({"system.links.classAssociations":L})}return!0}}class b0 extends h{get parserGroup(){return"Parser/Base"}get parserType(){return"creatureType"}async _parse(J,Z,Q=void 0){let Y=SBC.compendiumSearch,H=q$(J),X=!SBC.actor.race,G={name:H[0],type:"racial",subTypes:"",item:H[0]};if(H.length>1)G.subTypes=H[1];let z=await Y.findEntityInCompendia(G,{itemType:"class"});if(X){let V={name:z.name,img:z.img,type:"race",creatureTypes:[z.system.tag],creatureSubtypes:this.splitText(W.capitalize(G.subTypes)).map((P)=>pf1.utils.createTag(P)),desc:z.system.description.value,sources:z.system.sources,size:SBC.actor.system.traits.size.base},j=await W.generatePlaceholderEntity(V,Z);await g(j)}else{let V=SBC.actor.race,j=new Set,P=new Set;V.system.creatureTypes.base.forEach((O)=>{j.add(O)}),V.system.creatureSubtypes.base.forEach((O)=>{P.add(O)}),j.add(z.system.tag),this.splitText(W.capitalize(G.subTypes)).forEach((O)=>P.add(pf1.utils.createTag(O))),await V.update({"system.creatureTypes":Array.from(j),"system.creatureSubtypes":Array.from(P)})}let _={system:{level:0}};switch(G.name.toLowerCase()){case"undead":this.app.processData.flags.isUndead=!0,await A1(this.app.processData,"isUndead");break;case"construct":this.app.processData.flags.isConstruct=!0;break;default:break}if(G.subTypes!=="");await z.updateSource(_),this.app.processData.notes.creatureType={type:W.translate(`types.${W.camelize(H[0])}`),subTypes:G.subTypes.split(",").map((V)=>{V=V.trim();let j=W.haystackSearch(SBC.config.creatureSubTypes,V);if(j)return W.translate(`subTypes.${W.camelize(j)}`);return V.capitalize()})};let[q,K]=await g(z);if(K.name.match(/\bOutsider\b/i))SBC.app.processData.characterData.isOutsider=!0,SBC.app.processData.characterData.outsiderSkills=Object.keys(K.system.classSkills).filter((V)=>K.system.classSkills[V]),SBC.app.processData.characterData.outsiderId=K._id;if(!this.app.processData.characterData.race)this.app.processData.characterData.race=z.system.tag;return!0}}class D0 extends h{get parserGroup(){return"Parser/Base"}get parserType(){return"race"}async _parse(J,Z,Q=void 0){let Y=SBC.compendiumSearch,H={name:J.toLowerCase(),item:J};this.app.processData.notes.base.race=H.name.capitalize();let X=await Y.findEntityInCompendia(H,{itemType:"race"});if(!X){let G={name:J,type:"race"};X=await W.generatePlaceholderEntity(G,Z)}if(!this.app.processData.characterData.race)this.app.processData.characterData.race=pf1.utils.createTag(X.name);return await g(X),!0}}var K$={blindsight:"system.traits.senses.bs.value",blindsense:"system.traits.senses.bse.value",darkvision:"system.traits.senses.dv.value",tremorsense:"system.traits.senses.ts.value",scent:"system.traits.senses.sc.value",truesight:"system.traits.senses.tr.value","true seeing":"system.traits.senses.tr.value","see in darkness":"system.traits.senses.sid","see invisibility":"system.traits.senses.si","low-light":"system.traits.senses.ll.enabled"},V$={blindsight:"PF1.Sense.blindsight",blindsense:"PF1.Sense.blindsense",darkvision:"PF1.Sense.darkvision",tremorsense:"PF1.Sense.tremorsense",scent:"PF1.Sense.scent","see in darkness":"PF1.Sense.seeInDark",truesight:"PF1.Sense.trueseeing","true seeing":"PF1.Sense.trueseeing","see invisibility":"PF1.Sense.seeInvis","low-light":"PF1.Sense.lowlight"};class y0 extends h{get parserGroup(){return"Parser/Base"}get parserType(){return"sense"}async _parse(J,Z,Q=void 0){let H=Object.values(n("senses")).map((G)=>G.toLowerCase()).concat(N1),X=[];this.app.processData.notes.base.senses=[];for(let G of H){if(J.search(G)===-1)continue;switch(G){case"scent":case"truesight":case"true seeing":case"blindsight":case"blindsense":case"darkvision":case"tremorsense":{let z=new RegExp(G+"\\s(\\d+)",""),_=J.match(z)?.[1]??(["truesight","true seeing"].includes(G)?120:0);await SBC.actor.update({[K$[G]]:+_});let[q,K]=pf1.utils.convertDistance(+_),V=V$[G]||null;this.app.processData.notes.base.senses.push((V?game.i18n.localize(V):G.capitalize())+` ${q} ${K}`);break}case"see in darkness":case"see invisibility":case"low-light":{await SBC.actor.update({[K$[G]]:!0});let z=V$[G]||null;this.app.processData.notes.base.senses.push(z?game.i18n.localize(z):G.capitalize());break}default:X.push(G.capitalize()),this.app.processData.notes.base.senses.push(G.capitalize());break}}if(!this.app.processData.notes.base.senses.length)delete this.app.processData.notes.base.senses;if(X.length)await SBC.actor.update({"system.traits.senses.custom":X.join(";")});return!0}}class d0 extends h{get parserGroup(){return"Parser/Base"}get parserType(){return"mythic"}async _parse(J,Z,Q=void 0){let Y=SBC.compendiumSearch;if(J=parseInt(J)||0,J===0)return!0;this.app.processData.notes.base.mr=J,W.log(W.translate("parser.mr.parseInfo",{value:J}));let H={name:"Mythic Rank",item:"Mythic Rank"},X=await Y.findEntityInCompendia(H,{itemType:"class",classes:this.app.processData.characterData.classes}),G=SBC.actor.itemTypes.class.find((O)=>O.system.subType==="racial"),z=Math.min(10,+G?.system?.hd),[_,q]=await g(X),K=[{_id:q.id,"system.level":J,"system.hp":z*J,"system.hd":z}],V=SBC.actor.itemTypes.feat.find((O)=>O.system.subType==="misc"&&O.system.tag==="surgeMythic"),j=SBC.actor.itemTypes.feat.find((O)=>O.system.subType==="misc"&&O.system.tag==="mythicPowerMythic"),P=0;while((!V||!j)&&P<10)await new Promise((O)=>{P++,setTimeout(O,1000)}),V=SBC.actor.itemTypes.feat.find((O)=>O.system.subType==="misc"&&O.system.tag==="surgeMythic"),j=SBC.actor.itemTypes.feat.find((O)=>O.system.subType==="misc"&&O.system.tag==="mythicPowerMythic");if(V){let O=6+2*Math.floor((J-1)/3);await V.actions.get(V.actions.contents[0].id).update({effectNotes:[`+[[1d${O}]] Surge`]})}if(j)K.push({_id:j.id,"system.uses.maxFormula":`${J}`,"system.uses.value":+J});return await SBC.actor.updateEmbeddedDocuments("Item",K),V?.prepareData(),await j?.recharge({value:+J,maximize:!0,commit:!0,period:"any"}),await j?.createItemLink("charges",V),await j0(SBC.actor,"system.details.cr.base",SBC.actor.system.details.cr.base-Math.floor(J/2)),!0}}class k0 extends h{get parserGroup(){return"Parser/Defense"}get parserType(){return"armorClass"}async _parse(J,Z,Q=void 0){let Y=J.split(";");if(Y.length>1)this.app.processData.miscNotes.acNotes.push(Y[1].trim());let H=Y[0].split(",");this.app.processData.notes.defense.acTypes=[];for(let X of H){let G=X.match(i1())?.[0]?.toLowerCase(),z=parseInt(X.match(/[+-]\d+/)?.[0])??0,_=z;switch(console.log(W.translate("parser.armorClass.parseInfo",{type:G,value:z})),G){case"natural":if(z-=await W.getTotalFromChanges(SBC.actor,"nac"),z!==0)this.app.processData.miscNotes.naturalAC=z;break;case"size":case"dex":break;case"armor":case"shield":case"base":case"enhancement":case"dodge":case"inherent":case"deflection":case"morale":case"luck":case"sacred":case"insight":case"resistance":case"profane":case"trait":case"racial":case"competence":case"circumstance":case"alchemical":case"penalty":case"rage":case"monk":case"wis":case"untyped":case"untypedPerm":if(z-=await W.getTotalFromChanges(SBC.actor,"ac",G),z!==0)this.app.processData.characterData.conversionValidation.attributes[G]=z;break;default:break}this.app.processData.notes.defense.acTypes.push({type:W.translate(`armorTypes.${G}`),value:_>=0?`+${_}`:_})}return!0}}class m0 extends h{get parserGroup(){return"Parser/Defense"}get parserType(){return"damageReduction"}async _parse(J,Z,Q=void 0){let Y=J.replace(/(^[,;\s]*|[,;\s]*$)/g,""),H=this.splitText(Y);this.app.processData.notes.defense.dr=[];let X=SBC.actor.system.traits.dr.value,G=SBC.actor.system.traits.dr.custom;for(let z of H){z=z.replace(/Effects/gi,"").trim();let _=/^(?<amount>\d+)\s*\/\s*(?<type1>.+?)(?:\s*(?<operator>or|and)\s*(?<type2>.+?))?$/g.exec(z),{amount:q,type1:K,operator:V,type2:j}=_.groups;if(console.log(W.translate("parser.damageReduction.parseInfo"),q,K,V,j,K?.search(Y0()),j?.search(Y0())),K&&K.match(Y0())||j&&j.match(Y0())){K=K?.match(Y0())?.[0],j=j?.match(Y0())?.[0];let P=[K,j].filter((O)=>!!O).map((O)=>pf1.utils.createTag(O));X.push({amount:+q,types:P,operator:V==="or"}),this.app.processData.notes.defense.dr.push([q,"/",this.getDamageTypePhrase(P[0]),...P[1]?[" ",W.translate(V)," ",this.getDamageTypePhrase(P[1])]:[]].join(""))}else G+=`${z.capitalize()};`,this.app.processData.notes.defense.dr.push(z.capitalize())}return await SBC.actor.update({"system.traits.dr.value":X,"system.traits.dr.custom":G.replace(/;$/,"")}),!0}getDamageTypePhrase(J){if(n("damageResistances")[J])return n("damageResistances")[J];let Z=pf1.registry.materials.getLabels();if(Z[J])return Z[J];let Q=pf1.registry.damageTypes.getLabels();if(Q[J])return Q[J];return""}}class u0 extends h{get parserGroup(){return"Parser/Defense"}get parserType(){return"hitPoints"}async _parse(J,Z,Q=void 0){let Y=SBC.actor.itemTypes.class,H=!1,[X,G,z,_,q]=this.processHPString(J);W.log(`HP: ${z} and Bonus: ${_}`);let K=0,V=0,j=z.reduce((w,x)=>{let[p,b]=x.split("d").map((s)=>parseInt(s));return K+=p,w+p*W.getDiceAverage(b)},0)+_;V=K-Y.reduce((w,x)=>w+(x.system.subType==="mythic"?0:x.system.level),0);let P=Y.find((w)=>w.system.subType==="racial");if(P)await P.update({"system.level":V,"system.hp":V*W.getDiceAverage(P.system.hd)});let O=SBC.actor.system.attributes.hp.value,L=j-O,E=Y.find((w)=>w.system.subType==="base"||w.system.subType==="npc");if(E){if(E.system.subType==="base"){if(!H){H=!0,W.log(`Maximizing first HD for ${E.name} - ${E.system.hd} - ${W.getDiceAverage(E.system.hd)}`);let w=E.system.hd-W.getDiceAverage(E.system.hd);j+=w,L+=w}}if(L===E.system.level)await E.update({"system.fc.hp.value":E.system.level}),L-=E.system.level,O+=E.system.level}let B=await t$(SBC.actor,Y);W.log(`HP Data: Statblock: ${j}, Actor: ${O}, System: ${B}`),W.log(`HP Difference between Statblock and Actor: ${L}`);let N=B-O;W.log(`HP Difference between System and Actor: ${N}`);let M=j-B;W.log(`HP Difference between Statblock and System: ${M}`);let T=h1(j+(X-j+N));if(this.app.processData.characterData.conversionValidation.attributes.hpTotal=T,this.app.processData.notes.defense.hpTotal=T,this.app.processData.notes.defense.hdTotal=K,this.app.processData.notes.defense.hdPool=G,await this.resetRacialClassesWithNoLevels(),!q.trim().length)return!0;let S=await $J(this.splitText(q,!1),Z);return this.app.processData.notes.defense.hdAbilities=S.join(", "),!0}processHPString(J){if(!J)return[0,"",[],0,""];if(J.match(/\);\s*(regeneration|fast[ -]healing)/i))J=J.replace(/\);(\s*regeneration|fast[ -]healing)/i,"), $1");let Z=this.splitText(J,!1),[Q,Y]=W.parseSubtext(Z[0]),H=Y.match(/(\d+d\d+)/g),G=Y.match(/(\b[^d+\s]*\d+[^\sd+]*\b)(?!\s*HD)/gi)?.reduce((z,_)=>z+parseInt(_),0)??0;return[Q,Y,H,G,Z[1]||""]}async resetRacialClassesWithNoLevels(){let J=[];if(SBC.actor.itemTypes.class.filter((Z)=>Z.system.level===0).forEach(async(Z)=>{if(Z.system.subType==="racial")J.push(Z);else await Z.update({"system.savingThrows":{fort:{value:"",base:0,good:Z.system.savingThrows.fort.good},ref:{value:"",base:0,good:Z.system.savingThrows.ref.good},will:{value:"",base:0,good:Z.system.savingThrows.will.good}}})}),J.length){if(!SBC.actor.itemTypes.race.length){let Q=J[0],Y=W.parseSubtext(Q.name),H={name:Y[0],creatureType:Y[0].toLowerCase(),desc:Q.system.description.value,img:Q.img,size:SBC.actor.system.traits.size.base,subTypes:Y.length>1?Y[1].replace(/\s/g,"").split(","):"",type:"race"};await g(await W.generatePlaceholderEntity(H))}SBC.actor.deleteEmbeddedDocuments("Item",J.map((Q)=>Q.id))}}}async function t$(J,Z){let Q=0,Y=game.settings.get("pf1","healthConfig"),H={continuous:Y.continuous,maximized:Y.maximized,rounding:Y.rounding,maximizedProgress:0},X=SBC.settings.getSetting(`${SBC.config.const.actorType[SBC.actorType]==="npc"?"npc":"pc"}health`);if(X)H.continuous=X==="continuous";for(let _ of Z){let q=_.system.subType,K=game.settings.get("pf1","healthConfig").getClassHD(_);switch(q){case"base":case"prestige":case"npc":case"racial":{let V=_.system.level,j=0;if(K.maximized&&H.maximizedProgress<K.maximized)j=Math.min(H.maximized-H.maximizedProgress,V),V-=j,H.maximizedProgress+=j;let P=e$(H,K,_.system.hd,V,j);Q+=P+_.system.fc.hp.value,await _.update({"system.hp":P});break}case"mythic":Q+=_.system.hp;break;default:break}}let G=J.system.attributes.hd.total,z=J.system.attributes.hpAbility;return Q+=G*J.system.abilities[z].mod,Q+=await W.getTotalFromChanges(J,"mhp"),Q}function e$(J,Z,Q,Y,H){let X=0,G=W.getDiceAverage(Q,Z.rate);if(!J.continuous)for(let _=0;_<Y;_++)X+=h1(G);else X=h1(G*Y);return X+=H*Q,X}function h1(J){switch(game.settings.get("pf1","healthConfig").rounding){case"up":J=Math.ceil(J);break;case"down":J=Math.floor(J);break;case"nearest":J=Math.round(J);break;default:break}return J}async function $J(J,Z){let Q=[],Y=new RegExp("\\b(regeneration|fast[ -]healing)\\b","gi");for(let H of J){if(H=H.trim(),H.length===0)continue;if(H.search(Y)===-1){let G={name:H,type:"misc"};Q.push(G.name);let z=await W.generatePlaceholderEntity(G,Z);await g(z);continue}switch(H.match(Y)[0].toLowerCase()){case"regeneration":{await A.map.defense.regeneration.parse(H,Z);break}case"fast healing":case"fast-healing":{await A.map.defense.fastHealing.parse(H,Z);break}default:break}Q.push(H)}return Q}class p0 extends h{get parserGroup(){return"Parser/Defense"}get parserType(){return"immunity"}async _parse(J,Z,Q=void 0){let Y=J.replace(/(^[,;\s]*|[,;\s]*$)/g,""),H=this.splitText(Y);this.app.processData.notes.defense.immune=[];let X={ci:SBC.actor.system.traits.ci.base,di:SBC.actor.system.traits.di.base};for(let G of H){G=this.sanitizeInput(G.replace(/(?<!Death )Effects/gi,"").trim());let z=G.toLowerCase().includes("fatigue");if(z||G.search(X1())!==-1){if(z)G="fatigued";let _=W.getKeyByValue(n("conditionTypes"),G);X.ci.push(W.camelize(_)),this.app.processData.notes.defense.immune.push(n("conditionTypes")[_])}else if(G.replace(/(\s*energy)/i,"").search(Y0(!0))!==-1){let _=W.getKeyByValue(pf1.registry.damageTypes.getLabels(),G.replace(/(\s*energy)/i,""));X.di.push(W.camelize(_)),this.app.processData.notes.defense.immune.push(pf1.registry.damageTypes.getLabels()[_]+(G.match(/ energy/)?" Energy":""))}else if(G.search(r1())!==-1){let _=W.getKeyByValue(pf1.registry.conditions.getLabels(),G);X.ci.push(W.camelize(_)),this.app.processData.notes.defense.immune.push(pf1.registry.conditions.getLabels()[_])}else if(G.search(W$())!==-1){let _=W.haystackSearch(SBC.config.creatureTypes,G),q=SBC.config.immunities[_]||{};if(q.condition)X.ci.push(...q.condition);if(q.damage)X.di.push(...q.damage);if(q.custom)X.ci.push(...q.custom);this.app.processData.notes.defense.immune.push(G.capitalize())}else X.ci.push(G.capitalize()),this.app.processData.notes.defense.immune.push(G.capitalize())}return await SBC.actor.update({"system.traits.ci":X.ci,"system.traits.di":X.di}),!0}sanitizeInput(J){let Z={fatigue:"fatigued",paralysis:"paralyzed",confusion:"confused",petrification:"petrified",stunning:"stunned"};for(let Q of Object.keys(Z))J=J.replace(new RegExp(Q,"gi"),Z[Q]);return J.trim()}}class o0 extends h{get parserGroup(){return"Parser/Defense"}get parserType(){return"resistance"}async _parse(J,Z,Q=void 0){let Y=J.replace(/(^[,;\s]*|[,;\s]*$)/g,"").replace("electricity","electric").replaceAll(" energy",""),H=this.splitText(Y);this.app.processData.notes.defense.resist=[];let X=SBC.compendiumSearch,G=SBC.actor.system.traits.eres.value,z=SBC.actor.system.traits.eres.custom,_=SBC.actor.system.traits.cres;for(let q=0;q<H.length;q++){let K=H[q].replace(/Effects/gi,"").trim();if(K.match(X1()))_+=`${K.capitalize()};`,this.app.processData.notes.defense.resist.push(_);else{let V=/^(?<type1>\S+)(?:\s*(?<operator>or|and)\s*(?<type2>\S+))?\s*(?<amount>\d+)$/g.exec(K);if(!V){let j={search:new Set,type:"feats",item:K};j.search=W.createSearchSet([W.capitalize(K)],!0);let P=await X.findEntityInCompendia(j,{itemTypes:["feat"],itemSubTypes:["classFeat","misc"],classes:this.app.processData.characterData.classes});if(!P)j.itemTypes="misc",P=await W.generatePlaceholderEntity(j);let O=W.checkForDuplicateItem(SBC.actor,"feat","classFeat",K,P);if(!O)O=W.checkForDuplicateItem(SBC.actor,"feat",null,K,P);if(!O)await g(P)}else{let{amount:j,type1:P,operator:O,type2:L}=V.groups;if(console.log(W.translate("parser.resistance.parseInfo"),j,P,O,L,P?.search(Y0()),L?.search(Y0())),P&&P.match(Y0())||L&&L.match(Y0())){P=P?.match(Y0())?.[0],L=L?.match(Y0())?.[0];let E=[P,L].filter((B)=>!!B).map((B)=>pf1.utils.createTag(B));G.push({amount:+j,types:E,operator:O==="or"}),this.app.processData.notes.defense.resist.push([this.getDamageTypePhrase(E[0]),...E[1]?[" ",W.translate(O)," ",this.getDamageTypePhrase(E[1])]:[]," ",j].join(""))}else z+=`${K.capitalize()};`,this.app.processData.notes.defense.resist.push(K.capitalize())}}}return await SBC.actor.update({"system.traits.cres":_.replace(/;$/,""),"system.traits.eres.value":G,"system.traits.eres.custom":z.replace(/;$/,"")}),!0}getDamageTypePhrase(J){if(n("damageResistances")[J])return n("damageResistances")[J];let Z=pf1.registry.materials.getLabels();if(Z[J])return Z[J];let Q=pf1.registry.damageTypes.getLabels();if(Q[J])return Q[J];return""}}var y8=Object.freeze({Fort:Symbol("fort"),Ref:Symbol("ref"),Will:Symbol("will")});class c0 extends h{get parserGroup(){return"Parser/Defense"}get parserType(){return"save"}async _parse(J,Z,Q=void 0){let Y=J,H="";if(/;(?![^(]*\))/.test(Y))[Y,H]=Y.split(/;(?![^(]*\))/);let X=this.splitText(Y).map(W.parseSubtext);for(let G=0;G<X.length;G++){let z=X[G][0],{type:_,value:q}=z.match(G$()).groups;if(_=_.toLowerCase(),!_){this.throwError(void 0,"parser.save.error",X[G].join(""),z);continue}if(this.app.processData.characterData.conversionValidation.attributes[_]=q,this.app.processData.notes.defense[_+"Save"]=q,X[G][1])H+=(H?`
`:"")+_.capitalize()+": "+X[G][1]}if(H)this.app.processData.miscNotes.saveNotes=H.trim(),this.app.processData.notes.defense.saveNotes=H.trim();return!0}}class l0 extends h{get parserGroup(){return"Parser/Defense"}get parserType(){return"spellResistance"}async _parse(J,Z,Q=void 0){let Y=J.replace(/(^[,;\s]*|[,;\s]*$)/g,""),H=W.parseSubtext(Y),X=H[0],G="",z="";if(H[1])G=H[1],z=G;else if(/\s*([-+]?\d+)\s+(.*)/.test(X))[X,G]=X.split(/\s*([-+]?\d+)\s+(.*)/).slice(1),z=G;return this.app.processData.miscNotes.srNotes=z,this.app.processData.miscNotes.sr=X.toString(),this.app.processData.notes.defense.srNotes=z,this.app.processData.notes.defense.sr=X.toString(),!0}}class n0 extends h{get parserGroup(){return"Parser/Defense"}get parserType(){return"weakness"}async _parse(J,Z,Q=void 0){let Y=J.replace(/(^[,;\s]*|[,;\s]*$)/g,""),H=this.splitText(Y);this.app.processData.notes.defense.weakness=Y;let X=SBC.actor.system.traits.dv.base;console.log(H);for(let G=0;G<H.length;G++){let z=H[G].replace(/Effects/gi,"").trim(),_=z.match(Y0());if(_)X.push(_[0]);else if(!SBC.actor.itemTypes.feat.find((q)=>q.system.subType==="misc"&&q.name.toLowerCase()===z.toLowerCase()))X.push(z.capitalize())}return await SBC.actor.update({"system.traits.dv":X}),!0}}class i0 extends h{get parserGroup(){return"Parser/Misc"}get parserType(){return"ecology"}async _parse(J,Z,Q=void 0){W.log(W.translate("parser.ecology.status",J));let Y=`<div><strong>${J.name}</strong>: ${J.entry}</div>`,H=SBC.actor.items.contents.find((X)=>X.name==="Ecology");if(H){let X=H.system.description.value;await H.update({"system.description.value":X+Y})}else{let X={name:"Ecology",type:"misc",desc:Y,img:"icons/environment/wilderness/tree-oak.webp"},G=await W.generatePlaceholderEntity(X,Z);await g(G)}return!0}}class r0 extends h{constructor(J){super(J);this.specialAbilityCount=0}get parserGroup(){return"Parser/Misc"}get parserType(){return"specialAbility"}async _parse(J,Z,Q=void 0){let{type:Y,name:H,description:X}=this.checkAbilityData(J,Z),G={name:H||"Special Ability",specialAbilityType:Y.toLowerCase(),type:"misc",desc:`<p>${X.replaceAll(`

`,"</p><p>")}</p>`},z=await W.generatePlaceholderEntity(G,Z),_=SBC.actor.itemTypes.feat.find((q)=>q.name===`Aura: ${z.name}`&&q.system.subType==="racial");if(_)await _.update({"system.description.value":G.desc});else await g(z);return this.app.processData.notes.specialAbilities.push({name:H,type:Y,typeName:pf1.config.abilityTypes[Y].short,description:W.convertStringUnits(X)}),!0}checkAbilityData(J,Z){if(J.search(H$())!==-1){let{description:X,name:G,type:z}=X$().exec(J).groups;if(z=z.toLowerCase().replace(/[()]*/g,""),z==="--")z="na";return{description:X.capitalize(),name:W.capitalize(G),type:z}}let Q=W.translate("parser.specialAbility.placeholderName",{value:++this.specialAbilityCount}),Y=J.trim(),H="na";return this.throwError(void 0,"parser.specialAbility.matchError"),{name:Q,description:Y,type:H}}}class s0 extends h{get parserGroup(){return"Parser/Misc"}get parserType(){return"tactics"}async parse(J,Z,Q=void 0){W.log(W.translate("parser.tactics.status",J));let Y=`<div><strong>${J.name}</strong>: ${J.entry}</div>`,H=SBC.actor.items.contents.find((X)=>X.name==="Tactics");if(H){let X=H.system.description.value;await H.update({"system.description.value":X+Y})}else{let X={name:W.translate("parser.tactics.placeholderName"),type:"misc",desc:Y,img:"icons/skills/targeting/crosshair-pointed-orange.webp"},G=await W.generatePlaceholderEntity(X,Z);await g(G)}return!0}}class a0 extends h{get parserGroup(){return"Parser/Offense"}get parserType(){return"speed"}async _parse(J,Z,Q){if(J.length<=0)return!0;let Y=J.replace(/(^[,;\s]*|[,;\s]*$)/g,""),H=W.parseSubtext(Y),X=H[0].match(/(\d+)\s*(ft\.|feet)?/)?.[1],G="";if(X==null)return this.throwParseError(void 0,J,Z,Q),!1;let z=pf1.utils.convertDistance(+X),_=game.i18n.localize(`PF1.Movement.Mode.${Q.toLowerCase()}`)+` ${z[0]} ${z[1]}`;switch(X-=await W.getTotalFromChanges(SBC.actor,`${Q}Speed`),X-=await W.getTotalFromChanges(SBC.actor,"allSpeeds"),this.app.processData.characterData.conversionValidation.attributes[Q]=+X,await SBC.actor.update({[`system.attributes.speed.${Q}.base`]:+X}),Q){case"fly":{if(H.length>1){let q=W.haystackSearch(Object.keys(n("flyManeuverabilities")),H[1]);if(q)await SBC.actor.update({["system.attributes.speed.fly.maneuverability"]:q}),_+=` (${game.i18n.localize(`PF1.Movement.FlyManeuverability.Quality.${q.toLowerCase()}`)})`;if(H[2])G=H[2]}break}default:if(H.length>1)G=H[1];break}return this.app.processData.notes.offense.speed.push(_),!0}}var q0=Object.freeze({Constant:"constant",Weekly:"weekly",Monthly:"monthly",Yearly:"yearly",AtWill:"atWill",Daily:"daily"}),W0={};class X0 extends h{get parserGroup(){return"Parser/Offense"}get parserType(){return"spellBook"}async _parse(J,Z,Q=void 0){W.log("Trying to parse the following Spell Book.",J);let{spellCastingType:Y,spells:H,spellBookType:X}=J,G=Y==="prepared"?"Prepared":Y==="points"?"Psychic":"Known";X=await this.setupSpellbook(Y,X,J.spellCastingClass,J.isAlchemist?"extracts":"spells",G,+J.casterLevel,+J.concentrationBonus,J.isSpellLike,J.firstLine,J.spellBookName),W0[X]={},[0,1,2,3,4,5,6,7,8,9].forEach((N)=>{W0[X][N]={},W0[X][N].base=0,W0[X][N].max=0});let z=SBC.actor.system.attributes.spells.spellbooks[X],_=[],q=null,K=null,V=z.name,j=X0.getClassPostfixFromSpellbookName(V),P=SBC.actor.itemTypes.class.filter((N)=>N.system.casting);P=P.map((N)=>N.system.tag.substring(0,3).toUpperCase()).concat(P.map((N)=>`${N.system.tag[0]}${N.system.tag[2]}${N.system.tag[3]}`.toUpperCase()));let O=J.spellCastingClass.match(C0());if(O)switch(O[0]){case"Abjurer":K="abj",q="Abjuration";break;case"Conjurer":K="con",q="Conjuration";break;case"Diviner":K="div",q="Divination";break;case"Enchanter":K="enc",q="Enchantment";break;case"Evoker":K="evo",q="Evocation";break;case"Illusionist":K="ill",q="Illusion";break;case"Necromancer":K="nec",q="Necromancy";break;case"Transmuter":K="trs",q="Transmuation";break;case"Universalist":default:K="",q="Universalist";break}else if(z.class==="wizard"||V&&V.toLowerCase().includes("wizard"))K="",q="Universalist";if(q==="Universalist")await SBC.actor.update({[`system.attributes.spells.spellbooks.${X}.domainSlotValue`]:0});let L=0;for(let N=0;N<H.length;N++)L+=this.splitText(H[N].replace(/(^[^-]*-)/,""),!1).length;let E="";for(let N=0;N<H.length;N++){if(H[N]==="")continue;let M=H[N],T={spellLevel:-1,spellsPerX:"",spellsPerXTotal:-1,isAtWill:!1,frequency:null,isSpellRow:!1,spellRowIsInitialized:!1,wizardSchool:K,isSpellLike:J.isSpellLike};if(this.processSpellRow(M,X,T),this.processFrequencies(M,T),T.isSpellRow){let w={frequency:T.spellLevel===-1?{type:W.translate(`spellFrequencyNoun.${T.frequency}`),amount:T.spellsPerXTotal!==-1?+T.spellsPerXTotal:0}:null,level:+T.spellLevel,levelEnum:W.translate(`spellLevelEnum.${T.spellLevel}`),spells:[]},x=this.splitText(M.replace(/(^[^-]*-)/,""),!1),p=!1,b=0;if(J.isSpellLike)for(let s of x){s=s.replaceAll(/\*/g,"").trim();let[C,e]=X0.processSpellName(s);if(C==="")continue;let I={search:new Set([C,e]),type:"spell",item:C};I.search=W.createSearchSet([C,e],!0,j.concat(P));let[r,u]=await this.findSpellEntities(I),y=await W.generatePlaceholderEntity(I,Z),R=W.checkForDuplicateItem(SBC.actor,"feat","misc",C,y);if(!(!r&&u)&&!(u&&L===1)&&!(!u&&R))b++}p=J.isSpellLike?b===0:!1,await W.runParallelOps(x,async(s)=>{if(p)L--;await this.processSpell(s.replaceAll(/\*/g,"").trim(),T,X,Y,j,P,Z,w,p)}),_.push(w)}else E=await this.parseSpellbookSpecials(M,Z,X);let S={};[0,1,2,3,4,5,6,7,8,9].forEach((w)=>{S[`system.attributes.spells.spellbooks.${X}.spells.spell${w}.base`]=W0[X][w].base,S[`system.attributes.spells.spellbooks.${X}.spells.spell${w}.max`]=W0[X][w].max}),await SBC.actor.update(S)}if(q){let N=SBC.compendiumSearch,M={search:new Set([`${q} School`,q]),type:"feat",item:q},T={itemType:"feat",itemSubType:"classFeat",classes:this.app.processData.characterData.classes,race:this.app.processData.characterData.race},S=SBC.actor,w=await N.findEntityInCompendia(M,T),x=S.itemTypes.feat.filter((p)=>p.system.subType==="classFeat").find((p)=>p.name===p.name===w?.name);if(M.search.clear(),w){if(!x||x&&w.flags.core?.sourceId!==x.flags.core?.sourceId)await W.addAssociatedClass(w,S.itemTypes.class),await g(w)}}let B=SBC.actor.system.attributes.spells.spellbooks[X];if(W.log(B),!L)await SBC.actor.update({[`system.attributes.spells.spellbooks.${X}`]:X0.getDefaultSpellbookData()});return this.app.processData.notes.offense.spellBooks.push({name:J.firstLine.split("(")[0].trim(),cl:+J.casterLevel,asf:B.arcaneSpellFailure?SBC.actor.spellFailure:0,concentration:(+J.concentrationBonus>=0?"+":"")+ +J.concentrationBonus,spellRows:_,specialRow:E}),W.log(_),[!0,X,L!==0]}async setupSpellbook(J,Z,Q,Y,H,X,G,z,_,q){let K=0,V=!1,j=!0,P={domainSlotValue:K,psychic:V,spellPreparationMode:J,inUse:!0},O=SBC.actor;if(!O.system.attributes.spells.spellbooks[Z])P=foundry.utils.mergeObject(X0.getDefaultSpellbookData(),P);let L=Q.match(C0())?"wizard":Q;if(z){let E=+X===O.system.attributes.hd.total;P=foundry.utils.mergeObject(P,{ability:"cha",autoSpellLevelCalculation:!1,autoSpellLevels:!1,class:E?"_hd":"","cl.formula":E?"":`${X}`,arcaneSpellFailure:!1,name:W.capitalize(_.match(/^(.*?)\(/)[1].trim()),kind:"arcane",hasCantrips:j,noAbilityLimit:!0})}else if(J==="points"){let E=O.system.abilities;P=foundry.utils.mergeObject(P,{arcaneSpellFailure:!1,autoSpellLevelCalculation:!1,class:"_hd",name:W.translate("spellbookName.psychicMagic"),kind:"psychic",hasCantrips:!0,isPsychic:!0,spellPreparationMode:"spontaneous",spellPoints:{useSystem:!0,maxFormula:"0",max:0},ability:E.int.total>=E.cha.total?"int":"cha"})}else P=foundry.utils.mergeObject(P,{class:L.toLowerCase(),name:Q.capitalize()+" "+W.translate(`spellbookName.${Y}`)+" "+H});if(["hd","_hd"].includes(Q)===!1){let E=O.itemTypes.class.filter((B)=>B.name.toLowerCase()===Q.toLowerCase()||B.system.tag===Q.toLowerCase())[0]??null;if(E){X=E.system.level+(isNaN(E.system.casting.offset)?0:E.system.casting.offset),Q=E.system.tag;let B=X0.getHighestSpellLevelFreeSlots(Q,E.system.level);if(delete P.name,P=foundry.utils.mergeObject(P,{class:Q,kind:E.system.casting.spells,ability:E.system.casting.ability,arcaneSpellFailure:E.system.casting.spells==="arcane",domainSlotValue:E.system.casting.domain,casterType:E.system.casting.progression,hasCantrips:E.system.casting.cantrips,autoSpellLevelCalculation:!0,"cl.-=autoSpellLevelCalculationFormula":null,psychic:E.system.casting.spells==="psychic",spellPreparationMode:E.system.casting.type,spells:B,inUse:!0}),!z){let N=O.itemTypes.class.filter((M)=>M.system.subType==="prestige"&&M.system.tag!==E.system.tag&&!this.app.processData.characterData.prestigeClassCasting.has(M.system.tag));if(N.length>0)for(let M of N){let T=Object.keys(Q1).find((w)=>w.toLowerCase()===M.name.toLowerCase()),S=Q1[`${T}`];if(S?.offset){if(S.castingType){if(S.castingType.includes(P.kind)===!1)continue}if(S.castingClass){if(S.castingClass.includes(P.class)===!1)continue}delete P["cl.-=autoSpellLevelCalculationFormula"],P=foundry.utils.mergeObject(P,{"cl.autoSpellLevelCalculationFormula":S.offset});let w=await W.processFormula(S.offset,O);X+=w.total,this.app.processData.characterData.prestigeClassCasting.set(M.system.tag,Z)}}}}}else if(Q==="hd")P=foundry.utils.mergeObject(P,{class:"_hd",ability:"cha"});if(q)P.name=q;return this.app.processData.characterData.conversionValidation.spellBooks[Z]={casterLevel:+X,concentrationBonus:+G},await O.update({[`system.attributes.spells.spellbooks.${Z}`]:P}),Z}async processSpellRow(J,Z,Q){let Y;if((Y=J.match(/^(\d+)\s*\bPE\b/))!==null){let H=Y[1];await SBC.actor.update({[`system.attributes.spells.spellbooks.${Z}.spellPoints`]:{maxFormula:H,value:+H}}),Q.isSpellRow=!0}else if((Y=J.match(/(\d+)\s*(?!rounds)?\/(?:day|week|month|year)/i))!==null)Q.spellsPerXTotal=Y[1],Q.isSpellRow=!0;else if((Y=J.match(/(^\d)/))!==null)Q.spellLevel=Y[1],Q.isSpellRow=!0;else if((Y=J.match(/\d+\/([a-zA-Z]*)\)*-/))!==null)Q.spellsPerX=Y[1]}processFrequencies(J,Z){switch(!0){case/Constant/i.test(J):Z.isSpellRow=!0,Z.frequency=q0.Constant,Z.isAtWill=!0;break;case/At[- ]will/i.test(J):Z.isSpellRow=!0,Z.frequency=q0.AtWill,Z.isAtWill=!0;break;case/\d+\s*(?:rounds)?\/day/i.test(J):Z.frequency=q0.Daily;break;case/\d+\s*(?:rounds)?\/week/i.test(J):Z.frequency=q0.Weekly;break;case/\d+\s*(?:rounds)?\/month/i.test(J):Z.frequency=q0.Monthly;break;case/\d+\s*(?:rounds)?\/year/i.test(J):Z.frequency=q0.Yearly;break;default:}}async processSpell(J,Z,Q,Y,H,X,G,z,_){let[q,K,V,j,P]=X0.processSpellName(J);if(q==="")return;let[O,L]=[null,null],E={search:new Set([q,K]),type:"spell",item:q};E.search=W.createSearchSet([q,K],!0,H.concat(X));let[B,N]=await this.findSpellEntities(E),M=_||!B?N:B;if(M===null)if(!_)M=await W.generatePlaceholderEntity(E,G);else E.type="classFeat",M=await W.generatePlaceholderEntity(E,G);let T=W.checkForDuplicateItem(SBC.actor,"feat","classFeat",q,M);if(!T)T=W.checkForDuplicateItem(SBC.actor,"feat","misc",q,M);let S=-1,w=V.match(/\bDC\b\s*(\d+)(?:,\s)?/);if(w)S=w[1],V=V.replace(w[0],"").trim();let x=V.match(/(?<![+-]\s*\d*\s*|level\s*)\b(\d+)\b(?!\s*d\s*\d*\s*[+-]|\s*lbs|\s*kg|\s*%|\s*rounds)[,)]?/i),p=1;if(x)p=parseInt(x[1]),V=V.replace(x[1],"").replace(/[,;]\s*$/,"").trim();if(V!=="")J=W.capitalize(q)+" ("+V+")";else J=W.capitalize(q);if(M.type==="feat"||T){if(!T)await W.addAssociatedClass(M,SBC.actor.itemTypes.class),M.name=J,[O,L]=await g(M);else L=T;await X0.setFeatureUses(L,p,Z.frequency),await L.update({name:J}),z.spells.push({name:L.name,prepCount:1,dc:-1,domain:!1});return}if(Z.wizardSchool&&Z.wizardSchool===M.system.school)j=!0;let b={name:J,"system.spellbook":Q};if(P)b.name+=" (Mythic)";if(Z.spellLevel!==-1)b["system.level"]=+Z.spellLevel;let s=J.match(/(\d+)\s*PE/);if(s!==null)b["spellPoints.cost"]=`${s[1]}`;switch(await this.processSpellSlots(Z,M,b,Q,Y,p,j),b["system.atWill"]=Z.isAtWill&&(M.system.level>0||Z.isSpellLike),Z.frequency){case q0.Constant:case q0.Weekly:case q0.Monthly:case q0.Yearly:b.name=W.translate(`spellFrequency.${Z.frequency}`)+": "+M.name;break;default:break}if(j)Object.assign(b,{"system.domain":!0,"system.slotCost":1});await M.updateSource(b),W.log("Spell Updates",b);try{[O,L]=await g(M)}catch(C){console.error(C)}await L.update(b),await this.processSpellDC(L,S,Q),z.spells.push({name:L.name,prepCount:p,dc:S,domain:!M.system?.school?j:!1})}async processSpellSlots(J,Z,Q,Y,H,X,G){let z=SBC.actor;if(!J.spellRowIsInitialized)await z.update({[`system.attributes.spells.spellbooks.${Y}.spells.spell${Z.system.level}.base`]:0}),J.spellRowIsInitialized=!0;if(!J.isAtWill&&!J.isConstant){if(J.spellsPerXTotal!==-1&&J.isSpellLike){if(Object.assign(Q,{"system.uses.max":+J.spellsPerXTotal,"system.uses.value":+J.spellsPerXTotal,"system.uses.per":J.spellsPerX,"system.preparation.max":+J.spellsPerXTotal,"system.preparation.value":+J.spellsPerXTotal}),Z.system.level===0)Object.assign(Q,{"system.uses.autoDeductChargesCost":"1"});W0[Y][`${Z.system.level}`].base+=+J.spellsPerXTotal,W0[Y][`${Z.system.level}`].max+=+J.spellsPerXTotal}else if(J.spellsPerXTotal!==-1&&H==="spontaneous"&&!J.isSpellLike)W0[Y][`${Z.system.level}`].base=+J.spellsPerXTotal,W0[Y][`${Z.system.level}`].max=+J.spellsPerXTotal;else if(H==="prepared"&&J.spellsPerXTotal===-1)Object.assign(Q,{"system.preparation.max":X,"system.preparation.value":X}),W0[Y][`${Z.system.level}`].base+=X,W0[Y][`${Z.system.level}`].max+=X;if(G)W0[Y][`${Z.system.level}`].base-=1,W0[Y][`${Z.system.level}`].max-=1}else if(Z.system.level===0&&H==="prepared")Object.assign(Q,{"system.preparation.max":X,"system.preparation.value":X})}async processSpellDC(J,Z,Q){let Y,H=SBC.actor.system.attributes.spells.spellbooks[Q].ability,X=SBC.actor.system.abilities[H].mod,G=10+ +J.system.level+ +X;if(Y=+Z-+G,Z!==-1&&J.system.actions.length>0){let z=J.system.actions,_=J.actions.get(J.actions.contents[0].id);if(_)await _.update({"save.dc":Y}),z[0]=_,await J.update({"system.actions":z})}}async parseSpellbookSpecials(J,Z,Q){let Y=null,H="",X="",G,z=0,_=SBC.compendiumSearch,q={search:new Set,type:"feat"},K={itemType:"feat",itemSubType:"classFeat",classes:this.app.processData.characterData.classes,race:this.app.processData.characterData.race},V=SBC.actor;do{if((G=J.match(/(?!Domain spell)Domains?\s*(.*?)(?:;|$)/i))!==null||(G=J.match(/Domain\s*spells*\s*\((.*?)\)\s*(?:;|$)/i))!==null){H=W.translate("spellFeature.domain")+": ",Y={label:H.replace(":",""),value:G[1]};for(let j of G[1].split(",")){j=W.parseSubtext(j)[0];let P=j.match(/\((.*) subdomain\)/i);if(P)q.search.add(`${P[1].capitalize()} Subdomain`),q.search.add(P[1].capitalize());else q.search.add(`${j.capitalize()} Domain`),q.search.add(`${j.capitalize()} Subdomain`),q.search.add(j.capitalize());q.item=j;let O=await _.findEntityInCompendia(q,K);if(q.search.clear(),O)await W.addAssociatedClass(O,V.itemTypes.class),await g(O);else H+=`${j}, `,z++}H=z>0?H.slice(0,-2):"",X="domains";break}if((G=J.match(/Myster[y|ies]\s*(.*?)(?:;|$)/i))!==null){H=W.translate("spellFeature.mystery")+": ",Y={label:H.replace(":",""),value:G[1]};for(let j of G[1].split(",")){j=W.parseSubtext(j)[0],q.search.add(`${j.capitalize()} Mystery`),q.search.add(j.capitalize()),q.item=j;let P=await _.findEntityInCompendia(q,K);if(q.search.clear(),P)await W.addAssociatedClass(P,V.itemTypes.class),await g(P);else H+=`${j}, `,z++}H=z>0?H.slice(0,-2):"",X="mysteries";break}if((G=J.match(/(?!Spirit magic spell)Spirits?\s*(.*?)(?:;|$)/i))!==null){H=W.translate("spellFeature.spirit")+": ",Y={label:H.replace(":",""),value:G[1]};for(let j of G[1].split(",")){j=W.parseSubtext(j)[0],q.search.add(`${j.capitalize()} Spirit`),q.search.add(j.capitalize()),q.item=j;let P=await _.findEntityInCompendia(q,K);if(q.search.clear(),P)await W.addAssociatedClass(P,V.itemTypes.class),await g(P);else H+=`${j}, `,z++}H=z>0?H.slice(0,-2):"",X="spirits";break}if((G=J.match(/Bloodlines?\s*(.*?)(?:;|$)/i))!==null){H=W.translate("spellFeature.bloodline")+": ",Y={label:H.replace(":",""),value:G[1]};for(let j of G[1].split(",")){j=W.parseSubtext(j)[0],q.search.add(`${j.capitalize()} Bloodline`),q.search.add(j.capitalize()),q.item=j;let P=await _.findEntityInCompendia(q,K);if(q.search.clear(),P)await W.addAssociatedClass(P,V.itemTypes.class),await g(P);else H+=`${j}, `,z++}H=z>0?H.slice(0,-2):"",X="bloodlines";break}if((G=J.match(/Patrons?\s*(.*?)(?:;|$)/i))!==null){H=W.translate("spellFeature.patron")+": ",Y={label:H.replace(":",""),value:G[1]};for(let j of G[1].split(",")){j=W.parseSubtext(j)[0],q.search.add(`${j.capitalize()} Patron`),q.search.add(j.capitalize()),q.item=j;let P=await _.findEntityInCompendia(q,K);if(q.search.clear(),P)await W.addAssociatedClass(P,V.itemTypes.class),await g(P);else H+=`${j}, `,z++}H=z>0?H.slice(0,-2):"",X="patrons";break}if((G=J.match(/(Opposition|Prohibited) Schools\s(.*?)(?:;|$)/i))!==null){let[j,P,O]=G;H=W.translate(`spellFeature.${P.toLowerCase()}`)+": "+O,X="oppositions"}if((G=J.match(/Thassilonian Specialization\s*(.*?)(?:;|$)/i))!==null){if(H=W.translate("spellFeature.thassilonianSpecialist")+": ",G[1])await V.update({[`system.attributes.spells.spellbooks.${Q}.domainSlotValue`]:2});Y={label:H.replace(":",""),value:G[1]};for(let j of G[1].split(",")){j=W.parseSubtext(j)[0],q.search.add(`${j.capitalize()} School`),q.search.add(j.capitalize()),q.item=j;let P=await _.findEntityInCompendia(q,K);if(q.search.clear(),P)await W.addAssociatedClass(P,V.itemTypes.class),await g(P);else H+=`${j}, `,z++}H=z>0?H.slice(0,-2):"",X="thassilonianSpecialist";break}if((G=J.match(/Inquisitions?\s*(.*?)(?:;|$)/i))!==null){H=W.translate("spellFeature.inquisition")+": ",Y={label:H.replace(":",""),value:G[1]};for(let j of G[1].split(",")){j=W.parseSubtext(j)[0],q.search.add(`${j.capitalize()} Inquisition`),q.search.add(j.capitalize()),q.item=j;let P=await _.findEntityInCompendia(q,K);if(q.search.clear(),P)await W.addAssociatedClass(P,V.itemTypes.class),await g(P);else H+=`${j}, `,z++}H=z>0?H.slice(0,-2):"",X="inquisition";break}}while(!1);if(H!==""){let j=await W.generatePlaceholderEntity({name:H,type:X},Z);await g(j)}return Y}static processSpellName(J){let Z=!1,Q=!1,Y=W.parseSubtext(J),H=Y[0].trim(),X=Y[1]?.trim()??"",G=J.replace(new RegExp(`(${J0(H)}\\s|\\(${J0(X)}\\))`,"g"),"").trim(),z=H;if(H==="")return[H,z,X,Z,Q];if(H.endsWith("D"))Z=!0,H=H.substring(0,H.length-1);else if(X.endsWith("D"))Z=!0,X=X.substring(0,X.length-1);else if(G.endsWith("D"))Z=!0;if(H.endsWith("M"))Q=!0,H=H.substring(0,H.length-1);else if(X.endsWith("M"))Q=!0,X=X.substring(0,X.length-1);else if(G.endsWith("M"))Q=!0;let _=H.match(new RegExp(`(${P0.join("\\b|\\b")})`,"gi"));if(_)z=H.replace(new RegExp(`(${_.join("\\b|\\b")})`,"gi"),"").trim();return[H,z,X,Z,Q]}async findSpellEntities(J,Z="both"){let Q=SBC.compendiumSearch,[Y,H]=[null,null];if(Z==="both"||Z==="spell")Y=await Q.findEntityInCompendia(J,{itemTypes:["spell"]});if(Z==="both"||Z==="classFeat")H=await Q.findEntityInCompendia(J,{itemTypes:["feat"],itemSubTypes:["classFeat","misc"],race:this.app.processData.characterData.race});return[Y,H]}static getDefaultSpellbookData(){return{name:"",inUse:!1,castPerDayAllOffsetFormula:"",preparedAllOffsetFormula:"",casterType:"high",class:"",cl:{formula:"",total:0},concentrationFormula:"",concentrationNotes:"",clNotes:"",ability:"int",autoSpellLevelCalculation:!0,autoSpellLevels:!0,psychic:!1,arcaneSpellFailure:!0,hasCantrips:!0,spellPreparationMode:"spontaneous",baseDCFormula:"10 + @sl + @ablMod",spellPoints:{useSystem:!1,value:0,maxFormula:"",restoreFormula:""},spells:{spell0:{castPerDayOffsetFormula:"",preparedOffsetFormula:""},spell1:{castPerDayOffsetFormula:"",preparedOffsetFormula:""},spell2:{castPerDayOffsetFormula:"",preparedOffsetFormula:""},spell3:{castPerDayOffsetFormula:"",preparedOffsetFormula:""},spell4:{castPerDayOffsetFormula:"",preparedOffsetFormula:""},spell5:{castPerDayOffsetFormula:"",preparedOffsetFormula:""},spell6:{castPerDayOffsetFormula:"",preparedOffsetFormula:""},spell7:{castPerDayOffsetFormula:"",preparedOffsetFormula:""},spell8:{castPerDayOffsetFormula:"",preparedOffsetFormula:""},spell9:{castPerDayOffsetFormula:"",preparedOffsetFormula:""}},spellSlotAbilityBonusFormula:"",domainSlotValue:1,concentration:{total:0},isSchool:!0}}static getClassPostfixFromSpellbookName(J){if(!J)return[];if(J=J.toLowerCase(),J.includes("domain"))return["CLE","DRU","INQ"];else if(J.includes("bloodline"))return["SOR","BLO"];else if(J.includes("school"))return["WIZ"];else if(J.includes("mystery"))return["ORA"];else if(J.includes("patron"))return["WIT"];else if(J.includes("spirit"))return["SHA"];else return[]}static getHighestSpellLevelFreeSlots(J,Z){let Q=0;switch(J){case"bloodrager":Q=Math.max(0,Math.ceil((Z-6)/3));break;case"sorcerer":Q=Math.max(0,Math.ceil(Z-2)/2);break;case"oracle":Q=Math.max(0,Math.floor(Z/2));break;case"psychic":Q=Math.max(1,Math.floor(Z/2));break;default:break}let Y={};if(Q>0)for(let H=1;H<=Q;H++)Y[`spell${H}.preparedOffsetFormula`]="1";return Y}static async setFeatureUses(J,Z,Q){let Y={"system.uses.value":Z,"system.uses.max":Z};if(!J.system.uses.maxFormula)Y["system.uses.maxFormula"]=`${Z}`;switch(Q){case q0.Weekly:Y["system.uses.per"]="week";break;default:Y["system.uses.per"]="day";break}await J.update(Y)}}class V0 extends h{constructor(J,Z,Q,Y){super(J);this.targetValueFields=Z,this.targetModFields=Q,this.supportedType=Y}async parse(J,Z){if(W.log(W.translate("parser.ability.status",{value:J,fields:this.targetValueFields.join(", ")})),typeof J===this.supportedType)try{for(let Q of this.targetValueFields)await j0(SBC.actor,Q,J);return!0}catch(Q){return this.throwError(Q,"parser.ability.error",J,Z,{fields:this.targetValueFields.join(", "),modValue:W.getModifier(J),modFields:this.targetModFields.join(", ")}),!1}else return this.throwError(void 0,"parser.ability.typeError",J,Z,{type:this.supportedType}),!1}}class t0 extends h{get parserGroup(){return"Parser/Statistics"}get parserType(){return"gear"}async _parse(J,Z,Q=void 0){let Y=SBC.compendiumSearch;if(J==="none")return!0;J=J.replace(/\b(?:and|with)\s*(\d+)/gi,", $1").replace(/ioun stones \([^)]+\)/i,(_)=>_.substring(_.indexOf("(")+1,_.length-1).split(",").map((q)=>{return q.split("[")[0].trim()+" Ioun Stone"}).join(", ")).replace(/(scrolls \([^)]+\))/gi,(_)=>{return _.substring(9,_.length-1).split(/,? and |, /g).map((q)=>"scroll of "+q).join(", ")}).replace(/implanted ioun stones? \(((?:[^,)]+,?)+)\)/gi,(_)=>_.substring(0,_.length-1).split("(")[1].split(",").map((q)=>{let K=q.match(/(\d+)/)?.[1]||1;return`Ioun Stone ${q.replace(/\d+/,"").trim().replace(/s$/,"")} (${K}, Implanted)`}).join(", "));let H={pp:0,gp:0,sp:0,cp:0},X=this.splitText(J,!1),G=[],z=["consumable","equipment","loot","weapon","container","implant"];if(await W.runParallelOps(X,async(_)=>{let q=!1,K=null;if(_=_.trim().replaceAll("*","").replaceAll("[","(").replaceAll("]",")").replace(/(\d+)\s*doses(?! of)/i,"$1").replace(/^pair of /i,"2 ").replace(/\(as\s+(?:an?\s+)?/i,"(").replace(/^And\s/i,""),/^\d+\s/.test(_)&&!W.getMoneyFromString(_))_=_.replace(/^(\d+)(.*)/,"$2 ($1)").trim();let V=0,j=!1;if(_.match(/\d+\s+[pscg]p\s+in\b/i)){let R;[R,_]=_.split(/\bin\b/i),_=`${_} worth ${R}`}if(_.match(/\bworth\b/i)){let R;[_,R]=_.split(/\bworth\b/i);let{worth:v,rest:U}=/(?<worth>(?:\s*\d+\s*[pgsc]p\s*){1,4})(?:each|for the pair|total|in all)?(?<rest>.*)/g.exec(R).groups;j=v.match(/for the pair|total|in all/i)!==null,_=(_+U).replace(/,\s*,\s*/g,", ").replace(/\(\s*,\s*/g,"(").replace(/\s*,\s*\)/g,")").replace(/\s{2,}/," ").replace(/\(\s*\)/g,"").trim().trim(),V=W.convertMoneyToGold(W.getMoneyFromString(v))}let P=0;if(/\+?\d+ Str\b/i.test(_))P=+_.match(/(\d+) Str\b/i)[1].trim(),_=_.replace(/\s*\(\+?\d+ Str\)/i,"").trim();let O=W.parseSubtext(_),L=O[0],E=O[1],B=new Set([_,L,E].filter((R)=>R));if(B.add(L.replace(/(^\d+|masterwork|mwk)/g,"").trim()),K=_?.match(/(?:\b|\()(?:focus\s+)?for\b/)){q=!0;let R=_.split(K[0])[0].trim();B.add(R)}let N=1,M="",T="",S=[],w=0,x={},p=SBC.actor.system.traits.size.base||"med",b="",s=null;[...B].forEach((R)=>{B.add(R.replace(/s of\b/i," of"))});let C=SBC.config.sillyGear,e=Object.keys(C);if([...B].forEach((R)=>{let v=W.haystackRegexSearch(e,R);if(v){let U=new RegExp(v,"i");B.add(R.replace(U,C[v])),q=!0}}),[...B].forEach((R)=>{if(K=R.match(/(\d+) charges?/i))s=+K[1],B.add(R.replace(K[0],"").replace(/\(\s*,\s*/,"(").replace(/\(\s*\)/,"").trim())}),[...B].forEach((R)=>{if((K=R.match(x0()))!==null)p=W.getKeyByValue(n("actorSizes"),K[0])||"med",B.add(R.replace(K[0],"").trim())}),[...B].forEach((R)=>{if((K=R.match(_$()))!==null)B.add(R.replace(K[0],"").trim()),b=K[0]}),E?.length){let R=_.match(/\((\d+)\s*(?:\)\s*$|,\s*)/);if(R)N=+R[1],B.add(E.replace(new RegExp(`^${R[1]}`),"").replace(/^\s*,\s*/,"").trim()),B.add(_.replace(new RegExp(`\\(\\s*${R[1]}`),"(").replace(/\(\s*,\s*/,"(").replace("()","").trim())}if([...B].forEach((R)=>{if(R.toLowerCase().includes("rod")&&R.toLowerCase().includes("metamagic")){let v=R.match(/(lesser|normal|greater)/i)?.[0]||"";if(R=R.replace(/rod(?: of)?/i,"").replace(/metamagic/i,"").replace(v,"").trim(),R.toLowerCase().includes("elemental"))R="Elemental",q=!0;R=`${R} Metamagic Rod, ${W.capitalize(v)}`,B.add(R)}}),[...B].forEach((R)=>{let v;if(v=R.toLowerCase(),v.includes("holy symbol")){let U=v.match(/\b(?:wood|silver|gold|iron|platinum|flask|tattoo)/gi)?.[0]||"wood";if(v.startsWith(U.toLowerCase()))v=v.split(" ").slice(1).join(" ");if(v.includes("unholy"))q=!0;if(!v.split(" ")[0].includes("holy"))q=!0,U="iron";if(v.includes(" of "))q=!0;B.add(`Holy Symbol (${U.capitalize()})`)}}),[...B].forEach((R)=>{if((K=R.match(_1()))!==null)B.add(R.replace(_1(),"").trim()),B.add(R.replace(_1(),"").trim()+` (${K[0]})`)}),[...B].forEach((R)=>{if((K=R.match(J$()))!==null)B.add(R.replace(K[0],"").trim()+` (${K[0]})`),B.add(R.replace(K[0],"").trim()+` ${K[0]}`)}),[...B].forEach((R)=>{if((K=Z$().exec(R))!==null)B.add(`${K[2]} (${K[1]})`),B.add(K[2])}),[...B].forEach((R)=>{if(R.search(s1())!==-1){let v=R.match(A0());M=v?v[0]:M,M=pf1.registry.materials.contents.find((U)=>z0(U)===W.capitalize(M??"")||U.id===M)?.id??null,B.add(R.replace(A0(),"").replace(/\s{2,}/," ").trim())}}),_.match(/amulet of mighty fist/i)){w=+_.match(/\+[12345]/)?.[1]||0;let R=f1();while((K=R.exec(_))!==null){let v=K.groups,U=W.getMagicAbility(v.ability,v.prefix||v.postfix||void 0);x[U.name]=U}q=!0,B.add("Amulet of Mighty Fists"+(w?` +${w}`:"+1")),V=this.calculateItemPrice({name:"",type:"weapon",system:{price:0}},{material:null,addons:[],enhancementValue:w,enhancementTypes:Object.values(x)})*2}else[...B].forEach((R)=>{if(R.match(/\+[12345]/)&&!R.match(/\d$/))w=+R.match(/[12345]/)[0].trim(),R=R.replace(/\+[12345]/,"").trim(),B.add(R);if(w){let v=f1(),U=R;while((K=v.exec(U))!==null){let t=K.groups,d=W.getMagicAbility(t.ability,t.prefix||t.postfix||void 0);if(d.hasSpecialTerm)if(t.ability.toLowerCase()==="bane"){let[o,c]=W.extractCreatureTypeInfo(R);R=R.replace(o,"").replace(c,"").replace(`-${t.ability}`,"").trim(),d.specialTerm=`${o} ${c}`}else{let o=R.match(new RegExp("\\b(?:([a-z-]+)[- ])?"+d.name+"(?: \\(([^)]+)\\))?","i")),c=o[1]||o[2];if(c)d.specialTerm=c;R=R.replace(o[0],"")}else R=R.replace(K[0],"");B.add(R.replace(/\s{2,}/g," ").trim()),x[d.name]=d}}});[...B].forEach((R)=>{if((K=Q$().exec(R))!==null)B.add(R),B.add(R.replace(K[0],"").trim()),q=!0}),[...B].forEach((R)=>{B.add(R.replace(/\W?(Integrated|Implanted|Timeworn)\W?/gi,""))}),[...B].forEach((R)=>{if(R.includes("ironwood"))B.add(R.replace(/\bironwood\b\s+/i,"")),T="iron",q=!0}),this.handleSpecialCases(B,E),[...B].forEach((R)=>{if(R.search(/\b(?:physical might|mental prowess)\b/i)!==-1)R=R.replace(/Intelligence/i,"Int").replace(/Wisdom/i,"Wis").replace(/Charisma/i,"Cha").replace(/Strength/i,"Str").replace(/Dexterity/i,"Dex").replace(/Constitution/i,"Con"),B.add(R.replace(/(Str|Dex|Con|Int|Wis|Cha),\s*(Dex|Con|Wis|Cha)/i,"$1 & $2")),q=!0}),[...B].forEach((R)=>{if(R.search(U0())!==-1)S=R.match(U0()).map((U)=>{let t=U[0]+U.slice(1).replace(/\s/,"");return pf1.registry.materials.find((d)=>d.id===t||z0(d).toLowerCase()===U.toLowerCase())?.id??null}).filter((U)=>!!U),B.add(R.replace(U0(),""))});let I={type:"loot",name:L.replace(/^([\d+]+|\b(?:masterwork|mwk|broken|timeworn)\b)/gi,"").trim(),rawName:N>1?this.stripQuantity(W.singularize(_)):_,subtext:E,price:j?V/N:V,value:0,size:p,fluffTerm:b,enhancementValue:w,enhancementTypes:Object.values(x),maxStrength:P,charges:s,mwk:/\bmasterwork\b|\bmwk\b/i.test(L)||w>0,quantity:N,timeworn:/\btimeworn\b/i.test(L),broken:/\bbroken\b/i.test(L),material:M,baseMaterial:T,addons:S,implanted:null};[...B].forEach((R)=>{B.add(R?.replace(/ies\s*$/gi,"y")),B.add(R.replace(/ives/gi,"ife")),B.add(R?.replace(/(?!Charges)s\s*$/gi,""))}),console.log(_,B);let r=Object.keys(I),u={},y=W.getMoneyFromString(L);if(y){H.pp+=y.pp,H.gp+=y.gp,H.sp+=y.sp,H.cp+=y.cp;return}else if(W1().test(L)){W1().lastIndex=0,I.type="consumable";let R=L.match(W1()),v=this.getConsumableType(R[1]?.toLowerCase()),U=R[2].replace(/\+\d+/,"").trim(),t=R[2].match(/\+(\d+)/)?.[1]??0,d=parseInt(E?.match(/(\d+) charges/i)?.[1]??(/wand/i.test(v)?50:1)),o=E?.match(/CL\s*(\d+)/i)?.[1]??-1,c=null;if(u=await Y.findEntityInCompendia({search:new Set([`${v} of ${U}`]),item:`${v} of ${U}`},{itemType:"consumable"}),!u){if(u=await Y.findEntityInCompendia({search:new Set([U,W.singularize(U)]),item:U},{itemType:"spell"}),u){let k=u.toObject();if(t){let D=await Y.findEntityInCompendia({search:k.name,item:k.name},{itemType:"buff"});if(D){let l=D.system.changes[0].formula;for(let Q0=1;Q0<=20;Q0++)if((await new pf1.dice.RollPF(l,{item:{level:Q0}}).evaluate()).total===+t){k.cl=Q0;break}}}c=await CONFIG.Item.documentClasses.spell.toConsumable(k,v==="oil"?"potion":v)}}else c=u;if(c){if(v==="wand")I.charges=d;if(o>0)c.system.cl=parseInt(o);if(t)c.name+=` +${t}`,I.enhancementValue=0;if(v==="oil")c.name=c.name.replace("Potion","Oil"),c.system.unidentified.name=c.system.unidentified.name.replace("Potion","Oil");u=new Item.implementation(c)}}else if(u=await Y.findEntityInCompendia({search:B,item:_},{itemTypes:z}),u?.type==="implant")I.implanted=!0;if(E&&u?.name?.toLowerCase()===E.toLowerCase())q=!0;if(u&&Object.keys(u).length!==0){let R=q?W.capitalize(I.rawName):this.buildItemName(u,I),v=this.calculateItemPrice(u,I);if(u.system.price!==v)I.price=v;let U={name:R,"system.identifiedName":R};for(let t=0;t<r.length;t++){let d=r[t],o=I[d];if(!o||Array.isArray(o)&&!o.length)continue;switch(d){case"implanted":if(J!==null)U["system.implanted"]=o;break;case"charges":if(u.system?.uses?.per==="charges")U["system.uses.value"]=o;break;case"material":{let c=pf1.registry.materials.get(o)||null;if(!c)break;let k=Array.isArray(c.baseMaterial)?c.baseMaterial:[c.baseMaterial],D=I.baseMaterial||u.system?.material?.base?.value||u.system?.armor?.material?.base?.value;switch(D=k.includes(D)?D:k[0],u.type){case"weapon":U["system.material.normal.value"]=o,U["system.material.base.value"]=D;break;case"equipment":if(["armor","shield"].includes(u.system.subType))U["system.armor.material.normal.value"]=o,U["system.armor.material.base.value"]=D;break}Object.assign(U,this.applyMaterialInfo(u,I,I.material));break}case"size":U["system.size"]=o;break;case"maxStrength":if(u.type==="weapon"){let c=u.toObject().system.actions??[];c.forEach((k)=>setProperty(k,"ability.max",o)),U["system.actions"]=c}break;case"addons":{switch(u.type){case"weapon":U["system.material.addon"]=o;break;case"equipment":if(["armor","shield"].includes(u.system.subType))U["system.armor.material.addon"]=o;break}o.forEach((c)=>Object.assign(U,this.applyMaterialInfo(u,I,c)));break}case"enhancementTypes":{let c=u.system.description.value,k=+(I.enhancementValue||0)*3,D=[];if(o.forEach((l)=>{k=Math.max(k,l.cl),D.push(l.aura),c+=`
<h3>`+W.translate(`specialAbilities.${l.name}.name`)+`</h3>
`+W.translate(`specialAbilities.${l.name}.description`)}),U["system.description.value"]=c,U["system.cl"]=k,D=D.filter((l,Q0)=>D.indexOf(l)===Q0),D.length===1)U["system.aura.school"]=D[0];else U["system.aura.custom"]=!0,U["system.aura.school"]=D.map((l)=>W.translate(`auras.${l}`)).join(", ");break}case"enhancementValue":switch(u.type){case"weapon":U["system.enh"]=+o,U["system.masterwork"]=!0,U["system.aura.school"]="evo";break;case"equipment":U["system.armor.enh"]=+o,U["system.masterwork"]=!0,U["system.aura.school"]="abj";break}U["system.hp.max"]=u.system.hp.max+o*10,U["system.hp.value"]=u.system.hp.value+o*10,U["system.cl"]=+o*3;break;case"price":U["system.price"]=+o;break;case"mwk":U["system.masterwork"]=o;break;case"value":U["system.price"]=+o;break;case"quantity":U["system.quantity"]=+o;break;case"timeworn":U["system.timeworn"]=o;break;case"broken":U["system.broken"]=o;break;default:break}}if(Object.keys(U).length)console.log(W.translate("parser.gear.parseInfo"),U),await u.updateSource(U);await g(u)}else{I.name=_;let R=await W.generatePlaceholderEntity(I,Z);await g(R),G.push(I.name)}}),H.pp||H.gp||H.sp||H.cp){let _=((H.pp?W.translate("money.pp",{value:H.pp}):"")+" "+(H.gp?W.translate("money.gp",{value:H.gp}):"")+" "+(H.sp?W.translate("money.sp",{value:H.sp}):"")+" "+(H.cp?W.translate("money.cp",{value:H.cp}):"")).replace(/\s{2,}/," ").trim(),q={type:"container",name:W.translate("moneyPouch",{money:_}),currency:H},K=await W.generatePlaceholderEntity(q,Z);await g(K)}if(G.length>0)this.logInfo("parser.gear.generatedPlaceholders",G[0],Z,{items:G.join(", ")});return this.app.processData.notes.statistics.gear=this.getItemNotes(),!0}applyMaterialInfo(J,Z,Q){let Y={},H=pf1.registry.materials.get(Q)||null;if(!H)return Y;if(H.hardness)Y["system.hardness"]=H.hardness+Z.enhancementValue*2;if(H.healthMultiplier)Y["system.hp.max"]=Math.max(1,Math.floor(J.system.hp.max*H.healthMultiplier)+Z.enhancementValue*10),Y["system.hp.value"]=Math.max(1,Math.floor(J.system.hp.value*H.healthMultiplier)+Z.enhancementValue*10);if(H.masterwork)Y["system.masterwork"]=!0;if(H.weight.multiplier!==1)Y["system.weight.value"]=J.system.weight*H.weight.multiplier;if(H.weight.bonusPerPound)Y["system.weight.value"]=J.system.weight*(1+H.weight.bonusPerPound);if(J.type==="equipment"){let X=H[J.system.subType]||{acp:0,maxDex:0,asf:0};if(X.acp)Y["system.armor.acp"]=Math.max(0,J.system.armor.acp-X.acp);if(X.maxDex&&J.system.armor.dex)Y["system.armor.dex"]=J.system.armor.dex+X.maxDex;if(X.asf)Y["system.spellFailure"]=Math.max(0,J.system.spellFailure+X.asf)}return Y}buildItemName(J,Z){let Q=[J.name];if(Z.maxStrength)Q.unshift(`(+${Z.maxStrength} ${W.translate("str")})`);if(Z.addons.forEach((Y)=>{let H=pf1.registry.materials.get(Y);if(H)Q.push(H.name)}),Z.material&&!Z.name.match(/\bwand\b/i)){let Y=pf1.registry.materials.get(Z.material);if(Y&&!J.name.includes(Y.name))Q.push(Y.name);else Z.material=null}if(Z.enhancementTypes.forEach((Y)=>{Q.push((Y.hasSpecialTerm?W.capitalize(Y.specialTerm)+"-":"")+W.translate(`specialAbilities.${Y.name}.name`))}),Z.timeworn)Q.push(W.translate("timeworn"));if(Z.broken)Q.push(W.translate("broken"));if(Z.enhancementValue&&!J.name.match(new RegExp(`\\+${Z.enhancementValue}`)))Q.push("+"+Z.enhancementValue);else if(Z.mwk)Q.push(W.translate("masterwork"));if(Z.fluffTerm)Q.push(W.capitalize(Z.fluffTerm));if(Z.size&&Z.size!=="med")Q.push(n("actorSizes")[Z.size]);return Q.reverse().join(" ")}calculateItemPrice(J,Z){if(Z.price)return Z.price;let Q=J.system.price||0;if(Q+=this.calculateMaterialPrice(J,Z,Z.material),Z.addons.forEach((H)=>Q+=this.calculateMaterialPrice(J,Z,H)),Z.mwk)if(J.system.subType==="ammo"||Z.name.toLowerCase()==="shuriken"||Z.name.toLowerCase()==="crystal chakram")Q+=6;else Q+=J.type==="weapon"?300:150;let Y=Z.enhancementValue;if(Z.enhancementTypes.forEach((H)=>{if(H.bonus)Y+=H.bonus;if(H.staticCost)Q+=H.staticCost}),Y){let H=J.type==="weapon"?2000:J.type==="equipment"?1000:40;if(J.name.toLowerCase()==="shuriken"||J.name.toLowerCase()==="crystal chakram")H=40;Q+=Math.pow(Y,2)*H}if(Z.maxStrength){let H=Z.rawName.match(/longbow/i);Q+=Z.maxStrength*(H?100:75)}return Q}calculateMaterialPrice(J,Z,Q){let Y=parseFloat(J.system.price)||0,H=Y,X=pf1.registry.materials.get(Q);if(!X)return 0;switch(J.type){case"equipment":{if(J.system.subType!=="armor"&&J.system.subType!=="shield")break;if(X)switch(Y*=X.price.multiplier||1,J.system.subType){case"shield":Y+=X.price.shield||0;break;case"armor":switch(J.system.equipmentSubtype){case"lightArmor":Y+=X.price.lightArmor||0;break;case"mediumArmor":Y+=X.price.mediumArmor||0;break;case"heavyArmor":Y+=X.price.heavyArmor||0;break}break;default:Y+=X.price.perPound*J.system.weight.value;break}if(Z.mwk&&X?.masterwork)Y-=150;break}case"weapon":{if(X)Y*=X.price.multiplier||1;if(J.name.toLowerCase()==="shuriken"||J.name.toLowerCase()==="crystal chakram"){if(Y+=X.price.ammunition||0,Z.mwk&&X?.masterwork)Y-=6}else{switch(J.system.weaponSubtype){case"light":Y+=X.price.lightWeapon||0;break;case"1h":Y+=X.price.oneHandWeapon||0;break;case"2h":Y+=X.price.twoHandWeapon||0;break;case"ranged":Y+=X.price.rangedTwoHandWeapon||0;break;default:Y+=X.price.perPound*J.system.weight.value;break}if(Z.mwk&&X?.masterwork)Y-=300}break}case"loot":{if(J.system.subType!=="ammo")break;if(X)if(Y*=X.price.multiplier||1,X.price.ammunition)Y+=X.price.ammunition;else Y+=X.price.perPound*J.system.weight.value;if(Z.mwk&&!X?.masterwork)Y+=6;break}}if(Z.enhancementValue)Y+=X.enhancement?.weapon||0;return Y-H}getItemNotes(){let J=[],Z=SBC.actor,Q=["weapon","equipment","consumable","loot","container"];for(let Y of Q)Z.itemTypes[Y].forEach((H)=>{J.push({name:H.name,quantity:H.system.quantity||1,charges:H.system.uses?.per==="charges"?H.system.uses.value:null})});return J}getConsumableType(J){switch(!0){case J.search(/^(?:potion|oil)s?/i)!==-1:return"potion";case J.search(/^wands?/i)!==-1:return"wand";case J.search(/scrolls?/i)!==-1:return"scroll";default:return}}stripQuantity(J){return J.replace(/\(\d+\s*[,)]\s*/,"(").replace("()","").trim()}handleSpecialCases(J,Z){[...J].forEach((Q)=>{if(Q.search(/grenades?$/gi)!==-1)J.add(`Grenade (${Q.replace(/s$/,"")})`)}),[...J].forEach((Q)=>{if(Q.search(/black powder horn/i)!==-1)J.add(Q.replace(/black powder horn/i,"Powder Horn"))}),[...J].forEach((Q)=>{if(Q.includes("flail")&&(!Q.includes("light")||!Q.includes("heavy")))J.add(Q.replace(/flail/i,"Light Flail"))}),[...J].forEach((Q)=>{if(Q.search(/studded leather(?!\s*armor)/i)!==-1)J.add(Q.replace(/studded leather/i,"Studded Leather Armor"))}),[...J].forEach((Q)=>{if(Q.search(/lamellar\s*armor/i)!==-1)J.add(Q.replace(/lamellar armor/i,"Lamellar"))}),[...J].forEach((Q)=>{if(Q.toLowerCase().includes("pearl of power")){let Y=+Q.match(/(\d+)/)?.[1];if(Y){let H=["st","nd","rd"][Y-1]??"th";J.add(`Pearl of Power, ${Y}${H} Level Spell`)}}}),[...J].forEach((Q)=>{if(Q.match(/tool/i)&&Q.match(/artisan|thieves/i)){let Y=Q.includes("artisan")?"Artisan's":"Thieves'";J.add(Y+" Tools, "+(Q.match(/\b(?:mwk|masterwork)\b/i)?"Masterwork":"Common"))}}),[...J].forEach((Q)=>{if(Q.toLowerCase().includes("bullet"))J.add(Q.replace(/bullet/i,"Firearm Bullet"))}),[...J].forEach((Q)=>{if(Q.toLowerCase().includes("bolt"))J.delete(Q),J.add(Q.replace(/bolt/i,"Crossbow Bolt"))}),[...J].forEach((Q)=>{if(Q.toLowerCase().includes("alchemical")&&Q.toLowerCase().includes("cartridge")){Q=Q.replace(/alchemical(.*)cartridges?/gi,"$1 Alchemical Cartridge").replace(/\s{2,}/," ").trim();let Y=Q.toLowerCase().split("alchemical cartridge")[0].trim();J.add("Alchemical Cartridge ("+Y+(Z.includes("bullet")||Y==="paper"?", bullet or pellet":"")+")")}})}}class e0 extends h{get parserGroup(){return"Parser/Statistics"}get parserType(){return"language"}async _parse(J,Z,Q=void 0){let Y=J.split(/[,;]/g),H=[],X=[],G="";this.app.processData.notes.statistics.languages=[];for(let z=0;z<Y.length;z++){let _=Y[z].trim(),q=W.parseSubtext(_);if(q.length>1){_=q[0],G=q[1],H.push(`${_} (${G})`);continue}if(_.search($$())!==-1){let K=W.getKeyByValue(n("languages"),_);X.push(K)}else H.push(_)}return await SBC.actor.update({"system.traits.languages":X.concat(H).concat(SBC.actor.system.traits.languages.base)}),this.app.processData.notes.statistics.languages.push(...X,...H),!0}}class $1 extends h{get parserGroup(){return"Parser/Statistics"}get parserType(){return"skill"}versatilePerformanceSkillOverrides={};versatilePerformanceSkillDisablers={};async _parse(J,Z,Q=void 0){let[Y,H]=J.split(/racial (?:modifiers?|bonus)/i);Y=this.splitText(Y),H=H?this.splitText(H):[],this.app.processData.notes.statistics.skills=[];let X=SBC.actor.system.attributes.hd.total,G=[],z={},_={},q={},K=SBC.actor.items.contents;await W.runParallelOps(K,async(O)=>{let L=Object.keys(O.system.classSkills??{});for(let E=0;E<L.length;E++){let B=L[E];if(O.system.classSkills[B]===!0){if(!G.includes(B))G.push(B)}}await this.updateSkillChanges(O,_)});let V=0,j={art:1,crf:1,lor:1,prf:1,pro:1},P=(O)=>O.replace(/\bEnter Choice\b/gim,"any one").replace(/Arcane/gim,"Arcana").replace(/\bPer\./gim,"Perception").replace(/S\. Motive/gim,"Sense Motive").replace(/\bLing\./gim,"Linguistics");for(let O of H){let E=P(O).match(t1());if(!E)continue;let B=parseInt(E.groups.value),N=Object.keys(_).find((M)=>_[M].name===E.groups.name);if(N&&_[N].racial&&E.groups.context)z[E.groups.name.toLowerCase()]={name:E.groups.name,number:B,prefixedValue:W.prefixNumber(B),context:E.groups.context??""}}this.app.processData.notes.statistics.racialSkillModifiers=Object.keys(z).length?Object.values(z):null;for(let O=0;O<Y.length;O++){if(!Y[O])continue;let L=P(Y[O]);if(L.match(/[+-]?\s*\d+(?![^(]*\))/g)?.length>1){let N=L.split(/(?<=[-+]\d+) /);L=N.splice(0,1)[0],Y.push(...N)}let E=null,B=["Arcana","Dungeoneering","Engineering","Geography","History","Local","Nature","Nobility","Planes","Religion"];if(L.search(/knowledge|perform|craft|profession|lore|artistry/i)!==-1&&L.search(/,|\band\b|&/g)!==-1){let N=W.parseSubtext(L),M=N[0],T=N[2][0],S=N[1].split(/,|\band\b|&/g);for(let w=0;w<S.length;w++){let x=S[w].trim(),p=M+" ("+x+") "+T;Y.push(p)}continue}if(L.match(/\bknowledge\b/i)&&L.match(/\bany\b/i)){let N=W.parseSubtext(L),M=N[0],T=N[2][0],S=N[1].match(/\bany\b (.*)/i)[1],w=["one","two","three","four","five","six","even","eight","nine"].indexOf(S)+1,x="";for(let p=0;p<w;p++){let b=Math.floor(Math.random()*10),s=new RegExp(B[b],"i");if(x.search(s)===-1&&!Y.includes(s)){let C=B[b],e=M+" ("+C+") "+T;Y.push(e),x+=e}else p--}continue}if(L.match(/\bknowledge\b/i)&&L.match(/\ball\b/i)){let N=W.parseSubtext(L),M=N[0],T=N[2][0];for(let S=0;S<B.length;S++){let w=B[S].trim(),x=M+" ("+w+") "+T;Y.push(x)}continue}E=W.parseSubtext(L);try{let N=E[0].replace(/[+-]?\s*\d+/g,"").trim(),M=E[0].replace(N,"").replace(/\s/g,""),T="",S="";if(E[1])if(E[1].startsWith("+"))S=E[1];else T=E[1];if(E[2]){if(M===""&&E[2][1])S=E[2][1];M=E[2][0]}let w=N+" ("+T+")",x="";if(N.match(w1()))x=W.getKeyByValue(n("skills"),N);else if(w.match(w1()))N=w,x=W.getKeyByValue(n("skills"),w);else x="skill";let p=SBC.actor.system.traits.size.base,b=0;if(x!=="skill"){let s=SBC.actor.system.skills[x].ability,C=SBC.actor.system.abilities[s].mod;switch(x){case"fly":b=pf1.config.sizeFlyMods[p];break;case"ste":b=pf1.config.sizeStealthMods[p];break;default:break}let e={name:N,key:x,total:+M,abilityMod:+C,classSkill:G.includes(x),sizeMod:+b,racialModifiers:z,changes:_,acp:SBC.actor.system.skills[x].acp,acpTotal:SBC.actor.system.attributes.acp.total,maxRanks:X,speedBonus:["swm","clm"].includes(x)?SBC.actor.system.attributes.speed[x==="swm"?"swim":"climb"].base>0?8:0:0,isOutsider:SBC.app.processData.characterData.isOutsider,outsiderSkillPicks:SBC.app.processData.characterData.outsiderSkillPicks,outsiderSkills:SBC.app.processData.characterData.outsiderSkills,isExpert:SBC.app.processData.characterData.isExpert,expertSkillPicks:SBC.app.processData.characterData.expertSkillPicks,expertSkills:SBC.app.processData.characterData.expertSkills},[I,r,u]=this.calculateSkillRanks(e);if(r){if(u==="outsider")SBC.app.processData.characterData.outsiderSkillPicks-=1,SBC.app.processData.characterData.outsiderSkills.push(x);else SBC.app.processData.characterData.expertSkillPicks-=1,SBC.app.processData.characterData.expertSkills.push(x);e.classSkill=!0}let y=z[N.toLowerCase()]?.context.length?`${S?"; ":""}${z[N.toLowerCase()].prefixedValue}${z[N.toLowerCase()].context}`:"";if(x.search(/(art|crf|lor|prf|pro)/)===-1)await SBC.actor.update({[`system.skills.${x}.rank`]:I}),q[x]={},await W.runParallelOps(K,async(R)=>{await this.updateSkillChanges(R,q)}).then(async()=>{let R=Object.assign({},e,{skillChanges:q}),[v,U,t]=this.calculateSkillRanks(R);if(U){if(t==="outsider")SBC.app.processData.characterData.outsiderSkillPicks-=1,SBC.app.processData.characterData.outsiderSkills.push(x);else SBC.app.processData.characterData.expertSkillPicks-=1,SBC.app.processData.characterData.expertSkills.push(x);e.classSkill=!0}if(I!==v)await SBC.actor.update({[`system.skills.${x}.rank`]:v})}),this.app.processData.characterData.conversionValidation.skills[x]={total:+M,context:S.replace(/\+?(-?\d+)/g,(R)=>W.prefixNumber(+R-+M))+y},this.app.processData.notes.statistics.skills.push({name:n("skills")[x]||N,prefixedValue:M>=0?"+"+ +M:M,context:S});else{let R=x+ +j[x],v=Object.assign({},e,{key:R,skillChanges:q});await SBC.actor.update({[`system.skills.${x}.subSkills.${R}`]:{ability:SBC.actor.system.skills[x].ability,acp:SBC.actor.system.skills[x].acp,cs:SBC.actor.system.skills[x].cs,name:T.capitalize(),rank:I,rt:SBC.actor.system.skills[x].rt}}),q[x]={},await W.runParallelOps(K,async(U)=>{await this.updateSkillChanges(U,q)}).then(async()=>{let[U,t,d]=this.calculateSkillRanks(v);if(I!==U)await SBC.actor.update({[`system.skills.${x}.subSkills.${R}`]:{ability:SBC.actor.system.skills[x].ability,acp:SBC.actor.system.skills[x].acp,cs:SBC.actor.system.skills[x].cs,name:T.capitalize(),rank:U,rt:SBC.actor.system.skills[x].rt}})}),this.app.processData.characterData.conversionValidation.skills[R]={name:T.capitalize(),total:+M,context:S.replace(/\d+/g,(U)=>+U-+M)},this.app.processData.notes.statistics.skills.push({name:n("skills")[x]+` (${T.capitalize()})`,prefixedValue:M>=0?"+"+ +M:M,context:S}),j[x]++}}else{let s="skill";if(V>0)s="skill"+(+V+1);let C=SBC.actor.system.abilities.int.mod,e=+M-+C;if(_[s]!==null&&_[s]!==void 0)e-=_[s];await SBC.actor.update({[`system.skills.${s}`]:{ability:"int",acp:!1,background:!1,cs:!1,custom:!0,name:N,rank:e,rt:!1}}),this.app.processData.characterData.conversionValidation.skills[s]={name:N,total:+M,context:S.replace(/\d+/g,(I)=>+I-+M)},this.app.processData.notes.statistics.skills.push({name:N,prefixedValue:M>=0?"+"+ +M:M,context:S}),V++}if(N.toLowerCase()==="perception")this.app.processData.notes.base.perception=M>=0?"+"+ +M:M}catch(N){return this.throwError(void 0,"parser.skill.failedToParse",{value:E}),!1}}return!0}async updateSkillChanges(J,Z){if(!J.system.changes)return;await W.runParallelOps(J.system.changes,async(Q)=>{let Y="";if(/skill\.(...)\.subSkills/i.test(Q.target))Y=Q.target.match(/skill\....\.subSkills\.(.*)/i)[1];else if(/skill\./i.test(Q.target))Y=Q.target.match(/skill\.(.*)/i)[1];if(Y!==""){let X=(await Roll.fromTerms(Roll.parse(Q.formula,J.getRollData())).evaluate())?.total??+Q.formula;if(Z[Y]||={total:0,skillFocus:!1,racial:!1},Z[Y].total+=X,J.name.match(/Skill Focus/i))Z[Y].skillFocus=!0;else Z[Y].skillFocus=!1;Z[Y].racial=Z[Y].racial||Q.type==="racial",Z[Y].name=n("skills")[Y]}})}calculateSkillRanks({name:J,key:Z,total:Q=0,abilityMod:Y=0,classSkill:H=!1,sizeMod:X=0,racialModifiers:G={},changes:z={},acp:_=!1,acpTotal:q=0,maxRanks:K=0,speedBonus:V=0,isOutsider:j=!1,outsiderSkills:P=[],outsiderSkillPicks:O=4,isExpert:L=!1,expertSkills:E=[],expertSkillPicks:B=10}={}){if(Object.keys(this.versatilePerformanceSkillOverrides).includes(Z))return[0,!1,""];let N=+Q-+Y-(H?pf1.config.classSkillBonus:0)-+X-+V,M=!1,T="";if(_&&q)N+=q;if(Z==="fly")N-=pf1.config.flyManeuverabilityValues[SBC.actor.system.attributes.speed.fly.maneuverability];if(G[J.toLowerCase()]&&G[J.toLowerCase()].context.length===0)N-=G[J.toLowerCase()].number;if(z[Z]!==null&&z[Z]!==void 0)N-=z[Z].total;if((z[Z]?.skillFocus?N-K-3===3||N-K===3:N-K===3||N-K===3||N>K)&&j&&O>0&&!P.includes(Z)&&!H){if(M=!0,T="outsider",z[Z]?.skillFocus&&N-K-3===3)N-=3;N-=pf1.config.classSkillBonus}else if((z[Z]?.skillFocus?N-K-3===3||N-K===3:N-K===3||N>K)&&L&&B>0&&!E.includes(Z)&&!H){if(M=!0,T="expert",z[Z]?.skillFocus&&N-K-3===3)N-=3;N-=pf1.config.classSkillBonus}return W.log(`Skill: ${J} | Total: ${Q} | Ability: ${Y} | Class: ${H} | Size: ${X} | Racial: ${G[J.toLowerCase()]?.number??0} | Change: ${z[Z]?.total??0} | Ranks: ${N}`),[Math.clamp(N,0,K),M,T]}}class F1 extends h{get parserGroup(){return"Parser/Base"}get parserType(){return"age"}async _parse(J,Z,Q=void 0){let Y,H={phys:0,ment:0};switch(J){case"Venerable":Y="SBCPF1.parser.age.venerable",J="venerable",H.phys=-6,H.ment=3;break;case"Old":Y="SBCPF1.parser.age.old",J="old",H.phys=-3,H.ment=2;break;case"Middle[- ]Aged?":Y="SBCPF1.parser.age.middleAged",J="middleAge",H.phys=-1,H.ment=1;break;case"Young":Y="SBCPF1.parser.age.young",J="young";break;default:Y="SBCPF1.parser.age.adult",J="adult"}return Y=game.i18n.localize(Y),await SBC.actor.update({"system.details.age":Y,"system.traits.ageCategory":J}),this.app.processData.notes.age=Y,!0}getAbilityChange(J){let Z=["str","dex","con"].includes(J);switch(SBC.actor.system.traits.ageCategory.base){case"venerable":return Z?-6:3;case"old":return Z?-3:2;case"middleAge":return Z?-1:1;case"young":switch(J){case"con":case"str":case"wis":return-2;case"dex":return 2;default:return 0}default:return 0}}}class A{static map={};static initMapping(J){A.map={types:{npc:["base","defense","offense","tactics","statistics","ecology","special abilities","description"],character:["base","defense","offense","tactics","statistics","ecology","special abilities","description"],vehicle:["vehicleBase","vehicleDefense","vehicleOffense","vehicleDescription"],trap:["trap"],haunt:["hauntBase"]},trap:{name:new a(J,["name","prototypeToken.name"],"string"),cr:new a(J,["system.details.cr.base","system.details.cr.total"],"number"),type:new a(J,["system.details.type"],"string"),perception:new a(J,["system.attributes.perception.total"],"number"),disableDevice:new a(J,["system.attributes.disableDevice.total"],"number"),trigger:new H0(J,["base.trigger"]),reset:new H0(J,["base.reset"]),effect:new H0(J,["base.effect"]),source:new H0(J,["base.source"]),description:new H0(J,["description.long"],"string")},haunt:{name:new a(J,["name","prototypeToken.name"],"string"),cr:new a(J,["system.details.cr.base","system.details.cr.total"],"number"),alignment:new a(J,["system.details.alignment"],"string"),source:new H0(J,["base.source"]),description:new H0(J,["description.long"],"string")},base:{name:new a(J,["name","prototypeToken.name"],"string"),cr:new a(J,["system.details.cr.base","system.details.cr.total"],"number"),mr:new d0(J),level:new H0(J,["system.details.level.value"]),xp:new H0(J,["system.details.xp.value"]),gender:new a(J,["system.details.gender"],"string"),age:new F1(J),race:new D0(J),classes:new g0(J),source:new H0(J,["base.source"]),alignment:new a(J,["system.details.alignment"],"string"),size:new a(J,["system.traits.size"],"string"),space:new a(J,["prototypeToken.height","prototypeToken.width"],"number"),scale:new a(J,["prototypeToken.texture.scaleX","prototypeToken.texture.scaleY"],"number"),creatureType:new b0(J),init:new a(J,["system.attributes.init.total"],"number"),senses:new y0(J),aura:new h0(J)},defense:{acNormal:new a(J,["system.attributes.ac.normal.total"],"number"),acFlatFooted:new a(J,["system.attributes.ac.flatFooted.total"],"number"),acTouch:new a(J,["system.attributes.ac.touch.total"],"number"),acTypes:new k0(J),hp:new u0(J),regeneration:new a(J,["system.traits.regen"],"string"),fastHealing:new a(J,["system.traits.fastHealing"],"string"),saves:new c0(J),immune:new p0(J),resist:new o0(J),weakness:new n0(J),defensiveAbilities:new I0(J),dr:new m0(J),sr:new l0(J)},offense:{speed:new a0(J),attacks:new E0(J),specialAttacks:new S0(J),space:new a(J,["prototypeToken.height","prototypeToken.width"],"number"),stature:new a(J,["system.traits.stature"],"string"),spellBooks:new X0(J)},tactics:new s0(J),statistics:{str:new V0(J,["system.abilities.str.value"],["system.abilities.str.mod"],"number"),dex:new V0(J,["system.abilities.dex.value"],["system.abilities.dex.mod"],"number"),con:new V0(J,["system.abilities.con.value"],["system.abilities.con.mod"],"number"),int:new V0(J,["system.abilities.int.value"],["system.abilities.int.mod"],"number"),wis:new V0(J,["system.abilities.wis.value"],["system.abilities.wis.mod"],"number"),cha:new V0(J,["system.abilities.cha.value"],["system.abilities.cha.mod"],"number"),bab:new a(J,["system.attributes.bab.total"],"number"),cmb:new a(J,["system.attributes.cmb.total"],"number"),cmd:new a(J,["system.attributes.cmd.total"],"number"),feats:new I0(J),skills:new $1(J),languages:new e0(J),sq:new S0(J),gear:new t0(J)},ecology:new i0(J),specialAbilities:new r0(J),description:new H0(J,["description.long"],"string")}}static getNeededCategories(J){switch(J){case"character":case"npc":return["defense","offense","statistics"];case"vehicle":return["vehicleDefense","vehicleOffense"];case"trap":case"haunt":return[]}}}class g1{static async buildChanges(J,Z=null){let Q=SBC.actor,Y=null,H=[];if(Z!==null)Y=Q.items.get(Z),H=[Y];if(Y===null)H=Q.items;let X=Q.getRollData(),G={};H.forEach((z)=>{let _=z.changes;if(!foundry.utils.isEmpty(_))_.map(async(q)=>{let{target:K,formula:V,type:j}=q;if(G[K]==null)G[K]={};let P=await Roll.fromTerms(Roll.parse(V,X)).evaluate();if(P=P?.total??+V,G[K][j]==null)G[K][j]=P;else G[K][j]+=P})}),J.changes=G}static async getValueFromChanges(J,Z=null,Q=null){let Y=0;if(Z==null&&Q==null)return Y;else if(Z!=="all"){if(J.changes[Z]==null)return 0;for(let H in Object.keys(J.changes[Z]))if(Q&&H===Q||Q==null)Y+=J.changes[Z][H];return Y}else return Object.keys(J.changes).map((H)=>{W.log(`Checking subtarget ${H}:`),Object.keys(J.changes[H]).map((X)=>{if(W.log(`type k is ${X} = ${J.changes[H][X]}`),Q&&X===Q||Q==null)Y+=+J.changes[H][X]})}),Y}static async conversionValidation(J){if(!SBC.settings.getSetting("createBuff"))return;SBC.settings.getSetting("debug").debug&&console.groupCollapsed("sbc-pf1 | Conversion Validation"),console.log(J);let Z=SBC.actor,Q=J.characterData.conversionValidation;try{await this.buildChanges(J);let Y=[],H=[],X=[],G=0,z=Object.keys(Q.spellBooks),_={};for(let O=0;O<z.length;O++){let L=z[O],E=Q.spellBooks[L].casterLevel,B=Q.spellBooks[L].concentrationBonus,N=Z.system.attributes.spells.spellbooks[L].cl.total;console.log(L,E,N);let M=Z.system.attributes.spells.spellbooks[L].concentration.total,T=+E-+N,S=+B-M-T;if(J.miscNotes.spellbookNotes[O]={key:L},T!==0)J.miscNotes.spellbookNotes[O].casterLevel=`sbc | Total in statblock was CL ${E}, adjust as needed.`,_[`data.attributes.spells.spellbooks.${L}`]={cl:{formula:T.toString()}};if(S!==0)J.miscNotes.spellbookNotes[O].concentrationBonus=`sbc | Total in statblock was +${B}, adjust as needed.`,_[`data.attributes.spells.spellbooks.${L}.concentrationFormula`]=S.toString()}if(!foundry.utils.isEmpty(_))await Z.update(_),await JJ(Z,J.miscNotes.spellbookNotes);let q=["str","dex","con","int","wis","cha"];for(let O of q){let L=Z.system.abilities[O].total,E=Q.attributes[O.capitalize()]??L,B=+E-+L;if(B===0)continue;console.log(E,L);let N=Object.assign({},new pf1.components.ItemChange().toObject(void 0,!1),{formula:B.toString(),type:"untypedPerm",target:O,value:+B});Y.push(N),delete Q.attributes[O.capitalize()]}if(Y.length){let O={name:"sbc | Conversion Buff (Ability Scores)",type:"buff",system:{description:{value:`<h2>sbc | Conversion Buff (Ability Scores)</h2>
                            This Buff was created by <strong>sbc</strong> to compensate for differences between the statblock input and FoundryVTTs automatically calculated values.
                            <br><br>
                            As differences in ability scores can have cascading effects, these get handled first and in a separate conversion buff.`},active:!0,subType:"perm",changes:Y,hideFromToken:!0,level:0,tag:"sbcConversionBuff1",useCustomTag:!0},img:"systems/pf1/icons/skills/yellow_36.jpg"};await Z.createEmbeddedDocuments("Item",[O])}let K=Object.keys(Q.attributes);if(K.splice(K.indexOf("acNormal"),1),K.splice(K.indexOf("acTouch"),1),K.splice(K.indexOf("acFlatFooted"),1),K.push("acNormal","acTouch","acFlatFooted"),J.characterData.isOutsider){let O=Z.itemTypes.class.find((L)=>L.id===J.characterData.outsiderId);if(O){let L={fort:0,ref:0,will:0},E={fort:O.system.savingThrows.fort.value,ref:O.system.savingThrows.ref.value,will:O.system.savingThrows.will.value,changed:!1};for(let B of["fort","ref","will"]){let N=Q.attributes[B],M=Z.system.attributes.savingThrows[B].total??0;L[B]=+N-+M}if(L.fort!==0&&L.ref!==0&&L.fort+L.ref===0)E.fort=O.system.savingThrows.ref.value,E.ref=O.system.savingThrows.fort.value,E.changed=!0;else if(L.fort!==0&&L.will!==0&&L.fort+L.will===0)E.fort=O.system.savingThrows.will.value,E.will=O.system.savingThrows.fort.value,E.changed=!0;else if(L.ref!==0&&L.will!==0&&L.ref+L.will===0)E.ref=O.system.savingThrows.will.value,E.will=O.system.savingThrows.ref.value,E.changed=!0;if(E.changed)await O.update({"system.savingThrows.fort.value":E.fort,"system.savingThrows.ref.value":E.ref,"system.savingThrows.will.value":E.will})}}for(let O=0;O<K.length;O++){let L=K[O],E="",B="",N=Q.attributes[L],M=0,T=0,S=0;if(isNaN(N))continue;switch(L.toLowerCase()){case"cmd":case"cmb":case"init":if(M=Z.system.attributes[L].total,E="untypedPerm",B=L,W.log(`Attribute: ${L} | Total in Actor: ${M} | Total in Statblock: ${N}`),M!==N)S=+N-+M;break;case"hpbonus":E="untypedPerm",B="mhp",S=+N;break;case"hptotal":M=Z.system.attributes.hp.max,E="untypedPerm",B="mhp",S=+N-+M;break;case"acnormal":M=Z.system.attributes.ac.normal.total,E="untypedPerm",B="aac",S=+N-+M-+G;break;case"base":case"enhancement":case"dodge":case"inherent":case"deflection":case"morale":case"luck":case"sacred":case"insight":case"resistance":case"profane":case"trait":case"racial":case"competence":case"circumstance":case"alchemical":case"penalty":T=await this.getValueFromChanges(J,"all",L.toLowerCase()),E=L,B="aac",S=+N-+T,G+=+S;break;case"rage":E="untypedPerm",B="ac",S=+N;break;case"fort":case"ref":case"will":E="untypedPerm",B=L,M=Z.system.attributes.savingThrows[L].total??0,S=+N-+M;break;default:break}if(S!==0){let w=Object.assign({},new pf1.components.ItemChange().toObject(void 0,!1),{formula:S.toString(),type:E,target:B,value:+S});H.push(w)}}let V=Object.keys(Q.context);for(let O=0;O<V.length;O++){let L=V[O],E=Q.context[L];if(E!==""){let B={subTarget:L,target:"misc",text:E};X.push(B)}}let j=Object.keys(Q.skills);for(let O=0;O<j.length;O++){let L=j[O];if(Object.keys(A.map.statistics.skills.versatilePerformanceSkillOverrides).includes(L))continue;let E=L.replace(/(\d+)/,""),B=Q.skills[L],N=0,M=Object.keys(Z.system.skills[E]),T="";if(!M.includes("subSkills"))N=Z.getSkillInfo(L).mod??0,T=`skill.${L}`;else N=Z.getSkillInfo(`${E}.${L}`).mod??0,T=`skill.${E}.${L}`;if(B.context!==""){let S=B.context,w={target:T,text:S};X.push(w)}if(+B.total!==+N){let S=+B.total-+N;if(S!==0){let w=await new pf1.components.ItemChange({formula:S.toString(),type:"untypedPerm",target:T,value:+S});H.push(w.toObject())}}}let P={name:"sbc | Conversion Buff",type:"buff",system:{description:{value:`<h2>sbc | Conversion Buff</h2>
                        This Buff was created by <strong>sbc</strong> to compensate for differences between the input and the values FoundryVTT calculates automatically.
                        <br><br>
                        Especially when the pathfinder system gets upgraded, entries in compendiums get updated or foundry changes in some way, this buff may become outdated.
                        <br><br>
                        For most mooks the conversion should more or less work, but for important NPCs or creatures it is adviced to double check the conversion manually.`},active:!0,subType:"perm",changes:H,contextNotes:X,hideFromToken:!0,level:0,tag:"sbcConversionBuff2",useCustomTag:!0},img:"systems/pf1/icons/skills/yellow_36.jpg"};if(H.length>0||X.length>0)await Z.createEmbeddedDocuments("Item",[P]);Hooks.callAll("sbc.validated",Z)}catch(Y){SBC.settings.getSetting("debug").debug&&console.error(Y);let H="Failed to validate the conversion and create a conversion buff",X=new f(f.ERRORLEVELS.ERROR,"Validation",H);throw J.errors.push(X),console.error(Y),Y}SBC.settings.getSetting("debug").debug&&console.groupEnd()}}async function JJ(J,Z){let Q=[],Y="";for(let X of Z){let G=J.system.attributes.spells.spellbooks[X.key];if(X.casterLevel||X.concentration){if(Y+=`<p><strong>${G.name||G.label}</strong>:</p>`,X.casterLevel)Q.push({target:`cl.book.${X.key}`,text:X.casterLevel}),Y+=`<p>Caster Level: ${X.casterLevel}</p>`;if(X.concentration)Q.push({target:`concn.${X.key}`,text:X.concentration}),Y+=`<p>Concentration Bonus: ${X.concentration}</p>`}}let H=J.itemTypes.feat.find((X)=>X.name==="Miscellaneous Notes");if(H)Y=H.system.description.value+Y,await H.update({"system.contextNotes":H.system.contextNotes.concat(Q),"system.description.value":Y});else Y=`<p>This feature was created by <strong>SBC</strong> to collect any notes that don't have a source on the actor,
                such as saving throw details or a bonus to CMD from extra legs. It may also be used to record a natural armor bonus,
                spell resistance bonus, or spellcasting notes.</p>${Y}`,await J.createEmbeddedDocuments("Item",[{name:"Miscellaneous Notes",type:"feat",system:{contextNotes:Q,description:{value:Y},subType:"misc",tag:"miscellaneousNotes"},img:"systems/pf1/icons/skills/yellow_36.jpg"}])}var J1={content:"",line:0};async function F$(J,Z,Q){SBC.settings.getSetting("debug")&&console.groupCollapsed("sbc-pf1 | "+J.parsedCategories+"/"+J.foundCategories+" >> PARSING BASE DATA");let Y=[];J.notes.base={},J1={content:"",line:0};let H=null,X=null;for(let G=0;G<Z.length;G++)try{let z=Z[G].trim();if(z==="")continue;if(!Y.name){if([Y.name,z]=await ZJ(z,G),z==="")continue}if(!Y.cr&&z.match(/\bCR\b/i)!==null){if([Y.cr,z]=await QJ(J,z,G),z==="")continue}if(!Y.mr){if(z.match(/\bMR\b/i)!==null)H=G,X=z;if(Y.classes&&X)[Y.mr,X]=await YJ(J,X,H)}if(G!==0){if(!Y.source&&z.toLowerCase().startsWith("source")){if([Y.source,z]=await HJ(z,G),z==="")continue}if(!Y.xp&&z.toLowerCase().startsWith("xp")){if([Y.xp,z]=await XJ(J,z,G),z==="")continue}if(!Y.gender&&T1().test(z)){if([Y.gender,z]=await GJ(z,G),z==="")continue}if(!Y.race){if([Y.race,z]=await WJ(z,G),z==="")continue}if(!Y.classes){let _=z.match(z1()),q=z.toLowerCase().startsWith("source");if(!Y.age&&W.haystackRegexSearch(["Middle[- ]Aged?","Old","Venerable"],z)){if([Y.age,z]=await _J(z,G),z==="")continue}if(!_&&!q){if(Y.classes=await zJ(z,G),z==="")continue}}if(!Y.alignment&&z1().test(z)){if([Y.alignment,z]=await qJ(J,z,G),z==="")continue;if(Y.alignment===!0)Y.classes=!0}if(!Y.size&&x0().test(z)){if(Y.size=await KJ(J,z,G),z==="")continue}if(!Y.creatureType&&C1().test(z)&&x0().test(z)){if([Y.creatureType,z]=await VJ(z,G),z==="")continue}if(!Y.init&&z.toLowerCase().match(/^init\b/i)){if([Y.init,z]=await FJ(J,z,G),z==="")continue}if(!Y.senses&&z.match(/\bSenses\b/i)!==null){if([Y.senses,z]=await jJ(z,G),z==="")continue}if(!Y.aura&&z.match(/\bAura\b/i)!==null)J1={content:z,line:G},Y.aura=!0}}catch(z){SBC.settings.getSetting("debug")&&console.error(z);let _="Parsing the base data failed at the highlighted line",q=new f(f.ERRORLEVELS.ERROR,"Parse/Base",_,Q+G+1);return J.errors.push(q),J.input.prepared.success=!1,SBC.settings.getSetting("debug")&&console.groupEnd(),!1}if(!Y.cr&&SBC.actorType===0){let G=new f(f.ERRORLEVELS.WARNING,"Parse/Base","No CR for this NPC detected, please check the highlighted line",0);J.errors.push(G)}if(!Y.creatureType){let G=new f(f.ERRORLEVELS.ERROR,"Parse/Base","No creature type found!");J.errors.push(G)}return W.log("RESULT OF PARSING BASE DATA (TRUE = PARSED SUCCESSFULLY)"),W.log(Y),SBC.settings.getSetting("debug")&&console.groupEnd(),!0}async function ZJ(J,Z){let Q=A.map.base.name,Y=J.replace(/\bCR\b.*$/i,"").replace(/\($/,"").trim(),H=await Q.parse(Y.trim().capitalize(),Z);if(H)J=W.cleanLine(Y,J);return[H,J]}async function QJ(J,Z,Q){let Y=A.map.base.cr,H=Z.match(/\bCR\b\s(-|\d*\.\d+|\d+(?:\/\d+)?)/i),X=H[1];if(X.includes("/"))J.notes.base.cr=X;else for(let[z,_]in Object.entries(SBC.config.const.crFractions))if(+X===_){J.notes.base.cr=z;break}let G=await Y.parse(parseFloat(SBC.config.const.crFractions[X]||X),Q);if(G)Z=W.cleanLine(H[0],Z);return[G,Z]}async function YJ(J,Z,Q){let Y=A.map.base.mr,X=Z.match(/\bMR\b\s(\d+)/i)[1];J.notes.base.mr=X;let G=await Y.parse(X,Q);if(G)Z=W.cleanLine(X,Z);return[G,Z]}async function HJ(J,Z){let Q=A.map.base.source,Y=J.match(/^Source\s+(.*)/)[1].trim(),H=await Q.parse(Y,Z);if(H)J=W.cleanLine(Y,J);return[H,J]}async function XJ(J,Z,Q){let Y=A.map.base.xp,H=Z.match(/^XP\s+([\d,.]*)/)?.[1].replace(/\.,/g,"").trim()??"0";J.notes.base.xp=H;let X=await Y.parse(H,Q);if(X===!0)Z=W.cleanLine(Z.match(/^(XP\s+[\d,.]*)/)[1],Z);return[X,Z]}async function GJ(J,Z){let Q=J.match(T1())[0],H=await A.map.base.gender.parse(Q,Z);if(H)J=W.cleanLine(Q,J);return[H,J]}async function WJ(J,Z){let Q=A.map.base.race,Y=W.haystackRegexSearch(SBC.config.races.map((H)=>H+="\\b"),J)?.replace("\\b","")||W.haystackRegexSearch(E1.map((H)=>H+="\\b"),J)?.replace("\\b","")||!1;if(!Y)return[!1,J];if(new RegExp(`\\(${Y.toLowerCase()}|,\\s*${Y.toLowerCase()}\\s*,|${Y.toLowerCase()}\\)`).test(J.toLowerCase()))return[!1,J];return[await Q.parse(Y,Z),W.cleanLine(Y,J)]}async function _J(J,Z){let Q=W.haystackRegexSearch(["Middle[- ]Aged?","Old","Venerable"],J)||"",H=await A.map.base.age.parse(Q,Z);if(H)J=W.cleanLine(Q,J);return[H,J]}async function zJ(J,Z){let Q=J.match(v0());if(Q){let Y=J.slice(J.indexOf(Q[0]));return await A.map.base.classes.parse(Y,Z)}return!0}async function qJ(J,Z,Q){let Y=A.map.base.alignment,H=Z.match(z1())[1].trim();J.notes.base.alignment=H;let X=await Y.parse(H.replace(/\bN\b/,"TN").toLowerCase(),Q);if(X)Z=W.cleanLine(H,Z);return[X,Z]}async function KJ(J,Z,Q){let Y=A.map.base.size,H=Z.match(x0())[0].trim();J.notes.base.size=H;let X=W.getKeyByValue(n("actorSizes"),H),G=A.map.base.space,z=A.map.base.scale,_=pf1.config.tokenSizes[X].w,q=pf1.config.tokenSizes[X].scale;switch(X){case"dim":case"fine":case"tiny":await SBC.actor.update({"system.skills.swm.ability":"dex","system.skills.clm.ability":"dex","system.attributes.cmbAbility":"dex"});break;default:break}return{size:await Y.parse(X,Q),space:await G.parse(_,Q),scale:await z.parse(q,Q)}}async function VJ(J,Z){let Q=J.match(C1())[1],H=await A.map.base.creatureType.parse(Q,Z);if(H)J=W.cleanLine(Q,J);return[H,J]}async function FJ(J,Z,Q){let Y=A.map.base.init,H=Z.match(/Init\s*([+-]?\d+)/)[1].trim();J.characterData.conversionValidation.attributes.init=+H;let X=await Y.parse(+H,Q);if(X)Z=W.cleanLine(H,Z);return[X,Z]}async function jJ(J,Z){let Q=A.map.base.senses,Y=J.match(/\bSenses\b\s*(.*?)(?:\n|$|\s*Aura)/gim)[0].replace(/\bSenses\b\s*|\s*Aura\b/g,""),H=await Q.parse(Y,Z);if(H)J=W.cleanLine(Y,J);return[H,J]}async function j$(){if(!J1.content)return!0;let J=A.map.base.aura,Z=J1.content.match(/\bAura\b\s*(.*)/gim)[0].replace(/\s*Aura\b/g,"");return await J.parse(Z,J1.line)}async function L$(J,Z,Q){SBC.settings.getSetting("debug")&&console.groupCollapsed("sbc-pf1 | "+J.parsedCategories+"/"+J.foundCategories+" >> PARSING DEFENSE DATA");let Y=[];J.notes.defense={};for(let H=0;H<Z.length;H++)try{let X=Z[H];if(!Y.acNormal&&X.toLowerCase().startsWith("ac"))Y.acNormal=await b1("acNormal","AC",J,X,H+Q);if(!Y.acTouch&&X.match(/Touch/i))Y.acTouch=await b1("acTouch","Touch",J,X,H+Q);if(!Y.acFlatFooted&&X.match(/flat-footed/i))Y.acFlatFooted=await b1("acFlatFooted","flat-footed",J,X,H+Q);if(!Y.acTypes&&/AC.*?\((.*?)\)/i.test(X))Y.acTypes=await LJ(J,X,H+Q);if(!Y.hp&&X.toLowerCase().startsWith("hp"))Y.hp=await OJ(X,H+Q);if(!Y.saves&&X.toLowerCase().startsWith("fort "))Y.saves=await PJ(X,H+Q);if(!Y.dr&&X.match(/\bDR\b/i))Y.dr=await BJ(X,H+Q);if(!Y.immune&&X.match(/Immune\b/i))Y.immune=await EJ(X,H+Q);if(!Y.resist&&X.match(/(?<!abilities\s*)\bResist\b/i))Y.resist=await MJ(X,H+Q);if(!Y.weakness&&X.match(/\bWeaknesses\b/i))Y.weakness=await NJ(X,H+Q);if(!Y.sr&&X.match(/\bSR\b/i))Y.sr=await RJ(X,H+Q);if(!Y.defensiveAbilities&&X.match(/Defensive Abilities\b/i))Y.defensiveAbilities=await vJ(J,X,H+Q)}catch(X){SBC.settings.getSetting("debug")&&console.error(X);let G=`Parsing the defense data failed at line ${Q+H+1}`,z=new f(f.ERRORLEVELS.ERROR,"Parse/Defense",G,H+Q);return J.errors.push(z),SBC.settings.getSetting("debug")&&console.groupEnd(),!1}return W.log("RESULT OF PARSING DEFENSE DATA (TRUE = PARSED SUCCESSFULLY)"),W.log(Y,SBC.actor.system),SBC.settings.getSetting("debug")&&console.groupEnd(),!0}async function b1(J,Z,Q,Y,H){let X=A.map.defense[J],G=new RegExp(`${Z}\\s*(-?\\d+)`,"i"),z=Y.match(G)[1].trim();return Q.notes.defense[J]=z,Q.characterData.conversionValidation.attributes[J]=+z,await X.parse(+z,H)}async function LJ(J,Z,Q){let Y=A.map.defense.acTypes,H=Z.match(/AC.*?\((.*?)\)/i)[1].trim();return J.characterData.conversionValidation.attributes.acTypes=H,await Y.parse(H,Q)}async function OJ(J,Z){let Q=A.map.defense.hp,Y=J.match(/^(?:HP)(.*)/i)[1].trim();return await Q.parse(Y,Z)}async function PJ(J,Z){let Q=A.map.defense.saves,Y=J.match(/^(Fort.*)/i)[1].trim();return await Q.parse(Y,Z)}async function BJ(J,Z){let Q=A.map.defense.dr,Y=J.match(/\bDR\b(.*?)(?=$|Immune|Resist|SR|Weakness)/i)[1].trim();return await Q.parse(Y,Z)}async function EJ(J,Z){let Q=A.map.defense.immune,Y=J.match(/\bImmune\b(.*?)(?=$|Resist|SR|Weakness|DR)/i)[1].trim();return await Q.parse(Y,Z)}async function NJ(J,Z){let Q=A.map.defense.weakness,Y=J.match(/\bWeakness(?:es)?\b(.*?)(?=$|\b(?:Resist|Immune|SR|Weakness|DR)\b)/i)[1].trim();return await Q.parse(Y,Z)}async function MJ(J,Z){let Q=A.map.defense.resist,Y=J.match(/\bResist\b(.*?)(?=$|\b(?:Immune|SR|Weakness|DR)\b)/i)[1].trim();return await Q.parse(Y,Z)}async function RJ(J,Z){let Q=A.map.defense.sr,Y=J.match(/\bSR\b(.*?)(?=$|\b(?:Immune|Resist|Weakness|DR)\b)/i)[1].trim();return await Q.parse(Y,Z)}async function vJ(J,Z,Q){let Y=A.map.defense.defensiveAbilities,H=Z.match(/Defensive Abilities\b\s*(.*?)(?=$|\b(?:Immune|Resist|Weakness|DR|SR)\b)/i)[1].replace(/\s*[,;]+/g,",").replace(/(,\s*$)/,"").trim(),[X,G]=await Y.parse(H,Q,"class-abilities",["buff","consumable","equipment","feat","loot","weapon"]);return J.notes.defense.defensiveAbilities=G,X}async function O$(J,Z,Q){SBC.settings.getSetting("debug")&&console.groupCollapsed("sbc-pf1 | "+J.parsedCategories+"/"+J.foundCategories+" >> PARSING DESCRIPTION DATA"),J.notes.description={};let Y="";for(let X=0;X<Z.length;X++)try{let G=Z[X];switch(G.toLowerCase()){case"description":break;case"":Y=Y.concat(`
`);break;default:Y=Y.concat(G+`
`);break}}catch(G){SBC.settings.getSetting("debug")&&console.error(G);let z=`Parsing the description data failed at line ${Q+X+1}`,_=new f(f.ERRORLEVELS.WARNING,"Parse/Description",z,X+Q);return J.errors.push(_),J.input.prepared.success=!1,SBC.settings.getSetting("debug")&&console.groupEnd(),!1}return J.notes.description.long=Y,await A.map.description.parse(Y,Q),W.log("RESULT OF PARSING DESCRIPTION DATA (TRUE = PARSED SUCCESSFULLY)"),SBC.settings.getSetting("debug")&&console.groupEnd(),!0}async function P$(J,Z,Q){SBC.settings.getSetting("debug")&&console.groupCollapsed("sbc-pf1 | "+J.parsedCategories+"/"+J.foundCategories+" >> PARSING ECOLOGY DATA");let Y=[];J.notes.ecology={hasEcology:!0};for(let H=0;H<Z.length;H++)try{let X=Z[H],G=A.map.ecology;if(!Y.environment&&X.match(/Environment/i))Y.environment=await UJ(G,J,X,Q+H);if(!Y.organization&&X.match(/Organization/i))Y.organization=await xJ(G,J,X,Q+H);if(!Y.treasure&&X.match(/Treasure/i))Y.treasure=await IJ(G,J,X,Q+H)}catch(X){SBC.settings.getSetting("debug")&&console.error(X);let G=`Parsing the ecology data failed at line ${Q+H+1} (non-critical)`,z=new f(f.ERRORLEVELS.WARNING,"Parse/Ecology",G,H+Q);throw J.errors.push(z),SBC.settings.getSetting("debug")&&console.groupEnd(),X}return W.log("RESULT OF PARSING ECOLOGY DATA (TRUE = PARSED SUCCESSFULLY)"),W.log(Y),SBC.settings.getSetting("debug")&&console.groupEnd(),!0}async function UJ(J,Z,Q,Y){let H={name:"Environment",entry:Q.match(/^(?:Environment)([\s\S]*?)(?=$|Organization|Treasure)/i)[1]};return Z.notes.ecology.environment=H.entry,await J.parse(H,Y)}async function xJ(J,Z,Q,Y){let H={name:"Organization",entry:Q.match(/(?:Organization)([\s\S]*?)(?=$|Treasure)/i)[1]};return Z.notes.ecology.organization=H.entry,await J.parse(H,Y)}async function IJ(J,Z,Q,Y){let H={name:"Treasure",entry:Q.match(/(?:Treasure)([\s\S]*?)$/i)[1]};if(Q.match(/(NPC Gear)/i)){let G=Q.match(/(?:NPC Gear\s*\()([^)]*)/gi)[0].replace(/NPC Gear\s*\(/i,"");Z.treasureParsing.treasureToParse=G,Z.treasureParsing.lineToRemove=Y;let z=`
        This is treasure and will not be included as items in the actor. If you want to parse these as real items, press here:<br/>
        <input type="button" id="parseTreasureAsGearButton" value="Parse Treasure as Gear"></input>`,_=new f(f.ERRORLEVELS.WARNING,"Parse/Ecology",z,Y);Z.errors.push(_)}return Z.notes.ecology.treasure=H.entry,await J.parse(H,Y)}var O0={},_0=0,Z0=0,N0={0:"primary",1:"secondary",2:"tertiary",3:"spelllike",4:"quinary",5:"senary",6:"septenary",7:"octonary"},L0=[],O1=[];async function E$(J,Z,Q){O0={},_0=0,Z0=0,L0=[],O1=[],SBC.settings.getSetting("debug")&&console.groupCollapsed("sbc-pf1 | "+J.parsedCategories+"/"+J.foundCategories+" >> PARSING OFFENSE DATA");let Y=[];J.notes.offense={speed:[],spellBooks:[]};let H={text:"",line:0},X={text:"",line:0},G=Z.some((_)=>/^Special\s+Attacks\b\s*/i.test(_)),z={text:"",line:0};for(let _=0;_<Z.length;_++)try{let q=Z[_];if(/^Spe{0,2}d\s*/i.test(q)){if(!Y.landSpeed&&/^Spe{0,2}d\s*\d+/i.test(q))Y.landSpeed=await f0(q,"land","^Spe{0,2}d",_+Q);else Y.landSpeed=await f0("Speed 0 ft.","land","^Spe{0,2}d",_+Q);if(!Y.swimSpeed&&q.match(/\bSwim\s*/i))Y.swimSpeed=await f0(q,"swim","\\bSwim",_+Q);if(!Y.climbSpeed&&q.match(/\bClimb\s*/i))Y.climbSpeed=await f0(q,"climb","\\bClimb",_+Q);if(!Y.burrowSpeed&&q.match(/\bBurrow\s*/i))Y.burrowSpeed=await f0(q,"burrow","\\bBurrow",_+Q);if(!Y.flySpeed&&q.match(/\bFly\s*/i))Y.flySpeed=await f0(q,"fly","\\bFly",_+Q)}if(!Y.melee&&q.match(/^Melee\s*/i)){if(H=await B$(q,"Melee",Z[_+1],_+Q),J.notes.offense.melee=H.text,!G)await L1(J),Y.melee=await j1(H,"mwak")}if(!Y.ranged&&q.match(/^Ranged\s*/i)){if(X=await B$(q,"Ranged",Z[_+1],_+Q),J.notes.offense.ranged=X.text,!G)await L1(J),Y.ranged=await j1(X,"rwak")}if(!Y.specialAttacks&&q.match(/^Special\s+Attacks\b\s*/i))z.text=q,z.line=_+Q;if(!Y.spaceStature){if(/^Space\b.*\bReach\b/i.test(q)){let K=A.map.offense.stature,[V,j]=await wJ(q,_+Q),[P,O]=await fJ(q);J.notes.offense.space=pf1.utils.convertDistance(+j).join(" "),J.notes.offense.reach=pf1.utils.convertDistance(+P).join(" "),J.notes.offense.reachContext=W.convertStringUnits(O);let L=+P<+j?"long":"tall";Y.spaceReach={space:V,stature:await K.parse(L,_+Q)}}}if(!Y.spellLikeAbilities&&q.match(/Spell-Like\s+Abilities\b\s*/i))D1(J,q,_,!0,!1),W.log(`Spell-Like Abilities found: ${Z0}, ${L0[Z0]}`);if(!Y.psychicMagic&&q.match(/^Psychic\s+Magic\b\s*/i))D1(J,q,_,!1,!0),O0[_0].spells.push(Z[_+1]),_++;if(!Y.spellBooks&&/(?:Spells|Extracts) (?:Prepared|Known)\b\s*/i.test(q))D1(J,q,_,!1,!1),W.log(`Spellbook ${Z0}, ${L0[Z0]}`);if(_0!==0&&Z0<=_0&&+_>+L0[Z0]){if(/Spell-Like|Spells|Extracts (?:Prepared|Known)|Psychic Magic/gi.test(q)===!1)O0[Z0].spells.push(q)}if(_==Z.length-1){let K=0,V={};if(await W.runParallelOps(Object.values(O0),async(j,P)=>{let O=new X0(SBC.app);W.log(`Spellbook ${P} Processing: ${j.spellBookType}`,j);let[L,E,B]=await O.parse(j,L0[P]);if(B)V[E]=N0[K],K++;W.log(`Spellbook ${P} Results: ${L} - ${E} - ${B}`)}),K>0){let j={},P=SBC.actor.system.attributes.spells.spellbooks,O=new Set(Object.keys(P)),L=[],E=SBC.actor.itemTypes.spell;for(let[B,N]of Object.entries(V)){if(N===B){O.delete(N);continue}j[N]=pf1.utils.deepClone(P[B]),E.filter((M)=>M.system.spellbook===B).forEach((M)=>{L.push({_id:M._id,"system.spellbook":N})}),J.characterData.conversionValidation.spellBooks[N]=pf1.utils.deepClone(J.characterData.conversionValidation.spellBooks[B]),delete J.characterData.conversionValidation.spellBooks[B],O.delete(N)}O.forEach((B)=>{j[B]=X0.getDefaultSpellbookData()}),await SBC.actor.update({"system.attributes.spells.spellbooks":j}),await SBC.actor.updateEmbeddedDocuments("Item",L)}if(!G)await L1(J);else Y.specialAttacks=await SJ(J,z.text,z.line),await L1(J),Y.melee=await j1(H,"mwak"),Y.ranged=await j1(X,"rwak")}}catch(q){SBC.settings.getSetting("debug")&&console.error(q);let K=`Parsing the offense data failed at line ${Q+_+1}`,V=new f(f.ERRORLEVELS.ERROR,"Parse/Offense",K,_+Q);return J.errors.push(V),SBC.settings.getSetting("debug")&&console.groupEnd(),!1}return W.log("RESULT OF PARSING OFFENSE DATA (TRUE = PARSED SUCCESSFULLY)"),W.log(Y),SBC.settings.getSetting("debug")&&console.groupEnd(),!0}async function f0(J,Z,Q,Y){let H=A.map.offense.speed,X=new RegExp(`${Q}\\s*($|[^,]*)`,"i"),G=J.match(X)[1].trim();return await H.parse(G,Y,Z)}function B$(J,Z,Q,Y){let H=new RegExp(`^${Z}\\s*(.*)`,"i"),X=J.match(H)[1].trim();if(X.match(/(or|and)$/i))X+=" "+Q.trim();return{text:X,line:Y}}async function j1(J,Z){return await A.map.offense.attacks.parse(J.text,J.line,Z)}async function SJ(J,Z,Q){let Y=A.map.offense.specialAttacks,H=Z.match(/^Special\s+Attacks?\s*(.*)/i)[1].trim(),[X,G]=await Y.parse(H,Q,["special-attacks","class-abilities"],["feat"],["classFeat"],!1);return J.notes.offense.specialAttacks=G,X}async function wJ(J,Z){let Q=A.map.offense.space,Y=J.match(/^Space\s*(\S+)\s+/i)[1];Y=Y.replace(/(.)-(.)/g,"$1.$2");let H=Y.match(/(\d*)\.+(\d*)\/+(\d*)/);if(H?.length>0)Y=+H[1]+H[2]/H[3];let X=Math.round(Y/0.5)*0.5/5,G=await Q.parse(X,Z);return Promise.resolve([G,Y])}async function fJ(J){let Z=W.parseSubtext(J.match(/Reach(.*)/i)[1]),Q="",Y="";if(Z[0]){Q=Z[0],Q=Q.replace(/(.)-(.)/g,"$1.$2");let H=Q.match(/(\d*)\.+(\d*)\/+(\d*)/);if(H?.length>1)Q=+H[1]+H[2]/H[3];Q=Q.replace(/(\d+\.?\d*)(.*)/g,"$1")}if(Z[1])Y=Z[1].replace(/[()]/g,"").trim();return Promise.resolve([Q,Y])}function TJ(J){return J.match(/\bCL\b\s*(?<cl>\d+)/i)?.groups.cl??0}function CJ(J){return J.match(/\b(Concentration\b|Conc\.)\s*\+(?<bonus>\d+)/i)?.groups?.bonus}function D1(J,Z,Q,Y,H){let X="_hd",G="prepared",z="spelllike",_=null,q=!1;if(!Y&&!H){G=Z.match(/Prepared/i)?"prepared":"spontaneous",X="hd",q=!!Z.match(/Extracts/i),z=null;let j=v0(!1).exec(Z)?.groups?.class;if(j){if(X=j,!SBC.actor.itemTypes.class.find((O)=>O.name.match(new RegExp(j,"i"))))X="hd",_=`${j} ${W.translate("spellbookName.spells"+(G==="prepared"?"Prepared":"Known"))}`}else{let P=SBC.actor.itemTypes.class.find((O)=>O.system.casting&&O.system.casting.type===G);X=P?P.name:"hd"}Z0=_0,_0++,W.log(`Current Spellbook: ${Z0}, Spellbooks found: ${_0}`),z=N0[Z0]}else if(H)Z0=_0,_0++,G="points",z=N0[Z0];else Z0=_0,_0++,z=N0[Z0];let K=TJ(Z),V=CJ(Z)??K;if(O1.includes(z)){let j=AJ();O0[j]=duplicate(O0[Z0]),O0[j].spellBookType=N0[j],L0[j]=L0[Z0]}O0[Z0]={firstLine:Z,spells:[],spellCastingType:G,spellCastingClass:X,casterLevel:K,concentrationBonus:V,spellBookType:z,isSpellLike:Y,isAlchemist:q,spellBookName:_},L0[Z0]=Q,O1.push(z),console.log(`Current Spellbook: ${Z0}, Spellbooks found: ${_0}`)}async function L1(J){let Z=SBC.actor.itemTypes.feat.filter((Y)=>Y.system.subType==="classFeat"),Q=Object.values(SBC.config.weaponGroups);for(let Y of Z){let H=W.parseSubtext(Y.name.toLowerCase());H.shift();for(let X of H){let G=Q.find((z)=>X.includes(z));if(G){let z=parseInt(X.match(/\+(\d+)/)?.[1]??0);W.log(`Found Group ${G}, Found Bonus ${z}`);let _=Object.keys(SBC.config.weaponGroups)[Q.indexOf(G)];if(G&&z>0&&!Object.keys(J.characterData.weaponGroups).includes(_))J.characterData.weaponGroups[_]=z}}}W.log("Weapon Groups",J.characterData.weaponGroups)}function AJ(){return parseInt(Object.keys(N0).find((J)=>!O1.includes(N0[J])))}async function N$(J,Z,Q){SBC.settings.getSetting("debug")&&console.groupCollapsed("sbc-pf1 | "+J.parsedCategories+"/"+J.foundCategories+" >> PARSING SPECIAL ABILITY DATA");let Y=[],H=0;J.notes.specialAbilities=[];let X=A.map.specialAbilities;for(let G=1;G<Z.length;G++)try{let z=Z[G],_=`specialAbility-${H}`;if(!Y[_])Y[_]=await X.parse(z,Q+G),H+=+!!Y[_]}catch(z){SBC.settings.getSetting("debug")&&console.error(z);let _=`Parsing the special abilities failed at line ${Q+G+1} (non-critical)`,q=new f(f.ERRORLEVELS.WARNING,"Parse/Special Abilities",_,G+Q);return J.errors.push(q),SBC.settings.getSetting("debug")&&console.groupEnd(),!1}return W.log("RESULT OF PARSING SPECIAL ABILITY DATA (TRUE = PARSED SUCCESSFULLY)"),W.log(Y),SBC.settings.getSetting("debug")&&console.groupEnd(),!0}var y1=!1,M$=!1,P1="",d1=-1;async function R$(J,Z,Q){SBC.settings.getSetting("debug")&&console.groupCollapsed("sbc-pf1 | "+J.parsedCategories+"/"+J.foundCategories+" >> PARSING STATISTICS DATA");let Y=[];J.notes.statistics={},J.treasureParsing.statisticsStartLine=Q;let H=[],X=0,G="",z=0;y1=!1,M$=Z.some((_)=>/\b((?:Combat |Other |^)Gear)\b/i.test(_)),P1="",d1=-1;for(let _ of["consumable","equipment","loot","weapon","container"])await Promise.all(SBC.actor.itemTypes[_]?.map(async(q)=>await q.delete()));for(let _=0;_<Z.length;_++)try{let q=Z[_];if(!Y.bab&&q.match(/^Base Atk\b/i)){let K=q.match(/Base Atk\b\s*([+-]?\d+)/gi)[0].replace(/Base Atk\b\s*/i,"");J.characterData.conversionValidation.attributes.bab=+K}if(!Y.cmb&&q.match(/\bCMB\b/i))Y.cmb=await hJ(J,q,Q+_);if(!Y.cmd&&q.match(/\bCMD\b/i))Y.cmd=await gJ(J,q,Q+_);if(!Y.feats&&q.match(/^Feats\b/i))Y.feats=await bJ(J,q,Q+_);if(!Y.languages&&q.match(/^Languages\b/i))Y.languages=await DJ(J,q,Q+_);if(/((?:Combat |Other |^)Gear)\b/i.test(q))Y.gear=await dJ(J,q,Q+_),y1=!0;if(!Y.abilities){if(/(Str|Dex|Con|Int|Wis|Cha)\s*(\d+|-)/i.test(q)&&!H.length)H=q.match(/((Str|Dex|Con|Int|Wis|Cha)\s*(\d+|-))/gi),X=_;if(mJ(_,Z.length)&&H.length>0){for(let K=0;K<H.length;K++)await kJ(H[K],J,X);Y.abilities=!0}}if(!Y.skills){if(q.match(/^Skills\b/i))P1=q.match(/Skills\b\s*(.*)/i)[1].replace(/\s*[,;]+/g,",").trim(),d1=Q+_,Y.skills=!0}if(!Y.sq){if(q.match(/^SQ\b/i))G=q,z=_;if(G&&Y.abilities)Y.sq=await yJ(J,G,Q+z)}}catch(q){SBC.settings.getSetting("debug")&&console.error(q);let K="Parsing the statistics data failed at the highlighted line",V=new f(f.ERRORLEVELS.ERROR,"Parse/Statistics",K,Q+_+1);return J.errors.push(V),J.input.prepared.success=!1,SBC.settings.getSetting("debug")&&console.groupEnd(),!1}return W.log("RESULT OF PARSING STATISTICS DATA (TRUE = PARSED SUCCESSFULLY)"),W.log(Y),SBC.settings.getSetting("debug")&&console.groupEnd(),!0}async function hJ(J,Z,Q){let Y=A.map.statistics.cmb,H=Z.match(/CMB\s+([+-]?(\d+)?\s*(\(.*\))?;?)/i)[1].trim().replace(";",""),X=H.match(/^([+-](\d+)?)/)?.[0]??null;J.flags.hasNoCMB=!X,X=X??0;let G=W.parseSubtext(H)[1];if(!J.flags.hasNoCMB)J.characterData.conversionValidation.attributes.cmb=+X;if(G){let z=G,_,q=/\+?(-?\d+)/g;while((_=q.exec(G))!==null){let K=+_[1],V=W.prefixNumber(K-+X),j=_[0].length;G=G.substring(0,_.index)+V+G.substring(_.index+j),q.lastIndex+=V.length}J.notes.statistics.cmbContext=" ("+z+")",J.miscNotes.cmbNotes=G??""}return await Y.parse(+X,Q)}async function gJ(J,Z,Q){let Y=A.map.statistics.cmd,H=Z.match(/CMD\s+([+-]?(\d+)?\s*(\(.*\))?;?)/i)[1].trim().replace(";",""),X=H.match(/^[+-]?(\d+)?/)?.[0]??null;J.flags.hasNoCMD=!X,X=X??0;let G=W.parseSubtext(H)[1];if(!J.flags.hasNoCMD)J.characterData.conversionValidation.attributes.cmd=+X;if(G){let z=G,_,q=/\+?(-?\d+)/g;while((_=q.exec(G))!==null){let K=+_[1],V=W.prefixNumber(K-+X),j=_[0].length;G=G.substring(0,_.index)+V+G.substring(_.index+j),q.lastIndex+=V.length}J.notes.statistics.cmdContext=" ("+z+")",J.miscNotes.cmdNotes=G??""}return await Y.parse(+X,Q)}async function bJ(J,Z,Q){let Y=A.map.statistics.feats,H=Z.match(/Feats\b\s*(.*)/i)[1].replace(/\s*[,;]+/g,",").trim(),[X,G]=await Y.parse(H,Q,"feats","feat","feat");if(J.notes.statistics.feats=G,!SBC.settings.getSetting("createAssociations")){let z=SBC.compendiumSearch;if(SBC.actor.getFeatCount().excess>0){let q={search:W.createSearchSet(["Bonus Feat","Bonus Feats","Bonus Combat Feats"],!0),item:"Bonus Feats"},K=await z.findEntityInCompendia(q,{itemType:"feat",itemSubType:"classFeat",classes:J.characterData.classes,race:J.characterData.race});if(K)await W.addAssociatedClass(K,SBC.actor.itemTypes.class),await g(K)}}return await uJ(J),X}async function DJ(J,Z,Q){let Y=A.map.statistics.languages,H=Z.match(/Languages\b\s*(.*)/i)[1].replace(/\s*[,;]+/g,",").trim();return await Y.parse(H,Q)}async function yJ(J,Z,Q){let Y=A.map.statistics.sq,H=Z.match(/SQ\b\s*(.*)/i)[1].replace(/\s*[,;]+\s*/g,", ").trim(),[X,G]=await Y.parse(H,Q,["monster-abilities","class-abilities"],["equipment","feat","weapon"],null,!1);return J.notes.statistics.sq=G,X}async function dJ(J,Z,Q){let Y=A.map.statistics.gear,H=Z.replace(/(Combat Gear|Other Gear|Gear)/g,"").replace(/[,;]+/g,",").replace(/[,;]$/,"").trim();if(!J.notes.statistics.gear)J.notes.statistics.gear=[];return await Y.parse(H,Q)}async function kJ(J,Z,Q){let Y=J.match(/(\w+)/)[1],H=J.match(/(\d+|-)/)[1];if(H==="-"||H===0||H==="0"){H=0;let q="no"+Y.capitalize();Z.flags[q]=!0}let X=await W.getTotalFromChanges(SBC.actor,Y),G=A.map.base.age.getAbilityChange(Y.toLowerCase()),z=+H-X-G;Z.characterData.conversionValidation.attributes[Y]=+H,Z.notes.statistics[Y.toLowerCase()]=+H,await A.map.statistics[Y.toLowerCase()].parse(+z,Q)}function mJ(J,Z){if(!M$)return!0;return y1||J===Z-1}async function uJ(J){let Z=SBC.actor.itemTypes.feat.filter((Q)=>Q.system.subType==="feat");for(let Q of Z){let Y=Q.name.toLowerCase(),H=W.parseSubtext(Y)[1];if(!H)continue;if(/greater weapon focus/.test(Y))J.characterData.weaponFocusGreater.push(H);else if(/weapon focus/.test(Y))J.characterData.weaponFocus.push(H);else if(/greater weapon specialization/.test(Y))J.characterData.weaponSpecializationGreater.push(H);else if(/weapon specialization/.test(Y))J.characterData.weaponSpecialization.push(H)}W.log("Weapon Focus",J.characterData.weaponFocus),W.log("Weapon Focus Greater",J.characterData.weaponFocusGreater),W.log("Weapon Specialization",J.characterData.weaponSpecialization),W.log("Weapon Specialization Greater",J.characterData.weaponSpecializationGreater)}async function v$(){let J={act:["blf","dis"],comedy:["blf","int"],dance:["acr","fly"],keyboard:["dip","int"],oratory:["blf","sen"],percussion:["han","int"],sing:["blf","sen"],string:["blf","dip"],wind:["dip","han"]},Z=A.map.statistics.skills,Q=P1.split(/racial (?:modifiers?|bonus)/i)[0];Q=Z.splitText(Q);for(let H of SBC.actor.itemTypes.feat.filter((X)=>X.system.subType==="classFeat"&&X.name.match(/Versatile Performance \(/i))){let X=W.parseSubtext(H.name)[1],G=J[X.toLowerCase()],z=Q.find((_)=>_.startsWith(`Perform (${X.toLowerCase()}`));if(G&&z){let _=z.match(/([+-]?\d+)/)[1];for(let q of G){let K=SBC.actor.getSkillInfo(q).name,V=Q.find((j)=>j.startsWith(K));if(V)if(V.match(/([+-]?\d+)/)[1]===_)Z.versatilePerformanceSkillOverrides[q]={name:X.toLowerCase(),value:_};else if(Z.versatilePerformanceSkillDisablers[q])Z.versatilePerformanceSkillDisablers[q].push(X);else Z.versatilePerformanceSkillDisablers[q]=[X]}}}if(await Z.parse(P1,d1),SBC.app.processData.characterData.isOutsider){let H=SBC.actor.items.get(SBC.app.processData.characterData.outsiderId);if(!H)return;let X={};SBC.app.processData.characterData.outsiderSkills.forEach((G)=>X[`system.classSkills.${G}`]=!0),await H.update(X)}if(SBC.app.processData.characterData.isExpert){let H=SBC.actor.items.get(SBC.app.processData.characterData.expertId);if(!H)return;let X={};SBC.app.processData.characterData.expertSkills.forEach((G)=>X[`system.classSkills.${G}`]=!0),await H.update(X)}let Y={};for(let H of Object.keys(Z.versatilePerformanceSkillDisablers))for(let X of Z.versatilePerformanceSkillDisablers[H]){let G=SBC.actor.allSkills.find((z)=>SBC.actor.getSkillInfo(z).name===X)?.replace("prf.","");if(G)Y[`${G}_${H}`]=!0}if(Object.keys(Y).length>0)await SBC.actor.setFlag(SBC.rollBonusOps.flagKey,"vp_disable_prf",Y)}async function U$(J,Z,Q){SBC.settings.getSetting("debug")&&console.groupCollapsed("sbc-pf1 | "+J.parsedCategories+"/"+J.foundCategories+" >> PARSING TACTICS DATA");let Y=[];J.notes.tactics={hasTactics:!0};let H=A.map.tactics;for(let X=0;X<Z.length;X++)try{let G=Z[X];if(!Y.beforeCombat&&G.match(/Before Combat/i)!==null)Y.beforeCombat=await pJ(H,J,G,Q+X);if(!Y.duringCombat&&G.match(/During Combat/i)!==null)Y.duringCombat=await oJ(H,J,G,Q+X);if(!Y.morale&&G.match(/^Morale/i)!==null)Y.morale=await cJ(H,J,G,Q+X);if(!Y.baseStatistics&&G.match(/^Base Statistics/i)!==null)Y.baseStatistics=await lJ(H,J,G,Q+X)}catch(G){SBC.settings.getSetting("debug")&&console.error(G);let z=`Parsing the tactics data failed at line ${Q+X+1} (non-critical)`,_=new f(f.ERRORLEVELS.WARNING,"Parse/Tactics",z,X+Q);return J.errors.push(_),SBC.settings.getSetting("debug")&&console.groupEnd(),!1}return W.log("RESULT OF PARSING TACTICS DATA (TRUE = PARSED SUCCESSFULLY)"),W.log(Y),SBC.settings.getSetting("debug")&&console.groupEnd(),!0}async function pJ(J,Z,Q,Y){let H={name:"Before Combat",entry:Q.match(/^(?:Before Combat)([\s\S]*?)(?=$|During Combat|Morale|Base Statistics)/i)[1]};return Z.notes.tactics.beforeCombat=H.entry,await J.parse(H,Y)}async function oJ(J,Z,Q,Y){let H={name:"During Combat",entry:Q.match(/^(?:During Combat)([\s\S]*?)(?=$|Morale|Base Statistics)/i)[1]};return Z.notes.tactics.duringCombat=H.entry,await J.parse(H,Y)}async function cJ(J,Z,Q,Y){let H={name:"Morale",entry:Q.match(/^(?:Morale)([\s\S]*?)(?=$|Base Statistics)/i)[1]};return Z.notes.tactics.morale=H.entry,await J.parse(H,Y)}async function lJ(J,Z,Q,Y){let H={name:"Base Statistics",entry:Q.match(/^(?:Base Statistics)([\s\S]*?)$/i)[1]};return Z.notes.tactics.baseStatistics=H.entry,await J.parse(H,Y)}class G0{static async prepareInput(J){if(SBC.isImporting=!0,SBC.settings.getSetting("debug")&&console.group("sbc-pf1 | PREPARING INPUT"),J.input.text==="")throw J.errors.push(new f(f.ERRORLEVELS.FATAL,"Prepare","Given input is empty.")),"Given input is empty.";try{if(game.modules.get("roll-bonuses-pf1")?.active)W.log("Roll Bonuses PF1 module is active"),J.flags.rollBonusesPF1=!0;$("#sbcProgressBar").css("width","5%");let Z=new RegExp("("+SBC.config.sources.join("\\b|")+")","gm");J.input.prepared.data=J.input.text.replace(/[]/gm,"-").replaceAll("","x").replace(/,+/gm,",").replaceAll("","1/2").replaceAll("","1/3").replaceAll("","1/4").replaceAll("","1/5").replaceAll("","1/6").replaceAll("","1/8").replace(Z,"").replace(/([a-z])B\b/gm,"$1").replace(/([a-z])M\b,\s*MA/gm,"$1M").replaceAll("",'"').replaceAll("",'"').replaceAll("","'").replaceAll("","'").replaceAll("","fl").replaceAll("","fi").replaceAll("","ff").replaceAll("","ffi").replaceAll("","ffl").replaceAll("","st").replace(/^-{20}$/gm,"").replace(/\*, (D,?)/g,"$1").split(/\n/g),W.log("Before: ",J.input.prepared.data);let Q=[],Y=new RegExp("^("+SBC.config.lineCategories.join("|")+")","i"),H=new RegExp("^("+SBC.config.lineStarts.join("|")+")(?!\\))","i");J.input.prepared.data.forEach((G,z)=>{if(Y.test(G)){if(G.match(/Offenses|Defenses/i))G=G.replace("Offenses","Offense").replace("Defenses","Defense");console.log(G,Y),G=G.toLowerCase().capitalize()}if(G&&SBC.config.lineStarts.some((_)=>G.startsWith(_)))Q.push(G);else if(z>0&&H.test(Q[Q.length-1])&&!H.test(G)&&!/^Description/i.test(Q[Q.length-1]))Q[Q.length-1]+=" "+G;else Q.push(G)});let X=0;for(let G=0;G<Q.length;G++){let z=Q[G];if(z.toLowerCase().startsWith("ecology")){X=G;continue}if(X&&z.toLowerCase().match(/^Treasure\s+(?:NPC gear|standard|double|triple)\s*\(.*\)/i)){let _="Gear "+z.replace(/^Treasure\s+(?:NPC gear|standard|double|triple)\s*\((.*?)(?:,\s+other treasure)?\)\s*$/i,"$1").replaceAll("[","(").replaceAll("]",")");Q.splice(G,1),Q.splice(X,0,_);break}}Q=Q.filter((G)=>!G.startsWith("*")),J.input.prepared.data=Q,W.log("After: ",J.input.prepared.data),J.input.prepared.success=!0,J.input.text=J.input.prepared.data.join(`
`)}catch(Z){let Q=new f(f.ERRORLEVELS.FATAL,"Prepare",Z);throw J.errors.push(Q),J.input.prepared.success=!1,Z}SBC.settings.getSetting("debug")&&console.groupEnd()}static async parseInput(J){SBC.settings.getSetting("debug")&&console.group("sbc-pf1 | PARSING INPUT");let Z=J.characterData,Q=J.input.text;if(Z==null||!Q){if(Z==null)J.errors.push(new f(f.ERRORLEVELS.FATAL,"Input","No valid characterData found"));if(!J.input.text)J.errors.push(new f(f.ERRORLEVELS.FATAL,"Parse","Not enough input found to parse"));J.input.prepared.success=!1}if(J.input.prepared.success){let Y=SBC.actor.type;try{G0.updateProgressBar(J,"Preparation","Clean-up");let H=A.map.types[Y];console.log(H);let X={};for(let q=1;q<H.length;q++){let K=H[q],V=new RegExp("^\\b"+K+"\\b\\s*(?:\\r?\\n|$)","i");J.input.prepared.data.filter(function(j,P){if(V.test(j)&&X[K]==null)X[K]=P})}let G=Object.keys(X),z=G.join(", ").capitalize();G.unshift("base");let _={};if(J.foundCategories=G.length,console.log("Found Categories: ",G,G.length),G.length!==0){let q=A.getNeededCategories(Y);if(q.length?q.every((V)=>G.includes(V)):!0){let V={base:[],description:[]},j={base:0,description:0};if(["npc","character"].includes(Y))V=foundry.utils.mergeObject(V,{defense:[],offense:[],statistics:[],tactics:[],ecology:[],specialAbilities:[]}),j=foundry.utils.mergeObject(j,{defense:0,offense:0,statistics:0,tactics:0,ecology:0,specialAbilities:0});let P=0;for(let L=0;L<G.length;L++){let E=G[L],B=P;j[E]=B;let N=X[G[L+1]];if(L===G.length-1)V[E]=J.input.prepared.data.slice(B);else V[E]=J.input.prepared.data.slice(B,N);P=N}let O=G;if(["npc","character"].includes(Y)){if(O.splice(G.indexOf("statistics"),1),O.splice(1,0,"statistics"),G.includes("special abilities"))O.splice(G.indexOf("special abilities"),1),O.splice(0,0,"special abilities")}for(let L=0;L<O.length;L++){let E=O[L];G0.updateProgressBar(J,"Parsing",E,O.length,L+1),_[E]=await G0.parseCategories(J,E,V[E],j[E])}if(["npc","character"].includes(Y)){if(G0.updateProgressBar(J,"Buffs","Looking for Auras and Buffs"),await j$(),await nJ(),G0.updateProgressBar(J,"Flags","Checking if Special Flags were set"),await A1(J),await rJ(J),SBC.settings.getSetting("rollBonusesIntegration"))await SBC.rollBonusOps.processTargets(SBC.actor.allItems);await g1.conversionValidation(J)}G0.updateProgressBar(J,"Preview","Generating Preview"),await iJ(J),J.input.prepared.success=!0,G0.updateProgressBar(J,"Ready","Actor is ready")}else{let V=`Failed to find enough keywords to parse the input.<br>
                                        Found Keywords: ${z}<br>
                                        Needed Keywords: Defense, Offense, Statistics<br>
                                        Optional Keywords: Special Abilities, Ecology, Tactics, Description`,j=new f(f.ERRORLEVELS.FATAL,"Parse",V);J.errors.push(j),J.input.prepared.success=!1,G0.updateProgressBar(J,"Error","An Error occurred during parsing")}}else{console.log("No categories found");let q=`Failed to find any keywords to parse the input.<br>
                                        Needed Keywords: Defense, Offense, Statistics<br>
                                        Optional Keywords: Special Abilities, Ecology, Tactics, Description`,K=new f(f.ERRORLEVELS.FATAL,"Parse",q);J.errors.push(K),J.input.prepared.success=!1,G0.updateProgressBar(J,"Error","An Error occurred during parsing")}}catch(H){let X="parseInput() failed with an unspecified error. Sorry!",G=new f(f.ERRORLEVELS.FATAL,"Parse",X);throw J.errors.push(G),J.input.prepared.success=!1,G0.updateProgressBar(J,"Error","An Error occurred during parsing"),H}}else{let Y="parseInput() failed as the input could not be prepared successfully",H=new f(f.ERRORLEVELS.FATAL,"Parse",Y);J.errors.push(H),J.input.prepared.success=!1,G0.updateProgressBar(J,"Error","An Error occurred during parsing")}SBC.settings.getSetting("debug")&&console.groupEnd()}static async parseCategories(J,Z,Q,Y){switch(Z){case"base":await F$(J,Q,Y);break;case"defense":await L$(J,Q,Y);break;case"offense":await E$(J,Q,Y),SBC.settings.getSetting("debug")&&console.groupCollapsed("sbc-pf1 | >> PARSING SKILL DATA"),await v$(),SBC.settings.getSetting("debug")&&console.groupEnd();break;case"statistics":await R$(J,Q,Y);break;case"tactics":await U$(J,Q,Y);break;case"ecology":await P$(J,Q,Y);break;case"special abilities":await N$(J,Q,Y);break;case"description":await O$(J,Q,Y);break;default:J.errors.push(new f(f.ERRORLEVELS.ERROR,"Parse/Categories",`No Parser found for category: ${Z}`)),J.input.prepared.success=!1;return}J.parsedCategories++}static async updateProgressBar(J,Z="",Q="",Y=1,H=1){let X=0,G=Q,z=100/Y;switch(J.progressBar.class=Z.toLowerCase(),Z.toLowerCase()){case"preparation":X=10,G=Z+": "+Q;break;case"parsing":X=Math.floor(10+0.6*z*H),G=Z+": "+Q;break;case"buffs":X=90;break;case"flags":X=95;break;case"preview":X=99;break;case"actor":X=100;break;case"error":X=100;break;default:break}J.progressBar.width=X,J.progressBar.text=G,await SBC.app.render()}}var q$=(J)=>{return W.parseSubtext(J)},z$=async(J,Z,Q)=>{let Y=Z.split("."),H=J;for(let X=0;X<Y.length-1;X++)H=H[Y[X]]||{};H[Y[Y.length-1]]=Q},j0=async(J,Z,Q)=>{return J.update({[Z]:Q})};async function A1(J,Z="all"){W.log("Flags set during the conversion process"),W.log(J.flags);let Q=[],Y=Z==="all"?Object.keys(J.flags):[Z];for(let H of Y)if(J.flags[H]){let X=[],G=null,z="string",_=!1;switch(H){case"isUndead":if(X=["system.attributes.hpAbility","system.attributes.savingThrows.fort.ability"],J.flags[H]===!0)G="cha";else G="con";_=!0;break;case"noStr":X=["system.abilities.str.base","system.abilities.str.value","system.abilities.str.total"],_=!0,G="NaN";break;case"noDex":X=["system.abilities.dex.base","system.abilities.dex.value","system.abilities.dex.total"],_=!0,G="NaN";break;case"noCon":X=["system.abilities.con.base","system.abilities.con.value","system.abilities.con.total"],_=!0,G="NaN";break;case"noInt":X=["system.abilities.int.base","system.abilities.int.value","system.abilities.int.total"],_=!0,G="NaN";break;case"noWis":X=["system.abilities.wis.base","system.abilities.wis.value","system.abilities.wis.total"],_=!0,G="NaN";break;case"noCha":X=["system.abilities.cha.base","system.abilities.cha.value","system.abilities.cha.total"],_=!0,G="NaN";break;default:break}if(_){let q=new a(SBC.app,X,z);Q[H]=await q.parse(G,-1)}}}async function g(J){try{let Z=await pf1.migrations.migrateItemData(J.toObject());if(!foundry.utils.isEmpty(Z))await J.updateSource(Z);return await J.updateSource({"system.links.supplements":[]}),[!0,(await SBC.actor.createEmbeddedDocuments("Item",[J.toObject()]))[0]]}catch(Z){SBC.settings.getSetting("debug")&&console.error(Z);let Q=`Failed to create embedded item ${J.name}.`,Y=new f(f.ERRORLEVELS.ERROR,"Parse",Q);return SBC.app.processData.errors.push(Y),SBC.app.processData.input.prepared.success=!1,[!1,null]}}async function nJ(){let J=SBC.compendiumSearch;try{SBC.settings.getSetting("debug").debug&&console.groupCollapsed("sbc-pf1 | Finding Buffs");let Z=SBC.actor.items.filter((Q)=>["feat","consumable","spell"].includes(Q.type));for(let Q of Z){let Y=Q.name,H=Y.replace(/(constant|weekly|monthly|yearly):/gi,"").trim(),X=Y.replace(/^(?:Potion|Wand) of\s+/gi,"").trim();console.log(`Checking ${Y}`,Q);let G={search:new Set([Y]),type:"buff",item:Y},z=Y.split(" ").slice(0,2).map((K)=>K.toLowerCase()),_=P0.find((K)=>{return K.split(" ").map((j)=>j.toLowerCase()).every((j)=>z.includes(j))});if(_)G.search.add(H.replace(new RegExp(`${_}`,"i"),"").trim()),G.search.add(X.replace(new RegExp(`${_}`,"i"),"").trim());else G.search.add(H),G.search.add(X);let q=await J.findEntityInCompendia(G,{packs:["pf1.commonbuffs"],itemType:"buff",classes:SBC.app.processData.characterData.classes});if(!q)q=game.items.getName(G.name);if(!q)q=game.items.getName(G.altName);if(q){console.log(`Found ${Y}.`,q);let K=0;switch(Q.type){case"spell":{let P=Q.system.spellbook;console.log(`Spellbook key for ${Y}: ${P}`);let O=pf1.utils.deepClone(Q.spellbook);console.log(`Spellbook data for ${Y}: `,O,O?.cl);let L=SBC.actor.system.attributes.spells.spellbooks[P]?.cl.total??-1;console.log(`Caster level for ${Q.name}: ${L}`)}break;case"consumable":K=Q.system.cl||0;break}if(K>0)q.updateSource({"system.level":K});console.log(`Creating buff for ${Y}.`);let[V,j]=await g(q);if(/^Constant:/i.test(Y))await j.update({"system.duration.value":""}),await j.setActive(!0)}}SBC.settings.getSetting("debug")&&console.groupEnd()}catch(Z){SBC.settings.getSetting("debug")&&console.error(Z)}}async function iJ(J){let Z="";if(game.version.startsWith("13"))Z=await foundry.applications.handlebars.renderTemplate("modules/pf1-statblock-converter/templates/sbcPreview.hbs",{actor:SBC.actor||{},notes:J.notes,flags:J.flags});else Z=await renderTemplate("modules/pf1-statblock-converter/templates/sbcPreview.hbs",{actor:SBC.actor||{},notes:J.notes,flags:J.flags});let Q=new Date,Y="";if(game.version.startsWith("13"))Y=await foundry.applications.handlebars.renderTemplate("modules/pf1-statblock-converter/templates/sbcNotes.hbs",{version:SBC.config.modData.version,date:Q.toLocaleString(game.settings?.get("core","language")||"en",{month:"long",day:"numeric",year:"numeric"}),preview:Z,rawInput:J.input.text});else Y=await renderTemplate("modules/pf1-statblock-converter/templates/sbcNotes.hbs",{version:SBC.config.modData.version,date:Q.toLocaleString(game.settings?.get("core","language")||"en",{month:"long",day:"numeric",year:"numeric"}),preview:Z,rawInput:J.input.text});await SBC.actor?.update({"system.details.notes.value":Y})}async function rJ(J){let Z=J.miscNotes,Q=SBC.actor,Y=[],H=[],X=`<p>This feature was created by <strong>SBC</strong> to collect any notes that don't have a source on the actor,
                such as saving throw details or a bonus to CMD from extra legs. It may also be used to record a natural armor bonus,
                spell resistance bonus, or spellcasting notes.</p>`,G=!1;if(Z.acNotes.length>0)G=!0,Y.push({target:"ac",text:Z.acNotes.join(", ")}),X+=`<p><strong>Armor Class Notes:</strong></p><p>${Z.acNotes.join(", ")}</p>`;if(Z.srNotes)G=!0,Y.push({target:"sr",text:Z.srNotes}),X+=`<p><strong>Spell Resistance Notes:</strong></p><p>${Z.srNotes}</p>`;if(Z.cmbNotes)G=!0,Y.push({target:"cmb",text:Z.cmbNotes}),X+=`<p><strong>CMB Notes:</strong></p><p>${Z.cmbNotes}</p>`;if(Z.cmdNotes)G=!0,Y.push({target:"cmd",text:Z.cmdNotes}),X+=`<p><strong>CMD Notes:</strong></p><p>${Z.cmdNotes}</p>`;if(Z.saveNotes)G=!0,Y.push({target:"allSavingThrows",text:Z.saveNotes}),X+=`<p><strong>Saving Throw Notes:</strong></p><p>${Z.saveNotes}</p>`;if(Z.sr>0)G=!0,H.push(await new pf1.components.ItemChange({formula:Z.sr.toString(),type:"untyped",target:"spellResist",value:+Z.sr}).toObject());if(Z.naturalAC>0)G=!0,H.push((await new pf1.components.ItemChange({formula:Z.naturalAC.toString(),type:"untyped",target:"nac",value:+Z.naturalAC})).toObject());if(!G)return;await Q.createEmbeddedDocuments("Item",[{name:"Miscellaneous Notes",type:"feat",system:{changes:H,contextNotes:Y,description:{value:X},subType:"misc",tag:"miscellaneousNotes"},img:"systems/pf1/icons/skills/yellow_36.jpg"}])}class T0{static get defaultData(){return{actorReady:!1,appData:{},characterData:{conversionValidation:{context:{},attributes:{},skills:{},spellBooks:{}},weaponFocus:[],weaponSpecialization:[],weaponFocusGreater:[],weaponSpecializationGreater:[],classes:[],archetypes:[],race:null,weaponGroups:{},hdMaximized:!1,prestigeClassCasting:new Map,isOutsider:!1,outsiderId:null,outsiderSkillPicks:4,outsiderSkills:[],isExpert:!1,expertId:null,expertSkillPicks:10,expertSkills:[],versatilePerformances:[]},changes:{},errors:[],flags:{hasNoCMB:!1,hasNoCMD:!1,noStr:!1,noDex:!1,noCon:!1,noInt:!1,noWis:!1,noCha:!1,isUndead:!1,isConstruct:!1,hasWeaponFinesse:!1},foundCategories:0,parsedCategories:1,imported:!1,input:{data:[],text:"",html:"",prepared:{data:[],success:!1},parsedSuccess:!1},miscNotes:{acNotes:[],cmdNotes:"",saveNotes:"",sr:0,srNotes:"",naturalAC:0,spellbookNotes:[]},notes:{},treasureParsing:{treasureToParse:"",lineToRemove:0,statisticsStartLine:0},progressBar:{class:"",text:"",width:0}}}}var{ApplicationV2:sJ,HandlebarsApplicationMixin:aJ}=foundry.applications.api;class k1 extends aJ(sJ){constructor(J,Z){super(Z);if(this.autoConvert=SBC.settings.getSetting("autoConvert"),this.processData=foundry.utils.mergeObject(T0.defaultData,{appData:J}),J.statblock){this.processData.input.text=J.statblock;let Q=this;setTimeout(async()=>{if(this.autoConvert)await Q.checkInput(document.getElementById("sbcInput"))},SBC.settings.getSetting("inputDelay"))}}static DEFAULT_OPTIONS={uniqueId:"sbcModal",id:"sbcModal",classes:["sbcModal"],position:{width:1024,height:768},window:{title:"SBCPF1.sbcTitle",resizable:!0},dragDrop:[{dragSelector:"#sbcModal"}]};get title(){return game.i18n.localize("SBCPF1.sbcTitle")}static PARTS={div:{scrollable:[".sbcInput",".sbcHighlights",".sbcPreview"],template:"modules/pf1-statblock-converter/templates/sbcModal.hbs"}};async close(J){if(!this.processData.imported&&SBC.actor?.id)await game.actors.get(SBC.actor.id)?.delete();SBC.app=null,await super.close(J)}async _preparePartContext(J,Z,Q){let Y=await super._preparePartContext(J,Z,Q);Y=foundry.utils.mergeObject(Y,{input:this.processData.input.text,actorType:SBC.actorType,choices:{0:"NPC",1:"PC"},errors:[],errorHighlights:[],preview:"",progressBar:{class:this.processData.progressBar.class,ready:this.processData.input?.prepared?.success||!1,text:this.processData.progressBar.text,width:this.processData.progressBar.width},autoConvert:this.autoConvert,actorArtPath:SBC.actorArtPath,tokenArtPath:SBC.tokenArtPath}),this.processData.input.prepared.data.forEach((z,_)=>{Y.errorHighlights.push({value:z,messageBefore:"",messageAfter:"",line:_,marked:!1})});let H=0,X="",G=0;if(this.processData.errors.forEach((z,_)=>{let q=z.errorLabel;if(z.level===f.ERRORLEVELS.ERROR||z.level===f.ERRORLEVELS.FATAL)q+=` >> ${z.keyword} failed `;if(q+=` >> ${z.message}`,q!==X){if(H=_,X=q,z.line!==-1&&z.value&&z.value instanceof String){let K=this.processData.input.prepared.data[z.line],V=z.value.trim(),[j,P]=K.split(V);Y.errorHighlights[z.line]={value:V,messageBefore:j,messageAfter:P,line:z.line,marked:!0}}Y.errors.push({message:q,duplicates:G})}else Y.errors[H].duplicates=G,G++}),Y.progressBar.ready)if(game.version.startsWith("13"))Y.preview=await foundry.applications.handlebars.renderTemplate("modules/pf1-statblock-converter/templates/sbcPreview.hbs",{actor:SBC.actor,notes:this.processData.notes,flags:this.processData.flags});else Y.preview=await renderTemplate("modules/pf1-statblock-converter/templates/sbcPreview.hbs",{actor:SBC.actor,notes:this.processData.notes,flags:this.processData.flags},{async:!0});return Y}async handleArtDrop(J){J.preventDefault(),console.debug("Got handleArtDrop event:"),console.debug(J);let Z=J.dataTransfer.files;console.debug("FileList is: "),console.debug(Z);let Q;if(!Z||Z.length===0){let Y=J.dataTransfer.getData("Text");if(!Y){this.element._onDrop(J);return}if(Y.includes("?"))Y=Y.substr(0,Y.indexOf("?"));let H=Y.split("/"),X=H[H.length-1];if(!X.includes(".")){console.log("SBC | Dragged non-file text:",Y),this.element._onDrop(J);return}let G=X.substr(X.lastIndexOf(".")+1);if(!Object.keys(CONST.IMAGE_FILE_EXTENSIONS).includes(G)){console.log("SBC | Dragged file with bad extension:",Y),this.element._onDrop(J);return}if(Y.includes("imgur")&&X.endsWith("_d.webp"))X=X.substr(0,X.length-7)+".png",Y=Y.substr(0,Y.length-7)+".png";Q={isExternalUrl:!0,url:Y,name:X}}else Q=Z[0];if(Q==null){console.log("SBC | No Files detected"),this.element._onDrop(J);return}console.debug("file is: "),console.debug(Q),await this.uploadFile(J,Q)}async uploadFile(J,Z){let Q=SBC.settings.getSetting("fileStorageSource"),Y="";if(await foundry.applications.api.DialogV2.wait({window:{title:W.translate("dialog.artwork.title")},content:`<p>${W.translate("dialog.artwork.selectType")}</p>`,classes:[],buttons:[{action:"one",default:!0,icon:"",label:W.translate("dialog.artwork.actor"),callback:()=>Y="actor"},{action:"two",icon:"",label:W.translate("dialog.artwork.token"),callback:()=>Y="token"}],rejectClose:!1}),!Y)return;if(SBC.isImporting)return;let H;if(Z.isExternalUrl)H={path:Z.url};else H=await FilePicker.upload(Q,`${SBC.targetFolder}/${Y}`,Z,Q==="s3"?{bucket:SBC.settings.getSetting("fileStorageBucket")}:{});SBC[`${Y}ArtPath`]=H.path,this.element.querySelector(`#sbc${W.capitalize(Y)}ArtPath`).value=SBC[`${Y}ArtPath`]}_onRender(J,Z){super._onRender(J,Z);let Q=this.element.querySelector("#sbcInput"),Y=this.element.querySelectorAll(".actorTypeToggle"),H=this;for(let q=0;q<Y.length;q++)Y[q].addEventListener("click",this.toggleActorType.bind(this,Q));if(Q.addEventListener("keyup",tJ(async()=>{if(H.autoConvert)await H.checkInput(Q)},SBC.settings.getSetting("inputDelay"))),Q.addEventListener("scroll",this.syncScrolls.bind(this)),this.element.querySelector("#sbcAutoConvertToggle").addEventListener("click",async(q)=>{let K=q.target.checked;if(H.autoConvert=K,W.log(`Auto Convert is now ${K?"enabled":"disabled"}`),K)await H.checkInput(Q);else await H.render(!0)}),this.element.querySelector("#sbcConvertButton").addEventListener("click",async()=>{let q=document.getElementById("sbcInput");await H.checkInput(q)}),this.element.querySelector("#sbcImportButton").addEventListener("click",this.import.bind(this)),this.element.querySelector("#sbcResetButton").addEventListener("click",this.resetSBC.bind(this)),this.element.querySelector("#sbcActorArtButton").addEventListener("click",(q)=>this._onActorArtBrowse(q)),this.element.querySelector("#sbcTokenArtButton").addEventListener("click",(q)=>this._onTokenArtBrowse(q)),this.element.querySelector("#sbcActorArtPath").addEventListener("change",(q)=>{SBC.actorArtPath=q.target.value}),this.element.querySelector("#sbcTokenArtPath").addEventListener("change",(q)=>{SBC.tokenArtPath=q.target.value}),this.element.querySelectorAll("[data-tooltip-extended]").forEach((q)=>{q.addEventListener("pointerover",this._activateExtendedTooltip.bind(this))}),this.element.querySelectorAll("[data-tooltip-extended]").forEach((q)=>{q.addEventListener("pointerleave",()=>game.tooltip.deactivate())}),game.version.startsWith("13"))this.dragDrop=new foundry.applications.ux.DragDrop({dropSelector:".sbcContainer",callbacks:{drop:this.handleArtDrop.bind(this)}}).bind(this.element);else this.dragDrop=new DragDrop({dropSelector:".sbcContainer",callbacks:{drop:this.handleArtDrop.bind(this)}}).bind(this.element)}async _activateExtendedTooltip(J){let Z=J.currentTarget,Q=Z.dataset.tooltipExtended;if(!Q)return;let Y=Q==="actor"?SBC.actorArtPath:SBC.tokenArtPath,H=document.createElement("template");if(H.innerHTML=`<div class="flexcol sbcExtendedTooltipText">
        <h3>${game.i18n.localize(`SBCPF1.${Q}Art`)}</h3>
        </div>`,Y){let X=Y.split("/").pop().replace(/\.[^.]+$/,"");H.innerHTML+=`<div class="flexcol sbcExtendedTooltip">
      <p>${X}</p>
      <img src="${Y}" alt="${game.i18n.localize(`SBCPF1.${Q}Art`)}" />
      </div>`}game.tooltip.activate(Z,{content:H.content,cssClass:"extended sbc",direction:Z.dataset.tooltipDirection||void 0})}_onActorArtBrowse(J){if(SBC.isImporting)return;let Z=SBC.settings.getSetting("actorArtFolder")||"";new FilePicker({type:"image",current:Z,callback:(Y)=>SBC.actorArtPath=Y,top:this.position.top+40,left:this.position.left+10,button:J.currentTarget,field:this.element.querySelector("#sbcActorArtPath")}).browse()}_onTokenArtBrowse(J){if(SBC.isImporting)return;let Z=SBC.settings.getSetting("tokenArtFolder")||"";new FilePicker({type:"image",current:Z,callback:(Y)=>SBC.tokenArtPath=Y,top:this.position.top+40,left:this.position.left+10,button:J.currentTarget,field:this.element.querySelector("#sbcTokenArtPath")}).browse()}syncScrolls(J){let Z=document.getElementById("sbcInput"),Q=document.getElementById("sbcBackdrop");Q.scrollTop=Z.scrollTop}async toggleActorType(J,Z){let Q=SBC.config;W.log(`Switching between ${Q.const.actorType[SBC.actorType]} and ${Q.const.actorType[+Z.target.value]} actor type.`),SBC.actorType=Z.target.value,SBC.configInitialized=!1,SBC.actor=await W.reinitActor(SBC.actor);let Y=this.processData.input.text,H=this.processData.appData;this.processData=foundry.utils.mergeObject(T0.defaultData,{appData:H}),this.processData.input.text=Y,J.value=Y,SBC.configInitialized=!0,J.dispatchEvent(new Event("keyup"))}async checkInput(J){if(!SBC.configInitialized)return;if(SBC.isImporting)return;let Z=this.processData.appData;if(this.processData=foundry.utils.mergeObject(T0.defaultData,{appData:Z}),this.processData.input.text=J.value.trim(),SBC.actor=await W.reinitActor(SBC.actor),this.processData.input.text){this.processData.actorReady=!1;try{await G0.prepareInput(this.processData)}catch(Q){console.error(Q)}try{await game.i18n.setLanguage("en"),await G0.parseInput(this.processData)}catch(Q){J.value=this.processData.input.prepared.data.join(`
`),SBC.isImporting=!1,await this.render()}finally{await game.i18n.setLanguage(globalThis.SBC.originalLang)}if(J.value=this.processData.input.prepared.data.join(`
`),this.processData.input.prepared.success)SBC.isImporting=!1,this.processData.actorReady=!0,Hooks.callAll("sbc.inputParsed"),await this.render();else{SBC.isImporting=!1,console.error("Could not parse the input");let Q=new f(f.ERRORLEVELS.FATAL,"Parse","Could not parse the input");this.processData.errors.push(Q),await this.render()}}else await this.render()}async import(){if(SBC.isImporting)return;if(console.log("Importing..."),W.log("Finished parsing. Importing..."),!this.processData.input.text){let J=new f(f.ERRORLEVELS.FATAL,"Input","No Input found");this.processData.errors.push(J)}else if(!this.processData.actorReady){let J=new f(f.ERRORLEVELS.FATAL,"Import","Could not create an Actor");this.processData.errors.push(J)}else{let J=SBC.actor.toObject(),Z=await pf1.migrations.migrateActorData(J,null,{actor:SBC.actor});if(Z.folder=SBC.folderId,Z[`flags.${SBC.config.modData.mod}.version`]=SBC.config.modData.version,SBC.uuidSource)Z[`flags.${SBC.config.modData.mod}.uuid`]=SBC.uuidSource;if(SBC.actorArtPath)Z.img=SBC.actorArtPath;if(SBC.tokenArtPath)Z["prototypeToken.texture.src"]=SBC.tokenArtPath;let Q=[];for(let Y of Object.values(SBC.actor.itemTypes))Q=Q.concat(Y.sort((H,X)=>H.name.localeCompare(X.name)).map((H,X)=>({_id:H.id,sort:112500+X*CONST.SORT_INTEGER_DENSITY})));await SBC.actor.updateEmbeddedDocuments("Item",Q),await SBC.actor.update(Z),await SBC.actor.performRest({restoreHealth:!1}),Hooks.callAll("sbc.actorImported",SBC.actor),this.processData.imported=!0,await this.close();return}this.render(!0)}async resetSBC(){let J=this.processData.appData;this.processData=foundry.utils.mergeObject(T0.defaultData,{appData:J}),SBC.actor=await W.reinitActor(SBC.actor),this.render(!0)}}function tJ(J,Z){let Q;return(...Y)=>{clearTimeout(Q),Q=setTimeout(function(){J.apply(this,Y)},Z)}}class W{static async createActor(){let J=await Actor.create({name:"sbc | Actor Template",type:SBC.config.const.actorType[SBC.actorType],folder:SBC.wipFolderId});return await this.setTokenData(J),J}static async reinitActor(J){if(J){if(game.actors.get(J.id))W.log(`Deleting actor ${J.name} with ID ${J.id}.`,void 0,"info"),await J.delete()}return await W.createActor()}static async setTokenData(J){let Z=J.type==="character"?"pc":"npc";return await J.update({prototypeToken:{displayName:SBC.settings.getSetting("displayName"),sight:{enabled:SBC.settings.getSetting(`${Z}sight`)},disposition:SBC.settings.getSetting("disposition"),displayBars:SBC.settings.getSetting("displayBars"),bar1:SBC.settings.getSetting("attributeBar1"),bar2:SBC.settings.getSetting("attributeBar2"),brightSight:0}})}static log(J,Z=null,Q="debug"){let Y=console[Q];if(Y==="debug"&&!SBC.settings.getSetting("debug"))return;let H=`
`+new Error().stack.split(`
`).slice(2,3).join(`
`);if(Z)Y("sbc-pf1 | "+J,Z,H);else Y("sbc-pf1 | "+J,H)}static async generatePlaceholderEntity(J,Z=-1){let Q={name:J.name?J.name:J.item?J.item:"undefined",type:J.type?J.type:null,changes:J.changes||[],creatureTypes:J.creatureTypes?J.creatureTypes:[],creatureSubtypes:J.creatureSubtypes?J.creatureSubtypes:[],img:J.img?J.img:"systems/pf1/icons/skills/yellow_36.jpg",size:J.size?J.size:"med",sources:J.sources?J.sources:[],subtext:J.subtext?J.subtext:null,currency:J.currency?J.currency:null,price:J.price||0,enhancement:J.enhancement?J.enhancement:null,mwk:J.mwk?J.mwk:null,quantity:J.quantity?J.quantity:null,wizardClass:J.wizardClass?J.wizardClass:null,suffix:J.suffix?J.suffix:null,archetype:J.archetype?J.archetype:null,level:J.level?J.level:null,specialAbilityType:J.specialAbilityType?J.specialAbilityType:"na",desc:J.desc?J.desc:"sbc | Placeholder"},Y=null;switch(J.type){case"container":Y=new Item.implementation({name:Q.name,type:"container",system:{description:{value:"sbc | All currency carried was put into this container."},currency:{pp:Q.currency.pp,gp:Q.currency.gp,sp:Q.currency.sp,cp:Q.currency.cp},weightReduction:100},img:"systems/pf1/icons/items/inventory/pouch-sealed.jpg"});break;case"feat":case"feats":Y=new Item.implementation({name:Q.name.capitalize(),type:"feat",system:{description:{value:"sbc | As "+Q.name+" could not be found in any compendium, a placeholder was generated."}},img:Q.img});break;case"race":Y=new Item.implementation({name:Q.name.capitalize(),type:"race",system:{creatureTypes:Q.creatureTypes,description:{value:Q.desc||"sbc | As no playable race was found a placeholder was generated."},size:Q.size,creatureSubtypes:Q.creatureSubtypes,sources:Q.sources},img:Q.img});break;case"misc":Y=new Item.implementation({name:Q.name.capitalize(),type:"feat",system:{abilityType:Q.specialAbilityType,description:{value:Q.desc},changes:Q.changes,subType:"misc"},img:Q.img});break;case"attack":Y=new Item.implementation({name:Q.name.capitalize(),type:"attack",system:{description:{value:Q.desc},subType:"misc"},img:Q.img});break;case"classFeat":case"class-abilities":if(Q.specialAbilityType!==null)Y=new Item.implementation({name:Q.name.capitalize(),type:"feat",system:{abilityType:Q.specialAbilityType,description:{value:Q.desc},subType:"classFeat"},img:Q.img});else Y=new Item.implementation({name:Q.name.capitalize(),type:"feat",system:{abilityType:"",description:{value:Q.desc},subType:"classFeat"},img:Q.img});break;case"domains":case"mysteries":case"oppositions":case"spirits":case"bloodlines":case"patrons":case"thassilonianSpecialist":case"inquisition":Y=new Item.implementation({name:Q.name.capitalize(),type:"feat",system:{description:{value:"sbc | As there is no dedicated field for "+Q.type+", this placeholder was created."},subType:"classFeat"},img:Q.img});break;case"loot":{Y=new Item.implementation({name:Q.quantity>1?this.singularize(Q.name):Q.name,type:Q.type,system:{quantity:Q.quantity,value:Q.value,price:Q.price,description:{value:"sbc | As "+Q.name+" could not be found in any compendium, a placeholder was generated."}},img:Q.img});break}default:Y=new Item.implementation({name:Q.name.capitalize(),type:Q.type,system:{description:{value:"sbc | As "+Q.name+" could not be found in any compendium, a placeholder was generated."}},img:Q.img});break}return Y}static cleanLine(J,Z){return Z.replace(J,"").trim()}static haystackSearch(J,Z){if(!Z)return null;J=J.sort((Q,Y)=>Y.length-Q.length),Z=Z.toLowerCase();for(let Q of J)if(Z.includes(Q.toLowerCase()))return Q;return null}static haystackRegexSearch(J,Z){if(!Z)return null;J=J.sort((Q,Y)=>Y.length-Q.length),Z=Z.toLowerCase();for(let Q of J)if(Z.match(new RegExp(Q,"i"))!==null)return console.log(Q),Q;return null}static haystackSearchAll(J,Z){if(!Z)return null;let Q=[];Z=Z.toLowerCase();for(let Y of J)if(Z.includes(Y.toLowerCase()))Q.push(Y);return Q}static parseSubtext(J){let Z=J.replace(/(^[,;.: ]*|[,;.: ]+$)/g,""),Q=Z.indexOf("("),Y=Z.indexOf(")");if(Y===-1)Z+=")",Y=Z.indexOf(")");if(Q>-1&&Y>Q){let H=Z.substring(0,Q).trim(),X=Z.substring(Q+1,Y).trim(),G=[];if(Y+1<Z.length){let z=Z.substring(Y+1).replace(/(^[,;.: ]*|[,;.: ]+$)/g,"").trim();G=this.parseSubtext(z)}if(!Array.isArray(G)||!G.length)return[H,X];else return[H,X,G]}else return[J]}static getKeyByValue(J,Z){return Object.keys(J).find((Q)=>J[Q].toLowerCase()===Z.toLowerCase())}static getModifier(J){return Math.floor((J-10)/2)}static getDiceAverage(J,Z=0.5){return(J+1)*Z}static async getTotalFromChanges(J,Z,Q=null){let Y=J.items.contents,H=0,X=J.getRollData();return await Promise.all(Y.map(async(G)=>{if(G.system.changes){let z=G.system.changes,_=G.getRollData(),q=z.find(function(K){if(K.target.toLowerCase()===Z.toLowerCase()&&(!Q||K.type===Q))return K});if(q){let K=null;if(/@class\.level/.test(q.formula))K=await Roll.fromTerms(Roll.parse(q.formula,_)).evaluate();else K=await Roll.fromTerms(Roll.parse(q.formula,X)).evaluate();H+=K?.total??+q.formula}}})),Promise.resolve(H)}static makeValueRollable(J){return J.replace(/(\d+d\d+)/g,"[[$1]]")}static camelize(J){if(!J)return J;return J.replace(/^([A-Z])|[\s-_]+(\w)/g,function(Z,Q,Y,H){if(Y)return Y.toUpperCase();return Q.toLowerCase()})}static translate(J,Z={}){return game.i18n.format(`SBCPF1.${J}`,Z)}static async runParallelOps(J,Z,Q=[]){if(Array.isArray(J)){let H=J.map(async(X,G)=>await Z(X,G,...Q));return await Promise.all(H)}let Y=Object.keys(J).map(async(H)=>await Z(J[H],H,...Q));return await Promise.all(Y)}static convertStringUnits(J){let Z=J.matchAll(/(\d+)-foot/g);for(let K of Z){let[V,j]=pf1.utils.convertDistance(+K[1]);J=J.replace(K[0],V+"-"+(j==="m"?"meter":"foot"))}let Q=J.matchAll(/(\d+)-mile/g);for(let K of Q){let[V,j]=pf1.utils.convertDistance(+K[1],"mi");J=J.replace(K[0],V+"-"+(j==="km"?"kilometer":"mile"))}let Y=J.matchAll(/(\d+) feet/g);for(let K of Y){let[V,j]=pf1.utils.convertDistance(+K[1]);J=J.replace(K[0],V+" "+(j==="m"?"meters":"feet"))}let H=J.matchAll(/(\d+) miles/g);for(let K of H){let[V,j]=pf1.utils.convertDistance(+K[1],"mi");J=J.replace(K[0],V+" "+(j==="km"?"kilometers":"miles"))}let X=J.matchAll(/(\d+) ft\./g);for(let K of X)J=J.replace(K[0],pf1.utils.convertDistance(+K[1]).join(" "));let G=J.matchAll(/(\d+) mi\b/g);for(let K of G)J=J.replace(K[0],pf1.utils.convertDistance(+K[1],"mi").join(" "));let z=pf1.utils.getWeightSystem(),_=J.matchAll(/(\d+) lbs?\./g);for(let K of _){let V=pf1.utils.convertWeight(+K[1]);J=J.replace(K[0],V+" "+(z==="metric"?"kg":V!==1?"lbs.":"lb."))}let q=J.matchAll(/(\d+) pounds?/g);for(let K of q){let V=pf1.utils.convertWeight(+K[1]);J=J.replace(K[0],pf1.utils.convertWeight(V)+" "+(z==="metric"?"kilogram":"pound")+(V!==1?"s":""))}return J}static singularize(J){return J.replace(/\(\d+\)/g,"").trim().replace(/ies$/,"y").replaceAll("doses of","dose of").replace(/s$/,"")}static capitalize(J){return(J||"").split(" ").map((Z)=>{if(["of","and","or","the","a","an"].includes(Z))return Z;if(Z.match(/^[^a-z]/i))return Z.charAt(0)+Z.charAt(1).toUpperCase()+Z.slice(2);return Z.charAt(0).toUpperCase()+Z.slice(1)}).join(" ")}static getMoneyFromString(J){let Z=Y$().exec(J);if(!Z[0])return null;let Q=Z.groups;return{pp:+(Q.pp||0),gp:+(Q.gp||0),sp:+(Q.sp||0),cp:+(Q.cp||0)}}static convertMoneyToGold(J){return+(J.pp||0)*10+ +(J.gp||0)+ +(J.sp||0)/10+ +(J.cp||0)/100}static getMagicAbility(J,Z){let Q=Z?`${Z} ${J}`:J;Q=Q.toLowerCase().replace(/[- ]/g,"");for(let Y in SBC.config.magicalAbilities.Abilities)if(Y.toLowerCase()===Q)return{name:Y,...SBC.config.magicalAbilities.Abilities[Y]};return null}static async processFormula(J,Z,Q=null){let Y=Z.getRollData(),H=Q?.getRollData(),X=null;if(/@class\.level/.test(J)&&H)X=await Roll.fromTerms(Roll.parse(J,H)).evaluate(),W.log(`Processing ${J} and got results: `,[X,H,Roll.parse(J,H)]);else X=await Roll.fromTerms(Roll.parse(J,Y)).evaluate(),W.log(`Processing ${J} and got results: `,[X,Y,Roll.parse(J,Y)]);return{formula:X?.formula??+J,total:X?.total??+J}}static async addAssociatedClass(J,Z){if(J.system.subType==="classFeat"&&J.system.associations.classes?.length>0){let Q=J.system.associations.classes.map((H)=>H.toLowerCase());Z=Z.map((H)=>H.system.tag);let Y=Q.find((H)=>Z.includes(H));if(Y)await J.updateSource({"system.class":Y})}}static stringSimilarity(J,Z){return 1-this.levenshteinDistance(J,Z)/Math.max(J.length,Z.length)}static levenshteinDistance(J,Z){if(J===Z)return 0;if(J.length>Z.length)[J,Z]=[Z,J];let Q=(S,w,x,p,b)=>{return S<w||x<w?S>x?x+1:S+1:p===b?w:w+1},[Y,H]=[J.length,Z.length];while(Y>0&&J.charCodeAt(Y-1)===Z.charCodeAt(H-1))Y--,H--;let X=0;while(X<Y&&J.charCodeAt(X)===Z.charCodeAt(X))X++;if(Y-=X,H-=X,Y===0||H<3)return H;let G=0,z,_,q,K,V,j,P,O,L,E,B,N,M=[];for(z=0;z<Y;z++)M.push(z+1),M.push(J.charCodeAt(X+z));let T=M.length-1;for(;G<H-3;){L=Z.charCodeAt(X+(_=G)),E=Z.charCodeAt(X+(q=G+1)),B=Z.charCodeAt(X+(K=G+2)),N=Z.charCodeAt(X+(V=G+3)),j=G+=4;for(z=0;z<T;z+=2)P=M[z],O=M[z+1],_=Q(P,_,q,L,O),q=Q(_,q,K,E,O),K=Q(q,K,V,B,O),j=Q(K,V,j,N,O),M[z]=j,V=K,K=q,q=_,_=P}for(;G<H;){L=Z.charCodeAt(X+(_=G)),j=++G;for(z=0;z<T;z+=2)P=M[z],M[z]=j=Q(P,_,j,L,M[z+1]),_=P}return j}static checkForDuplicateItem(J,Z,Q,Y,H){let X=[];if(!Z||Z==="all")X=J.allItems;else X=J.itemTypes[Z];if(Q)X=X.filter((z)=>z.system.subType===Q);let G=new RegExp(`(^${J0(Y.toLowerCase())})`,"i");return X.find((z)=>G.test(z.name.toLowerCase())||z.system.tag&&H.system.tag&&z.system.tag===H.system.tag||pf1.utils.createTag(z.name)===pf1.utils.createTag(H.name))}static prefixNumber(J){return("+"+J).replace(/\+([-+])/g,"$1")}static async openSBCDialog(J=null,Z=null){if(SBC.uuidSource=Z,!SBC.configInitialized)return;if(await W.initializeSBC(),!SBC.app)W.log(W.translate("log.inputDialogDoesNotYetExist")),SBC.actor=await W.createActor(),SBC.app=new k1({folderId:SBC.folderId,wipFolderId:SBC.wipFolderId,statblock:J}),A.initMapping(SBC.app);W.log(W.translate("log.openingInputDialog")),SBC.app.render(!0),Hooks.callAll("sbc.started")}static async initializeSBC(){if(!game.user.isGM)return;W.log("Initializing sbc v"+SBC.config.modData.version);let J=SBC.settings.getSetting("importFolder"),Z="SBC_WIP",Q=await game.folders.find((H)=>H.name===J&&H.type==="Actor"),Y=await game.folders.find((H)=>H.name===Z&&H.type==="Actor");if(!Q){let H=await Folder.create({name:J,type:"Actor",color:"#e76f51",parent:null,_id:"SBC0000000000000"}),X=W.translate("interfaceMessages.folderCreated");ui.notifications.info(X),W.log(X),Q=H}if(SBC.folderId=Q.id,!Y){let H=await Folder.create({name:Z,type:"Actor",color:"#e76f51",parent:Q});SBC.wipFolderId=H.id}else SBC.wipFolderId=Y.id,game.actors.filter((H)=>H.folder?.id===Y.id).map(async(H)=>await H.delete());SBC.actorArtFolder=SBC.settings.getSetting("actorArtFolder"),SBC.tokenArtFolder=SBC.settings.getSetting("tokenArtFolder"),SBC.actorArtPath="",SBC.tokenArtPath="",SBC.actorType=SBC.settings.getSetting("defaultActorType"),Hooks.callAll("sbc.reset")}static async createFolderIfMissing(J){let Z=SBC.settings.getSetting("fileStorageSource");try{if(!(await FilePicker.browse(Z,J)).dir.includes(J))await FilePicker.createDirectory(Z,J,Z==="s3"?{bucket:SBC.settings.getSetting("fileStorageBucket")}:{})}catch(Q){try{await FilePicker.createDirectory(Z,J,Z==="s3"?{bucket:SBC.settings.getSetting("fileStorageBucket")}:{})}catch{}}}static createSearchSet(J,Z=!1,Q=[]){let Y=new Set;for(let H of J){if(!H)continue;if(Y.add(H),Z){let X=Q.length?Q:SBC.actor.itemTypes.class.filter((z)=>z.system.subType!=="racial");if(!Q.length)X=X.map((z)=>z.system.tag.substring(0,3).toUpperCase()).concat(X.map((z)=>`${z.system.tag[0]}${z.system.tag[2]}${z.system.tag[3]}`.toUpperCase())).concat(SBC.app.processData.characterData.archetypes.map((z)=>W.capitalize(z)));let G=X.indexOf("FIG");if(G>-1)X.splice(G,1),X.push("FGT");for(let z of X)Y.add(`${H} (${z})`)}}return Y}static sortArrayByName(J){J=foundry.utils.deepClone(J);for(let Z of J){if(!Z.name)continue;Z.name=Z.name.toLocaleLowerCase()}return pf1.utils.naturalSort(J,"name",{numeric:!0,ignorePunctuation:!0})}static extractCreatureTypeInfo(J){let Z=SBC.config.creatureTypes.find((Y)=>J.match(new RegExp("\\b"+Y+"\\b","i")))??"humanoid",Q=SBC.config.creatureSubTypes.find((Y)=>J.match(new RegExp("\\b"+Y+"\\b","i")));return[Z,Q]}}var m1=["NONE","attributes.hp","spells.spellbooks.primary.spellPoints","spells.spellbooks.secondary.spellPoints","spells.spellbooks.tertiary.spellPoints","spells.spellbooks.spelllike.spellPoints","details.xp","attributes.ac.normal.total","attributes.ac.flatFooted.total","attributes.ac.touch.total","attributes.cmd.total","attributes.speed.land.total","attributes.speed.land.fly.total","attributes.speed.land.swim.total","attributes.speed.land.climb.total","attributes.speed.land.burrow.total","attributes.sr.total"];class F0{static async updateCustomCompendiums(J=!1){SBC,await SBC.compendiumSearch.registerDefaultCompendia(),W.log("Updating custom compendiums");let Z=game.settings.get(SBC.config.modData.mod,"customCompendiums").replace(/\s/g,"").split(/[,;]/g).filter((X)=>!!X);if(!Z.length)return;let Q=Array.from(game.packs.keys()),Y=[],H=Z.filter((X)=>{if(SBC.compendiumSearch.isKnownCompendium(X))return!1;if(!Q.includes(X))return Y.push(X),!1;return!0});if(!J){if(Y.length>0){let G="sbc-pf1 | Failed to add the following compendiums to sbc, please check for typos ("+Y.toString()+")";ui.notifications.error(G),W.log(G)}if(!H.length)return;let X="sbc-pf1 | Added the following compendiums to sbc ("+H.toString()+")";ui.notifications.info(X),W.log(X)}await SBC.compendiumSearch.processCompendiums(H)}static async updateImportFolder(){W.log("Updating custom import folder");let J=F0.getSetting("importFolder");if(J!==""){let Z=null;try{Z=await game.folders.find((Q)=>Q.data.name===J&&Q.data.type==="Actor")}catch(Q){let Y="sbc-pf1 | Something went wrong while searching for an existing import folder.";ui.notifications.info(Y),W.log(Y)}if(Z===null){let Q=await Folder.create({name:J,type:"Actor",color:"#e76f51",parent:null}),Y="Created a custom folder for imported statblocks.";return ui.notifications.info(Y),W.log(Y),Q.id}else return Z.id}}static getSetting(J){if(J.includes("attributeBar")){let Z=parseInt(J.replace("attributeBar",""));if(isNaN(Z))return{};let Q=game.settings.get(SBC.config.modData.mod,Z===1?"bar1":"bar2");if(Q==="0")return{};else return{attribute:m1[Q]}}return game.settings.get(SBC.config.modData.mod,J)}}var x$={debug:{default:!1,type:Boolean},defaultActorType:{default:0,type:String,choices:{0:"NPC",1:"PC"}},autoConvert:{default:!1,type:Boolean},inputDelay:{default:750,type:Number,range:{min:250,max:5000,step:10}},importFolder:{default:"sbc | Imported Statblocks",type:String,onChange:()=>F0.updateImportFolder()},customCompendiums:{default:"",type:String,onChange:async()=>await F0.updateCustomCompendiums()},babeleDialog:{default:!1,type:Boolean},createBuff:{default:!0,type:Boolean},createAttacks:{default:!1,type:Boolean},createAssociations:{default:!1,type:Boolean},rollBonusesIntegration:{default:!1,type:Boolean},pcsight:{default:!0,type:Boolean},npcsight:{default:!0,type:Boolean},actorArtFolder:{default:null,type:String},tokenArtFolder:{default:null,type:String},pchealth:{default:"",type:String,choices:{"":"System default",discrete:"Discrete",continuous:"Continuous"}},npchealth:{default:"",type:String,choices:{"":"System default",discrete:"Discrete",continuous:"Continuous"}},disposition:{default:-1,type:String,choices:{"-1":"Hostile",0:"Neutral",1:"Friendly"}},displayName:{default:20,type:String,choices:{0:"None",10:"Control",20:"Owner Hover",30:"Hover",40:"Owner",50:"Always"}},displayBars:{default:20,type:String,choices:{0:"None",10:"Control",20:"Owner Hover",30:"Hover",40:"Owner",50:"Always"}},bar1:{default:"24",type:String,choices:m1},bar2:{default:"0",type:String,choices:m1},sbcMigrationVersion:{config:!1,default:"0.0.0",type:String}},I$=function(){let J=SBC.config;Object.entries(x$).forEach(([Z,Q])=>{game.settings.register(J.modData.mod,Z,Object.assign({name:W.translate(`settings.${Z}.name`),hint:W.translate(`settings.${Z}.hint`),scope:"world",config:x$[Z].config??!0},Q))})};var K0={modData:{version:"5.6.2",mod:"pf1-statblock-converter",modName:"sbc | PF1 Statblock Converter"},const:{lineheight:20,crFractions:{"1/8":0.125,"1/6":0.1625,"1/4":0.25,"1/3":0.3375,"1/2":0.5},actorType:{0:"npc",1:"character"},suffixMultiples:["st","nd","rd","th"]},sources:R1,lineCategories:["Defense","Offense","Statistics","Special Abilities","Description","Tactics","Ecology","([a-z ]*)?Spells","([a-z ]*)?Extracts","([a-z ]*)?Spell-Like"],lineStarts:["Source","CR","XP","[LC][GNE]","N[GE]?","Init","Aura","Senses","Defense","AC","HP","Fort","Resist","Immun(?:e|ities)","DR","Offense","Speed","Spd","Melee","Ranged","Space","Special","^Spell-Like","^(.*) Spell-Like","^Spells","^(.*) Spells","^Extracts","^(.*) Extracts","Constant","At[- ]will","[456789]th","3rd","2nd","1st","Cantrips","Orisons","0","D\\s*domain spell","Domains?","Myster[y|ies]","S\\s*spirit magic spell","Spirits?","Bloodlines?","Thassilonian Specialization","Patrons?","Statistics","Str","Base","Feats","Skills","Languages?","Ecology","Environment","Organization","Treasure","S[QR]","(?:Other |Combat )?Gear","Gear","(?:M|Fem)ale","Tactics","(?:Before|During) Combat","Morale","(?:Opposition|Prohibited) School","Defensive Abilities","Immune","Weaknesses","Description","\\d+\\s*(?:rounds)?\\/(day|month|year)",".*\\((S[PU]|EX|\\-\\-)\\)","\\*"],armorBonusTypes:["touch","flat-footed","natural","size","dex","armor","shield","base","enhancement","dodge","inherent","deflection","morale","luck","sacred","insight","resistance","profane","trait","racial","competence","circumstance","alchemical","penalty","rage","monk","wis","untyped"],techColors:M1,techTiers:["Mark (?:I{1,3}|I?V)","Grade (?:I{1,3}|I?V)"],magicalAbilities:H1,itemModifications:x1,weaponGroups:{},metamagic:P0,creatureTypes:v1,creatureSubTypes:U1,immunities:I1,sillyGear:S1,races:[],classes:[],mythicPaths:[],racialClasses:[],prestigeClassNames:[],templates:[],naturalAttacks:[],initializeConfig:async function(){let J=SBC.compendiumSearch.defaultCompendia,Z=SBC.settings.getSetting("customCompendiums");if(Z!=="")Z=Z.replace(/\s/g,""),J=J.concat(Z.split(/[,;]/g));await eJ(J),this.classes.sort(),this.mythicPaths.sort(),this.racialClasses.sort(),this.prestigeClassNames.sort();let Q=await game.packs.get("pf1.monster-abilities").index;for(let Y of Q)if(Y.name!=="")K0.naturalAttacks.push(Y.flags?.babele?.originalName??Y.name);for(let[Y,H]of Object.entries(n("weaponGroups"))){let X=H.toLowerCase().replace(/(.*), (.*)/,"$2 $1");if(!Object.values(K0.weaponGroups).includes(H))K0.weaponGroups[Y]=X}}};async function eJ(J){let Z=new Set,Q=new Set,Y=new Set,H=new Set,X=new Set,G=new Set,z=J.map(async(_)=>{let q=await game.packs.get(_);if(!q)return;let K=q.index;await Promise.all(K.map(async(V)=>{if(V.name==="")return;switch(V.type){case"class":switch(V.system?.subType){case"prestige":Q.add(V.flags?.babele?.originalName??V.name);break;case"mythic":Y.add(V.flags?.babele?.originalName??V.name);break;case"racial":H.add(V.flags?.babele?.originalName??V.name);break;default:Z.add(V.flags?.babele?.originalName??V.name);break}break;case"race":X.add(V.flags?.babele?.originalName??V.name);break;case"feat":switch(V.system?.subType){case"template":G.add((V.flags?.babele?.originalName??V.name).split("(")[0].replace("Creature","").trim());break}}}))});await Promise.all(z),K0.classes=Array.from(Z).filter((_)=>!!_),K0.mythicPaths=Array.from(Y).filter((_)=>!!_),K0.racialClasses=Array.from(H).filter((_)=>!!_),K0.prestigeClasses=Array.from(Q).filter((_)=>!!_),K0.races=Array.from(X),K0.templates=Array.from(G)}class M0{static re=/^(0|[1-9]\d*)\.(0|[1-9]\d*)(?:\.(0|[1-9]\d*)(?:-((?:0|[1-9]\d*|\d*[a-zA-Z-][0-9a-zA-Z-]*)(?:\.(?:0|[1-9]\d*|\d*[a-zA-Z-][0-9a-zA-Z-]*))*))?(?:\+([0-9a-zA-Z-]+(?:\.[0-9a-zA-Z-]+)*))?)?$/;constructor(){this.major=0,this.minor=0,this.patch=0,this.preRelease="",this.buildMetaData=""}static fromString(J){if(J.match(this.re)){let Z=new this;return Z.major=parseInt(RegExp.$1),Z.minor=parseInt(RegExp.$2),Z.patch=parseInt(RegExp.$3||0),Z.preRelease=RegExp.$4||"",Z.buildMetaData=RegExp.$5||"",Z}return null}toString(){return`${this.major}.${this.minor}.${this.patch}`}isHigherThan(J){if(this.major>J.major)return!0;if(this.major===J.major&&this.minor>J.minor)return!0;if(this.major===J.major&&this.minor===J.minor&&this.patch>J.patch)return!0;return!1}isLowerThan(J){if(this.major<J.major)return!0;if(this.major===J.major&&this.minor<J.minor)return!0;if(this.major===J.major&&this.minor===J.minor&&this.patch<J.patch)return!0;return!1}isSame(J){return this.major==J.major&&this.minor==J.minor&&this.patch==J.patch}}var u1="5.6.2";async function S$(J){J=(!J?game.actors.contents:J).filter((Z)=>Z.type==="character"||Z.type==="npc");for(let Z of J)await f$(Z)}async function w$(){let J=game.packs.filter((Z)=>Z.metadata.type==="Actor"&&Z.index.some((Q)=>Q.type==="npc"||Q.type==="character"));for(let Z of J){let Q=Z.locked;if(Q)await Z.configure({locked:!1});ui.notifications.notify(`Migrating compendium pack "${Z.metadata.label}" (${Z.metadata.id})`);try{await $5(Z),ui.notifications.notify(`Compendium pack "${Z.metadata.label}" (${Z.metadata.id}) migrated`)}catch(Y){ui.notifications.error(`Failed to migrate compendium pack "${Z.metadata.label}" (${Z.metadata.id}): ${Y.message}`)}if(Q)await Z.configure({locked:!0})}}async function $5(J){let Z=J.index.reduce((Q,Y)=>{if(["npc","character"].includes(Y.type))Q.push(Y._id);return Q},[]);if(!Z.length)return;for(let Q of Z){let Y=await J.getDocument(Q);if(!Y)continue;await f$(Y,J.metadata.label)}}async function f$(J,Z=null){let Q=!1;if(J.getFlag(SBC.config.modData.mod,"version"))Q=!0;else if(J.itemTypes.buff.some((z)=>z.name.startsWith("sbc")))Q=!0;else if((typeof J.system.details.notes==="object"?J.system.details.notes.value:J.system.details.notes)?.includes("<p>sbc | Generated with version"))Q=!0;if(!Q)return;let H=M0.fromString(u1),X=M0.fromString(J.getFlag(SBC.config.modData.mod,"version")||"0.0.0"),G=SBC.config.modData.version;if(!X.isLowerThan(H))return;else{if(!Z)ui.notifications.notify(`Migrating actor "${J.name}" from version ${X.toString()} to ${G}`);else console.log(`Migrating actor "${J.name}" from version ${X.toString()} to ${G} in pack "${Z}"`);let z={[`flags.${SBC.config.modData.mod}.version`]:G},_=[];if(J5(J,z),Z5(J,z),Q5(J,_),await J.update(z),_.length)await J.updateEmbeddedDocuments("Item",_);if(!Z)ui.notifications.notify(`Actor "${J.name}" migrated to version ${G}`);else console.log(`Actor "${J.name}" migrated to version ${G} in pack "${Z}"`)}}function J5(J,Z){let Q=J.system.traits.dr.value,Y=[];if(Q.forEach((H)=>{if(H.amount&&typeof H.amount==="string"){let X=parseInt(H.amount);if(!isNaN(X))H.amount=X;Y.push(H)}}),Y.length)Z["system.traits.dr.value"]=Y}function Z5(J,Z){let Q=J.system.traits.eres.value,Y=[];if(Q.forEach((H)=>{if(H.amount&&typeof H.amount==="string"){let X=parseInt(H.amount);if(!isNaN(X))H.amount=X;Y.push(H)}}),Y.length)Z["system.traits.eres.value"]=Y}function Q5(J,Z){let Q=J.itemTypes.buff.find((Y)=>Y.name==="sbc | Conversion Buff (Ability Scores)");if(Q){let Y=Q.toObject().system.changes.map((H)=>{return H.formula=H.formula==="NaN"?"0":H.formula,H});Z.push({_id:Q.id,"system.changes":Y})}}globalThis.SBC={app:null,actor:null,actorType:null,folderId:"",wipFolderId:"",config:K0,configInitialized:!1,compendiumSearch:new Z1,isImporting:!1,settings:F0,rollBonusOps:m,actorArtFolder:"",actorArtPath:"",tokenArtFolder:"",tokenArtPath:""};Hooks.once("setup",async()=>{SBC;let J=typeof ForgeVTT!="undefined"&&ForgeVTT.usingTheForge;game.settings.register(SBC.config.modData.mod,"fileStorageSource",{name:W.translate("settings.fileStorageSource"),scope:"world",config:!J,type:String,default:J?"forgevtt":"data",choices:{data:game.i18n.localize("FILES.SourceUser"),s3:game.i18n.localize("FILES.SourceS3")},onChange:async()=>{await B1()}}),game.settings.register(SBC.config.modData.mod,"fileStorageFolder",{name:W.translate("settings.fileStorageFolder.name"),hint:W.translate("settings.fileStorageFolder.hint"),scope:"world",config:!0,type:String,default:"sbc",onChange:async()=>{await B1()}});try{let Z=await FilePicker.browse("s3",""),Q={};for(let Y of Z.dirs)Q[Y]=Y;game.settings.register(SBC.config.modData.mod,"fileStorageBucket",{name:W.translate("settings.fileStorageBucket"),scope:"world",config:!J,type:String,default:J?"":FilePicker.S3_BUCKETS?.length>0?FilePicker.S3_BUCKETS[0]:"",choices:Q,onChange:async()=>{await B1()}})}catch{}I$()});Hooks.once("ready",async()=>{SBC.originalLang=game.settings.get("core","language")??"en",await F0.updateCustomCompendiums(!0),await W.initializeSBC(),await B1(),C$(),Hooks.callAll("sbc.loadCustomCompendiums"),await SBC.config.initializeConfig(),console.log(W.translate("log.configInitialized")),SBC.configInitialized=!0,game.modules.get(SBC.config.modData.mod).api={openSBCDialog:W.openSBCDialog};let J=u1,Z=game.settings.get(SBC.config.modData.mod,"sbcMigrationVersion");if(typeof Z==="number")Z=Z.toString()+".0";else if(typeof Z==="string"&&Z.match(/^([0-9]+)\.([0-9]+)$/))Z=`${Z}.0`;let Q=M0.fromString(J).isHigherThan(M0.fromString(Z));if(console.log(`SBC Migration: ${J} > ${Z} = ${Q}`),Q){if(Z!=="0.0.0")console.debug(W.translate("log.migrationMessage",{oldVersion:Z,newVersion:SBC.config.modData.version}));if(game.actors.size){let Y=ui.notifications.notify(W.translate("interfaceMessages.migrationStarted"),"info",{permanent:!0});await S$(),await w$(),ui.notifications.notify(W.translate("interfaceMessages.migrationFinished")),ui.notifications.remove(Y)}if(game.user.isGM)await game.settings.set(SBC.config.modData.mod,"sbcMigrationVersion",SBC.config.modData.version)}});Hooks.on("renderActorDirectory",(J,Z,Q)=>{if(C$(),window.jQuery&&Z instanceof jQuery)Z=Z[0];if(!game.user.hasPermission("ACTOR_CREATE"))return;W.log(W.translate("log.renderingButton"));let Y=document.createElement("button");Y.id="startSBCButton",Y.classList.add("create-entity","sbcButton");let H=document.createElement("i");H.classList.add("fas","fa-file-import"),Y.appendChild(H);let X=document.createTextNode(W.translate("sbcButton"));Y.appendChild(X),Z.querySelector(".directory-footer").append(Y),Y.addEventListener("click",async()=>await W.openSBCDialog())});Hooks.on("sbc.reset",async function(){let J=[],Z=SBC.settings.getSetting("customCompendiums");if(Z!=="")Z=Z.replace(/\s/g,""),J.push(...Z.split(/[,;]/g)),console.log(J);await T$(J)});Hooks.on("sbc.loadCustomCompendiums",async function(J){if(!J)return;let Z=new Set,Q=SBC.settings.getSetting("customCompendiums");if(Q!=="")Q=Q.replace(/\s/g,""),Z=new Set(Q.split(/[,;]/g));J.forEach((Y)=>{Z.add(Y)}),await T$(Array.from(Z)),SBC.config.initializeConfig(),game.settings.set(SBC.config.modData.mod,"customCompendiums",Array.from(Z).join(","))});Hooks.on("pf1RegisterMaterials",(J)=>{let Z=J.get("alchemicalSilver");Z.addon=!1,Z.name="PF1.Materials.Types.silver",J.register("pf1-statblock-converter","silver",Z)});Hooks.on("sbc.actorImported",(J)=>{if(F0.getSetting("babeleDialog"))game.babele?.translateActor(J)});async function T$(J){await SBC.compendiumSearch.processCompendiums(J,{reset:!0})}function C$(){document.querySelector(`.folder[data-folder-id="${SBC.wipFolderId}"]`)?.remove()}async function B1(){SBC;let Z=SBC.settings.getSetting("fileStorageFolder").split("/").filter((X)=>X!==""),Q=[];for(let X of Z)Q.push(X),await W.createFolderIfMissing(Q.join("/"));await W.createFolderIfMissing(Q.concat("actor").join("/")),await W.createFolderIfMissing(Q.concat("token").join("/"));let Y=[],H=SBC.settings.getSetting("fileStorageFolder");Y=Y.concat(H.split("/")).filter((X)=>X!==""),SBC.targetFolder=Y.join("/")}

//# debugId=C4436B1779FF6AF464756E2164756E21
//# sourceMappingURL=sbc.js.map
