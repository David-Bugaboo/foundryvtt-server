var __esm=(fn,res)=>()=>(fn&&(res=fn(fn=0)),res);function wrapNumber(num,min,max){const range=max-min+1,value=num-min+1;const t=value%range-1;return(t<0?range+t:t)+min}var exports_quench={};var init_quench=__esm(()=>{quench.registerBatch("koboldworks-turn-announcer.helpers",async function testHelpers({describe,it,expect,before,after}={}){describe("wrapNumber",function testWrapNumber(){it("wrap 5 [0 – 4] = 0",function(){expect(wrapNumber(5,0,4)).to.equal(0)});it("wrap 6 [2 – 4] = 3",function(){expect(wrapNumber(6,2,4)).to.equal(3)});it("wrap -1 [0 – 4] = 4",function(){expect(wrapNumber(-1,0,4)).to.equal(4)});it("wrap -2 [0 – 4] = 3",function(){expect(wrapNumber(-2,0,4)).to.equal(3)});it("wrap -2 [2 – 4] = 4",function(){expect(wrapNumber(-2,2,4)).to.equal(4)});it("wrap -102 [0 – 10] = 8",function(){expect(wrapNumber(-102,0,10)).to.equal(8)});it("wrap 103 [0 – 10] = 4",function(){expect(wrapNumber(103,0,10)).to.equal(4)})})},{displayName:game.i18n.localize("Koboldworks.TurnAnnouncer.Tests.Helpers")})});var CFG={id:"koboldworks-turn-announcer",SETTING:{missedKey:"missedTurn",hidePortrait:"hidePortrait",obfuscateNPCs:"obfuscateNPCs",roundCycling:"roundCycling",compact:"compact",turnLabel:"turnLabel",roundLabel:"roundLabel"}};var getPlayerOwners=(thing,perm)=>thing?game.users.players.filter((u)=>thing.testUserPermission(u,perm)):[];var escapeHTML=(unsafe)=>unsafe.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&apos;");var turn_template_file=`modules/${CFG.id}/template/turn-announcer.hbs`;var round_template_file=`modules/${CFG.id}/template/round-cycling.hbs`;var turnTemplate;var roundTemplate;Hooks.once("init",()=>{getTemplate(turn_template_file).then((t)=>turnTemplate=t);getTemplate(round_template_file).then((t)=>roundTemplate=t)});var lastCombatant={combatant:null,get tokenId(){return this.combatant?.token?.id},spoke:false};function hideContent(content){if(content){content.replaceChildren();content.style.display="none"}}function compressTurnAnnounceMessage(cm,html,main){const compact=game.settings.get(CFG.id,CFG.SETTING.compact);if(compact)main.classList.add("compact")}function compressRoundCyclingMessage(cm,html,main){if(!main)return;main.classList.add("koboldworks","round-cycling");const header=html.querySelector(".message-header");if(!header)return;header.querySelector(".message-sender")?.remove();const content=html.querySelector(".message-content");if(!content)return;const msg=content.querySelector(".round-message");header.prepend(msg);const icon=document.createElement("i");icon.classList.add("fa-solid","fa-hourglass-start","round-icon");msg?.prepend(icon," ");const data=content.querySelector(".round-cycling");if(data?.dataset){main.dataset.combatId=data.dataset.combatId;main.dataset.round=data.dataset.round}hideContent(content)}function compressMissedTurnMessage(cm,html,main){main.classList.add("koboldworks","missed-turn-announcer");const content=html.querySelector(".message-content > .turn-announcer");const header=main.querySelector(".message-header");if(!header)return;header.classList.remove("message-header");const wh=header.querySelector(".whisper-to");if(wh){main.title=wh.textContent;wh.remove()}const timestamp=header.querySelectorAll(".message-sender,.message-timestamp");timestamp?.forEach((el)=>el.style.display="none");const msgb=document.createElement("div");msgb.classList.add("missed-token");const missedIcon=content.querySelector(".missed-turn-icon"),missedText=content.querySelector(".missed-turn-text"),missedCombatant=content.querySelector(".missed-combatant"),missedName=document.createElement("span");missedName.classList.add("missed-turn-name");missedName.textContent=missedCombatant?.textContent?.trim()??"...";msgb.append(missedIcon," ",missedName," ",missedText);header.prepend(msgb);if(content)hideContent(content)}function updateLastCombatantFromMsg(cm,flags){lastCombatant.spoke=false;lastCombatant.combatant=game.combat?.getCombatantByToken(flags.token)??null}function chatMessageEvent(cm,[html],_options){const isGM=game.user.isGM;const flags=cm.flags?.[CFG.id];if(!flags){if(isGM&&cm.speaker?.token===lastCombatant.tokenId)lastCombatant.spoke=true;return}const main=html.closest("[data-message-id]");html?.classList.add("turn-announcer","koboldworks");if(flags.missedTurn)compressMissedTurnMessage(cm,html,main);else if(flags.turnAnnounce||flags.token){updateLastCombatantFromMsg(cm,flags);compressTurnAnnounceMessage(cm,html,main)}else if(flags.roundCycling){compressRoundCyclingMessage(cm,html,main)}main?.querySelector(".whisper-to")?.remove();if(cm.getFlag(CFG.id,"obfuscated")){html.classList.add("obfuscated");const combat=game.combats.get(cm.getFlag(CFG.id,"combat")),combatant=combat?.combatants.get(cm.getFlag(CFG.id,"combatant"));if(!combatant?.actor?.testUserPermission(game.user,"OBSERVER"))return;if(combatant?.token){const name=html.querySelector(".actor .name-box .name");if(name)name.textContent=combatant.token.name}}}var lastReported={};function missedTurn(data,context){if(data.last?.spoke||data.last==null)return;const preUpdate=context._turnAnnouncer;if(preUpdate?.combat===game.combats.active.id){if(preUpdate.roundShift<0||preUpdate.turnShift<0&&preUpdate.roundShift<=0)return}const{last,combat,combatant}=data;if(lastReported.combat!==undefined&&combat.id!==lastReported.combat)return;if(last.token?.id===combatant?.token?.id)return;if(lastReported.id===last.token?.id)return;lastReported={id:last.token?.id,combat:combat.id};const mt=game.i18n.localize("Koboldworks.TurnAnnouncer.MissedTurn");const scene=combat.scene,actor=last.actor?.id,token=last.token?.id,alias=last.name;if(actor===undefined||token===undefined)return;const cmName=escapeHTML(data.last.combatant.name);const msgData={content:`<div class="koboldworks turn-announcer"><span class='missed-turn-icon'><i class="fas fa-exclamation-triangle"></i></span><span class='missed-combatant'>${cmName}</span> <span class='missed-turn-text'>${mt}</span></div>`,speaker:{scene,actor,token,alias},flags:{[CFG.id]:{missedTurn:true,token,actor,combatant:last.combatant.id}}};ChatMessage.implementation.applyRollMode(msgData,CONST.DICE_ROLL_MODES.PRIVATE);return msgData}function generateCards(info,context){const msgs=[];if(game.settings.get(CFG.id,CFG.SETTING.missedKey)){const msg=missedTurn(info,context);if(msg)msgs.push(msg)}if(info.combatant.defeated)return msgs;if(info.last?.combatant!=null&&info.last.combatant.id===info.combatant.id)return msgs;const speaker=info.obfuscated?{user:game.user.id}:ChatMessage.getSpeaker({token:info.token?.document,actor:info.actor});const minPerm=CONST.DOCUMENT_OWNERSHIP_LEVELS.OBSERVER;const defaultVisible=info.hidden?false:info.actor?.ownership?.default>=minPerm;const cardData={content:turnTemplate(info,{allowProtoMethodsByDefault:true,allowProtoPropertiesByDefault:true}),speaker,rollMode:defaultVisible?"publicroll":"gmroll",whisper:defaultVisible?[]:getPlayerOwners(info.actor,minPerm).map((u)=>u.id),flags:{[CFG.id]:{turnAnnounce:true,token:info.token?.id,round:info.round,turn:info.turn,combat:info.combat.id,combatant:info.combatant.id,obfuscated:info.obfuscated}}};ChatMessage.applyRollMode(cardData,!info.hidden?"publicroll":"gmroll");if(cardData.rollMode==="publicroll")delete cardData.whisper;msgs.push(cardData);return msgs}function generateRoundCyclingCard(combat){const speaker=ChatMessage.getSpeaker("GM");const override=game.settings.get(CFG.id,CFG.SETTING.roundLabel);const data={combat};if(override)data.message=override.replace("{round}",combat.round);else data.message=game.i18n.format("Koboldworks.TurnAnnouncer.RoundCycling",{round:combat.round});const msgData={content:roundTemplate(data,{allowProtoMethodsByDefault:true,allowProtoPropertiesByDefault:true}),speaker,rollMode:"publicroll",flags:{[CFG.id]:{roundCycling:true,round:combat.round,combat:combat.id}}};if(!game.user.isGM){}return msgData}function announceRoundCycling(combat,context){if(combat.__turnAnnouncerLastRoundCycle>=combat.round)return;if(context._turnAnnouncer.roundShift<=0)return;combat.__turnAnnouncerLastRoundCycle=combat.round;return generateRoundCyclingCard(combat)}function announceTurn(combat,context){const combatant=combat.combatant;const defeated=combatant?.defeated??false;const tokenDoc=combatant?.token;if(!tokenDoc)return;const previous={combatant:lastCombatant.combatant,get defeated(){return this.combatant?.defeated},get token(){return this.combatant?.token},get actor(){return this.combatant?.actor},spoke:lastCombatant.combatant?.defeated?false:lastCombatant?.spoke??false};if(!defeated){lastCombatant.combatant=combatant;lastCombatant.spoke=false}if(!combat.started)return;const info={actor:combatant.actor,combatant,combat,last:previous,token:tokenDoc.object,tokenDoc,get round(){return this.combat?.round},get turn(){return this.combat?.turn},user:combatant.players[0]??game.users.activeGM??game.users.find((u)=>u.isGM),get player(){return this.user?.name},name:null,label:null,get hidden(){return this.combatant?.hidden??false},get visible(){return this.combatant?.visible??false},obfuscated:false};info.name=info.token?.name??combatant.name;info.portrait=tokenDoc?.texture.src??info.actor.prototypeToken?.texture.src;const obfuscateType=game.settings.get(CFG.id,CFG.SETTING.obfuscateNPCs);const hasVisibleName=()=>info.token?[30,50].includes(tokenDoc.displayName):true;const obfuscate={get all(){return false},get owned(){return!info.actor.hasPlayerOwner},get token(){return!hasVisibleName()},get any(){return!(info.actor?.hasPlayerOwner||hasVisibleName())}};info.obfuscated=obfuscate[obfuscateType]??false;if(info.obfuscated)info.name=game.i18n.localize("Koboldworks.TurnAnnouncer.UnidentifiedTurn");const label=`<span class='name'>${escapeHTML(info.name)}</span>`;const override=game.settings.get(CFG.id,CFG.SETTING.turnLabel);if(override)info.label=override.replace("{name}",label);else info.label=game.i18n.format("Koboldworks.TurnAnnouncer.Turn",{name:label});if(!info.portrait||game.settings.get(CFG.id,CFG.SETTING.hidePortrait))info.hidePortrait=true;const msgs=generateCards(info,context);return msgs}function processTurn(combat,changed,context,userId){if(game.user.id!==userId)return;const msgs=[];if(game.settings.get(CFG.id,CFG.SETTING.roundCycling)){const roundMsg=announceRoundCycling(combat,context);if(roundMsg)msgs.push(roundMsg)}const turnMsgs=announceTurn(combat,context);if(turnMsgs?.length)msgs.push(...turnMsgs);if(msgs.length)ChatMessage.create(msgs)}Hooks.once("init",()=>{game.settings.register(CFG.id,CFG.SETTING.turnLabel,{name:"Koboldworks.TurnAnnouncer.TurnCardLabel",hint:"Koboldworks.TurnAnnouncer.TurnCardHint",type:String,config:true,scope:"world",default:""});game.settings.register(CFG.id,CFG.SETTING.roundLabel,{name:"Koboldworks.TurnAnnouncer.RoundCardLabel",hint:"Koboldworks.TurnAnnouncer.RoundCardHint",type:String,config:true,scope:"world",default:""});game.settings.register(CFG.id,CFG.SETTING.obfuscateNPCs,{name:"Koboldworks.TurnAnnouncer.ObfuscateNPCsLabel",hint:"Koboldworks.TurnAnnouncer.ObfuscateNPCsHint",type:String,config:true,scope:"world",choices:{all:"Koboldworks.TurnAnnouncer.ObfuscateNPCsVisibility.All",owned:"Koboldworks.TurnAnnouncer.ObfuscateNPCsVisibility.Owned",token:"Koboldworks.TurnAnnouncer.ObfuscateNPCsVisibility.Token",any:"Koboldworks.TurnAnnouncer.ObfuscateNPCsVisibility.Any"},default:"all"});game.settings.register(CFG.id,CFG.SETTING.roundCycling,{name:"Koboldworks.TurnAnnouncer.RoundCyclingLabel",hint:"Koboldworks.TurnAnnouncer.RoundCyclingHint",type:Boolean,config:true,scope:"world",default:true});game.settings.register(CFG.id,CFG.SETTING.missedKey,{name:"Koboldworks.TurnAnnouncer.MissedTurnLabel",hint:"Koboldworks.TurnAnnouncer.MissedTurnHint",type:Boolean,config:true,scope:"world",default:false,onChange:(value)=>value?Hooks.on("renderChatMessage",chatMessageEvent):Hooks.off("renderChatMessage",chatMessageEvent)});game.settings.register(CFG.id,CFG.SETTING.hidePortrait,{name:"Koboldworks.TurnAnnouncer.HidePortraitLabel",hint:"Koboldworks.TurnAnnouncer.HidePortraitHint",type:Boolean,config:true,scope:"world",default:false});game.settings.register(CFG.id,CFG.SETTING.compact,{name:"Koboldworks.TurnAnnouncer.CompactLabel",hint:"Koboldworks.TurnAnnouncer.CompactHint",type:Boolean,config:true,scope:"world",default:true})});Hooks.on("preUpdateCombat",function preUpdateCombat(combat,updateData,context){const roundDelta=updateData.round!==undefined?updateData.round-combat.round:0,turnCount=combat.turns.length,roundAdjust=roundDelta*turnCount,forward=roundDelta>=0,turnDelta=updateData.turn!==undefined?updateData.turn-combat.turn:0,turnDeltaWrapped=roundDelta==0?turnDelta:wrapNumber(roundAdjust+turnDelta,forward?0:-(turnCount-1),forward?turnCount-1:0);context._turnAnnouncer={turnShift:turnDeltaWrapped,roundShift:roundDelta,combat:combat.id}});Hooks.on("updateCombat",processTurn);Hooks.on("renderChatMessage",chatMessageEvent);Hooks.once("ready",()=>{lastCombatant.combatant=game.combat?.combatant??null});Hooks.once("init",()=>{if(game.modules.get("quench")?.active)Hooks.on("quenchReady",()=>Promise.resolve().then(() => (init_quench(),exports_quench)))});

//# debugId=E4684F041F76407364756E2164756E21
//# sourceMappingURL=turn-announcer.mjs.map
