var __defProp=Object.defineProperty;var __export=(target,all)=>{for(var name in all)__defProp(target,name,{get:all[name],enumerable:!0,configurable:!0,set:(newValue)=>all[name]=()=>newValue})};var __esm=(fn,res)=>()=>(fn&&(res=fn(fn=0)),res);var CFG;var init_config=__esm(()=>{CFG={id:"koboldworks-pf1-little-helper",SETTINGS:{generalWorldConfiguration:"config-world",generalClientConfiguration:"config-client",featureKey:"features",inlineFormulaDetail:"inline-formula-detail",chat:"chat",wbl:"wblRatio",transparencySham:"gmtransparencysham",transparency:"transparency"},ROLLMODES:{"":"LittleHelper.Options.NoOverride",publicroll:"CHAT.RollPublic",gmroll:"CHAT.RollPrivate",selfroll:"CHAT.RollSelf",blindroll:"CHAT.RollBlind"},system:{get version(){return game.system.version},atLeast:function(v){let v0=this.version;return foundry.utils.isNewerVersion(v0,v)||v==v0},newerThan:function(v){return foundry.utils.isNewerVersion(this.version,v)}},core:{get version(){return game.version},atLeast:function(v){let curVer=this.version;return foundry.utils.isNewerVersion(curVer,v)||v==curVer},newerThan:function(v){return foundry.utils.isNewerVersion(this.version,v)}},state:{alt:!1},API:{utility:{},formula:{},classes:{},slots:{}},i18n:{},console:{colors:{main:"color:yellowgreen",number:"color:mediumpurple",string:"color:mediumseagreen",label:"color:goldenrod",id:"color:darkseagreen",unset:"color:unset",error:"color:red"}},isStream:void 0,version:{feature:void 0,patch:void 0}};Hooks.once("init",()=>{CFG.isStream=game.view==="stream";let version=game.system.version.split(".").map(Number);CFG.version.feature=version.shift(),CFG.version.patch=version.shift();let C=CFG.console.colors;console.log("%cLittle Helper%c \uD83E\uDD8E",C.main,C.unset,"| Detected System Version | Feature:",CFG.version.feature,"| Patch:",CFG.version.patch),Object.freeze(CFG)})});class i18n{static has=(string)=>game.i18n.has(string);static get=(string,mapping)=>mapping?game.i18n.format(string,mapping):game.i18n.localize(string)}class Icon{#cls;#string;constructor(icon,type="fa-solid"){this.#cls=new Set([type,icon]),this.#string=[...this.#cls].join(" ")}toString(){return this.#string}get string(){return this.toString()}}var FAIcons;var init_icons=__esm(()=>{FAIcons={link:new Icon("fa-link"),unlink:new Icon("fa-unlink"),heart:new Icon("fa-heart"),heartBroken:new Icon("fa-heart-broken"),box:new Icon("fa-box"),coins:new Icon("fa-coins"),hourglass:new Icon("fa-hourglass"),hourglassStart:new Icon("fa-hourglass-start"),seedling:new Icon("fa-seedling"),skull:new Icon("fa-skull"),dice:new Icon("fa-dice"),d20:new Icon("fa-dice-d20"),questionCircle:new Icon("fa-question-circle"),infoCircle:new Icon("fa-info-circle"),exclamationTriangle:new Icon("fa-exclamation-triangle"),cog:new Icon("fa-cog"),shieldAlt:new Icon("fa-shield-alt"),ruler:new Icon("fa-ruler-combined"),rulerCombined:new Icon("fa-ruler-combined"),bullseye:new Icon("fa-bullseye"),table:new Icon("fa-table"),signLanguage:new Icon("fa-sign-language"),puzzlePiece:new Icon("fa-puzzle-piece"),save:new Icon("fa-floppy-disk"),mitten:new Icon("fa-mitten"),spinner:new Icon("fa-spinner"),batteryHalf:new Icon("fa-battery-half"),eye:new Icon("fa-eye"),eyeSlash:new Icon("fa-eye-slash"),search:new Icon("fa-search"),book:new Icon("fa-book"),globe:new Icon("fa-globe"),filter:new Icon("fa-filter"),user:new Icon("fa-user"),infinity:new Icon("fa-infinity"),star:new Icon("fa-star"),crown:new Icon("fa-crown"),recycle:new Icon("fa-recycle"),reset:new Icon("fa-rotate-left"),sync:new Icon("fa-sync"),syncAlt:new Icon("fa-sync-alt"),file:new Icon("fa-file"),fileAlt:new Icon("fa-file-alt"),fileExport:new Icon("fa-file-export"),folder:new Icon("fa-folder"),folderOpen:new Icon("fa-folder-open")}});function stopEventPropagation(event2){return event2.preventDefault(),event2.stopPropagation(),event2}class UserDataShim{id;role;name;get isGM(){return this.role>=CONST.USER_ROLES.ASSISTANT}constructor({name,role,id}={}){this.id=id,this.name=name,this.role=role}}function getUserFromData(){let data=game.data,id=data?.userId,userData=id?data.users?.find((u)=>u._id===id)??{}:{};return new UserDataShim({id,name:userData.name,role:userData.role??0})}function getTransparency(){return game.settings.get(CFG.id,"transparency")}function testTransparency(user,doc){if(!doc)return!0;switch(getTransparency()){case 3:return doc.testUserPermission(user,CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER);case 2:return doc.testUserPermission(user,CONST.DOCUMENT_OWNERSHIP_LEVELS.OBSERVER);case 1:return doc.hasPlayerOwner??doc.document?.hasPlayerOwner;default:return!0}}function compressFormula(formula,stripDetail=!0){if(stripDetail)formula=formula.replaceAll(/\s+/g,"").replaceAll(/\[[^\]]+]/g,"");return formula.replaceAll(/\s+\+\s*-\s+/g," - ")}function hideFromNonGM(user){if(user.isGM)return!1;return game.settings.get(CFG.id,CFG.SETTINGS.transparencySham)}function enrichRoll(roll,formula,label,rollData={}){let a=createNode("a",void 0,["inline-roll","inline-result"],{tooltip:formula.replace("@check",rollData.check)});return a.dataset.roll=escape(JSON.stringify(roll)),a.innerHTML=`<i class='${FAIcons.d20}'></i> ${label}`,a}function unifyProficiency(prof){if(prof==null)return[];if(prof.total)return[...prof.total,...trimProfs(prof.customTotal)];return[...prof.value,...trimProfs(prof.custom),...trimProfs(prof.customTotal)]}function warningSymbol(){let i=document.createElement("i");return i.classList.add("fa-solid","fa-exclamation-triangle"),i}function constructWarning(warning,css=[]){let symbol=warningSymbol();return addCoreTooltip(symbol,warning),symbol.classList.add("lil-warning-symbol",...css),symbol}function addWarning(el,warning){if(!el)return;return el.classList.add("lil-warning"),el.prepend(constructWarning(warning)),el}function createNode(node="span",text,classes=[],{tooltip,isHTML=!1,children=[],data,attr}={}){let n=document.createElement(node);if(text)if(isHTML)n.innerHTML=text;else n.textContent=text;if(classes.length>0)n.classList.add(...classes.filter((c)=>!!c));if(children.length>0)n.append(...children.filter((c)=>!!c));if(data)for(let[key,value]of Object.entries(data))n.setAttribute(`data-${key}`,value);if(attr){for(let[key,value]of Object.entries(attr))if(value!==void 0)n.setAttribute(key,value)}if(tooltip)addCoreTooltip(n,tooltip);return n}function appendElements(el,...els){return el.append(...els),el}function canViewChatMessage(cm,user=game.user){let whisper=cm.whisper;if(user.isGM)return!0;let isAuthor=cm.isAuthor;if(whisper.length>0){if(!isAuthor)return whisper.includes(user.id);if(cm.blind)return!1}if(isAuthor)return!0;if(cm.author?.role>=CONST.USER_ROLES.ASSISTANT&&hideFromNonGM(user))return!1;return!0}function maxPrecision(num,decimalPlaces=0,type="round"){let p=Math.pow(10,decimalPlaces||0),n=num*p*(1+Number.EPSILON);return Math[type](n)/p}function addCoreTooltip(element,content,direction,css){let tm=CONFIG.ux.TooltipManager;if(direction??=tm.TOOLTIP_DIRECTIONS.UP,element.dataset.tooltip=content,direction)element.dataset.tooltipDirection=direction;if(css)element.dataset.tooltipClass=css;return element}var clampNum,setSheetMarker=(sheet,flag,id,callback)=>{sheet.___littleHelper??={};let h=sheet.___littleHelper;if(h[flag]?.fn)h[flag].fn(sheet);h[flag]={fn:callback,id}},delSheetMarker=(sheet,flag,id)=>{sheet.___littleHelper??={};let h=sheet.___littleHelper;if(h[flag]?.id===id)delete h[flag]},trimProfs=(profs)=>{if(Array.isArray(profs))return profs;else return profs?.split(";").map((p)=>p?.trim()).filter((p)=>p?.length>0)??[]},signNum,formatNum,getRelevantAE=(actor,{item,condition}={})=>{if(item&&!condition){let ae=item.effect;if(ae)return ae}let effects=[...actor.allApplicableEffects()].filter((ae)=>ae.active);if(item){let options={relative:actor};return effects.find((ae)=>ae.origin?fromUuidSync(ae.origin||"",options)===item:!1)}else if(condition){let relevant=effects.filter((ae)=>ae.statuses.has(condition));return relevant.sort((a,b)=>{if(a.origin&&!b.origin)return-1;if(b.origin&&!a.origin)return 1;return a.statuses.size-b.statuses.size}),relevant[0]}};var init_common=__esm(()=>{init_config();init_icons();clampNum=Math.clamp??Math.clamped;signNum=new Intl.NumberFormat(void 0,{signDisplay:"always"}).format,formatNum=new Intl.NumberFormat(void 0).format});function benchPressBasics(content,shared){let actor=shared.actor,c=createNode("div","",["token-info","flexcol"]),protoToken=actor.prototypeToken,hasVision=protoToken.sight.enabled,linkData=protoToken.actorLink,disposition=`${protoToken.disposition}`,displayName=protoToken.displayName,displayBars=protoToken.displayBars,dispositionLabel={0:"TOKEN.DISPOSITION.NEUTRAL",1:"TOKEN.DISPOSITION.FRIENDLY","-1":"TOKEN.DISPOSITION.HOSTILE"},dispositionStyle={0:"neutral",1:"friendly","-1":"hostile"},displayLabel={0:"TOKEN.DISPLAY_NONE",10:"TOKEN.DISPLAY_CONTROL",20:"TOKEN.DISPLAY_OWNER_HOVER",30:"TOKEN.DISPLAY_HOVER",40:"TOKEN.DISPLAY_OWNER",50:"TOKEN.DISPLAY_ALWAYS"};c.append(createNode("h2","Token Info"),appendElements(createNode("div",null,["detail-content"]),appendElements(createNode("div","",["flexrow"]),createNode("h4",i18n.get("LittleHelper.Details.Token.Disposition"),["header","width6"]),createNode("label",i18n.get(dispositionLabel[disposition]),["disposition",dispositionStyle[disposition],"width14","value","center-text"])),appendElements(createNode("div","",["flexrow"]),createNode("h4",i18n.get("Vision"),["header","width6"]),createNode("label",i18n.get(hasVision?"LittleHelper.Details.Token.Sighted":"LittleHelper.Details.Token.Blind"),[hasVision?"sighted":"blind","vision","width14","value","center-text"])),appendElements(createNode("div","",["flexrow"]),createNode("h4",i18n.get("LittleHelper.Details.Token.Linked"),["header","width6"]),createNode("label",linkData?"Linked":"Unlinked",[linkData?"linked":"unlinked","linkstate","width14","value","center-text"])),appendElements(createNode("div","",["flexrow"]),createNode("h4",i18n.get("TOKEN.CharShowNameplate"),["header","width6"]),createNode("label",i18n.get(displayLabel[displayName]),["name-display","width14","value","center-text"])),appendElements(createNode("div","",["flexrow"]),createNode("h4",i18n.get("TOKEN.ResourceDisplay"),["header","width6"]),createNode("label",i18n.get(displayLabel[displayBars]),["bar-display","width14","value","center-text"])))),content.append(c)}var init_token_info=__esm(()=>{init_common();Hooks.on("little-helper.details-tab.content",benchPressBasics)});function formatCurrency(value,signed=!1){let rate=pf1.config.currency.standardRate,unit=pf1.config.currency.standard,formatter=signed?signNum:formatNum;return game.i18n.format(`PF1.Currency.Inline.${unit}`,{value:formatter(pf1.utils.limitPrecision(value/rate,2))})}function getItemValue(item,grouped,contained=!1){let currency=item.getTotalCurrency?.({inLowestDenomination:!0})??0,value=item.getValue({sellValue:1,inLowestDenomination:!0,recursive:!1});switch(item.type){case"loot":switch(item.subType){case"treasure":case"tradeGoods":grouped.tradeGoods=value;break;case"ammo":grouped.ammunition+=value;break}break;case"weapon":{let equipped=item.isActive;if(!contained&&equipped)break;grouped.unusedWeapons+=value;break}case"equipment":{let equipped=item.isActive;if(!contained&&equipped)break;switch(item.subType){case"armor":case"shield":grouped.unusedArmor+=value;break;default:grouped.unusedGear+=value;break}break}case"consumable":grouped.consumables+=value;break}let items=0;if(item.type==="container")for(let sitem of item.items){let iv=getItemValue(sitem,grouped,!0);items+=iv.items+iv.value,currency+=iv.currency}return{currency,items,value,get total(){return this.currency||0+this.items||0+this.value||0}}}function getTotalInventoryValue(actor,grouped){let inventory=0,currency=0,contents=0;for(let item of actor.items){if(!item.isPhysical)continue;let iv=getItemValue(item,grouped);inventory+=iv.value,currency+=iv.currency,contents+=iv.items}return{contents,currency,inventory}}function wealthByLevelProvider(content,shared){let actor=shared.actor,actorData=actor.system,ratio=game.settings.get(CFG.id,CFG.SETTINGS.wbl),standardRate=pf1.config.currency.standardRate,lv=actorData.details.level.value,typedValue={tradegoods:0,consumables:0,ammunition:0,unusedWeapons:0,unusedArmor:0,unusedGear:0},tvt=getTotalInventoryValue(actor,typedValue),inventoryValue=tvt.inventory+tvt.contents,currency=(actor.getTotalCurrency?.({inLowestDenomination:!0})??0)+tvt.currency,totalWealth=inventoryValue+currency,normalWbl=wealthByLevel[lv]??Number.NaN,wbl=normalWbl*ratio,diff=totalWealth-wbl*100,wblTooltip;if(ratio!==1)wblTooltip=`${Math.round(ratio*100)}% of ${formatCurrency(normalWbl*standardRate)}`;let unused=0,headerLabel=createNode("h2","Wealth by Level");if(ratio!==1)headerLabel.append(createNode("span",`${Math.round(ratio*100)}%`,["ratio"]));let c=createNode("div","",["wealth-by-level","flexcol"]);c.append(headerLabel,appendElements(createNode("div",void 0,["detail-content"]),appendElements(createNode("div","",["flexrow"]),createNode("h4","Expected",["header","width8"]),createNode("label",formatCurrency(wbl*standardRate),["expected","width8","value","number"],{tooltip:wblTooltip})),appendElements(createNode("div","",["flexrow"]),createNode("h4","Possessed",["header","width8"]),createNode("label",formatCurrency(totalWealth),["total-value","width8","value","number"]),createNode("label",`[${maxPrecision(totalWealth/(wbl*standardRate)*100,2)}% of WBL]`,["percentage"])),appendElements(createNode("div","",["flexrow"]),createNode("h4","– Unused",["header","width8"]),createNode("label",formatCurrency(unused),["unused","width8","value","number"]),createNode("label",`[${inventoryValue>0?maxPrecision(unused/inventoryValue*100,2):0}% wealth]`,["unused","percentage"])),appendElements(createNode("div","",["flexrow"]),createNode("h4","– Consumables",["header","width8"]),createNode("label",formatCurrency(typedValue.consumables),["consumables","width8","value","number"]),createNode("label",`[${inventoryValue>0?maxPrecision(typedValue.consumables/inventoryValue*100,2):0}% wealth]`,["unused","percentage"])),appendElements(createNode("div","",["flexrow"]),createNode("h4","– Ammunition",["header","width8"]),createNode("label",formatCurrency(typedValue.ammunition),["ammunition","width8","value","number"]),createNode("label",`[${inventoryValue>0?maxPrecision(typedValue.ammunition/inventoryValue*100,2):0}% wealth]`,["unused","percentage"])),appendElements(createNode("div","",["flexrow"]),createNode("h4","– Trade goods",["header","width8"]),createNode("label",formatCurrency(typedValue.tradegoods),["trade-goods","width8","value","number"]),createNode("label",`[${inventoryValue>0?maxPrecision(typedValue.tradegoods/inventoryValue,2):0}% wealth]`,["unused","percentage"])),appendElements(createNode("div","",["flexrow"]),createNode("h4","– Coinage",["header","width8"]),createNode("label",formatCurrency(currency),["total-coinage","width8","value","number"]),createNode("label",`[${currency>0?maxPrecision(currency/totalWealth*100,2):0}% wealth]`,["unused","percentage"])),appendElements(createNode("div","",["flexrow"]),createNode("h4","Difference",["header","width8"]),createNode("label",formatCurrency(diff,!0),["diff","width8","value","number"]),createNode("label",diff>=0?"ahead":"behind")),createNode("p","This does not take into account fine untrackable details, such as carrying items for other people, nor can it identify backup gear or similar reliably."))),content.append(c)}var wealthByLevel;var init_wealth_by_level=__esm(()=>{init_config();init_common();wealthByLevel={2:1000,3:3000,4:6000,5:10500,6:16000,7:23500,8:33000,9:46000,10:62000,11:82000,12:108000,13:140000,14:185000,15:240000,16:315000,17:410000,18:530000,19:685000,20:880000};Hooks.on("little-helper.details-tab.content",wealthByLevelProvider)});var getPackedSize=(obj)=>JSON.stringify(obj).length,actorStats=(content,shared)=>{let actor=shared.actor,c=createNode("div","",["actor-stats","flexcol"]),obj=actor.toObject(),actorSize=getPackedSize(obj),itemsSize=getPackedSize(obj.items),itemCount=obj.items.length,itemTypeSizes={};for(let item of actor.items){let type=item.type;itemTypeSizes[type]??={size:0,count:0,biggest:{size:0,name:null}};let t=itemTypeSizes[type];t.count+=1;let size=getPackedSize(item);if(t.size+=size,size>t.biggest.size)t.biggest.size=size,t.biggest.name=item.name}let itemTypeSizeArray=[];for(let[type,value]of Object.entries(itemTypeSizes))itemTypeSizeArray.push({type,...value});itemTypeSizeArray=itemTypeSizeArray.sort((a,b)=>b.size-a.size).slice(0,3);let itemRows=[];for(let stack of itemTypeSizeArray){if(stack.size===0)continue;let typeSize=appendElements(createNode("div","",["flexrow"]),createNode("h4",`– ${stack.type}`,["header","width8"]),createNode("label",`${maxPrecision(stack.size/1000,2)} kB`,["items-size","width8","value","number"]),createNode("label",`[${stack.count} entries; ${maxPrecision(stack.size/itemsSize*100,2)}% of all items]`,["count","percentage"]));itemRows.push(typeSize)}c.append(createNode("h2","Stats"),appendElements(createNode("div",null,["detail-content"]),appendElements(createNode("div","",["flexrow"]),createNode("h4","Total Size",["header","width8"]),createNode("label",`${maxPrecision(actorSize/1000,2)} kB`,["size","width8","value","number"])),appendElements(createNode("div","",["flexrow"]),createNode("h4","Items",["header","width8"]),createNode("label",`${(itemsSize/1000).toFixed(2)} kB`,["items-size","width8","value","number"]),createNode("label",`[${maxPrecision(itemsSize/actorSize*100,2)}% of total; ${itemCount} entries]`,["count","percentage"])),...itemRows)),content.append(c)};var init_actor_stats=__esm(()=>{init_common();Hooks.on("little-helper.details-tab.content",actorStats)});function benchPressBasics2(content,shared){let actor=shared.actor,c=createNode("div","",["benchpress","flexcol"]),actorData=actor.system,press=BP.take4,level=actorData.details.level.value,index=clampNum(level-1,0,19),saves=Object.values(actorData.attributes.savingThrows).map((s)=>signNum(s.total)).join("/"),coreAttack=actorData.attributes.attack.shared+actorData.attributes.attack.general,szMod=pf1.config.sizeMods[actorData.traits.size],meleeAtkAbl=foundry.utils.getProperty(actorData,`abilities.${actorData.attributes.attack.meleeAbility}.mod`)??0,rangedAtkAbl=foundry.utils.getProperty(actorData,`abilities.${actorData.attributes.attack.rangedAbility}.mod`)??0,rAtk=coreAttack+szMod+actorData.attributes.attack.ranged+rangedAtkAbl,mAtk=coreAttack+szMod+actorData.attributes.attack.melee+meleeAtkAbl,bestAtk=Math.max(rAtk,mAtk);c.append(createNode("h2","Bench-Pressing"),appendElements(createNode("div",null,["detail-content"]),appendElements(createNode("div",null,["flexrow","header"]),createNode("label",null,["header","width6"]),createNode("label","Armor",["header","width4","number"]),createNode("label","Attack",["header","width4","number"]),createNode("label","Saves",["header","width6","number"])),appendElements(createNode("div",null,["flexrow","have"]),createNode("label","Possessed",["header","width6"]),createNode("label",`${actorData.attributes.ac.normal.total}`,["have","value","number","width4"]),createNode("label",`${signNum(bestAtk)}`,["have","value","number","width4"]),createNode("label",`${saves}`,["have","value","number","width6"])),appendElements(createNode("div",null,["flexrow"]),createNode("label","Expected",["header","width6","number"]),createNode("label",`${press.armor[index]}`,["expected","value","number","width4"]),createNode("label",`${signNum(press.attack[index])}`,["expected","value","number","width4"]),createNode("label",`${signNum(press.save[index])}`,["expected","value","number","width6"])),createNode("p",i18n.get("LittleHelper.Details.BenchPressing.Disclaimer"),[],{isHTML:!0}))),content.append(c)}var BP;var init_benchpress=__esm(()=>{init_common();BP={base:{level:[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20]},take2:{attack:[9,10,11,13,14,15,17,18,19,23,24,27,28,30,34,34,35,37,42,43],armor:[18,20,21,22,24,26,28,29,31,32,34,35,37,38,39,41,42,46,47,47],save:[5,6,7,8,8,9,10,11,11,12,13,14,14,15,16,17,17,18,19,20],baddc:[19,20,21,21,22,23,24,25,25,26,26,28,28,30,31,29,31,33,32,35],gooddc:[20,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,36,38,38,40]},take4:{attack:[7,8,9,10,11,12,13,14,16,17,18,20,21,22,23,24,25,27,27,30],armor:[18,20,21,23,25,27,28,30,31,32,34,36,37,38,40,42,45,45,47,48],save:[5,6,7,8,9,10,11,12,13,13,15,15,15,17,18,19,20,22,24,24],baddc:[16,17,17,18,19,20,21,22,22,24,24,25,25,27,27,27,28,29,30,31],gooddc:[18,19,20,20,22,23,24,25,26,25,28,29,29,31,31,32,34,35,36,38]}};Hooks.on("little-helper.details-tab.content",benchPressBasics2)});async function openAESheet(ev,actor){ev.preventDefault();let el=ev.target.closest(".active-effects .active-effect[data-effect-uuid]");if(!el)return;let aeId=el.dataset.effectUuid;(await fromUuid(aeId)).sheet.render(!0,{focus:!0})}function detailActiveEffects(content,shared){let actor=shared.actor,c=createNode("div",void 0,["flexcol"]),g=createNode("ul",void 0,["active-effects"]);c.append(createNode("h2","Active Effects",["lil-details-active-effects"]),appendElements(createNode("div",void 0,["detail-content"]),g)),g.append(createNode("li",void 0,["header"],{children:[createNode("span"," ",["image"]),createNode("span","Name",["name"]),createNode("span"," ",["image"]),createNode("span","Origin",["origin"]),createNode("span","Duration",["duration"])]}));let effects=[...actor.allApplicableEffects()];if(effects.length>0)for(let ae of effects){let{img:icon,origin:originLink}=ae,origin=originLink?fromUuidSync(originLink,{relative:actor}):void 0,parent=ae.parent;origin??=parent;let itemImage=origin?.img??"",haveOrigin=!!origin;g.append(createNode("li",void 0,["active-effect"],{data:{"effect-uuid":ae.uuid},children:[createNode("span",icon?void 0:" ",["image","image-ae"],{children:icon?[createNode("img",void 0,[],{attr:{src:icon}})]:[]}),createNode("span",ae.name||ae.label,["name","ae-label"]),createNode("span",haveOrigin?void 0:" ",["image","image-ae",haveOrigin?"present":"missing"],{children:haveOrigin?[createNode("img",void 0,[],{attr:{src:itemImage}})]:[]}),createNode("span",origin?.name??(originLink?"[missing]":"[n/a]"),["name","origin",haveOrigin?"present":"missing"]),createNode("span",ae.duration.seconds,["duration"])]}))}else g.append("",createNode("p","No active effects found.",["hint","span-all"]));g.addEventListener("contextmenu",(ev)=>openAESheet(ev,actor)),content.append(c)}var init_active_effects=__esm(()=>{init_common();Hooks.on("little-helper.details-tab.content",detailActiveEffects)});var exports__init={};var init__init=__esm(()=>{init_token_info();init_wealth_by_level();init_actor_stats();init_benchpress();init_active_effects()});var exports_unit_tests={};__export(exports_unit_tests,{registerTests:()=>registerTests});function registerTests(){try{let api=game.modules.get("koboldworks-pf1-little-helper").api;quench.registerBatch("koboldworks-pf1-little-helper.formulas",async function({describe,it,expect,before,after}={}){describe("Formula Resolution",function(){let rollData={dex:2,bab:17,size:4},formulas={"3d6+(@dex)d6+2":"3d6+2d6+2","@dex > 1 ? 5 : 2":"5","@dex > 1 ? (2 < 1 ? 3 : 4) : 5":"4","sizeRoll(1,12,@size)+1d8+6+2+1-2-6+2":"1d12+1d8+3","-(1 + (floor(@bab / 4))) + 1":"-4","@formulaicAttack * -5":"0","2 <= 4 ? 1 : (floor(2 / 11 + 1)d6)":"1","2 <= 4 ? 1 : floor(2 / 11 + 1)d6":"1","4>=10 ? 0 : 4>=5 ? -2 : -4":"-4","2 + 2 * 2 ** 2":"10","2 + 2 ** 2 * 2":"10","-5 + 1":"-4","2 * 2 + -6 / 2":"1","4d6-0+2":"4d6+2","sizeRoll(1, 12)":"1d12","sizeRoll(2, 6, 5) + 5 + 2":"3d6+7","(floor(5/2))d6":"2d6","max(1d6,4)":"max(1d6,4)","(--2 + 3)":"5","1d8 + min(2,3)":"1d8+2","sizeRoll(1, 8, @size) + 2 + 2":"1d8+4"};for(let[formula,expected]of Object.entries(formulas))it(formula,function(){try{let rv=api.formula.simplify(formula,rollData,{debug:!0});console.log("Formula Testing:",rv.formula,"=",expected,rv),expect(rv.formula).to.equal(expected)}catch(err){throw console.warn("Failed to parse:",formula),err}})})},{displayName:"Koboldworks – Little Helper \uD83E\uDD8E"})}catch(err){console.error(err)}}init_config();init_common();init_config();init_config();class SubSetting{label;hint;type;value;fallback;callback;get display(){return this.#displayFn(this.value)}#displayFn=()=>"undefined";constructor({setting,label,value,hint,type=Boolean,fallback,display,callback}={},key){if(this.key=key,this.label=label||`LittleHelper.Feature.${setting}.${key}.Label`,this.hint=hint||`LittleHelper.Feature.${setting}.${key}.Hint`,this.type=type,this.fallback=fallback,this.value=value??fallback,typeof display==="function")this.#displayFn=display;this.callback=callback}}class ClientSettingsData{static default(){let settings=new this;for(let feature of Feature.collection){let subSettings={enabled:feature.defaultState};if(feature.subsettings!==void 0&&!foundry.utils.isEmpty(feature.subsettings)){subSettings.config={};for(let[key,cfg]of Object.entries(feature.subsettings))subSettings.config[key]=cfg.fallback}settings[feature.setting]=subSettings}return settings}}class Conflict{system;core;module;get obsolete(){let d=this.details;if(d.system.active)return!0;if(d.core.active)return!0;if(d.module.active)return!0;return!1}constructor({system,core,module}={}){this.system=system,this.core=core,this.module=module}#details;get details(){return this.#details??={system:{get active(){return this.obsolete},_active:this.system!=null,obsolete:this.system?CFG.system.atLeast(this.system):!1,version:{threshold:this.system,current:CFG.system.version}},core:{get active(){return this.obsolete},_active:this.core!=null,obsolete:this.core?CFG.core.atLeast(this.core):!1,version:{threshold:this.core,current:CFG.core.version}},module:{get active(){return this.obsolete},_active:this.module?.length>0,obsolete:this.module?.some((m)=>game.modules.get(m)?.active)??!1,cause:this.module?.filter((m)=>game.modules.get(m)?.active)}},this.#details}}class Requirements{core;system;module;get satisfied(){if(this.module&&!game.modules.get(this.module)?.active)return!1;if(this.system&&!CFG.system.atLeast(this.system))return!1;if(this.core&&!CFG.core.atLeast(this.core))return!1;return!0}constructor(data){this.module=data.module,this.system=data.system,this.core=data.core}#details;get details(){let mod=game.modules.get(this.module);return this.#details??={core:{get active(){return this._active},_active:this.core!=null,version:{threshold:this.system,current:CFG.core.version},satisfied:this.core==null?!0:CFG.core.atLeast(this.core)},system:{get active(){return this._active},_active:this.system!=null,version:{threshold:this.system,current:CFG.system.version},satisfied:this.system==null?!0:CFG.system.atLeast(this.system)},module:{get active(){return this._active},_active:this.module!=null,id:this.module,present:!!mod,enabled:mod?.active,satisfied:mod?.active??!1}},this.#details}}class Feature{enabled=!1;get active(){if(CFG.isStream&&!this.stream)return!1;return this.enabled&&!this.disabled}defaultState=!0;disabled=!1;restart=!1;gmOnly=!1;scope;get world(){return this.scope==="world"}label;hint;notification;warning;setting;category;requirements;conflict;impact;stream;subsettings;enable(){}disable(){}static collection=new Collection;static stage={init:[],setup:[],ready:[]};constructor({setting,label,hint,notification,warning,category,enable,disable,stage="init",scope="client",restart=!1,gm=!1,disabled=!1,requirements,conflict,enabledByDefault=!0,subsettings,impact,stream=!1}={}){if(this.setting=setting,this.label=label||`LittleHelper.Feature.${setting}.Label`,this.hint=hint||`LittleHelper.Feature.${setting}.Hint`,this.notification=notification,this.warning=warning,this.category=category,this.enable=enable,this.disable=disable,this.scope=scope,this.restart=restart,this.gmOnly=gm??!1,this.disabled=disabled,this.defaultState=enabledByDefault,this.subsettings=subsettings,this.impact=impact,this.stream=stream,conflict)this.conflict=new Conflict(conflict);if(requirements)this.requirements=new Requirements(requirements);if(Feature.collection.has(setting))throw Error(`Little Helper \uD83E\uDD8E | Attempting to re-define "${setting}"`);if(Feature.collection.set(setting,this),!Feature.stage[stage])throw Error(`Little Helper \uD83E\uDD8E | Registered "${setting}" for invalid or already passed stage: "${stage}".`);Feature.stage[stage].push(this)}static create({setting,label,hint,notification,warning,category,enableCallback,disableCallback,stage="init",gm=!1,disabled=!1,conflict,requirements,enabledByDefault=!0,impact}={}){new Feature({setting,label,hint,notification,warning,category,enableCallback,disableCallback,stage,gm,disabled,conflict,requirements,enabledByDefault,impact})}toggle(){this.enabled=!this.enabled,this.enabled?this.enable():this.disable()}testToggle(){let scope=this.world?CFG.SETTINGS.generalWorldConfiguration:CFG.SETTINGS.generalClientConfiguration,settings=game.settings.get(CFG.id,scope),doToggle=this.enabled!==(settings[this.setting]?.enabled??!0);if(doToggle)this.toggle();return doToggle}firstTimeLaunch=!1;get firstTime(){let scope=this.world?CFG.SETTINGS.generalWorldConfiguration:CFG.SETTINGS.generalClientConfiguration;return game.settings.get(CFG.id,scope)[this.setting]?.enabled===void 0}init(user,settings){this.firstTimeLaunch=this.firstTime;let scope=this.world?CFG.SETTINGS.generalWorldConfiguration:CFG.SETTINGS.generalClientConfiguration;settings??=foundry.utils.mergeObject(ClientSettingsData.default(),game.settings.get(CFG.id,scope),{inplace:!1});let cfg=settings[this.setting];if(this.enabled=cfg?.enabled??this.defaultState,this.subsettings!==void 0)for(let[key,ss]of Object.entries(this.subsettings))ss.value=cfg.config[key]??ss.fallback,this.subsettings[key]=new SubSetting(ss,key);let C=CFG.console.colors;if(this.conflict?.obsolete){let d=this.conflict.details,o=["%cLittle Helper%c \uD83E\uDD8E",C.main,C.unset,"| Feature:",this.setting,"| ⚠️ Obsoleted |"],coreConflict=d.core.active,systemConflict=d.system.active,moduleConflict=d.module.active;if(coreConflict)o.push("Foundry",d.core.version);if(systemConflict){if(coreConflict)o.push("|");o.push("Game System",d.system.version)}if(moduleConflict){if(coreConflict||systemConflict)o.push("|");o.push("Module(s)",d.module.cause)}console.log(...o),this.disabled=!0}if(!this.disabled&&this.requirements?.satisfied===!1){let d=this.requirements.details,o=["%cLittle Helper%c \uD83E\uDD8E",C.main,C.unset,"| Feature:",this.setting,"| ⚠️ Requirements Not Met |"],coreReq=d.core.active,systemReq=d.system.active,moduleReq=d.module.active,coreAndSysReq=coreReq&&systemReq,versionAndMod=(coreReq||systemReq)&&moduleReq;if(coreReq)o.push("Foundry",d.core.version.threshold);if(coreAndSysReq)o.push("|");if(systemReq)o.push("Game System",d.system.version.threshold);if(versionAndMod)o.push("|");if(moduleReq)o.push("Module",{id:d.module.id});console.log(...o),this.disabled=!0}if(this.gmOnly&&!user.isGM)this.disabled=!0}load(){if(this.active)this.enable()}save(){let scope=this.world?CFG.SETTINGS.generalWorldConfiguration:CFG.SETTINGS.generalClientConfiguration,settings=game.user.getFlag(CFG.id,scope);settings[this.setting].enabled=this.enabled,game.user.setFlag(CFG.id,scope,settings)}static saveAll(settings){let oldSettings=foundry.utils.deepClone(game.settings.get(CFG.id,CFG.SETTINGS.generalClientConfiguration));return this.settings=foundry.utils.mergeObject(ClientSettingsData.default(),oldSettings,{inplace:!1}),this.settings=foundry.utils.mergeObject(this.settings,settings,{inplace:!1}),game.settings.set(CFG.id,CFG.SETTINGS.generalClientConfiguration,this.settings).then((_)=>{let refreshRequired=!1;for(let[id,cfg]of Object.entries(settings)){let feature=Feature.collection.get(id);if(cfg.config!==void 0)for(let[key,ss]of Object.entries(cfg.config))feature.subsettings[key].value=ss;if(cfg.enabled!==feature.enabled){let noOldSettings=oldSettings[id]?.enabled===void 0,rv=cfg.enabled?feature.enable():feature.disable();if(!noOldSettings&&rv===!1)refreshRequired=!0;feature.enabled=cfg.enabled}}if(refreshRequired)ui.notifications?.warn(i18n.get("LittleHelper.Warning.RefreshNeeded"))})}}init_config();init_common();init_icons();class ClientSettingsDialog extends FormApplication{settings;constructor(){super();this.settings=foundry.utils.mergeObject(ClientSettingsData.default(),foundry.utils.deepClone(game.settings.get(CFG.id,CFG.SETTINGS.generalClientConfiguration))),this.features=Feature.collection.filter((f)=>!f.world),this.groups={};for(let feature of this.features){let cat=feature.category;this.groups[cat]??=[],this.groups[cat].push(feature)}}get template(){return`modules/${CFG.id}/templates/client-settings.hbs`}getData(){let data=super.getData();return data.features=this.features,data.groups=this.groups,data.sorted=Object.entries(this.groups).map(([id,group])=>({id,group,label:i18n.get(`LittleHelper.Settings.Category.${id}`)})).sort((a,b)=>a.label.localeCompare(b.label,void 0,{sensitivity:"base"})),data.icons=FAIcons,data}static get defaultOptions(){let _default=super.defaultOptions;return{..._default,title:i18n.get("LittleHelper.Settings.Client",{module:"Little Helper \uD83E\uDD8E"}),classes:[..._default.classes,"koboldworks","settings"],width:460,height:720,id:"little-helper-client-settings",scrollY:["section.content"],closeOnSubmit:!0,submitOnChange:!1,submitOnClose:!1,resizable:!0}}_updateObject(event2,data){Feature.saveAll(foundry.utils.expandObject(data))}_reset(){for(let f of this.features)if(!f.disabled)f.enabled=f.defaultState;this.render()}_clear(){for(let f of this.features)if(!f.disabled)f.enabled=!1;this.render()}searchTimer;lastTerm;doSearch(area,term){for(let el of area.querySelectorAll(".search-mismatch,.search-match,.search-match-inner"))el.classList.remove("search-mismatch","search-match","search-match-inner");if(term.length===0)return;for(let group of area.querySelectorAll(".group ul")){let matches=0;for(let setting of group.querySelectorAll(".setting[data-setting-id]")){let match=!1;if(setting.querySelector("label")?.textContent.trim().toLocaleLowerCase().includes(term))match=!0,setting.classList.add("search-match");else if(setting.querySelector(".hint")?.textContent.trim().toLocaleLowerCase().includes(term))match=!0,setting.classList.add("search-match");if(match)matches++;else setting.classList.add("search-mismatch")}if(group.querySelector(".title")?.textContent.trim().toLocaleLowerCase().includes(term))matches++,group.classList.add("search-match");if(matches===0)group.classList.add("search-mismatch");else group.classList.add("search-match-inner")}}debounceSearch(html,event2){stopEventPropagation(event2),clearTimeout(this.searchTimer);let term=event2.target.value.trim();if(term===this.lastTerm)return;this.lastTerm=term,setTimeout(()=>this.doSearch(html,term.toLocaleLowerCase()),250)}activateListeners(jq){super.activateListeners(jq);let html=jq[0];html.querySelector('button[type="reset"]').addEventListener("click",(event2)=>this._reset(stopEventPropagation(event2))),html.querySelector('button[type="clear"]').addEventListener("click",(event2)=>this._clear(stopEventPropagation(event2)));let searchArea=html.querySelector("section.content"),search=html.querySelector("input.search-input");search.addEventListener("change",this.debounceSearch.bind(this,searchArea)),search.addEventListener("input",this.debounceSearch.bind(this,searchArea));for(let el of html.querySelectorAll("button[data-callback]")){let p=el.dataset.callback,[fId,_,fsId]=p.split("."),f=Feature.collection.get(fId),ss=f?.subsettings[fsId];if(!ss)continue;el.addEventListener("click",(ev)=>{ev.preventDefault(),ev.stopPropagation(),ss.callback.fn(ev,f,ss)})}}}init_icons();Hooks.once("init",function(){let fields=foundry.data.fields,C=CFG.console.colors;console.debug("%cLittle Helper%c \uD83E\uDD8E | Registering Settings",C.main,C.unset),game.settings.register(CFG.id,CFG.SETTINGS.generalClientConfiguration,{type:Object,default:ClientSettingsData.default(),scope:"client",config:!1}),game.settings.register(CFG.id,CFG.SETTINGS.transparency,{name:"Transparency",hint:"What permission level is required to display certain potentially sensitive information.",config:!0,scope:"world",type:Number,default:3,choices:{3:"Owner",2:"Observer",1:"Player-owned",0:"Any (full transparency)"},requiresReload:!0}),game.settings.register(CFG.id,CFG.SETTINGS.transparencySham,{name:"GM special case for transparency",hint:"GM is treated as special case for transparency. If enabled, various information enhancements are not applied to GM generated content regardless of the general transparency setting. This exists mostly as compatibility shim with other modules that want to obfuscate information.",type:Boolean,default:!1,config:!0,scope:"world",requiresReload:!0}),game.settings.register(CFG.id,CFG.SETTINGS.inlineFormulaDetail,{name:"Detailed inline formulas",hint:"Display greater detail for inline formulas. If disabled, flairs and excess details are scrubbed.",config:!0,scope:"client",type:Boolean,default:!0,requiresReload:!0}),game.settings.register(CFG.id,CFG.SETTINGS.wbl,{name:"Wealth by Level Ratio",config:!0,scope:"world",type:new foundry.data.fields.NumberField({positive:!0,min:0.01,step:0.01,max:3,initial:1})}),game.settings.registerMenu(CFG.id,CFG.SETTINGS.generalClientConfiguration,{id:`${CFG.id}-config-client`,name:"Client-side settings",label:"Client Configuration",icon:FAIcons.user,type:ClientSettingsDialog,restricted:!1}),game.settings.register(CFG.id,"ignoreActors",{name:"LittleHelper.Settings.IgnoreActorTypes",hint:"LittleHelper.Settings.IgnoreActorTypesHint",default:[],type:new fields.SetField(new fields.StringField({choices:()=>{let l=foundry.utils.deepClone(CONFIG.Actor.typeLabels);delete l.base;for(let key of Object.keys(l))if(key.includes("."))delete l[key];return l}})),scope:"client",config:!0}),game.settings.register(CFG.id,"migration",{type:String,default:"0.6.0",scope:"world",config:!1})});init_config();var ConditionHelp={};Hooks.once("setup",function(){let C=CFG.console.colors;console.debug("%cLittle Helper%c \uD83E\uDD8E | i18n | Building condition help",C.main,C.unset);for(let k of pf1.registry.conditions.keys())ConditionHelp[k]=`LittleHelper.Conditions.${k}`;CFG.i18n.conditions=ConditionHelp});init_common();class SharedData{user;document;sysSheet=!1;coreSheet=!1;altSheet=!1;get isObserver(){return this.document.permission>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OBSERVER}get systemDocument(){let doc=this.document;if(doc instanceof Actor)return Object.keys(game.system.documentTypes.Actor).includes(doc.type);else if(doc instanceof Item)return Object.keys(game.system.documentTypes.Item).includes(doc.type);else return!1}get systemData(){let doc=this.document;if(doc instanceof Actor||doc instanceof Item)return doc.system;if(doc instanceof pf1.components.ItemAction)return doc}get sourceData(){return this.document.toObject().system}#rollData;get rollData(){if(!this.#rollData)if(!this.document.actor&&!(this.document instanceof Actor))this.#rollData={...game.user.character?.getRollData(),...this.document.getRollData()};else this.#rollData={...this.document.getRollData()};return this.#rollData}#dc;get dc(){return this.#dc??=this.document.getDC(this.rollData),this.#dc}tabs={};#items;get items(){if(!this.#items){let actor=this.document,books=actor.system.attributes?.spells?.spellbooks;this.#items={byType:{}};let itemTypes=this.document.itemTypes;for(let[key,list]of Object.entries(itemTypes))this.#items.byType[key]??={},Object.defineProperty(this.#items.byType[key],"all",{value:list,enumerable:!0});let typed=this.#items.byType;for(let type of Object.keys(typed)){let activeCache=[],subTypes={},items=typed[type];for(let item of items.all){if(items.active=!0,item.isActive)activeCache.push(item);if(item.type==="spell"){let itemData=item.system,bookId=itemData.spellbook;if(!bookId)continue;items._book??={},items._book[bookId]??={all:[],book:books?.[bookId]};let book=items._book[bookId];book.all.push(item),book[itemData.level]??=[],book[itemData.level].push(item)}else{let subType=item.subType;items[subType]??={all:[]},items[subType].all.push(item)}}let props={active:{value:activeCache}};for(let[key,data]of Object.entries(subTypes))props[key]={value:data};Object.defineProperties(items,props)}}return this.#items}get actor(){let doc=this.document;if(doc instanceof Actor)return doc;if(doc instanceof Item)return doc.actor??game.user.character;if(doc instanceof pf1.components.ItemAction)return doc.item?.actor??game.user.character}get actorData(){return this.actor.system}get item(){let doc=this.document;if(doc instanceof Item)return doc;if(doc instanceof Actor)return;return doc.item}get itemData(){return this.item.system}get action(){let doc=this.document;if(doc instanceof Item)return;if(doc instanceof Actor)return;return doc}#mindless;get isMindless(){return this.#mindless??=this.actor?.system.abilities?.int?.value===null,this.#mindless}constructor(user,doc){this.user=user,this.document=doc}}class AncillaryCallback{fn;priority;id;constructor(fn,priority=0,id){this.fn=fn,this.priority=priority,this.id=id}}class HookAncillary{#callbacks={item:[],actor:[],chat:[],action:[],compendium:[]};register(context,callback,{priority=0,id}={}){if(context==="chat"&&game?.ready)console.warn("Chat hook registered very late");this.#callbacks[context].push(new AncillaryCallback(callback,priority,id)),this.#callbacks[context].sort((a,b)=>b.priority-a.priority)}unregister(context,callback){let list=this.#callbacks[context],i=list.findIndex((e)=>e.fn==callback);if(i!==-1)list.splice(i,1)}#call(context,app,...args){if(context==="actor"&&!["character","npc"].includes(app.actor.type))return;let shared=new SharedData(game.user??getUserFromData(),app.object??app.document??app.action??app.item??app);if(["actor","item"].includes(context)&&!shared.isObserver)return;if(context!=="chat")app.__littleHelper??={};args=args.map((a)=>a instanceof jQuery?a[0]:a);let list=this.#callbacks[context];for(let li of list)try{li.fn(app,...args,shared)}catch(err){console.error(err),this.unregister(context,li)}}constructor(){Hooks.once("init",this.#init.bind(this)),Hooks.once("setup",this.#setup.bind(this)),Hooks.once("ready",this.#ready.bind(this))}_oldMsgId;#init(){if(Hooks.on("renderCompendiumDirectory",this.#call.bind(this,"compendium")),getUserFromData().role>0)Hooks.on("renderChatMessageHTML",this.#call.bind(this,"chat")),Hooks.once("ready",()=>this._startCleanup());else console.warn("Little Helper \uD83E\uDD8E | Could not retrieve user information; delaying processing."),this._oldMsgId=Hooks.on("renderChatMessageHTML",this._collectOldMessages.bind(this)),Hooks.once("ready",this._finishCollection.bind(this))}#setup(){}#ready(){Hooks.on("renderActorSheet",this.#call.bind(this,"actor")),Hooks.on("renderItemSheet",this.#call.bind(this,"item")),Hooks.on("renderItemActionSheet",this.#call.bind(this,"action"))}_initialCMs=[];_collectOldMessages(cm,jq){this._initialCMs.push([cm,jq])}_finishCollection(){Hooks.off("renderChatMessage",this._oldMsgId),Hooks.on("renderChatMessageHTML",this.#call.bind(this,"chat"));for(let msgArgs of this._initialCMs)this.#call("chat",...msgArgs);this._startCleanup()}_startCleanup(){delete this._initialCMs,delete this._finishCollection,delete this._collectOldMessages,delete this._oldMsgId,delete this._startCleanup}}var Ancillary=new HookAncillary;init_config();init_common();init_config();init_icons();class NewsDialog extends FormApplication{constructor(features){super();this.features=features,this.groups={};for(let feature of this.features){let cat=feature.category;this.groups[cat]??=[],this.groups[cat].push(feature)}}get template(){return`modules/${CFG.id}/templates/news.hbs`}static get defaultOptions(){let options=super.defaultOptions;return{...options,title:"Little Helper \uD83E\uDD8E new features",width:460,classes:[...options.classes,"koboldworks","news"],closeOnSubmit:!0,submitOnClose:!1,submitOnChange:!1}}getData(){let data=super.getData();return data.features=this.features,data.groups=this.groups,data.sorted=Object.entries(this.groups).map(([id,group])=>({id,group,label:`LittleHelper.Settings.Category.${id}`})).sort((a,b)=>a.id.localeCompare(b.id)),data.icons=FAIcons,data}_updateObject(event2,formData){Feature.saveAll(foundry.utils.expandObject(formData))}static display(newfeatures){new NewsDialog(newfeatures).render(!0,{focus:!1})}}var init=()=>{let C=CFG.console.colors;console.log("%cLittle Helper%c \uD83E\uDD8E | Initializing Features",C.main,C.unset);let user=game.user??getUserFromData(),settings=foundry.utils.mergeObject(ClientSettingsData.default(),game.settings.get(CFG.id,CFG.SETTINGS.generalClientConfiguration),{inplace:!1});for(let f of Feature.collection)f.init(user,settings);CFG.API.features=Feature.collection,CFG.API.utility.deleteClientSettings=()=>game.settings.set(CFG.id,CFG.SETTINGS.generalClientConfiguration,{})};function load(stage){for(let f of Feature.stage[stage])try{f.load()}catch(error){f.error=error,console.error(error)}}Hooks.once("init",init);Hooks.once("i18nInit",()=>{for(let feature of Feature.collection){let{label,hint}=feature;feature.label=i18n.has(label)?i18n.get(label):label,feature.hint=i18n.has(hint)?i18n.get(hint):hint}});Hooks.once("init",function(){load("init")});Hooks.once("setup",function(){load("setup")});Hooks.once("ready",function(){load("ready"),delete Feature.stage;let firstTime=Feature.collection.filter((f)=>f.firstTimeLaunch);if(firstTime.length>0)NewsDialog.display(firstTime)});init_common();function rollAgain(ev,button){ev.preventDefault(),ev.stopPropagation();let skillId=button.dataset.skillId,abilityId=button.dataset.abilityId,saveId=button.dataset.saveId,roll;if(skillId)roll="skill";else if(abilityId)roll="ability";else if(saveId)roll="save";if(!roll)ui.notifications.warn("Undefined roll received."),console.warn("ROLL | Undefined roll received");let actors=canvas.tokens.controlled.map((t)=>t.actor).filter((a)=>a!=null);if(actors.length===0&&game.user.character)actors=[game.user.character];if(actors.length===0)return ui.notifications.warn("No valid actor selected for rolling.");let isShift=ev.shiftKey,skipDialog=game.settings.get("pf1","skipActionDialogs")&&!isShift||!game.settings.get("pf1","skipActionDialogs")&&isShift,msg=game.messages.get(button.closest(".chat-message[data-message-id]").dataset.messageId),reference=msg?.uuid,dc=msg?.system.dc;for(let a of actors)if(skillId)a.rollSkill(skillId,{skipDialog,reference,dc});else if(abilityId)a.rollAbilityTest(abilityId,{skipDialog,reference,dc});else if(saveId)a.rollSavingThrow(saveId,{skipDialog,reference,dc})}function handleCMbySubject(cm,html,subject){if(!cm.isContentVisible)return;let{skill:skillId,ability:abilityId,save:saveId,core:otherId}=subject;if(skillId||abilityId||saveId){let button=createNode("span","Roll",["lil-roll-button"]);if(skillId)button.dataset.skillId=skillId;if(abilityId)button.dataset.abilityId=abilityId;if(saveId)button.dataset.saveId=saveId;if(otherId)button.dataset.coreId=otherId;button.prepend(createNode("i",null,["fa-solid","fa-dice"])),button.addEventListener("click",(ev)=>rollAgain(ev,button)),html.querySelector(".flavor-text")?.after(button,createNode("div",null,["kbwks-flow-break"]))}}function handleMessage(cm,html,options,shared){if(!canViewChatMessage(cm,shared.user))return;let subject=cm.system?.subject;if(subject)handleCMbySubject(cm,html,subject)}function enable(){return Ancillary.register("chat",handleMessage),!1}function disable(){return Ancillary.unregister("chat",handleMessage),!1}new Feature({setting:"quick-roller",category:"chat-card",enable,disable,stage:"init"});init_common();function applyBuff(actor,buff,createData){let old=actor.items.find((i)=>i.type==="buff"&&i.name===createData.name);if(old){if(old.isActive)return;let updateData={"system.active":!0},level=createData.system?.level;if(old.system.level!==level)updateData["system.level"]=level;return old.update(updateData)}else return actor.createEmbeddedDocuments("Item",[createData])}function applyBuffTriage(ev,buff){ev.preventDefault(),ev.stopPropagation();let actors=canvas.tokens.controlled.map((t)=>t.actor).filter((a)=>a?.isOwner);if(actors.length===0)return ui.notifications?.warn("No valid actors selected.");let buffData=buff.toObject();delete buffData.ownership,delete buffData.sort,delete buffData.folder,delete buffData.system.links,delete buffData.system.duration?.start,buffData.system.active=!0;for(let a of actors)applyBuff(a,buff,buffData)}function addApplyBuff(cm,html){if(!cm.isContentVisible)return;let item=cm.itemSource;if(item?.type!=="buff")return;if(cm.getFlag("pf1","metadata")?.action)return;let content=html.querySelector(".card-content"),d=createNode("div",null,["lil-apply-buff","flexrow"]),button=createNode("button","Apply to Selected",["apply-button"]);d.append(button),button.addEventListener("click",(ev)=>applyBuffTriage(ev,item)),content?.after(d)}function enable2(){Ancillary.register("chat",addApplyBuff)}function disable2(){return Ancillary.unregister("chat",addApplyBuff),!1}new Feature({setting:"card-apply-buff",label:"Apply Buff Button",hint:"Adds button to apply a buff to selected tokens to buff chat cards.",category:"chat-card",enable:enable2,disable:disable2,stage:"init"});function mutationNodeHandler(node,mutation){if(!node.classList?.contains("dice-tooltip"))return;let parentEl=mutation.target,rollData=JSON.parse(unescape(parentEl.dataset.roll)),roll=RollPF.fromData(rollData),formula=parentEl.title,data={roll,rollData,formula};Hooks.callAll("little-helper.cm.dice-tooltip",node,parentEl,data)}function mutationListHandler(mutation){if(mutation.type!=="childList")return;for(let node of mutation.addedNodes)mutationNodeHandler(node,mutation)}function mutationCallback(mutations){for(let mut of mutations)mutationListHandler(mut)}var observerConfig={subtree:!0,childList:!0,attributes:!1},observer=new MutationObserver(mutationCallback);function initMutationObserver(){let chatLog=document.getElementById("chat-log")??document.getElementById("chat");observer.observe(chatLog,observerConfig)}Hooks.once("init",()=>{Hooks.on("renderChatLog",initMutationObserver)});init_config();init_common();function inlineFormulaDetails(node,_,data){let formula=compressFormula(data.roll._formula,!game.settings.get(CFG.id,CFG.SETTINGS.inlineFormulaDetail)).replaceAll(/([)\d])\s*([+*\-/])\s*/g,(_2,m1,m2)=>`${m1} ${m2} <wbr>`),formulaEl=createNode("div",formula,["inline-formula","lil-dice-tooltip-source"],{isHTML:!0});node.prepend(formulaEl,document.createElement("hr"))}function enable3(){Hooks.on("little-helper.cm.dice-tooltip",inlineFormulaDetails)}function disable3(){Hooks.off("little-helper.cm.dice-tooltip",inlineFormulaDetails)}new Feature({setting:"inline-roll-formula",label:"Inline Roll Formula",hint:"Display formula at top of inline roll expanded view in chat log.",category:"chat-card",enable:enable3,disable:disable3,stage:"init"});init_common();var newProp=(text,classes=[],tooltip)=>createNode("span",text,["tag",...classes],{tooltip});function additionalProperties(cm,html,options,shared){let item=cm.itemSource;if(!item)return;if(!canViewChatMessage(cm,shared.user))return;if(!testTransparency(game.user,item))return;let cardContent=html.querySelector(".pf1.item-card");if(!cardContent)return;let extraProps=[],props=html.querySelector(".property-group.gm-sensitive div");if(!props)return;let actionId=cardContent.dataset.actionId,action=item.actions?.get(actionId);if(action&&action.attackType=="natural"&&!action.naturalAttack.primaryAttack)extraProps.push(newProp(i18n.get("PF1.SecondaryAttack"),["lil-potentially-invalid"],"Matches only default choice."));if(extraProps.length>0)props.append(...extraProps)}function enable4(){Ancillary.register("chat",additionalProperties)}function disable4(){return Ancillary.unregister("chat",additionalProperties),!1}new Feature({setting:"card-additional-properties",label:"Additional Properties",hint:"Adds additional properties to chat cards, such as secondary natural attack identifier.",category:"chat-card",enable:enable4,disable:disable4,stage:"init",stream:!0});init_common();function cardHeaderEnrichment(cm,html){let item=cm.itemSource;if(!canViewChatMessage(cm))return;if(!testTransparency(game.user,item))return;let metadata=cm.system;if(!item)return;if(item.isPhysical&&!item.system.identified)return;let cl=metadata?.config?.cl??item.casterLevel,sl=metadata?.config?.sl??item.spellLevel;if(!(cl>0||sl>0))return;let hd=createNode("div","",["lil-header-details","flexcol"]);if(cl>0)hd.append(createNode("span",`CL ${cl}`,["lil-cl","lil-detail"]));if(Number.isFinite(sl))hd.append(createNode("span",`SL ${sl}`,["lil-sl","lil-detail"]));if(hd.children.length>0)html.querySelector(".card-header .item-name")?.after(hd)}function enable5(){Ancillary.register("chat",cardHeaderEnrichment)}function disable5(){return Ancillary.unregister("chat",cardHeaderEnrichment),!1}new Feature({setting:"card-header-enrichment",label:"Header Enrichment",hint:"Adds additional details to card headers, such as spell level and caster level.",category:"chat-card",enable:enable5,disable:disable5,stage:"init",stream:!0});init_common();function boundingWidth(b){if(!b)return{l:0,w:window.innerWidth,t:0};let bv=b.getBoundingClientRect();return{l:bv.left,w:bv.width,t:bv.top,h:bv.height}}function setStaticToolTipListener(parentEl,tooltip,{aligned=!0,boundedBy}={}){parentEl.addEventListener("pointerenter",function(){let p=parentEl.getBoundingClientRect(),{l,w,t}=boundingWidth(boundedBy);if(tooltip.style.cssText+=`--p-left:${p.left};--p-bottom:${p.bottom};--width:${tooltip.clientWidth};--p-right:${p.right};--height:${tooltip.clientHeight};--p-height:${p.height};--p-width:${p.width};--p-right:${p.right};--p-top:${Math.max(t,p.top)};`,aligned)tooltip.classList.toggle("right-aligned",p.left>l+Math.floor(w/2))},{passive:!0})}function hookCoreTooltip(el,{css,direction,fn,context}={}){let tm=CONFIG.ux.TooltipManager;direction??=tm.TOOLTIP_DIRECTIONS.UP,el.addEventListener("pointerover",async(event2)=>{let content=await fn(event2,el,context);if(!content)return;let tt={direction};if(typeof content==="string")tt.text=content;else tt.html=content;if(css)tt.cssClass=css;game.tooltip.activate(el,tt)},{passive:!0}),el.addEventListener("pointerleave",()=>game.tooltip.deactivate(),{passive:!0})}async function fillCardTooltip(tip,cm,{tagGroups=[]}={}){let speaker=ChatMessage.getSpeakerActor(cm.speaker),isVisible=cm.isContentVisible,whisper=cm.whisper,isWhisper=whisper.length>0,isBlind=isWhisper&&cm.blind,author=cm.author,authorId=author?.id,isSelfWhisper=whisper.length==1&&whisper[0]==authorId,nameDetails=[];if(!authorId)nameDetails.push(" ",createNode("span","(Missing)",["hint"]));else if(authorId===game.user.id)nameDetails.push(" ",createNode("span","(You)",["hint"]));let ul=createNode("ul",void 0,["details"],{children:[createNode("li",void 0,["author"],{children:[createNode("label","Author"),createNode("span",`${author?.name}`,["name","author-name","value"],{children:nameDetails})]})]}),addLine=()=>ul.append(createNode("hr",void 0,["span-2"]));if(speaker&&isVisible){addLine();let alias=cm.speaker.alias,tokenName=speaker.token?.name,actorName=speaker.name,primaryName=alias??tokenName??actorName,lis=createNode("li",void 0,["speaker"],{children:[createNode("label","Speaker"),createNode("span",primaryName,["name","speaker-name","value"])]});if(ul.append(lis),speaker.testUserPermission(game.user,"OBSERVER")){if(!!tokenName&&primaryName!==tokenName){let lit=createNode("li",void 0,["speaker"],{children:[createNode("label","Token"),createNode("span",tokenName,["name","token-name","value"])]});ul.append(lit)}if(!!actorName&&primaryName!==actorName&&tokenName!==actorName){let lia=createNode("li",void 0,["speaker"],{children:[createNode("label","Actor"),createNode("span",actorName,["name","actor-name","value"])]});ul.append(lia)}}}addLine();let modeLabel;if(!isWhisper)modeLabel="Public";else if(isBlind)modeLabel="Blind GM Whisper";else if(isSelfWhisper)modeLabel="Self";else if(whisper.every((u)=>game.users.get(u)?.isGM))modeLabel="GM Whisper";else modeLabel="Whisper";let rlmode=createNode("li",void 0,["roll-mode"],{children:[createNode("label","Visibility"),createNode("span",modeLabel,["name","speaker-name","value"])]});if(ul.append(rlmode),isBlind){let li=createNode("li",void 0,["blind"],{children:[createNode("label","Blind"),createNode("span",isBlind?"Yes":"No",["blind-mode",isBlind?"enabled":"disabled","value"])]});ul.append(li)}if(isSelfWhisper){let li=createNode("li",void 0,["selfroll"],{children:[createNode("label","Self"),createNode("span",isSelfWhisper?"Yes":"No",["self-roll-mode",isSelfWhisper?"enabled":"disabled","value"])]});ul.append(li)}else if(isWhisper){let lipre=createNode("li",void 0,["whisper"],{children:[createNode("label","Whisper"),createNode("span",isWhisper?"Yes":"No",["whisper-mode",isWhisper?"enabled":"disabled","value"])]});if(ul.append(lipre),isVisible){let targets=cm.whisper.map((uid)=>game.users.get(uid)??{id:uid,missing:!0});for(let t of targets){let isSelf=game.user.id===t.id,isGM=t.isGM===!0,label=t.name??`[${t.id}]`,targetNames=[];if(isSelf)targetNames.push(" ",createNode("span","(You)",["hint"]));let li=createNode("li",void 0,["whisper-target"],{children:[createNode("label"," – ",["preformatted"]),createNode("span",label,["name","whisper-target",isSelf?"self":"other",isGM?"gm":"player","value"],{data:{"user-id":t.id},children:targetNames})]});ul.append(li)}}}addLine();let timestamp=cm.timestamp,dateLabel=new Date(timestamp).toLocaleString(),lidate=createNode("li",void 0,["date-time"],{children:[createNode("label","Date & Time"),createNode("time",dateLabel,["date-time","value"])]});if(ul.append(lidate),feature.subsettings.stealTimestamp.value){let lifuzzy=createNode("li",void 0,["relative-time"],{children:[createNode("label","Relative"),createNode("time",tip.querySelector(".message-timestamp")?.textContent,["message-timestamp","value"])]});ul.append(lifuzzy)}if(isVisible&&tagGroups.length>0){addLine();let tagEl=createNode("div",void 0,["property-group-tags","span-2"]);for(let g of tagGroups){let tagGEl=createNode("div",void 0,["tags"]);tagGEl.append(...g.tags),tagEl.append(createNode("h3",`Tags: ${g.label}`,["group-title"]),tagGEl)}ul.append(tagEl)}if(Hooks.call("little-helper.chat.tooltip.meta",cm,ul)===!1)return;tip.replaceChildren(ul)}function injectChatTooltip(cm,html,options,shared){let tip=createNode("div",null,["lil-tooltip","lil-card-tooltip"]);if(feature.subsettings.stealRecipients.value)html.querySelector(".message-header .whisper-to")?.remove();if(feature.subsettings.stealTimestamp.value)tip.append(html.querySelector(".message-metadata .message-timestamp"));let tagGroups=[];if(feature.subsettings.stealTags.value){let footer=html.querySelector("footer.card-footer");for(let el of footer?.querySelectorAll(".property-group.general-notes")??[]){let label=el.firstElementChild?.textContent?.trim(),tags=[...el.querySelectorAll(".tag")];if(tags.length>0)tagGroups.push({label,tags}),el.remove()}}html.addEventListener("pointerenter",()=>fillCardTooltip(tip,cm,{tagGroups}),{passive:!0,once:!0}),setStaticToolTipListener(html,tip,{aligned:!1}),html.append(tip)}function enable6(){Ancillary.register("chat",injectChatTooltip)}function disable6(){return Ancillary.unregister("chat",injectChatTooltip),!1}var feature=new Feature({setting:"card-tooltips",label:"Metadata Tooltips",hint:"Display card metadata in a tooltip.",category:"chat-card",enable:enable6,disable:disable6,stage:"init",subsettings:{stealRecipients:new SubSetting({label:"Steal Recipients",hint:"Remove recipient display from the main card, only displaying it in the tooltip.",fallback:!0,type:Boolean}),stealTimestamp:new SubSetting({label:"Steal Timestamp",hint:"Move timestamp display from the main card into the tooltip.",fallback:!0,type:Boolean}),stealTags:new SubSetting({label:"Steal Property Tags",hint:"Move property tags into the tooltip.",fallback:!1,type:Boolean})},conflict:{core:13}});init_common();var getSkillName=(id)=>pf1.config.skills[id]||id;class Tag{check;success;failure;possible;content;hint;constructor(label,{hint,check=0,success=!1,possible=!1,failure=!1}={}){this.check=check,this.content=label,this.hint=hint,this.success=success,this.possible=possible,this.failure=failure}}function appendCustomTags(html,tags=[]){let div=createNode("div",void 0,["property-group","reminders","lil-check-notes"]),tagList=createNode("div",void 0,["tag-list","flexrow"]);div.append(tagList);for(let t of tags){let tag=createNode("span",void 0,["tag","enriched"]);if(tag.innerHTML=t.content,t.check){if(tag.classList.add("check"),t.success)tag.classList.add("success");if(t.possible)tag.classList.add("possible");if(t.failure)tag.classList.add("failure")}if(t.hint)tag.classList.add("hint"),addCoreTooltip(tag,t.hint);tagList.append(tag)}html.querySelector(".message-content")?.append(div)}function handleSkillCheck({skillId,tags,check,cm,actor}={}){let isMetric=pf1.utils.getDistanceSystem()==="metric",rank=cm.system.config.rank??0,trained=rank>0;switch(skillId){case"apr":tags.push(new Tag(i18n.get("LittleHelper.Checks.BaseDC",{dc:20}),{check,failure:check<10,possible:check>=10&&check<20,success:check>=20}));break;case"spl":{let rollData={check},formula="@check[Result] - 15[Base DC]",roll=RollPF.safeRollSync("@check[Result] - 15[Base DC]",rollData),enriched=enrichRoll(roll,"@check[Result] - 15[Base DC]",roll.total,rollData).outerHTML;tags.push(new Tag(i18n.get("LittleHelper.CardHints.IdentifyMaxLevel",{level:enriched}),{hint:"LittleHelper.CardHints.IdentifyMaxLevelHint",check,possible:check>=15,success:check>33,failure:check<15}));break}case"dip":tags.push(new Tag(i18n.get("LittleHelper.CardHints.IndifferentBaseDC",{dc:15}),{hint:"",check,failure:check<5,possible:check>=5&&check<15,success:check>15}));break;case"int":tags.push(new Tag(i18n.get("LittleHelper.CardHints.DemoralizeDC"),{check,failure:check<10,possible:check>=10}),new Tag(i18n.get("LittleHelper.CardHints.DemoralizeSizeBonus"),{hint:"LittleHelper.CardHints.DemoralizeSizeBonusHint"}));break;case"fly":tags.push(new Tag(i18n.get("LittleHelper.CardHints.FlySlowDC",{dc:10}),{check,success:check>=10,failure:check<10}),new Tag(i18n.get("LittleHelper.CardHints.FlyHoverDC",{dc:15}),{check,success:check>=15,failure:check<15}),new Tag(i18n.get("LittleHelper.CardHints.FlyOtherDC",{dc:"15/20"}),{check,success:check>=20,possible:check>=15&&check<20,failure:check<15}));break;case"acr":{tags.push(new Tag(i18n.get("LittleHelper.CardHints.TumbleDC"),{hint:"LittleHelper.CardHints.TumbleDCHint",check,failure:check<0,possible:check>=0}));let actor2=ChatMessage.getSpeakerActor(cm.speaker),unit=isMetric?pf1.config.measureUnitsShort.m:pf1.config.measureUnitsShort.ft;if(!actor2)return;let rollData={attributes:{speed:{land:{total:actor2.system.attributes?.speed?.land?.total??0}}},check},hformula="floor((@check[Result] + floor(((@attributes.speed.land.total - 30) / 10)[Speed Modifier] * 4[Check Adjust])) / 4)",hroll=RollPF.safeRollSync(hformula,rollData),hcv=pf1.utils.convertDistance(hroll.total)[0],henriched=hroll.err?"<i>NaN</i>":enrichRoll(hroll,hformula,`${hcv} ${unit}`,rollData).outerHTML;tags.push(new Tag(i18n.get("LittleHelper.CardHints.JumpHeight",{value:henriched}),{check,failure:hroll.total<=0,possible:hroll.total>0,hint:hroll.err?.message}));let dformula="@check[Check] + floor((@attributes.speed.land.total - 30) / 10)[Speed Modifier] * 4[Check Adjust]",droll=RollPF.safeRollSync(dformula,rollData),dcv=pf1.utils.convertDistance(droll.total)[0],denriched=droll.err?"<i>NaN</i>":enrichRoll(droll,dformula,`${dcv} ${unit}`,rollData).outerHTML;tags.push(new Tag(i18n.get("LittleHelper.CardHints.JumpLength",{value:denriched}),{check,failure:droll.total<=0,possible:droll.total>0,hint:droll.err?.message}));break}case"blf":tags.push(new Tag(i18n.get("LittleHelper.CardHints.FeintDC",{dc:10}),{hint:"LittleHelper.CardHints.FeintDCHint",check,failure:check<10,possible:check>=10}),new Tag(i18n.get("LittleHelper.CardHints.OpposedBy",{skill:getSkillName("sen")})));break;case"clm":{tags.push(new Tag(i18n.get("LittleHelper.CardHints.ClimbNaturalRockDC",{dc:15}),{check,possible:check>=5,failure:check<5}));let clmb=actor?.system.attributes?.speed?.climb?.total??0,speed=clmb;if(clmb==0){let base=(actor?.system.attributes?.speed?.land?.total??0)/5;speed=Math.floor(base/4)*5}let[cspeed,unit]=pf1.utils.convertDistance(speed),lspeed=i18n.get("Koboldworks.Missing.PF1.Distance",{distance:cspeed,unit:pf1.config.measureUnitsShort[unit]||unit}),hint=clmb>0?"LittleHelper.CardHints.NaturalSpeed":"LittleHelper.CardHints.ClimbSpeedHint";if(tags.push(new Tag(i18n.get("LittleHelper.CardHints.ClimbSpeed",{speed:lspeed}),{hint})),speed>0){let aspeed=i18n.get("Koboldworks.Missing.PF1.Distance",{distance:cspeed*2,unit:pf1.config.measureUnitsShort[unit]||unit});tags.push(new Tag(i18n.get("LittleHelper.CardHints.FastClimb",{speed:aspeed}),{hint:"LittleHelper.CardHints.FastClimbHint"}))}break}case"dev":tags.push(new Tag(i18n.get("LittleHelper.CardHints.DisableDeviceBaseDC",{dc:10}),{check,failure:check<10,possible:check>=10}),new Tag(i18n.get("LittleHelper.CardHints.DisableLockBaseDC",{dc:20}),{check,failure:check<20,possible:check>=20}));break;case"dis":tags.push(new Tag(i18n.get("LittleHelper.CardHints.OpposedBy",{skill:getSkillName("per")})));break;case"esc":tags.push(new Tag(i18n.get("LittleHelper.CardHints.EscapeArtistBaseDC",{dc:20}),{check,failure:check<20,possible:check>=20}));break;case"han":tags.push(new Tag(i18n.get("LittleHelper.CardHints.HandleAnimalBaseDC",{dc:10}),{check,failure:check<10,possible:check>=10}));break;case"hea":tags.push(new Tag(i18n.get("LittleHelper.CardHints.HealCommonDC",{dc:15}),{check,success:check>=15,possible:check>=13&&check<15,failure:check<13}),new Tag(i18n.get("LittleHelper.CardHints.HealDeadlyDC",{dc:20}),{hint:"LittleHelper.CardHints.HealDeadlyDCHint",check,success:check>=24,possible:check>=18&&check<23,failure:check<18}));break;case"rid":tags.push(new Tag(i18n.get("LittleHelper.CardHints.RideFastMountDC",{dc:20}),{check,failure:check<20,success:check>=20}));break;case"sen":tags.push(new Tag(i18n.get("LittleHelper.Checks.BaseDC",{dc:20}),{check,failure:check<20,possible:check>=20}),new Tag(i18n.get("LittleHelper.CardHints.OpposedBy",{skill:getSkillName("blf")})));break;case"slt":tags.push(new Tag(i18n.get("LittleHelper.CardHints.PalmDC",{dc:20}),{check,failure:check<10,possible:check>=10}),new Tag(i18n.get("LittleHelper.CardHints.StealDC",{dc:20}),{check,failure:check<20,possible:check>=20}),new Tag(i18n.get("LittleHelper.CardHints.OpposedBy",{skill:getSkillName("per")})));break;case"per":tags.push(new Tag(i18n.get("LittleHelper.CardHints.OpposedBy",{skill:getSkillName("ste")})),new Tag(i18n.get("LittleHelper.CardHints.OpposedBy",{skill:getSkillName("slt")})));break;case"ste":tags.push(new Tag(i18n.get("LittleHelper.CardHints.OpposedBy",{skill:getSkillName("per")})));break;case"sur":{tags.push(new Tag(i18n.get("LittleHelper.CardHints.SubsistDC",{dc:10}),{hint:"LittleHelper.CardHints.SubsistDCHint",check,failure:check<10,success:check>=10}));let count=Math.max(0,Math.floor((check-8)/2));tags.push(new Tag(i18n.get("LittleHelper.CardHints.SubsistFed",{count})));break}case"swm":{tags.push(new Tag(i18n.get("LittleHelper.Checks.BaseDC",{dc:10}),{check,failure:check<10,possible:check>=10}));let swm=actor?.system.attributes?.speed?.swim?.total??0,speed=swm;if(swm==0){let base=(actor?.system.attributes?.speed?.land?.total??0)/5;speed=Math.floor(base/4)*5}let[cspeed,unit]=pf1.utils.convertDistance(speed),lspeed=i18n.get("Koboldworks.Missing.PF1.Distance",{distance:cspeed,unit:pf1.config.measureUnitsShort[unit]||unit}),hint=swm>0?"LittleHelper.CardHints.NaturalSpeed":"LittleHelper.CardHints.SwimSpeedHint";tags.push(new Tag(i18n.get("LittleHelper.CardHints.SwimSpeed",{speed:lspeed}),{hint}));break}case"umd":{let rollData={check},formula="@check[Result] - 20[Base DC]",roll=RollPF.safeRollSync("@check[Result] - 20[Base DC]",rollData),enriched=enrichRoll(roll,"@check[Result] - 20[Base DC]",roll.total,rollData).outerHTML;tags.push(new Tag(i18n.get("LittleHelper.CardHints.UMDWandDC",{dc:20}),{check,failure:check<20,possible:check>=20}),new Tag(i18n.get("LittleHelper.CardHints.UMDScrollMaxLevel",{level:enriched}),{hint:"LittleHelper.CardHints.UMDScrollMaxLevelHint",check,possible:check>=20,failure:check<20,success:check>=29}));break}case"kar":case"kdu":case"ken":case"kge":case"khi":case"klo":case"kna":case"kno":case"kpl":case"kre":if(!trained)tags.push(new Tag(i18n.get("LittleHelper.CardHints.UntrainedKnowledgeMaxDC",{dc:10}),{hint:"LittleHelper.CardHints.CommonKnowledgeHint",check,success:check>=10,failure:check<5,possible:check<10&&check>=5}));if(rank!==0)tags.push(new Tag(i18n.get("LittleHelper.CardHints.KnowledgeBaseDC",{dc:15}),{hint:"LittleHelper.CardHints.KnowledgeBaseDCHint",check,failure:check<15,possible:check>=15&&check<33,success:check>=33}));break;case void 0:break;default:break}}function handleAbilityCheck({abilityId,tags,check,cm,actor}={}){switch(abilityId){case"str":tags.push(new Tag(i18n.get("LittleHelper.Checks.BaseDC",{dc:5}),{check,failure:check<5,possible:check>=5}),new Tag(i18n.get("LittleHelper.CardHints.DoorDC"),{hint:"LittleHelper.CardHints.DoorDC",check,possible:check<30,success:check>=30,failure:check<0}));break;case"dex":tags.push(new Tag(i18n.get("LittleHelper.Checks.BaseDC",{dc:5}),{check,failure:check<5,possible:check>=5}));break;case"con":{tags.push(new Tag(i18n.get("LittleHelper.Checks.BaseDC",{dc:5}),{check,failure:check<5,possible:check>=5}));let actor2=ChatMessage.getSpeakerActor(cm.speaker);if(!actor2)return;let hp=actor2.system.attributes?.hp;if(hp.value+hp.temp<0){let rollData={attributes:{hp}},formula="10[Base] - (@attributes.hp.value + @attributes.hp.temp)[Effective HP]",roll=RollPF.safeRollSync("10[Base] - (@attributes.hp.value + @attributes.hp.temp)[Effective HP]",rollData),dc=roll.total,enriched=enrichRoll(roll,"10[Base] - (@attributes.hp.value + @attributes.hp.temp)[Effective HP]",roll.total,rollData).outerHTML;tags.push(new Tag(i18n.get("LittleHelper.CardHints.StabilizeDC")+" "+enriched,{check,failure:dc>check,success:dc<=check}))}else{let b=actor2.system.conditions.bleed;tags.push(new Tag(i18n.get("PF1.Condition.stable"),{check,success:!b,possible:b}))}break}case"int":tags.push(new Tag(i18n.get("LittleHelper.Checks.BaseDC",{dc:5}),{check,failure:check<5,possible:check>=5}));break;case"wis":tags.push(new Tag(i18n.get("LittleHelper.Checks.BaseDC",{dc:5}),{check,failure:check<5,possible:check>=5}));break;case"cha":tags.push(new Tag(i18n.get("LittleHelper.Checks.BaseDC",{dc:10}),{check,failure:check<10,possible:check>=10}));break}}function handleOtherCheck({otherId,tags,check,cm,actor}={}){switch(otherId){case"concentration":{let rollData={check},formulaDefensiveCasting="floor((@check[Result] - 15[Base DC]) / 2)",formulaEntangledCasting="floor(@check[Result] - 15[Base DC])",defensiveRoll=RollPF.safeRollSync("floor((@check[Result] - 15[Base DC]) / 2)",rollData),entangledRoll=RollPF.safeRollSync("floor(@check[Result] - 15[Base DC])",rollData),enrichedDef=enrichRoll(defensiveRoll,"floor((@check[Result] - 15[Base DC]) / 2)",defensiveRoll.total,rollData).outerHTML,enrichedEtgl=enrichRoll(entangledRoll,"floor(@check[Result] - 15[Base DC])",entangledRoll.total,rollData).outerHTML;tags.push(new Tag(i18n.get("LittleHelper.Checks.Other.concentration.DefensiveMaxSL",{level:enrichedDef}),{hint:"DC 15+SL×2",check,failure:check<15,possible:check>=15,success:check>33}),new Tag(i18n.get("LittleHelper.Checks.Other.concentration.DamagedDC"),{hint:"LittleHelper.CardHints.ContinuousDamageHint",check,failure:check<10,possible:check>=10}),new Tag(i18n.get("LittleHelper.Checks.Other.concentration.GrappledDC"),{check,failure:check<10,possible:check>=10}),new Tag(i18n.get("LittleHelper.Checks.Other.concentration.EntangledMaxSL",{level:enrichedEtgl}),{hint:"LittleHelper.Checks.Other.concentration.EntangledMaxSLHint",check,failure:check<15,possible:check>=15,success:check>=24}));break}case void 0:break}}function handleSaveCheck({saveId,tags,check,cm,actor}){switch(saveId){case"ref":case"will":case"fort":tags.push(new Tag(i18n.get("LittleHelper.Checks.BaseDC",{dc:10}),{check,failure:check<10,possible:check>=10}));break;case void 0:break}}function handleCheckMessages(cm,html,options,shared){if(!canViewChatMessage(cm,shared.user))return;let subject=cm.system.subject;if(!subject)return;let actor=ChatMessage.getSpeakerActor(cm.speaker),roll=cm.rolls[0],check=roll?roll.total:0,tags=[],skillId=subject.skill,abilityId=subject.ability,saveId=subject.save,otherId=subject.core;if(skillId)handleSkillCheck({skillId,tags,check,cm,actor});if(abilityId)handleAbilityCheck({abilityId,tags,check,cm,actor});if(saveId)handleSaveCheck({saveId,tags,check,cm,actor});if(otherId)handleOtherCheck({otherId,tags,check,cm,actor});if(Hooks.call("little-helper.checks.hints",tags,{subject,cm,roll,result:check,element:html,cls:Tag}),tags.length>0)appendCustomTags(html,tags)}function enable7(){return Ancillary.register("chat",handleCheckMessages),!1}function disable7(){return Ancillary.unregister("chat",handleCheckMessages),!1}new Feature({setting:"card-hints",category:"chat-card",enable:enable7,disable:disable7,stage:"init",stream:!0});init_common();function enhanceAttackRoll(el,roll,total){let rolls=roll.dice.length===1?roll.dice.map((d)=>`${d.values.join(", ")}`):[`${roll.terms[0].total}`],diceTotal=roll.dice.length===1?roll.dice.reduce((a,r)=>a+r.total,0):roll.terms[0].total,hasDice=roll.dice.length>0,bonus=roll.total-diceTotal;if(hasDice){let rollEl=createNode("span",rolls.join("+"),["lil-roll","roll","die","d20"]),bonusEl=createNode("span",signNum(bonus),["lil-bonus"]),totalEl=createNode("span",total,["lil-total"]);el.append(rollEl,bonusEl,createNode("span","⇒",["lil-arrow"]),totalEl)}else{let rollEl=createNode("span","?",["lil-roll","roll","die","d20"]),bonusEl=createNode("span","+?",["lil-bonus"]),totalEl=createNode("span",total,["lil-total"]);el.append(rollEl,bonusEl,createNode("span","⇒",["lil-arrow"]),totalEl)}el.classList.add("lil-enhanced-roll")}function attackRollEnricher(cm,html){if(!cm.isContentVisible)return;if(!(cm.system?.rolls?.attacks?.length>0))return;if(!canViewChatMessage(cm))return;let ir=html.querySelectorAll(".chat-attack td[colspan] .inline-roll.inline-result[data-roll]");for(let irEl of ir){if(irEl.classList.contains("defense-dc"))return;try{irEl.classList.add("lil-expanded-inline-roll","lil-roll-restyle");let faIcon=irEl.firstElementChild,faText=faIcon?.nextSibling;if(!faText)continue;enhanceAttackRoll(irEl,Roll.fromJSON(unescape(irEl.dataset.roll)),faText.textContent?.trim()),faIcon.remove(),faText.remove()}catch(err){console.error(err)}}}function enable8(){Ancillary.register("chat",attackRollEnricher)}function disable8(){Ancillary.unregister("chat",attackRollEnricher)}new Feature({setting:"attack-roll-enhancer",label:"Enrich Attack Rolls",hint:"Enriches display of attack rolls.",category:"chat-card",enable:enable8,disable:disable8,stage:"init",stream:!0});function enhanceInlineRoll(el,roll){if(el.classList.add("lil-roll-restyle"),roll.dice.length===0){el.classList.add("diceless");return}let tMin=0,tMax=0,tRatio=0,dice=0;for(let d of roll.dice){let min=0,max=0,ratio=0;for(let r of d.results){if(!r.active)continue;if(dice++,r.result==1)min++;else if(r.result==d.faces)max++;ratio+=r.result}let pMin=dice,pMax=d.number*d.faces,pAvg=Math.floor((pMax+pMin)/2*10)/10;ratio/=dice,ratio=Math.floor(ratio/d.faces*1000)/1000,tMin+=min,tMax+=max,tRatio+=ratio}if(tRatio=Math.floor(tRatio/roll.dice.length*100)/100,tMin>0)el.classList.add("has-min-roll");if(tMax>0)el.classList.add("has-max-roll");if(tMin===dice)el.classList.add("minimum-roll");if(tMax===dice)el.classList.add("maximum-roll");if(tRatio>0.9)el.classList.add("great-roll");if(tRatio>0.75)el.classList.add("good-roll");else if(tRatio>0.5)el.classList.add("decent-roll");if(tRatio<0.1)el.classList.add("horrible-roll");if(tRatio<0.25)el.classList.add("bad-roll");else if(tRatio<0.5)el.classList.add("poor-roll");if(tRatio<0.6&&tRatio>0.4)el.classList.add("middling-roll");el.dataset.rollGrade=Math.round(tRatio*10);let firstTerm=roll.terms[0];if(firstTerm.constructor.name==="Die"){let results=firstTerm.results.filter((r)=>r.active);if(results.length===1){let natural=results[0].result;el.dataset.rollNatural=natural}}}function inlineRollEnricher(cm,html){for(let el of html.querySelectorAll("a.inline-roll.inline-result")){let rollString=unescape(el.dataset.roll);if(!el.dataset.roll)continue;let json=JSON.parse(rollString);if(!json)return;try{enhanceInlineRoll(el,Roll.fromData(json))}catch(err){console.error({json,element:el,message:cm},err)}}}function enable9(){Ancillary.register("chat",inlineRollEnricher)}function disable9(){Ancillary.unregister("chat",inlineRollEnricher)}new Feature({setting:"inline-roll-grading",label:"Inline Roll Grading",hint:"Grades inline rolls with how well or poorly they went.",category:"chat-card",enable:enable9,disable:disable9,stage:"init",stream:!0});function meldDamageRolls(cm,html){let{itemSource:item,system:metadata}=cm;if(!metadata)return;if(!(metadata.rolls?.attacks?.[0]?.damage?.[0]!==void 0||item?.hasDamage))return;for(let tr of html.querySelectorAll(".chat-attack tr"))for(let[index,el]of tr.querySelectorAll("td").entries()){if((index+1)%2===0)continue;if(el.colSpan>1)continue;let ir=el.querySelector(".inline-roll,span"),next=el.nextElementSibling;if(ir){if(ir.classList.add("lil-melded-roll"),el.classList.add("lil-melded-type"),next){let noType=next.textContent.length===0;if(el.append(" ",...el.nextElementSibling.childNodes),el.colSpan=2,noType)el.append(i18n.get("PF1.Unknown"))}}else if(el.textContent===""&&next.textContent==="")el.colSpan=2;next?.remove()}}function enable10(){Ancillary.register("chat",meldDamageRolls,{priority:-100})}function disable10(){return Ancillary.unregister("chat",meldDamageRolls),!1}new Feature({setting:"card-damage-melding",label:"Meld Damage & Type",hint:"Combines damage and type into single cell.",category:"chat-card",enable:enable10,disable:disable10,stage:"init",stream:!0});init_config();function scrollToEnd(){let log=document.getElementById("chat-log");if(!log)return;let position=log.clientHeight+log.scrollTop,target=log.scrollHeight;if(position==target)return;let C=CFG.console.colors;console.log(`%cLittle Helper%c \uD83E\uDD8E | Scrolling from %c${position}%c to %c${target}%c`,C.main,C.unset,C.number,C.unset,C.number,C.unset),log.scrollTo(0,target)}Hooks.once("ready",()=>setTimeout(scrollToEnd,1000));init_config();async function cardDamageSanityCheck(wrapped,value,options={}){let msg=options.message;if(!(msg instanceof ChatMessage))return wrapped(value,options);let trueTargets=msg.system?.targets?.map((id)=>canvas.scene?.tokens.get(id)??fromUuidSync(id))??[];if(trueTargets.length===0)return wrapped(value,options);let selected=canvas.tokens.controlled.map((t)=>t.document),notInTargets=selected.filter((t)=>!trueTargets.includes(t));if(notInTargets.length>0){let targets=notInTargets.map((t)=>({token:t,targeted:!1,selected:!0})),actualTargets=trueTargets.map((t)=>({token:t,targeted:!0,selected:selected.includes(t)})),templateData={targets,included:actualTargets.filter((t)=>t.selected),excluded:actualTargets.filter((t)=>!t.selected)},rt=foundry.applications.handlebars.renderTemplate;if(await foundry.applications.api.DialogV2.confirm({window:{title:i18n.get("LittleHelper.Untargeted.Title")},content:await rt(`modules/${CFG.id}/templates/dialog/target-validation.hbs`,templateData),classes:["lil-target-sanity-check"]})!==!0)return!1}return wrapped(value,options)}var enable11=()=>{if(pf1.utils.chat?.onButton)libWrapper.register(CFG.id,"pf1.documents.actor.ActorPF.applyDamage",cardDamageSanityCheck,libWrapper.MIXED)},disable11=()=>{if(pf1.utils.chat?.onButton)libWrapper.unregister(CFG.id,"pf1.documents.actor.ActorPF.applyDamage")};new Feature({setting:"apply-damage-sanity",label:"Apply Damage Sanity Checks",hint:"Perform minor sanity check on applying damage by checking your selected tokens are among targets. If discrepancies are found, confirmation dialog is displayed.",category:"chat-card",enable:enable11,disable:disable11,stage:"init"});init_common();class TabData{tab;constructor(tab){this.tab=tab}}var systemSheets=new Set;function detectSheets(){for(let data of Object.values(CONFIG.Actor.sheetClasses.character))if(data.id.startsWith("pf1."))systemSheets.add(data.cls.name);for(let data of Object.values(CONFIG.Actor.sheetClasses.npc))if(data.id.startsWith("pf1."))systemSheets.add(data.cls.name);for(let types of Object.values(CONFIG.Item.sheetClasses))for(let data of Object.values(types))if(data.id.startsWith("pf1."))systemSheets.add(data.cls.name);for(let sheet of Object.values(pf1.applications.component))systemSheets.add(sheet.name)}function initSharedDocData(sheet,html,_opts,shared){let sheetClass=sheet.constructor.name;if(shared.sysSheet=systemSheets.has(sheetClass),shared.coreSheet=sheet.document instanceof Actor?["ActorSheetPFCharacter","ActorSheetPFNPC"].includes(sheetClass):shared.sysSheet,!shared.sysSheet)shared.altSheetZenvy=sheet.options.classes.includes("pf1alt");for(let tab of html.querySelectorAll("section .tab[data-tab]"))shared.tabs[tab.dataset.tab]=new TabData(tab)}function initSharedActorData(sheet,html,_opts,shared){if(html instanceof jQuery)html=html[0];let spellbook=shared.tabs.spellbook;if(spellbook?.tab)Object.defineProperty(spellbook,"tabs",{_spellbooks:void 0,get:function(){if(!this._spellbooks){if(this._spellbooks=this.tab.querySelectorAll('.tab[data-group="spellbooks"]'),!this._spellbooks)return;if(this._spellbooks)for(let tab of this._spellbooks)for(let node of tab.querySelectorAll(".spellbook-header"))node.querySelector(".item-name")?.append(createNode("div",void 0,["lil-spell-details","lil-right-justify"]))}return this._spellbooks}});let summary=shared.tabs.summary;if(summary?.tab)Object.defineProperty(summary,"attributes",{_attributes:void 0,get:function(){return this._attributes??=this.tab?.querySelector(".attributes"),this._attributes}})}Ancillary.register("actor",initSharedDocData,{priority:1100});Ancillary.register("item",initSharedDocData,{priority:1100});Ancillary.register("action",initSharedDocData,{priority:1100});Ancillary.register("actor",initSharedActorData,{priority:1000});Hooks.once("ready",detectSheets);init_config();class ActorOverrideConfig extends foundry.applications.api.HandlebarsApplicationMixin(foundry.applications.api.DocumentSheetV2){get title(){return i18n.get("LittleHelper.Settings.ActorOverridesTitle")+` – ${this.actor.name}`}get actor(){return this.document}static DEFAULT_OPTIONS={tag:"form",classes:["little-helper","lil-overrides-config"],form:{handler:this._onSubmit,submitOnChange:!0},window:{icon:"fa-solid fa-screwdriver-wrench",height:"auto",width:"auto"},sheetConfig:!1};static PARTS={form:{template:`modules/${CFG.id}/templates/actor-config.hbs`}};_initializeApplicationOptions(options){return options=super._initializeApplicationOptions(options),options.uniqueId=`app-lh-overrides-${options.document.uuid}`,options}_prepareContext(){let api=CFG.API,keys=["new-actor-guide","missing-bits","excess-skill-ranks","duplicate-slots"];return{id:CFG.id,flags:this.actor.getFlag(CFG.id,"overrides"),features:Object.fromEntries(keys.map((key)=>[key,api.features.get(key).enabled]))}}static async open(ev,actor,options={}){ev.preventDefault();let el=ev.target,{bottom,right}=el.getBoundingClientRect();options.document=actor;let app=Object.values(ui.windows).find((app2)=>app2 instanceof ActorOverrideConfig&&app2.document===actor)??new this(options);return app.render({position:{top:bottom+6,left:right-320},force:!0,focus:!0}),app}static async _onSubmit(event2,form,formData){this._toggleDisabled?.(!0),formData=foundry.utils.expandObject(formData.object);let update=await this.document.update(formData);if(foundry.utils.isEmpty(update))this._toggleDisabled?.(!1)}}async function injectActorSetup(sheet,html,options,shared){if(html instanceof jQuery)html=html[0];let tab=shared.tabs.settings?.tab;if(!tab)return void console.debug("Little Helper | Actor Config | Settings tab not found");let buttons=tab.querySelector(".base-setup .pointbuy-calculator")?.parentElement;if(!buttons)return void console.debug("Little Helper | Actor Config | Buttons not found!");let acb=document.createElement("button");acb.classList.add("lil-overrides-config"),acb.type="button",acb.innerHTML=i18n.get("LittleHelper.Settings.ActorOverridesButton"),acb.addEventListener("click",(ev)=>ActorOverrideConfig.open(ev,sheet.actor)),buttons?.append(acb)}Ancillary.register("actor",injectActorSetup);init_common();function enrichCreatureTypeInfo(sheet,html,options,shared){if(!shared.coreSheet)return;let tab=shared.tabs.attributes?.tab;if(!tab)return;let qr=tab.querySelector('input[name="system.attributes.quadruped"]'),actor=sheet.actor,humtoggle=createNode("input");if(humtoggle.type="checkbox",humtoggle.readOnly=!0,humtoggle.disabled=!0,humtoggle.checked=actor.system.traits?.humanoid??!1,!actor.race)humtoggle.indeterminate=!0;let hum=createNode("div",null,["form-group"],{children:[createNode("label",i18n.get("PF1.CreatureTypes.humanoid")),createNode("label",null,["checkbox"],{children:[humtoggle]})]});qr.parentElement?.parentElement.after(hum)}function enable12(){Ancillary.register("actor",enrichCreatureTypeInfo)}function disable12(){Ancillary.unregister("actor",enrichCreatureTypeInfo)}new Feature({setting:"creature-type-info",category:"actor-sheet",enable:enable12,disable:disable12,stage:"ready"});init_common();init_common();var timeTransform=(t,unit)=>{switch(unit){case"round":case"rounds":return t*CONFIG.time.roundTime;case"hour":case"hours":return t*60*60;case"minute":case"minutes":return t*60;case"turn":case"turns":return t*CONFIG.time.roundTime;case"second":case"seconds":case"sec":return t}},humanTimeUnit={r:{short:"rnd(s)",long:"round(s)"},m:{short:"min(s)",long:"minute(s)"},h:{short:"hr(s)",long:"hour(s)"},d:{short:"d(s)",long:"day(s)"},w:{short:"w(s)",long:"week(s)"},mo:{short:"mo(s)",long:"month(s)"},y:{short:"y(s)",long:"year(s)"}},TIME={MINUTE:60,HOUR:3600,DAY:86400,WEEK:604800,MONTH:2592000,YEAR:31536000},getHumanTime=(t)=>{let num,unit,ta=Math.abs(t);if(ta<CONFIG.time.roundTime*15)num=Math.floor(t/CONFIG.time.roundTime),unit="r";else if(ta<TIME.HOUR*2)num=maxPrecision(t/TIME.MINUTE,2),unit="m";else if(ta<TIME.DAY*1.3)num=maxPrecision(t/TIME.HOUR,2),unit="h";else if(ta<TIME.DAY*14)num=maxPrecision(t/TIME.DAY,2),unit="d";else if(ta<TIME.DAY*60)num=maxPrecision(t/TIME.WEEK,2),unit="w";else if(ta<TIME.YEAR)num=maxPrecision(t/TIME.MONTH,2),unit="mo";else num=maxPrecision(t/TIME.YEAR,2),unit="y";return{n:num,u:unit}};class Duration{start=0;duration=0;offset=0;get world(){return game.time.worldTime+this.offset}get remaining(){return this.start+this.duration-this.world}get passed(){return this.world-this.start}effect;item;constructor(start,duration,{activeEffect,item,offset}={}){if(this.start=start??0,this.duration=duration??0,this.offset=offset??0,this.effect=activeEffect??void 0,this.item=item??void 0,!item&&activeEffect.parent instanceof Item)this.item=activeEffect.parent}}var getAEDuration=(ae,{offset=0}={})=>{let dur=ae?.duration;if(!dur)return;return new Duration(dur.startTime,dur.seconds,{activeEffect:ae,offset})},getTimeFromItem=(item,rollData)=>{let actor=item?.actor,ae=actor?getRelevantAE(actor,{item}):void 0;if(ae)return getAEDuration(ae);let dur=item.system.duration,roll=RollPF.safeRollSync(dur.value,rollData??item.getRollData(),void 0,void 0,{minimize:!0}),value;if(roll.isDeterministic)value=roll.total;else value=pf1.utils.formula.simplify(roll.formula);return new Duration(dur.start,timeTransform(value,dur.units),{item})};var openSheets={};function addDurationDisplay(el,ae,time){let{n,u}=getHumanTime(time),text=`${n} ${humanTimeUnit[u].short}`;return el??=createNode("i",void 0,["lil-condition-duration"]),el.innerHTML=text,el}function initializeConditionDurations(sheet,html,options,shared){let actor=sheet.actor;if(actor.statuses.size===0){delete openSheets[sheet.appId];return}let wt=game.time.worldTime;openSheets[sheet.appId]=sheet;let statusAEs={};for(let ae of actor.allApplicableEffects()){if(!ae.active)continue;for(let status of ae.statuses)statusAEs[status]??=[],statusAEs[status].push(ae)}for(let el of shared.tabs.buffs?.tab?.querySelectorAll(".buffs-conditions .condition.active a[data-condition-id]")??[]){let statusId=el.dataset.conditionId,aes=statusAEs[statusId];if(!(aes?.length>0))continue;aes.sort((a,b)=>(a.duration?.startTime??-1/0)-(b.duration?.startTime??-1/0));let ae=aes[0],nel=addDurationDisplay(void 0,ae,Math.floor(wt-ae.duration.startTime));el.append(nel),el.classList.add("lil-stretched-condition")}}function closeActorSheet(sheet){delete openSheets[sheet.appId]}function refreshSheetDurations(wt,_delta){for(let sheet of Object.values(openSheets)){let conds=sheet.element?.[0].querySelector('.tab.buffs[data-tab="buffs"] .buffs-conditions');if(!conds)continue;let actor=sheet.actor,statusAEs={};for(let ae of actor.allApplicableEffects())for(let status of ae.statuses)statusAEs[status]??=[],statusAEs[status].push(ae);for(let el of conds.querySelectorAll(".buffs-conditions .condition.active a[data-condition-id]")){let dEl=el.querySelector(".lil-condition-duration");if(!dEl)continue;let statusId=el.dataset.conditionId,aes=statusAEs[statusId];if(!(aes?.length>0))continue;aes.sort((a,b)=>(a.duration?.startTime??-1/0)-(b.duration?.startTime??-1/0));let ae=aes[0];addDurationDisplay(dEl,ae,wt-ae.duration.startTime)}}}function enable13(){Ancillary.register("actor",initializeConditionDurations),Hooks.on("closeActorSheet",closeActorSheet),Hooks.on("updateWorldTime",refreshSheetDurations)}function disable13(){Ancillary.unregister("actor",initializeConditionDurations),Hooks.off("closeActorSheet",closeActorSheet),Hooks.off("updateWorldTime",refreshSheetDurations);for(let k of Object.keys(openSheets))delete openSheets[k]}new Feature({setting:"actor-sheet-condition-durations",category:"actor-sheet",enable:enable13,disable:disable13,stage:"ready"});init_common();var getTimeStr=(sdur)=>{let{n,u}=getHumanTime(sdur);return`${n} ${humanTimeUnit[u].long}`},activateDurationTooltip=async(el,buff)=>{let fragment=document.createDocumentFragment(),dur=getTimeFromItem(buff),durStr=getTimeStr(dur?.duration??0),remStr=getTimeStr(dur?.remaining??0),pasStr=getTimeStr(dur?.passed??0);fragment.append(createNode("label","Active:"),createNode("span",pasStr,["active","value"]),createNode("label","Remaining:"),createNode("span",remStr,["remaining","value"]),createNode("label","Max duration:"),createNode("span",durStr,["duration","value"]));let tm=CONFIG.ux.TooltipManager,tooltip={html:fragment,cssClass:"pf1 lil-duration-tooltip",direction:tm.TOOLTIP_DIRECTIONS.LEFT};game.tooltip.activate(el,tooltip)};function addBuffDurationTooltips(sheet,html,options,shared){let tab=shared.tabs.buffs?.tab;if(!tab)return;let actor=sheet.actor;if((actor.itemTypes.buff?.filter((i)=>i.isActive)??[]).length===0)return;for(let el of tab.querySelectorAll("li.item[data-item-id]")){let itemId=el.dataset.itemId,buff=actor.items.get(itemId);if(!buff?.isActive)continue;let durEl=el.querySelector(".item-detail.item-duration");if(!durEl)continue;durEl.addEventListener("pointerenter",(_)=>activateDurationTooltip(durEl,buff),{passive:!0}),durEl.addEventListener("pointerleave",()=>game.tooltip.deactivate())}}function enable14(){Ancillary.register("actor",addBuffDurationTooltips)}function disable14(){Ancillary.unregister("actor",addBuffDurationTooltips)}new Feature({setting:"buff-tooltips",category:"actor-sheet",enable:enable14,disable:disable14,stage:"ready"});init_config();init_common();function addConditionTooltips(sheet,html,options,shared){let conds=shared.tabs.buffs?.tab?.querySelector(".buffs-conditions");if(!conds)return;let ConditionHelp2=CFG.i18n.conditions,fillTooltip=async(tip,condition)=>tip.innerHTML=ConditionHelp2[condition]??i18n.get("LittleHelper.Conditions._missing");for(let el of conds.querySelectorAll(".condition [data-condition-id]")){let condition=el.dataset.conditionId,tip=createNode("div",null,["lil-tooltip"]),p=el.parentElement;p.append(tip),p?.addEventListener("pointerenter",(_)=>fillTooltip(tip,condition),{passive:!0,once:!0}),setStaticToolTipListener(p,tip,{aligned:!0,boundedBy:conds})}}function enable15(){Ancillary.register("actor",addConditionTooltips)}function disable15(){Ancillary.unregister("actor",addConditionTooltips)}new Feature({setting:"actor-condition-tooltips",label:"Condition Tooltips",hint:"Display tooltips describing effects of a conditon in buffs tab.",category:"actor-sheet",enable:enable15,disable:disable15,stage:"ready"});init_common();function attackDetailsInjection(sheet,html,_options,shared){let actor=sheet.actor;if(shared.rollData.shield.type<=1)return;let tab=shared.tabs.combat?.tab;if(!tab)return;let items=tab?.querySelectorAll(".item[data-item-id]");if(!items)return;for(let node of items){let item=actor.items.get(node.dataset.itemId);if(!item)continue;if(item.system.held!=="2h")continue;node.classList.add("lil-awkward-shield");let name=node.querySelector(".item-name");if(!name)continue;let twohanded=createNode("i",void 0,["fa-solid","fa-sign-language","lil-icon","right-floater","hands-of-effort"]);addCoreTooltip(twohanded,"LittleHelper.Warning.NoShieldWithTwohanded"),name.append(twohanded)}}Ancillary.register("actor",attackDetailsInjection);init_common();function showThacoh(sheet,html,_options,shared){let actor=shared.actor;if(!["character","npc"].includes(actor.type))return;let acEl=html.querySelector("section > .tab.combat .combat-defenses .ac-normal");if(!acEl)return;let bab=actor.type=="character"?actor.system.attributes?.hd?.total:Math.min(Math.floor(actor.system.details?.cr?.total*0.9),20),abilities=actor.system.abilities,abl=Math.max(...Object.values(abilities).map((a)=>a.mod)),feats=1+(bab>6?1:0),wt=clampNum(Math.floor((bab-1)/4),0,4),enh=clampNum(Math.floor((bab-2)/3),0,5);if(bab>1&&enh==0)enh+=1;let ac=actor.system.attributes.ac.normal.total,buffs=0;buffs+=clampNum(Math.floor((bab+4)/5),0,4);let hitTotal=bab+abl+enh+wt+feats+buffs,formula=`+${bab}[BAB] +${abl}[Abl] +${enh}[Enh]<br>+${wt}[WT] +${feats}[Feats] +${buffs}[Buffs]<br>= <span class="value">+${hitTotal} to-hit</span>`,minRoll=clampNum(ac-hitTotal,1,20),el=createNode("span",` ${minRoll}+`,["lil-thacoh"]),die=createNode("i",null,["fa-solid","fa-dice-d20"]);el.prepend(die),el.dataset.tooltip=i18n.get("LittleHelper.Info.Thacoh")+"<br>"+formula,el.dataset.tooltipClass="pf1 lil-tooltip",acEl.append(el)}function enable16(){Ancillary.register("actor",showThacoh)}function disable16(){Ancillary.unregister("actor",showThacoh)}new Feature({setting:"actor-thacoh",label:"To Hit AC",hint:"Display estimation of high likely you're to be hit on combat tab.",category:"actor-sheet",enable:enable16,disable:disable16,stage:"ready"});init_config();init_common();async function fillDetailsTab(content,actor){let C=CFG.console.colors;console.debug(`%cLittle Helper%c \uD83E\uDD8E | Rendering details tab on-demand for %c${actor.name}%c [%c${actor.id}%c]`,C.main,C.unset,C.label,C.unset,C.id,C.unset),await Promise.resolve().then(() => (init__init(),exports__init));let shared=new SharedData(game.user,actor);Hooks.call("little-helper.details-tab.content",content,shared)}function insertDetailsTab(sheet,html){if(/Loot/.test(sheet.constructor.name))return;let content=createNode("div",void 0,["tab","lil-details-content"]);content.dataset.group="primary",content.dataset.tab="lil-details";let navbutton=createNode("a",void 0,["item","lil-sheet-tab"]);navbutton.dataset.tab="lil-details";let icon=createNode("i",void 0,["far","fa-file-alt"]);navbutton.append(icon);let shc=html.querySelector("section.primary-body"),nav=html.querySelector('nav.sheet-navigation.tabs[data-group="primary"]');if(!shc||!nav)return;shc.append(content),nav.append(navbutton),navbutton.addEventListener("click",()=>fillDetailsTab(content,sheet.actor),{passive:!0,once:!0})}function enable17(){Ancillary.register("actor",insertDetailsTab)}function disable17(){Ancillary.unregister("actor",insertDetailsTab)}new Feature({setting:"details-tab",label:"Details Tab",hint:"Add extra tab with random extra details.",category:"actor-sheet",enable:enable17,disable:disable17,stage:"ready"});init_common();function addFeatCount(parentEl,count,typed){let name=parentEl.querySelector(".item-list-header .item-name"),rjust=createNode("div",null,["lil-right-justify"]),iCount=createNode("label",i18n.get("LittleHelper.Count")+`: ${Math.max(0,count)}`,["lil-box","lil-feats-possessed"]);rjust.append(iCount),name.append(rjust)}function addSpellCount(parentEl,count,level){let actualCount=Math.max(0,count),pageCount=level>=0?actualCount*Math.max(1,level):null,tooltip=level>=0?i18n.get("LittleHelper.PageCount")+`: ${pageCount}`:void 0;parentEl.querySelector(".lil-spell-details").append(createNode("label",i18n.get("LittleHelper.Known")+`: ${actualCount}`,["lil-box","lil-spells-known"],{tooltip}))}function itemCountInjector(_sheet,_jq,_opts,shared){let typed=shared.items.byType,spells=typed.spell,spellTabs=shared.tabs.spellbook?.tabs??[];for(let tab of spellTabs){if(!spells)return;if(spells.all.length===0)continue;let bookId=tab.dataset.tab,book=spells._book?.[bookId];if(!book)continue;for(let ol of tab.querySelectorAll(".item-list[data-level]")){let level=ol.dataset.level,spellCount=book[level]?.length??0;addSpellCount(ol,spellCount,level)}}for(let ol of shared.tabs.feats?.tab?.querySelectorAll("ol.item-list[data-type]")??[]){let type=ol.dataset.type,subtype=ol.dataset.subtype,count=typed[type][subtype]?.all?.length??0;addFeatCount(ol,count,typed)}}Ancillary.register("actor",itemCountInjector);init_config();init_common();function calculateSkills(actor,rollData){let result={},useBGSkills=game.settings.get("pf1","allowBackgroundSkills"),abilities=actor.system.abilities,isMindless=abilities?.int?.value===null,intMod=isMindless?0:abilities?.int?.mod??0,ranks={allowed:0,used:0,bgAllowed:0,bgUsed:0,transferred:0};for(let sklId of actor.allSkills){let skill=actor.getSkillInfo(sklId,{rollData});if(skill.background&&useBGSkills)ranks.bgUsed+=skill.rank||0;else ranks.used+=skill.rank||0}let bgSkillClasses=new Set(pf1.config.backgroundSkillClasses);for(let cls of actor.itemTypes.class.filter((cls2)=>cls2.system.subType!=="mythic")){if(pf1.config.favoredClassTypes.includes(cls.subType))ranks.allowed+=cls.system.fc?.skill?.value||0;if(isMindless)continue;let hd=cls.hitDice;if(hd===0)continue;let perLevel=cls.system.skillsPerLevel||0;if(ranks.allowed+=Math.max(1,perLevel+intMod)*hd,useBGSkills&&bgSkillClasses.has(cls.subType)){let bgRanks=hd*pf1.config.backgroundSkillsPerLevel;if(bgRanks>0)ranks.bgAllowed+=bgRanks}}if(ranks.allowed+=actor.system.details?.skills?.bonus||0,useBGSkills&&ranks.bgUsed>ranks.bgAllowed)ranks.transferred=ranks.bgUsed-ranks.bgAllowed,ranks.allowed-=ranks.transferred,ranks.bgAllowed+=ranks.transferred;return ranks}function newActorGuide(sheet,html,options,shared){if(!sheet.isEditable)return;if(sheet.actor.getFlag(CFG.id,"overrides")?.ready)return;if(!["ActorSheetPFCharacter","ActorSheetPFNPC"].includes(sheet.constructor.name))return;let actor=shared.actor;if(!["character","npc"].includes(actor.type))return;if(actor._newActor===!1)return;let abls=actor.system.abilities,undefinedAbilities=Object.values(abls).every((abl)=>abl.value===10),itemTypes=shared.items.byType,noClass=itemTypes.class?.all.length==0,noRace=itemTypes.race?.all.length==0,noEquipment=itemTypes.weapon?.all.length==0&&itemTypes.equipment?.all.length==0&&itemTypes.loot?.all.length==0&&itemTypes.container?.all.length==0&&itemTypes.consumable?.all.length==0,ranks=calculateSkills(actor,shared.rollData),noSkills=ranks.allowed!==ranks.used||ranks.bgAllowed!==ranks.bgUsed,classLevels=itemTypes.class?.all.filter((cls)=>["base","npc","prestige","racial"].includes(cls.subType)).reduce((cur,o)=>cur+o.hitDice,0),noFeats=Math.ceil(classLevels/2)>0?itemTypes.feat?.all.filter((f)=>f.subType==="feat").length==0:!1;if(!undefinedAbilities&&!noClass&&!noRace&&!noFeats&&!noEquipment&&!noSkills){console.debug("LH | Marking",actor.name,actor.id,"as finished."),actor._newActor=!1;return}let warningClass="lil-new-actor-warning",tabWarningClass="lil-new-actor-tab-warning",tabs=html.querySelector("nav.tabs"),form=html.querySelector("form")??html,haveWarning=form.querySelector("form > .warning")!=null;function addWarning2(text){if(haveWarning)return;haveWarning=!0,form.prepend(createNode("span",text,["warning","charactermancer"]))}let stab=shared.tabs.summary?.tab;if(noClass)stab.querySelector(".classes-body")?.classList.add(warningClass),tabs.querySelector('.item[data-tab="summary"]')?.classList.add(tabWarningClass);if(noRace)stab.querySelector(".race-container")?.classList.add(warningClass),tabs.querySelector('.item[data-tab="summary"]')?.classList.add(tabWarningClass),addWarning2("The character has no race. Go to Summary tab to fix this.");if(undefinedAbilities){let atab=shared.tabs.attributes?.tab;atab?.querySelector("button.pointbuy-calculator")?.classList.add(warningClass);for(let el of atab?.querySelector(".ability-scores")?.querySelectorAll("tr.ability > th + td")??[])el.classList.add(warningClass);tabs.querySelector('.item[data-tab="attributes"]')?.classList.add(tabWarningClass),addWarning2("The character has no ability scores set. Go to Attributes tab to fix this.")}if(noFeats)shared.tabs.feats.tab?.querySelector("ol.feats-feat")?.classList.add(warningClass,"unpadded"),tabs.querySelector('.item[data-tab="feats"]')?.classList.add(tabWarningClass),addWarning2("The character has no feats. Go to Features tab to fix this.");if(noSkills)tabs.querySelector('.item[data-tab="skills"]')?.classList.add(tabWarningClass),addWarning2("The character has not used all their skill ranks or has used too many. Go to Skills tab to fix this.");if(noEquipment)tabs.querySelector('.item[data-tab="inventory"]')?.classList.add(tabWarningClass),addWarning2("The character has no equipment. Go to Inventory tab to fix this.")}function enable18(){Ancillary.register("actor",newActorGuide)}function disable18(){Ancillary.unregister("actor",newActorGuide)}new Feature({setting:"new-actor-guide",category:"actor-sheet",enable:enable18,disable:disable18,stage:"ready"});init_common();function insertCoinWeightDisplay(sheet,html,opts,shared){let weight=sheet.actor._calculateCoinWeight();if(weight<Number.EPSILON)return;let{light}=sheet.actor.getCarryCapacity(),ratio=maxPrecision(weight/light,2),weightCSS="smart-weight";if(ratio>=0.5)weightCSS="heavy-weight";else if(ratio>=0.35)weightCSS="moderate-weight";else if(ratio>=0.2)weightCSS="light-weight";else if(ratio>=0.1)weightCSS="feather-weight";let label=shared.tabs.inventory?.tab?.querySelector(".currency h3");if(!label)return;let units=pf1.utils.getWeightSystem()==="metric"?i18n.get("PF1.Kgs"):i18n.get("PF1.Lbs"),weightLabel=createNode("label",`(${maxPrecision(weight,1)} ${units})`,["lil-currency-weight",weightCSS]);weightLabel.dataset.ratio=ratio,weightLabel.dataset.grade=Math.round(ratio*10),label?.append(weightLabel)}function enable19(){Ancillary.register("actor",insertCoinWeightDisplay)}function disable19(){Ancillary.unregister("actor",insertCoinWeightDisplay)}new Feature({setting:"currency-weight-display",category:"actor-sheet",enable:enable19,disable:disable19,stage:"ready"});init_config();init_common();function cloneSlots(slots){slots={...slots};for(let[key,slot]of Object.entries(slots))slots[key]=slot.clone();return slots}function groupItems(eq,getSlot){let all={};for(let item of eq){let slot=getSlot(item);if(slot!=null){if(all[slot]===void 0)all[slot]=[];all[slot].push(item)}}return all}function countSlotUsage(info,grouped){for(let key of Object.keys(info)){info[key]=info[key].clone();let value=info[key];if(grouped[key]===void 0)continue;value.count=grouped[key].length}}function markItems(section,info,actor,grouped,getSlot){let items=section.querySelectorAll(".item[data-item-id]");for(let el of items){let item=actor.items.get(el.dataset.itemId),slot=getSlot(item);if(info[slot]?.warn){if(!grouped[slot].some((i)=>i.id===item.id))continue;let st=el.querySelector(".item-slot"),soft=info[slot].soft;st.classList.add(soft?"lil-warning":"lil-error");let sel=st.firstElementChild||st,msg=i18n.get("LittleHelper.Warning.TooManySlotItems",{used:info[slot].count,limit:info[slot].limit});if(soft)msg+="<br>"+i18n.get("LittleHelper.Clarify.NoActionNeeded");sel.dataset.tooltip+="<br>"+msg}}}function notifyLackingUsage(el,info,labels){let unusedSlots=[];for(let[slot,sInfo]of Object.entries(info))if(Number.isFinite(sInfo.limit)&&sInfo.count<sInfo.limit)unusedSlots.push(slot);if(unusedSlots.length>0){let unusedMsg=i18n.get("LittleHelper.Warning.UnusedSlots")+": "+unusedSlots.map((s)=>labels[s]||s).sort((a,b)=>a.localeCompare(b,void 0,{sensitivity:"base"})).join(", "),holder=createNode("div",null,["lil-unused-slots"]);holder.append(createNode("i",null,["fa-solid","fa-info-circle","lil-info-symbol"]),unusedMsg),el.append(holder)}}function armorAndShieldConflicts(tab,actor){let eq=actor.itemTypes.equipment?.filter((i)=>i.isActive&&["armor","shield"].includes(i.subType))??[],grouped=groupItems(eq,(i)=>i.subType),info=cloneSlots(CFG.API.slots.armor);countSlotUsage(info,grouped);let eqSec=tab?.querySelector('.item-list[data-list="armor"]');if(!eqSec)return;if(markItems(eqSec,info,actor,grouped,(i)=>i?.subType),feature2.subsettings.unused.value&&info.armor.count==0){let unusedMsg=i18n.get("LittleHelper.Warning.NoArmor"),holder=createNode("div",null,["lil-unused-slots"]);holder.append(createNode("i",null,["fa-solid","fa-info-circle","lil-info-symbol"]),unusedMsg),eqSec.append(holder)}}function magicItemConflicts(tab,actor){let eq=actor.itemTypes.equipment?.filter((i)=>i.isActive&&i.hasSlots)??[];if(eq.length===0)return;let grouped=groupItems(eq,(i)=>i.system.slot),info=cloneSlots(CFG.API.slots.wondrous);countSlotUsage(info,grouped);let eqSec=tab?.querySelector('.item-list[data-list="equipment"]');if(!eqSec)return;if(markItems(eqSec,info,actor,grouped,(i)=>i?.system.slot),feature2.subsettings.unused.value)notifyLackingUsage(eqSec,info,pf1.config.equipmentSlots.wondrous)}function implantConflicts(tab,actor){let eq=actor.itemTypes.implant?.filter((i)=>i.isActive)??[];if(eq.length===0)return;let grouped=groupItems(eq,(i)=>i.system.slot),info=cloneSlots(CFG.API.slots.implants);countSlotUsage(info,grouped);let eqSec=tab?.querySelector('.item-list[data-list="implants"]');if(!eqSec)return;if(markItems(eqSec,info,actor,grouped,(i)=>i?.system.slot),feature2.subsettings.unused.value);}function slotUsageConflict(sheet,html,options,shared){if(!sheet.isEditable)return;if(!shared.coreSheet)return;if(sheet.actor.getFlag(CFG.id,"overrides")?.equipped)return;let tab=shared.tabs?.inventory?.tab;if(!tab)return;let actor=sheet.actor;armorAndShieldConflicts(tab,actor),magicItemConflicts(tab,actor),implantConflicts(tab,actor)}function enable20(){Ancillary.register("actor",slotUsageConflict)}function disable20(){Ancillary.unregister("actor",slotUsageConflict)}var feature2=new Feature({setting:"duplicate-slots",category:"actor-sheet",enable:enable20,disable:disable20,stage:"ready",subsettings:{unused:new SubSetting({label:"Unused Slots",hint:"Display summary of unused slots at end of the slotted item list.",type:Boolean,fallback:!0})}});init_config();class Slot{limit=1;soft=!1;count=0;constructor(limit=1,{soft=!1,count=0}={}){this.limit=limit,this.soft=soft,this.count=count}get warn(){return this.count>this.limit}clone(){return new Slot(this.limit,{soft:this.soft,count:this.count})}}var wondrousSlots={belt:new Slot(1),body:new Slot(1),chest:new Slot(1),eyes:new Slot(1),feet:new Slot(1),hands:new Slot(1),head:new Slot(1),headband:new Slot(1),neck:new Slot(1),ring:new Slot(2),shoulders:new Slot(1),slotless:new Slot(Number.POSITIVE_INFINITY),wrists:new Slot(1)},implantSlots={arm:new Slot(1),body:new Slot(1,{soft:!0}),brain:new Slot(1,{soft:!0}),ears:new Slot(1),eyes:new Slot(1),head:new Slot(1),legs:new Slot(1)},armorSlots={armor:new Slot(1,{soft:!0}),shield:new Slot(1)};CFG.API.slots={wondrous:wondrousSlots,implants:implantSlots,armor:armorSlots};CFG.API.classes.slot=Slot;init_common();var addFASIcon=(el,iconCss)=>{return el.prepend(createNode("i",void 0,iconCss)),el};function getBaseGearInfo(sheet,shared){let cache={},types=shared.items.byType;cache.equipment={},cache.weapon=[];for(let i of types.equipment.active){let subType=i.subType;if(["shield","armor"].includes(subType))cache[i.type][subType]=i}for(let i of types.weapon.active)cache[i.type].push(i);return cache}function getItemInfo(item,rv={},{isIdentified=!0}={}){let{type,subType,system:itemData}=item;if(game.user.isGM)isIdentified=!0;switch(rv.weight=itemData.weight,rv.size=itemData.size,rv.resizing=itemData.resizing,rv.broken=itemData.broken??!1,type){case"equipment":switch(subType){case"shield":case"armor":rv.armor=itemData.armor,rv.masterwork=itemData.masterwork??!1,rv.enhancement=isIdentified?rv.armor.enh??0:0,rv.ac=rv.armor.value+rv.enhancement,rv.maxDex=rv.armor.dex,rv.acp=Math.max(0,rv.armor.acp+(rv.masterwork?-1:0)),rv.asf=itemData.spellFailure}break;case"weapon":rv.masterwork=itemData.masterwork,rv.enhancement=isIdentified?rv.enh:0;break;case"attack":break}let act=item.defaultAction;if(rv.action??={},act?.hasAttack)rv.action.critRange=act.critRange??20,rv.action.critMult=act.ability?.critMult??2;return rv}function artificialSubType(item){switch(item.type){case"weapon":return"any"}}var sizeMap={fine:0,dim:1,tiny:2,sm:3,med:4,lg:5,huge:6,grg:7,col:8};async function enrichItemSummary(item,node,{actor,gear}={}){let props=node.querySelector(".tag-list");if(!props)props=document.createElement("div"),props.classList.add("tag-list"),node.append(props);let itemData=item.system,actorData=actor.system,type=item.type,subType=item.subType??artificialSubType(item),isPhysical=["weapon","equipment","consumable","loot","container"].includes(type),isIdentified=itemData.identified??!0,action=item.defaultAction,info=getItemInfo(item,void 0,{isIdentified}),acAbility=actorData.attributes.ac.normal.ability,dexMod=actorData.abilities[acAbility]?.mod;if(isPhysical){if(item.type!=="weapon"&&["armor","shield"].includes(subType)){let acText=i18n.get("LittleHelper.Info.AC",{ac:info.ac});if(props.append(createNode("span",acText,["tag","ac",info.enhancement>0?"enhanced":"mundane"])),Number.isFinite(info.maxDex)){let emDex=Math.min(info.maxDex,dexMod),mdText=i18n.get("LittleHelper.Info.MDexAC",{mdex:info.maxDex,ac:emDex});props.append(createNode("span",mdText,["tag","mdex"]))}let acpText=i18n.get("LittleHelper.Info.ACP",{acp:info.acp});if(props.append(createNode("span",acpText,["tag","acp"])),info.asf>0){let text=i18n.get("LittleHelper.Info.ASF",{asf:info.asf});props.append(createNode("span",text,["tag","asf"]))}}let price=item.getValue({recurivse:!1,sellValue:1,inLowestDenomination:!0});if(price!==void 0){let valueText=i18n.get("LittleHelper.Info.Value",{gp:pf1.utils.limitPrecision(price/100,2)});props.append(createNode("span",valueText,["tag","value"]))}let hp=itemData.hp;if(hp?.value!==void 0){let hpText=i18n.get("LittleHelper.Info.HP",{current:hp.value,max:hp.max}),hpTag=createNode("span",hpText,["tag","hit-points"]);if(info.broken||hp.value<hp.max/2)addFASIcon(hpTag,["fa-solid","fa-heart-broken"]);else addFASIcon(hpTag,["fa-solid","fa-heart"]);props.append(hpTag)}let hardness=itemData.hardness?.total;if(hardness!==void 0){let hardText=i18n.get("LittleHelper.Info.Hardness",{hardness});props.append(createNode("span",hardText,["tag","hardness"]))}if(info.size!==void 0&&!info.resizing){let sizeNum=sizeMap[info.size],actorSize=actorData.traits.size?.value??sizeMap.med;if(sizeNum!==actorSize&&!["consumable"].includes(item.type)){let sizeLabel=pf1.config.actorSizes[info.size];props.append(createNode("span",sizeLabel.capitalize(),["tag","size","bad-fit"]))}}if(type==="container"){let items=item.items,countLabel=i18n.get("LittleHelper.Info.ItemCount",{count:items.contents.length});if(props.append(createNode("span",countLabel,["tag","items"])),items.some((i)=>i.type==="container")){let subcontainers=i18n.get("LittleHelper.Info.Subcontainers");props.append(addFASIcon(createNode("span",subcontainers,["tag","sub-containers"]),["fa-solid","fa-box"]))}let cp=item.getTotalCurrency({inLowestDenomination:!0});if(cp!=0){let currencyLabel=i18n.get("LittleHelper.Info.Currency",{gp:cp/100});props.append(addFASIcon(createNode("span",currencyLabel,["tag","container-currency"]),["fa-solid","fa-coins"]))}}}if(info.action?.critRange!==void 0){let text=i18n.get("LittleHelper.Info.Critical",{range:info.action.critRange,mult:info.action.critMult});props.append(addFASIcon(createNode("span",text,["tag","critical"]),["fa-solid","fa-bullseye"]))}let area=action?.area;if(area)props.append(addFASIcon(createNode("span",area,["tag","area"]),["fa-solid","fa-ruler-combined"]));if(itemData.duration?.value){let ti=getTimeFromItem(item,item.getRollData())?.duration,ht=getHumanTime(ti);props.append(addFASIcon(createNode("span",`${ht.n} ${humanTimeUnit[ht.u].long}`,["tag","duration","scaling"]),["fa-solid","fa-hourglass"]))}if(itemData.spellDuration)props.append(addFASIcon(createNode("span",itemData.spellDuration,["tag","duration","descriptive"]),["fa-solid","fa-hourglass"]));let comparedItem=gear[type]?.[subType]?.id===item.id?void 0:gear[type]?.[subType];if(comparedItem){let diffs=[],cItemData=comparedItem.system,itemInfoC=getItemInfo(comparedItem,void 0,{isIdentified:cItemData.identified??!0});switch(type){case"equipment":{let acD=info.ac-itemInfoC.ac,acpD=info.acp-itemInfoC.acp,asfD=info.asf-itemInfoC.asf,mdexD=info.maxDex-itemInfoC.maxDex,eDexCurrent=Number.isFinite(info.maxDex)?Math.min(dexMod,info.maxDex):void 0,eDexOther=Number.isFinite(itemInfoC.maxDex)?Math.min(dexMod,itemInfoC.maxDex):void 0,eDexD=(eDexCurrent??Number.POSITIVE_INFINITY)-(eDexOther??Number.POSITIVE_INFINITY);if(acD!==0){let acText=i18n.get("LittleHelper.Info.AC",{ac:signNum(acD)});diffs.push(createNode("span",acText,["tag","ac"]))}if(mdexD!==null){let mdexText=Number.isFinite(eDexD)?i18n.get("LittleHelper.Info.MDexAC",{mdex:signNum(mdexD),ac:signNum(eDexD)}):i18n.get("LittleHelper.Info.MDex",{mdex:signNum(mdexD)});diffs.push(createNode("span",mdexText,["tag","mdex"]))}if(acpD!==0){let acpText=i18n.get("LittleHelper.Info.ACP",{acp:signNum(acpD)});diffs.push(createNode("span",acpText,["tag","acp"]))}if(asfD!==0){let asfText=i18n.get("LittleHelper.Info.ASF",{asf:signNum(asfD)});diffs.push(createNode("span",asfText,["tag","asf"]))}let compareText=i18n.get("LittleHelper.Info.ComparedAgainst",{name:comparedItem.name});diffs.push(createNode("span",compareText,["lil-short-label"]));break}}let cprops=createNode("div",void 0,["item-comparison","item-properties","tag-list"]);cprops.append(createNode("span",i18n.get("LittleHelper.Info.Comparison")),": ",...diffs),props.after(cprops)}if(item.type==="weapon"){let qualities=Object.entries(itemData.properties??{}).filter(([_,enabled])=>enabled).map(([key])=>createNode("div",pf1.config.weaponProperties[key],["tag"]));if(qualities.length>0){let wprops=createNode("div",void 0,["weapon-qualities","item-properties","tag-list"]);wprops.append(createNode("span",i18n.get("Koboldworks.Missing.PF1.Qualities")),": ",...qualities),props.after(wprops)}}}var config={subtree:!1,childList:!0,attributes:!1},observers={};function enrichOpenSummaries(sheet,html,options,shared){let actor=sheet.document,gearCache=getBaseGearInfo(sheet,shared);for(let el of html.querySelectorAll(".item-list > .item[data-item-id] > .item-summary")){let itemId=el.closest(".item[data-item-id]")?.dataset.itemId,item=actor.items.get(itemId);if(item)enrichItemSummary(item,el,{actor,gear:gearCache})}}function mutHandler(mut,actor,gearCache){let node=mut.addedNodes[0];if(!node.classList.contains("item-summary"))return;let item=actor?.items.get(mut.target.dataset.itemId);if(!item)return;enrichItemSummary(item,node,{actor,gear:gearCache})}function observeItems(sheet,html,options,shared){let actor=sheet.actor,gearCache=getBaseGearInfo(sheet,shared),mutationCallback2=(mutList)=>{for(let mut of[...mutList].filter((m)=>m.addedNodes.length))mutHandler(mut,actor,gearCache)};observers[sheet.appId]?.observer?.disconnect();let observer2=new MutationObserver(mutationCallback2);observers[sheet.appId]={_sheet:new WeakRef(sheet),get sheet(){return this._sheet.deref()},_actor:new WeakRef(sheet.actor),get actor(){return this._actor.deref()},_observer:new WeakRef(observer2),get observer(){return this._observer.deref()}};for(let el of html.querySelectorAll(".item-list .item[data-item-id]"))observer2.observe(el,config)}var endObserver=(appId)=>{observers[appId]?.observer?.disconnect(),delete observers[appId]},closeSheetEvent=(sheet,jq)=>{endObserver(sheet.appId)};function enable21(){Ancillary.register("actor",observeItems),Ancillary.register("actor",enrichOpenSummaries),Hooks.on("closeActorSheet",closeSheetEvent)}function disable21(){for(let appid of Object.keys(observers))observers[appid]?.observer?.disconnect(),delete observers[appid];Ancillary.unregister("actor",observeItems),Ancillary.unregister("actor",enrichOpenSummaries),Hooks.off("closeActorSheet",closeSheetEvent)}new Feature({setting:"item-summary-enhancer",label:"Item Summary Enricher",hint:"Enriches item summary with additional info, such as item value, hit points, and hardness.",category:"actor-sheet",enable:enable21,disable:disable21,stage:"ready"});init_config();function checkExcessSkillRanks(sheet,html,data,shared){let actor=sheet.actor,actorData=shared.systemData;if(actor.getFlag(CFG.id,"overrides")?.excess)return;let hd=actorData.attributes.hd.total;for(let el of shared.tabs.skills?.tab?.querySelectorAll("[data-skill]")??[]){let parentSkill=el.dataset.mainSkill,skill=el.dataset.skill,key=parentSkill?`${parentSkill}.${skill}`:`${skill}`;if(actor.getSkillInfo(key).rank>hd)el.classList.add("lil-excess-skill-ranks")}}function enable22(){Ancillary.register("actor",checkExcessSkillRanks)}function disable22(){Ancillary.unregister("actor",checkExcessSkillRanks)}new Feature({setting:"excess-skill-ranks",category:"actor-sheet",enable:enable22,disable:disable22,stage:"ready"});init_config();init_common();init_icons();function fillLevels(list){for(let l of list){let max=list.at(-1).length,ol=l.length;if(l.length<max)l.length=list.at(-1).length,l.fill(null,ol,max)}}function processCastingLevels(list){return list.map((cl,i0)=>{return{level:i0+1,slots:cl.map((sl,i1)=>{return{level:i1,slots:sl,active:sl>=0,infinite:Number.POSITIVE_INFINITY===sl}})}})}var{ApplicationV2,HandlebarsApplicationMixin}=foundry.applications.api;class CasterProgressionTable extends HandlebarsApplicationMixin(ApplicationV2){casterClass;bookId;constructor(options){super(options);options.document.apps[this.id]=this,this.bookId=options.bookId;let actor=options.document,actorData=actor.system;if(this.book=actorData.attributes?.spells?.spellbooks?.[this.bookId]??{},this.book.class&&this.book.class!=="_hd")this.casterClass=actor.itemTypes.class.find((i)=>i.system.tag==this.book.class)}_initializeApplicationOptions(options){return options=super._initializeApplicationOptions(options),options.uniqueId=options.uniqueId+"-"+options.bookId,options}_getHeaderControls(){return[]}_preClose(){delete this.actor.apps[this.id]}get actor(){return this.options.document}get title(){let bookName=this.book.name||this.casterClass?.name||i18n.get(`PF1.SpellBook${this.bookId.capitalize()}`);return i18n.get("LittleHelper.CasterProgressionTitle",{actor:this.actor.name,book:bookName})}static DEFAULT_OPTIONS={classes:["lil-caster-progression"],position:{width:"auto"},window:{icon:"fa-solid fa-book",submitOnClose:!1,submitOnChange:!1,closeOnSubmit:!0},sheetConfig:!1};static PARTS={form:{template:`modules/${CFG.id}/templates/dialog/caster-progression.hbs`}};_preparePartContext(partId,context,options){let actor=this.actor,actorData=actor.system,book=actorData.attributes.spells.spellbooks[this.bookId],type=book.casterType,prepMode=book.spellPreparationMode,config2=foundry.utils.deepClone(pf1.config.casterProgression),casts=config2.castsPerDay[prepMode][type],prep=config2.spellsPreparedPerDay[prepMode][type];fillLevels(casts),fillLevels(prep);let actualCasts=processCastingLevels(casts),actualPrep=processCastingLevels(prep),classLevel=this.casterClass?.system?.level||actorData.attributes?.hd?.total||0,rollData=actor.getRollData(),bonusLevelFormula=book.cl?.autoSpellLevelCalculationFormula||"0";return classLevel+=RollPF.safeRollSync(bonusLevelFormula,rollData).total,Object.assign(context,{book,type,prepMode,config:config2,casts:actualCasts,prep:actualPrep,cl:classLevel,cantrips:!0,isSpontaneous:book.spontaneous,castsLevels:Array.fromRange(casts.at(-1).length),prepLevels:Array.fromRange(casts[prep.length-1].length),maxLevel:casts[prep.length-1].length,icons:FAIcons}),context}static open(actor,bookId){let uid=`${actor.uuid.replace(".","-")}-${bookId}-caster-progression`;(Object.values(ui.windows).find((app)=>app.id==uid)??new CasterProgressionTable({document:actor,bookId})).render({force:!0,focus:!0})}}function injectCasterProgressionTable(sheet,html,options,shared){let books=shared.tabs.spellbook;if(!books?.tab)return;let actor=sheet.actor,tabs=books.tabs??[];for(let el of tabs){let bookId=el.dataset.tab,r=el.querySelector(`[name="system.attributes.spells.spellbooks.${bookId}.spellPreparationMode"]`);if(!r)return;let b=createNode("i",null,["fa-solid","fa-table","fa-fw","lil-progression-table-button"]);hookCoreTooltip(b,{fn:()=>"Display Progression Table"}),b.addEventListener("click",(_)=>CasterProgressionTable.open(actor,bookId)),r.after(b)}}function enable23(){Ancillary.register("actor",injectCasterProgressionTable)}function disable23(){Ancillary.unregister("actor",injectCasterProgressionTable)}new Feature({setting:"caster-progression-table",label:"Caster Progression Table",hint:"Dialog for displaying currently configured caster progression. Accessed near spellbook progression configuration.",category:"actor-sheet",enable:enable23,disable:disable23,stage:"ready"});init_common();function spellLevelDCInjector(sheet,_jq,_opts,shared){let rd=shared.rollData;for(let tab of shared.tabs.spellbook?.tabs??[]){let bookId=tab.dataset.tab,bookData=rd.spells[bookId];if(!bookData)continue;rd.ablMod=rd.abilities[bookData.ability]?.mod??0,rd.cl=bookData.cl.total;for(let node of tab.querySelectorAll(".spellbook-header")){if(rd.sl=Number(node.dataset.level),!Number.isFinite(rd.sl))continue;let roll=RollPF.safeRollSync(bookData.baseDCFormula,rd);delete rd.sl;let holder=node.querySelector(".lil-spell-details"),b=createNode("label",null,["lil-box","lil-spell-dc"]),tt;if(roll.err)b.textContent=i18n.get("PF1.DCThreshold",{threshold:"Error"}),tt=roll.err.message;else b.textContent=i18n.get("PF1.DCThreshold",{threshold:roll.total}),tt=roll.formula;addCoreTooltip(b,tt),holder?.append(b)}delete rd.cl,delete rd.ablMod}}Ancillary.register("actor",spellLevelDCInjector);init_common();function addSpellTooltips(sheet,html,options,shared){let actor=shared.actor,bookTabs=shared.tabs.spellbook?.tabs,formatter=new Intl.ListFormat(game.i18n.lang,{style:"short",type:"unit"}),listFormat=(str)=>formatter.format(str),fillTooltip=async(tip,el,spell)=>{let{system:itemData,defaultAction:act}=spell,ul=createNode("ul",void 0,["details"]);if(tip.append(createNode("h2",spell.name,["name"]),ul),!act){ul.append(createNode("li","No Actions",["warning","span-2"]));return}let rollData=act.getRollData(),schoolParts=[createNode("span",pf1.config.spellSchools[itemData.school],["school","value","text"])];if(itemData.subschool){let subschool;if(typeof itemData.subschool==="string"&&itemData.subschool)subschool=itemData.subschool?[itemData.subschool]:[];else subschool=listFormat(itemData.subschool.names??[]);if(subschool?.length)schoolParts.push(" (",createNode("span",subschool,["subschool","value","text"]),")")}if(itemData.descriptors){let descriptors=itemData.descriptors.names;if(descriptors.length>0)schoolParts.push(" [",createNode("span",listFormat(descriptors),["descriptors","value","text"]),"]")}if(ul.append(createNode("li",void 0,["school"],{children:[createNode("label","School"),createNode("span",void 0,["school","composite"],{children:schoolParts})]})),itemData.components.material){let mats=itemData.materials,materialDetails=createNode("span",void 0,["material","composite"]);if(materialDetails.append(createNode("span",mats.value,["detail","value","text"])),mats.gpValue>0)materialDetails.append(" [",createNode("span",`${mats.gpValue} gp`,["cost","value","number"]),"]");ul.append(createNode("li",void 0,["material"],{children:[createNode("label","Material"),materialDetails]}))}if(itemData.components.focus){let focus=itemData.materials.focus;ul.append(createNode("li",void 0,["focus"],{children:[createNode("label","Focus"),createNode("span",focus,["value","text","focus"])]}))}let rUnits=act.range.units;if(act.hasRange&&!!rUnits){let rangeDetails=createNode("span",void 0,["range","composite"]),isBasic=["ft","km","m"].includes(rUnits),isIndistinct=["personal","seeText","special","unlimited","none"].includes(rUnits);if(!isBasic)rangeDetails.append(createNode("span",pf1.config.distanceUnits[rUnits],["units","text"]));if(!isIndistinct){let range=act.getRange(),[_,unit]=pf1.utils.convertDistance(0,isBasic?rUnits:void 0),uLabel=pf1.config.measureUnitsShort[unit]??pf1.config.distanceUnits[unit],rl=`${range} ${uLabel}`,rd=createNode("span",rl,["measured","value","number"]);if(isBasic)rangeDetails.append(rd);else rangeDetails.append(" (",rd,")")}ul.append(createNode("li",void 0,["range"],{children:[createNode("label","Range"),rangeDetails]}));let mi=act.range.maxIncrements??1;if(mi>1)ul.append(createNode("li",void 0,["range"],{children:[createNode("label","Max Increments"),createNode("span",`${mi}`,["value"])]}))}let area=act.area;if(area?.length>0)ul.append(createNode("li",void 0,["area"],{children:[createNode("label","Area"),createNode("span",area,["value","text","area"])]}));let target=act.target?.value;if(target)ul.append(createNode("li",void 0,["target"],{children:[createNode("label","Target"),createNode("span",target,["value","text","target"])]}));if(act.duration&&act.duration.value?.length&&act.duration.units){let d=act.duration.value,enriched=!1;if(act.duration?.units==="spec"){if(/\[\[.*]]/.test(d))d=await pf1.utils.enrichHTMLUnrolled(d,{rollData}),enriched=!0}else try{let roll=Roll.create(d,rollData);if(roll.isDeterministic)roll.evaluateSync(),d=i18n.get("PF1.Time.Format",{value:roll.total,unit:pf1.config.timePeriods[act.duration.units]});else{let minRoll=roll.evaluateSync({minimize:!0}),maxRoll=roll.clone().evaluateSync({maximize:!0});d=i18n.get("PF1.Time.Format",{value:`${minRoll.total} – ${maxRoll.total}`,unit:pf1.config.timePeriods[act.duration.units]})}}catch(err){console.error("Formula:",d,`
`,err,`
`,sheet.document)}ul.append(createNode("li",void 0,["duration"],{children:[createNode("label","Duration"),createNode("span",d,["value","text"],{isHTML:enriched})]}))}if(act.hasSave){let dc=act.getDC(rollData),type=act.save.type,saveDetails=createNode("span",void 0,["save","composite"]);saveDetails.append("DC ",createNode("span",dc,["value","number"])," ",pf1.config.savingThrows[type]),ul.append(createNode("li",void 0,["save"],{children:[createNode("label",i18n.get("PF1.Save")),saveDetails]}))}};if(bookTabs)for(let bookTab of bookTabs){let bookId=bookTab.dataset.tab;for(let spellEl of bookTab.querySelectorAll(".item[data-item-id]")){let tip=createNode("div",null,["lil-tooltip"]),item=actor.items.get(spellEl.dataset.itemId);if(!item)continue;spellEl.append(tip),spellEl.addEventListener("pointerenter",()=>fillTooltip(tip,spellEl,item),{passive:!0,once:!0}),setStaticToolTipListener(spellEl,tip,{aligned:!1,boundedBy:bookTab}),spellEl.addEventListener("pointermove",(ev)=>{spellEl.style.setProperty("--mx",ev.clientX);let tp=tip.getBoundingClientRect(),{left,width}=spellEl.getBoundingClientRect();if(tip.classList.contains("right-aligned"))tip.classList.toggle("right-aligned",tp.right+10>left+width/2);else tip.classList.toggle("right-aligned",tp.left>left+width/2)},{passive:!0})}}}function enable24(){Ancillary.register("actor",addSpellTooltips)}function disable24(){Ancillary.unregister("actor",addSpellTooltips)}new Feature({setting:"actor-spell-tooltips",label:"Spell Tooltips",hint:"Display tooltips describing some spell details.",category:"actor-sheet",enable:enable24,disable:disable24,stage:"ready"});init_config();init_common();init_config();var getActorQuickSkillsConfig=(actor)=>{let config2=actor.getFlag(CFG.id,"quickSkills");if(config2)return new QuickSkillsModel(config2);return null};function getActorSkills(actor,options){let skills=[],addSkill=(sklId)=>{let ski=actor.getSkillInfo(sklId)??{};if(ski.mod>options.maxMod)options.maxMod=ski.mod;let[parentId,subId]=ski.id.split(".");ski.parentId=parentId,ski.subId=subId,skills.push({...ski})},bannedIds=game.settings.get("pf1","allowBackgroundSkills")?new Set:new Set(pf1.config.backgroundOnlySkills);for(let skillId of actor.allSkills??[]){if(bannedIds.has(skillId))continue;try{addSkill(skillId)}catch{}}skills.sort((a,b)=>a.fullName.localeCompare(b.fullName,void 0,{sensitivity:"base"}));let rv={};for(let s of skills)rv[s.id]=s;return rv}var getDefaultQuickSkills=()=>[...QuickSkillsModel.DEFAULT_SKILLS],getGetUserDefaultQuickSkills=()=>game.settings.get(CFG.id,"quickSkills")?.split(",").filter((id)=>!!id)??[];class QuickSkillsModel extends foundry.abstract.DataModel{static defineSchema(){let fields=foundry.data.fields;return{skills:new fields.SetField(new fields.StringField,{initial:()=>getGetUserDefaultQuickSkills()}),threshold:new fields.NumberField({initial:0.4}),minRank:new fields.NumberField({initial:1}),useMod:new fields.BooleanField({initial:!0}),sortMod:new fields.BooleanField({initial:!1}),defaults:new fields.BooleanField({initial:!0})}}static migrateData(source){if(typeof source.skills==="string")source.skills=source.skills.split(",").map((sk)=>sk.trim()).filter((sk)=>!!sk)}static DEFAULT_SKILLS=new Set(["per","dip","hea"])}init_config();init_icons();init_common();class SkillEditor extends foundry.applications.api.HandlebarsApplicationMixin(foundry.applications.api.ApplicationV2){skillsConfig;constructor(options={}){options.isUser=!!options.document,options.document??=new Actor.implementation({type:"character",name:"Quick Skills Temp"});super(options);this.skillsConfig=getActorQuickSkillsConfig(options.document)??new QuickSkillsModel}get actor(){return this.options.document}get title(){let actor=this.actor;if(actor.id)return i18n.get("LittleHelper.QuickSkills.ActorTitle",{name:actor.name,id:actor.id});else return i18n.get("LittleHelper.QuickSkills.DefaultTitle")}static DEFAULT_OPTIONS={tag:"form",classes:["lil-quick-skills-editor"],window:{icon:"fa-solid fa-hands",resizable:!0},position:{width:460},form:{handler:this._onSubmit,submitOnChange:!1,closeOnSubmit:!0,submitOnClose:!1}};static PARTS={form:{template:`modules/${CFG.id}/templates/quick-skills-editor.hbs`},footer:{template:"templates/generic/form-footer.hbs"}};_initializeApplicationOptions(options){options=super._initializeApplicationOptions(options);let actor=options.document;if(actor.id)options.uniqueId=`quick-skills-editor-${actor.uuid.replaceAll(".","-")}`;else options.uniqueId="quick-skills-editor-defaults";return options}async _prepareContext(options){let actor=this.actor,actorData=actor?.system,skills=getActorSkills(actor,{maxMod:Number.NEGATIVE_INFINITY}),qs=this.skillsConfig??new QuickSkillsModel;for(let skId of qs.skills){let sklData=skills[skId];if(sklData)sklData.selected=!0;else console.warn("Invalid skill ID:",skId)}for(let sk of getDefaultQuickSkills()){if(qs.skills.size===0)skills[sk].selected=!0;skills[sk].default=!0}let context={actor,user:this.options.isUser,skills,icons:FAIcons,labels:{}};if(actor){let hd=actorData.attributes.hd.total,maxRank=hd,minRank=qs.minRank??1;context.threshold=qs.threshold,context.thresholdPct=Math.floor(qs.threshold*100),context.useMod=qs.useMod,context.maxMod=options.maxMod,context.maxRank=maxRank,context.minRank=minRank,context.labels.maxMod=`<span class='maxmod-value'>${signNum(context.maxMod)}</span>`,context.labels.maxRank=`<span class='maxrank-value'>${context.maxRank}</span>`}return context}async resetSkills(){let actor=this.actor;if(actor.id){if(await foundry.applications.api.DialogV2.confirm({window:{title:i18n.get("LittleHelper.QuickSkills.Reset.Title")},content:"<p>"+i18n.get("LittleHelper.QuickSkills.Reset.Info")}))actor.unsetFlag(CFG.id,"quickSkills"),this.close()}else this.skillsConfig.updateSource({skills:QuickSkillsModel.DEFAULT_SKILLS}),this.render(),ui.notifications.warn(i18n.get("LittleHelper.QuickSkills.Reset.Soft"))}_onRender(context,options){super._onRender(context,options);let html=this.element.querySelector(".window-content"),actor=this.actor;if(html.querySelector('button[data-action="reset"]').addEventListener("click",(ev)=>{ev.preventDefault(),ev.stopPropagation(),this.resetSkills().then((_)=>this.render())}),!actor.id)return;let t=html.querySelector(".threshold"),r=t?.querySelector('[name="threshold"]'),mr=t?.querySelector('[name="minRank"]'),um=t?.querySelector('[name="useMod"]'),p=t?.querySelector(".percentage"),hus=html.querySelector("input.hide-unselected"),sl=html.querySelector(".skill-list"),actorData=actor.system,hd=actorData.attributes.hd.total,maxRank=hd,maxMod=Number.NEGATIVE_INFINITY,qs=getActorQuickSkillsConfig(actor)??new QuickSkillsModel,threshold=qs.threshold??0,minRank=qs.minRank??1,hideUnselected=!1,skills=html.querySelectorAll("[data-skill]"),useMod=qs.useMod;function highlightSkills(percent,minRank2=1){for(let el of skills){let rank=parseInt(el.dataset.rank)||0,mod=parseInt(el.dataset.mod)||0,val=useMod?mod:rank;if(mod>maxMod)maxMod=mod;let tt=useMod?maxMod:maxRank,pcte=percent>0?val>=Math.floor(tt*percent):!1,mre=minRank2>0?rank>=minRank2:!1,both=percent==0&&minRank2==0?!1:(percent>0?pcte:!0)&&(minRank2>0?mre:!0);el.classList.toggle("auto-select",both);let checkbox=el.querySelector("input");if(!checkbox.checked)checkbox.indeterminate=both}let thval=Math.floor((useMod?maxMod:maxRank)*threshold);p.textContent=`${Math.floor(percent*100)}% [${thval}]`}highlightSkills(qs.threshold),hus.addEventListener("change",(ev0)=>{hideUnselected=Boolean(ev0.target.checked),sl.classList.toggle("hide-unselected",hideUnselected),highlightSkills(threshold,minRank)},{passive:!0}),um.addEventListener("change",(ev0)=>{useMod=Boolean(ev0.target.checked),highlightSkills(threshold,minRank)},{passive:!0}),r.addEventListener("input",(ev0)=>highlightSkills(threshold=parseFloat(ev0.target.value),minRank),{passive:!0}),r.addEventListener("change",(ev0)=>highlightSkills(threshold=parseFloat(ev0.target.value),minRank),{passive:!0}),mr.addEventListener("input",(ev0)=>highlightSkills(threshold,minRank=parseFloat(ev0.target.value)),{passive:!0}),mr.addEventListener("change",(ev0)=>highlightSkills(threshold,minRank=parseFloat(ev0.target.value)),{passive:!0})}static _onSubmit(event2,form,formData){let actor=this.actor;formData=formData.object;let qs=[];for(let[skId,enabled]of Object.entries(formData))if(skId.startsWith("skill.")&&enabled)qs.push(skId.replace(/^skill\./,""));let C=CFG.console.colors;if(actor.id){let setup=new QuickSkillsModel({...formData,skills:qs});console.log("%cLittle Helper%c \uD83E\uDD8E | Quick Skills | Saving actor config:",C.main,C.unset,setup),actor.setFlag(CFG.id,"quickSkills",setup.toObject())}else console.log("%cLittle Helper%c \uD83E\uDD8E | Quick Skills | Saving defaults:",C.main,C.unset,qs),game.settings.set(CFG.id,"quickSkills",qs.join(","))}}Hooks.once("ready",()=>{let fields=foundry.data.fields;game.settings.register(CFG.id,"quickSkills",{type:new fields.StringField({initial:()=>[...QuickSkillsModel.DEFAULT_SKILLS].join(",")}),scope:"world",default:[...QuickSkillsModel.DEFAULT_SKILLS].join(","),config:!1}),game.settings.registerMenu(CFG.id,"quickSkillsMenu",{name:"Quick Skills",label:"Default Skills",type:SkillEditor,restricted:!0})});var skipConfirm=()=>game.settings.get("pf1","skipActionDialogs")&&!pf1.skipConfirmPrompt||!game.settings.get("pf1","skipActionDialogs")&&pf1.skipConfirmPrompt;async function onSkillEdit(ev,actor){ev.preventDefault(),ev.stopPropagation(),(Object.values(ui.windows).find((a)=>a instanceof SkillEditor&&a.actor===actor)??new SkillEditor({document:actor})).render({force:!0,focus:!0})}function onSkillClick(ev,actor){let el=ev.target.dataset.skill?ev.target:ev.target.closest(".lil-quick-skills [data-skill-id]");if(!el)return;ev.preventDefault(),ev.stopPropagation();let skillId=el.dataset.skillId;actor.rollSkill(skillId,{skipDialog:skipConfirm()})}var fillTooltip=async(event2,el,{actor,skillId}={})=>{let tip=document.createElement("div"),si=actor.getSkillInfo(skillId);tip.append(createNode("h2",si.fullName),createNode("div",null,["row","rank"],{children:[createNode("label",i18n.get("PF1.Rank")),createNode("span",`${si.rank??0}`,["rank","value",si.rank==0?"null":""])]}),createNode("div",null,["row","modifier"],{children:[createNode("label",i18n.get("PF1.Modifier")),createNode("span",signNum(si.mod),["modifier","value",si.mod===0?"null":""])]}),createNode("h3",i18n.get("LittleHelper.QuickSkills.Sources")));let sourceDetails=actor.getSourceDetails(`system.skills.${skillId}.mod`);for(let source of sourceDetails)tip.append(createNode("div",null,["row","source"],{children:[createNode("label",source.name),createNode("span",signNum(source.value),["value",source.value==0?"null":""])]}));return tip};function addQuickSkills(sheet,html,options,shared){let tab=shared.tabs.summary?.tab,sd=tab?.querySelector(".subdetails-body");if(!sd)return;let qsEl=createNode("div",null,["lil-quick-skills"]),actor=sheet.actor,actorData=actor.system,setup=getActorQuickSkillsConfig(actor),qs=new QuickSkillsModel(setup??{}),hd=actorData.attributes.hd.total,maxRank=hd,skopts={maxMod:Number.NEGATIVE_INFINITY},skills=getActorSkills(actor,skopts),bannedIds=game.settings.get("pf1","allowBackgroundSkills")?new Set:new Set(pf1.config.backgroundOnlySkills);for(let skId of qs.skills){let sklData=skills[skId];if(sklData){if(bannedIds.has(skId))continue;sklData.enabled=!0}else console.warn("Invalid skill ID found:",skId)}if(!setup){let dsq=getGetUserDefaultQuickSkills();for(let skId of dsq)skills[skId].autoSelect=!0;let casterSkills=new Set;for(let book of Object.values(actorData.attributes?.spells?.spellbooks??{})){if(book.inUse===!1)continue;switch(book.kind){case"arcane":if(!book.spontaneous)casterSkills.add("spl");break;case"alchemy":if(!book.spontaneous)casterSkills.add("spl");casterSkills.add("crf.alchemy");break}}for(let skId of casterSkills){if(!skills[skId])continue;skills[skId].autoSelect=!0}}if(qs.threshold>0||qs.minRank>0)for(let sk of Object.values(skills)){let mVal=!1,mRank=!1;if(qs.threshold>0){let val=qs.useMod?sk.mod:sk.rank,thval=qs.useMod?skopts.maxMod:maxRank;if(val>=Math.floor(thval*qs.threshold))mVal=!0}else mVal=!0;if(qs.minRank>0){if(sk.rank>=qs.minRank)mRank=!0}else mRank=!0;if(mVal&&mRank)sk.autoSelect=!0}let ul=createNode("ul",null,["skill-list"]),acp=actorData.attributes.acp.total,quickSkillCount=0;for(let skId of Object.keys(skills)){let sk=skills[skId];if(!sk.enabled&&!sk.autoSelect)continue;quickSkillCount++;let li=createNode("li",null,["skill"]),[parentId,subId]=skId.split(".");li.dataset.skillId=skId,li.dataset.skill=parentId,li.dataset.subSkill=subId,li.append(createNode("h4",sk.fullName,["name"]),createNode("span",signNum(sk.mod),["mod"]),createNode("i",null,["acp",sk.acp?"affected":"unaffected",acp>0?"penalty":"no-penalty","fa-solid","fa-shield-alt"],{tooltip:sk.acp?i18n.get("PF1.ACPLong")+`<br>-${acp}`:null}));let tm=CONFIG.ux.TooltipManager,context={actor,skillId:skId};hookCoreTooltip(li,{direction:tm.TOOLTIP_DIRECTIONS.LEFT,fn:fillTooltip,context,css:"lil-quick-skills-tooltip"}),ul.append(li)}if(quickSkillCount==0)ul.append(createNode("span",i18n.get("LittleHelper.QuickSkills.NoneMatched"),["lil-quick-skills-notification"]));let skEdit=createNode("span",null,["edit","action"]);skEdit.dataset.action="edit",skEdit.append(createNode("i",null,["fa-solid","fa-cog"])),skEdit.dataset.tooltip="LittleHelper.Action.Configure";let h=createNode("div",null,["quick-skills-header"]);h.append(createNode("h2",i18n.get("LittleHelper.QuickSkills.Title")),skEdit),qsEl.append(h,ul),skEdit.addEventListener("click",(ev)=>onSkillEdit(ev,actor)),qsEl.addEventListener("click",(ev)=>onSkillClick(ev,actor));let sdc=createNode("div",null,["flexrow","lil-subdetails-reorganizer"]);sd.before(sdc),sdc.append(sd,qsEl)}function enable25(){Ancillary.register("actor",addQuickSkills)}function disable25(){Ancillary.unregister("actor",addQuickSkills)}new Feature({setting:"summary-quick-skills",label:"Quick Skills",hint:"Displays quick & configurable skill roll access in summary tab.",category:"actor-sheet",enable:enable25,disable:disable25,stage:"ready"});init_common();var variants={linked:{label:"LittleHelper.LinkState.Linked.TitleTag",sub:"LittleHelper.LinkState.Linked.Token",proto:"LittleHelper.LinkState.Linked.Prototype",sproto:"LittleHelper.LinkState.Linked.PrototypeShort",css:["lil-token-linked","linked"],icon:["fa-solid","fa-link","fa-fw"]},unlinked:{label:"LittleHelper.LinkState.Unlinked.TitleTag",sub:"LittleHelper.LinkState.Unlinked.Token",proto:"LittleHelper.LinkState.Unlinked.Prototype",sproto:"LittleHelper.LinkState.Unlinked.PrototypeShort",css:["lil-token-unlinked","unlinked"],icon:["fa-solid","fa-unlink","fa-fw"]}};function actorLinkStatus(sheet,html,_opts,shared){let actor=sheet.actor,token=sheet.token??actor.token,isToken=!!token,isLinked=isToken?token.isLinked:actor.prototypeToken.actorLink;if(actor.pack)return;if(!shared.tabs.summary?.tab)return;let isProtoLinked=(actor.token?.baseActor??actor).prototypeToken.actorLink,vd=variants[isLinked?"linked":"unlinked"];if(game.user.isGM||!isLinked){let title=html.closest(".app.sheet.actor")?.querySelector(".window-title");if(!title)return;let fc=title.firstChild;if(fc){let extraLabel;if(isLinked)if(isProtoLinked)extraLabel="full-link";else extraLabel="bad-link";else if(isProtoLinked)extraLabel="broken";else extraLabel="full-unlink";fc.parentElement?.querySelector(".lil-link-status")?.remove();let linkLabel=createNode("i",null,["lil-link-status",...vd.icon,...vd.css,extraLabel]);addCoreTooltip(linkLabel,isToken?vd.sub:vd.proto,"DOWN"),fc.after(linkLabel)}}}function enable26(){Ancillary.register("actor",actorLinkStatus)}function disable26(){Ancillary.unregister("actor",actorLinkStatus)}new Feature({setting:"actor-unmistaken-linking",label:"Display Linking Status",hint:"Display if an actor is linked or not.",category:"actor-sheet",enable:enable26,disable:disable26,stage:"ready"});var healthLabels={0:"LittleHelper.HealthLevel.Healthy",1:"LittleHelper.HealthLevel.Grazed",2:"LittleHelper.HealthLevel.Wounded",3:"LittleHelper.HealthLevel.Critical",dying:"LittleHelper.HealthLevel.Dying",dead:"LittleHelper.HealthLevel.Dead"},evaluateDeathPoint=(actor)=>{let ad=actor.system;return ad.abilities.con.value===null?0:-(ad.abilities[ad.attributes.hpAbility]?.total??0)};Hooks.once("i18nInit",()=>{for(let[key,value]of Object.entries(healthLabels))healthLabels[key]=i18n.get(value)});init_common();function considerDeath(sheet,html,_opts,shared){let tab=shared.tabs.summary?.tab,hpEl=tab?.querySelector('[name="system.attributes.hp.value"]')?.parentElement;if(!hpEl)return;let{actor,systemData:actorData}=shared,hp=actorData.attributes.hp,eHP=hp.value+hp.temp,cls=[],hpPercentage=eHP/hp.max;switch(clampNum(4-Math.ceil(hpPercentage*4),0,3)){case 0:cls.push("healthy");break;case 1:cls.push("grazed");break;case 2:cls.push("wounded");break;case 3:cls.push("critical");break}if(eHP<=evaluateDeathPoint(actor))cls.push("lil-dead");else if(eHP>=0){cls.push("lil-alive");let eHPNL=eHP-hp.nonlethal;if(eHPNL>=0)cls.push("lil-awake");if(eHPNL<=0){if(eHPNL==0)cls.push("lil-staggered");if(eHPNL<0)cls.push("lil-unconscious");if(hp.nonlethal>0)tab.querySelector('[name="system.attributes.hp.nonlethal"]')?.parentElement?.classList.add("lil-staggered")}}else cls.push("lil-dying","lil-unconscious");hpEl.classList.add(...cls)}function enable27(){Ancillary.register("actor",considerDeath)}function disable27(){Ancillary.unregister("actor",considerDeath)}new Feature({setting:"death-proximity",label:"Death Proximity",hint:"Color and iconize actor sheet health depending on health status.",category:"actor-sheet",enable:enable27,disable:disable27,stage:"ready"});init_common();function addRaceName(sheet,html,options,shared){if(!shared.coreSheet)return;let actor=shared.actor,race=actor.race;if(!race)return;shared.tabs?.summary?.tab?.querySelector(".summary-header")?.querySelector(`[data-item-id="${race.id}"] .race-info`)?.prepend(createNode("div",null,["lil-race-name"],{children:[createNode("span",race.name,["name"])]}))}function enable28(){Ancillary.register("actor",addRaceName)}enable28();init_common();var ablKeys=["str","dex","con","int","wis","cha"];function summaryAbilityScores(sheet,html,options,shared){let actor=sheet.actor,actorData=shared.systemData,attr=shared.tabs.summary?.attributes;if(!attr)return;let abls=foundry.utils.deepClone(actorData.abilities),ablsSorted=[];for(let[key,abl]of Object.entries(abls)){let data=abl;data.key=key,ablsSorted.push(data)}ablsSorted.sort((a,b)=>b.total-a.total),ablsSorted[0].grade=5;let best=ablsSorted[0],worst=ablsSorted[5];for(let abl of ablsSorted)abl.percentile=maxPrecision((abl.total-worst.total)/(best.total-worst.total),2),abl.grade=Math.round(abl.percentile*5);let ablDiv=createNode("div",void 0,["lil-ability-scores"]),abilities={};for(let ablKey of ablKeys){let abl=abls[ablKey],aligner=createNode("div",void 0,["ability-score-holder"]),ablD=createNode("h3",void 0,["ability-score"]),l=createNode("label",i18n.get(`PF1.AbilityShort${ablKey.capitalize()}`)),t=createNode("span",abl.total,["total"]),m=createNode("span",`(${signNum(abl.mod)})`,["modifier"]),isNull=abl.total===null;if(isNull)t.textContent="–",m.textContent="",aligner.classList.add("null");if(abilities[ablKey]={d:ablD,l,t,m},ablD.append(l,t,m),aligner.append(ablD),ablDiv.append(aligner),ablD.dataset.ability=ablKey,ablD.dataset.grade=abl.grade,abl.grade==5){let icon=createNode("i",void 0,["far","fa-star","lil-icon"]);ablD.prepend(icon)}if(!isNull)ablD.addEventListener("click",function(ev){ev.preventDefault(),ev.stopPropagation(),actor.rollAbilityTest(ablKey)})}attr.before(ablDiv),attr.querySelector(".maneuverability-details")?.classList.add("lil-abl-score-layout-fix")}function enable29(){Ancillary.register("actor",summaryAbilityScores)}function disable28(){Ancillary.unregister("actor",summaryAbilityScores)}new Feature({setting:"summary-ability-scores",label:"Ability Scores in Summary Tab",hint:"Displays ability scores on the summary tab just above health.",category:"actor-sheet",enable:enable29,disable:disable28,stage:"ready"});init_config();init_common();class TokenSyncDialog extends FormApplication{constructor(...args){super(...args)}get document(){return this.object}get title(){return`Image Sync: ${this.document.token?.name??this.document.name}`}get template(){return`modules/${CFG.id}/templates/dialog/token-image-sync-dialog.hbs`}static get defaultOptions(){let _default=super.defaultOptions;return{..._default,classes:[..._default.classes,"lil-token-image-sync-dialog"],id:"lil-token-image-sync-dialog",height:"auto",width:"auto"}}getData(){let context=super.getData();return context.actor=this.document,context.token=this.document.token??this.document.prototypeToken,context}async _syncImage(ev,{source}={}){ev.preventDefault(),ev.stopPropagation();let actor=this.document,token=actor.token??actor.prototypeToken;switch(source){case"actor":if(actor.token)token.update({"texture.src":actor.img});else actor.update({"prototypeToken.texture.src":actor.img});break;case"token":actor.update({img:token.texture.src});break}this.close()}activateListeners(jq){let html=jq,actorImg=html.querySelector(".actor-image"),tokenImg=html.querySelector(".token-image");actorImg.addEventListener("click",(ev)=>this._syncImage(ev,{source:"actor"})),tokenImg.addEventListener("click",(ev)=>this._syncImage(ev,{source:"token"}))}}function tokenImageMismatch(sheet,html,options,shared){let actor=sheet.actor,img=shared.tabs.summary?.tab?.querySelector('section > .tab.summary img.profile[data-edit="img"]');if(!img)return;let pImg=actor.img,tImg=actor.token?.texture.src??actor.prototypeToken.texture.src;if(pImg===tImg)return;let slant=document.createElement("span");slant.classList.add("lil-token-mismatch-marker"),addCoreTooltip(slant,"Token image does not match profile.<br>Click to show sync options."),slant.addEventListener("click",(ev)=>{ev.preventDefault(),ev.stopPropagation(),new TokenSyncDialog(actor).render(!0,{focus:!0,left:ev.clientX+20,top:ev.clientY+20})}),img.before(slant)}function enable30(){Ancillary.register("actor",tokenImageMismatch)}function disable29(){Ancillary.unregister("actor",tokenImageMismatch)}new Feature({setting:"actor-token-mismatch",category:"actor-sheet",enable:enable30,disable:disable29,enabledByDefault:!1,stage:"ready"});init_common();function displayTokenName(sheet,html,options,shared){let tab=shared.tabs.summary?.tab,actor=sheet.actor,tokenName=(sheet.token??actor.token??actor.prototypeToken).name;if(actor.name==tokenName)return;let nameEl=tab?.querySelector("input[name=name]");if(!nameEl)return;let tokenNameEl=createNode("span",tokenName,["token-name"]);tokenNameEl.dataset.tooltip="Token Name",nameEl.after(tokenNameEl)}function enable31(){Ancillary.register("actor",displayTokenName)}function disable30(){Ancillary.unregister("actor",displayTokenName)}new Feature({setting:"actor-token-name",category:"actor-sheet",enable:enable31,disable:disable30,stage:"ready"});init_common();function rangeLabel(value,units){let label=pf1.utils.convertDistance(0)[1];switch(label=label==="ft"?pf1.config.measureUnitsShort.ft:pf1.config.measureUnitsShort.m,label=`${value} ${label}`,units){case"personal":return pf1.config.distanceUnits.personal;case"melee":return pf1.config.distanceUnits.melee+` (${label})`;case"touch":return pf1.config.distanceUnits.touch+` (${label})`;case"reach":return pf1.config.distanceUnits.reach+` (${label})`;default:return label}}async function fillActionDetails(act,item,ul,shared){let actor=item.actor,damage=Handlebars.helpers.actionDamage(act,shared.rollData,{hash:{combine:!0}});if(damage){let damagel=createNode("div",null,["damage","value","nowrap"]);damagel.append(damage);let label=act.isHealing?"PF1.Healing":"PF1.Damage";ul.append(createNode("li",null,["damage"],{children:[createNode("label",i18n.get(label)),damagel]}))}if(act.hasAttack){let attacks=act.getAttacks({full:!0,resolve:!0,bonuses:!0,conditionals:!0});if(attacks?.length){let attacksl=createNode("div",null,["attacks","value","nowrap"]);attacksl.append(attacks.map((a)=>signNum(a.bonus)).join("/")),ul.append(createNode("li",null,["attacks"],{children:[createNode("label","Attacks"),attacksl]}))}}if(act.isCharged){let charges=createNode("div",null,["charges","value"]),chargeCost=await act.getChargeCost({maximize:!0,interactive:!1});charges.append(createNode("span",`${Math.floor(item.charges/chargeCost)}`,["remaining"]));let m=item.chargeMax;if(m>0)charges.append(" / ",createNode("span",Math.floor(m/chargeCost),["max"]));ul.append(createNode("li",null,["charges"],{children:[createNode("label","Charges"),charges]}))}if(act.usesAmmo){let ammoId=item.getFlag("pf1","defaultAmmo"),ammo=actor.items.get(ammoId);if(ammo){let ammoLeft=ammo.system.quantity??0;ul.append(createNode("li",null,["ammo"],{children:[createNode("label","Ammo"),createNode("span",ammo.name,["value"])]}),createNode("li",null,["ammo"],{children:[createNode("label"," – Quantity"),createNode("span",ammoLeft,["value"])]}))}else ul.append(createNode("li",null,["ammo"],{children:[createNode("label","No Default Ammo",["warning","span-2"])]}))}let rUnits=act.range?.units;if(act.hasRange&&!!rUnits){let r=act.getRange(),rl=rangeLabel(r,rUnits);ul.append(createNode("li",null,["range"],{children:[createNode("label","Range"),createNode("span",rl,["value"])]}));let minRange=act.minRange;if(minRange>0){let mrlabel=rangeLabel(minRange,rUnits);ul.append(createNode("li",null,["range","min"],{children:[createNode("label","– Min"),createNode("span",mrlabel,["value"])]}))}if((act.range.maxIncrements??1)>1&&rUnits==="ft"){let maxRange=act.maxRange,mrlabel=rangeLabel(maxRange,rUnits);ul.append(createNode("li",null,["range","max"],{children:[createNode("label","– Max"),createNode("span",mrlabel,["value"])]}))}}}async function generateActionTooltip(el,item,shared){let template=document.createElement("template"),ul=createNode("ul",null,["details"]),act=item.defaultAction;if(act)await fillActionDetails(act,item,ul,shared);else ul.append(createNode("li","No Actions",["warning","span-2"]));template.content.append(createNode("h3",item.name,["name"]),document.createElement("hr"),ul);let tooltip={html:template.content,direction:game.tooltip.constructor.TOOLTIP_DIRECTIONS.UP,cssClass:"lil-quick-action-tooltip"};game.tooltip.activate(el,tooltip)}function addQuickActionTooltips(sheet,html,options,shared){let tab=shared.tabs.summary?.tab,actor=shared.actor,acts=tab?.querySelector(".quick-actions");if(!acts)return;for(let el of acts.querySelectorAll("[data-item-id]")){let item=actor.items.get(el.dataset.itemId);if(!item)continue;delete el.dataset.tooltip,el.addEventListener("pointerenter",(_)=>generateActionTooltip(el,item,shared),{passive:!0})}acts.addEventListener("pointerleave",()=>game.tooltip.deactivate())}function enable32(){Ancillary.register("actor",addQuickActionTooltips)}function disable31(){Ancillary.unregister("actor",addQuickActionTooltips)}new Feature({setting:"actor-quick-action-tooltips",label:"Quick Action Tooltips",hint:"Display tooltips for quick actions.",category:"actor-sheet",enable:enable32,disable:disable31,stage:"ready"});init_config();init_common();CFG.API.language={groups:{secret:{css:["secret"],icon:["fa-mask"],values:new Set(["druidic","drowsign"])},racial:{css:["racial"],icon:["fa-fish"],values:new Set(["elven","dwarven","gnome","orc","goblin","grippli","halfling","gnoll","tengu","strix","samsaran","kasatha","kuru","munavri","nagaji","caligni","dark","triaxian","yaddithian","androffan","catfolk","ib","lashunta","reptoid","rougarou","syrinx","vishkanya","vanaran"])},monster:{css:["monster","npc"],icon:["fa-pastafarianism"],values:new Set(["sphinx","sasquatch","aboleth","aklo","cyclops","necril","giant","dziriak","arboreal","treant","vegepygmy","boggard","migo","yithian","elderthing","shae","grioth"])},regional:{css:["regional"],icon:["fa-map"],values:new Set(["varisian","skald","taldane","shoanti","vudrani","varki","shadowtongue","orvian","osiriani","kelish","minatan","hallit","polyglot","mwangi"])},magic:{css:["draconic"],icon:["fa-dragon"],values:new Set(["draconic"])},fae:{css:["sylvan"],icon:["fa-cannabis"],values:new Set(["sylvan"])},elemental:{css:["elemental"],icon:["fa-fire"],values:new Set(["terran","ignan","aquan","auran"])},planar:{css:["planar"],icon:["fa-solar-panel"],values:new Set(["celestial","infernal","abyssal","protean"])},dead:{css:["rare"],icon:["fa-monument"],values:new Set(["azlanti","thassilonian","ancientosiriani","tekritanin","shory","jistka"])},common:{css:["lil-highlight","common"],icon:["fa-globe"],values:new Set(["common","taldane","tien","undercommon"])}}};var langMap;function manipulateTraitSelector(app,html){if(html instanceof jQuery)html=html[0];if(app.options.subject!=="languages")return;let langGroups=CFG.API.language.groups;if(!langGroups)return;if(!langMap){langMap=new Map;for(let[groupId,lang]of Object.entries(langGroups)){let i18nKey=`LittleHelper.Languages.${groupId}`;lang.label=i18n.has(i18nKey)?i18n.get(i18nKey):" ";for(let id of lang.values)langMap.set(id,lang)}let canonical=new Set(Object.keys(pf1.config.languages)),missing=new Set;for(let id of canonical)if(!langMap.has(id))missing.add(id);if(missing.size>0)console.warn(`LH | Following languages were not recognized:
`,missing)}html.classList.add("lil-enhanced-language-selector");for(let node of html.querySelectorAll('li input[type="checkbox"]')){if(node.type!=="checkbox")return;let el=node.closest("li"),lang=el.dataset.choice,icon,css,label=createNode("span",null,["lil-lang-type"]),langData=langMap.get(lang);if(langData)css=langData.css,icon=langData.icon,label.textContent=langData.label;else css=["unknown"],icon=["fa-question-circle"],label.textContent="Unidentified";if(css)el.classList.add(...css);if(icon)node.parentElement.append(createNode("i",null,["fa-solid",...icon,"lil-icon","lil-faded"]),label)}}function enable33(){Hooks.on("renderActorTraitSelector",manipulateTraitSelector)}function disable32(){Hooks.off("renderActorTraitSelector",manipulateTraitSelector)}new Feature({setting:"enhanced-language-selection",category:"actor-sheet",enable:enable33,disable:disable32,stage:"ready"});function discourageSourceless(sheet,html,options,shared){if(html instanceof jQuery)html=html[0];if(!shared.coreSheet)return;let actorData=shared.systemData,combatTab=shared.tabs.combat?.tab;if(combatTab){let notes=combatTab.querySelector(".defense-notes"),hasValues=!1,inputs=notes?.querySelectorAll("textarea");if(inputs){for(let input of inputs)if(input.textContent.length>0){hasValues=!0;break}}if(!hasValues){notes?.remove();let header=combatTab.querySelector("table")?.parentElement;if(header)header.style.flex="0";let footer=combatTab.querySelector(".combat-defenses");if(footer)footer.style.flex="0"}}let skillsTab=shared.tabs.skills?.tab;if(skillsTab){let bonusSkills=skillsTab.querySelector(".skill-rank-formula");if(actorData.details.bonusSkillRankFormula.length===0){bonusSkills?.remove();let lockbutton=skillsTab.querySelector(".skill-lock-button"),holder=lockbutton.parentElement;if(game.settings.get("pf1","allowBackgroundSkills")){let nav=skillsTab.querySelector("nav.tabs"),wrapper=document.createElement("div");wrapper.classList.add("lil-helper-skill-nav-wrapper"),nav.before(wrapper),wrapper.append(nav,lockbutton)}else{let superholder=holder?.parentElement;superholder.append(lockbutton),superholder.style.setProperty("flex-direction","row"),lockbutton.style.padding="0.3em";let prev=lockbutton.previousElementSibling;if(prev)prev.style.flex="1"}lockbutton.classList.add("lil-moved-skill-lock"),holder.remove()}}let tab=shared.tabs.spellbook?.tab;for(let el of tab?.querySelectorAll(".spellcasting-notes")??[]){let emptyNotes=!0;for(let nel of el.querySelectorAll("textarea")??[])if(nel.textContent.length>0)emptyNotes=!1;if(emptyNotes)el.remove()}}function enable34(){Ancillary.register("actor",discourageSourceless)}function disable33(){Ancillary.unregister("actor",discourageSourceless)}new Feature({setting:"discourage-sourceless",label:"Discourage Sourceless",hint:"Removes input elements for sourceless notes or bonuses that can be added in their actual sources, and adjusts layout to compensate.",category:"actor-sheet",enable:enable34,disable:disable33,stage:"ready"});init_config();init_common();function missingBitsWarnings(sheet,html,_data,shared){if(html instanceof jQuery)html=html[0];if(!sheet.isEditable)return;if(!shared.coreSheet)return;if(sheet.actor.getFlag(CFG.id,"overrides")?.complete)return;let actor=sheet.actor,actorData=shared.systemData,featTab=shared.tabs.feats?.tab,feats=actor.getFeatCount(),active=feats.active;if(feats.max!==active){let diff=active-feats.max,featsUsed=featTab?.querySelector(".tab-footer table td");if(featsUsed)addWarning(featsUsed,i18n.get("LittleHelper.Warning.FeatMismatch")),featsUsed.append(createNode("span",` (${Math.abs(diff)} ${diff<0?" missing":" excess"})`,["lil-diff"]))}let skillTab=shared.tabs.skills?.tab;if(skillTab){let srInfo=skillTab.querySelector(".skill-rank-info");if(srInfo){let skillRanksMax=srInfo.querySelector(".ranks-max"),skillRanksUsed=srInfo.querySelector(".ranks-used"),available=parseInt(skillRanksMax.innerText,10),used=parseInt(skillRanksUsed.innerText,10),diff=used-available;if(diff!==0)addWarning(skillRanksUsed,i18n.get("LittleHelper.Warning.SkillMismatch")),skillRanksUsed.append(createNode("span",` (${Math.abs(diff)} ${diff<0?" missing":" excess"})`,["lil-diff"]));let bgRanksMax=srInfo.querySelector(".ranks-max-bg"),bgRanksUsed=bgRanksMax?srInfo.querySelector(".ranks-used-bg"):void 0;if(bgRanksUsed){let available2=parseInt(bgRanksMax.innerText,10),used2=parseInt(bgRanksUsed.innerText,10),diff2=used2-available2;if(diff2!==0)addWarning(bgRanksUsed,i18n.get("LittleHelper.Warning.SkillMismatch")),bgRanksUsed.append(createNode("span",` (${Math.abs(diff2)} ${diff2<0?" missing":" excess"})`,["lil-diff"]))}for(let el of skillTab?.querySelectorAll('[data-skill] .skill-name input[type="text"]')??[])if(el.value.trim().length===0)el.closest("[data-skill]")?.classList.add("lil-missing-skill-name")}}let spellTab=shared.tabs.spellbook?.tab;for(let el of spellTab?.querySelectorAll(".spell-uses .spell-slots")??[]){let left=parseInt(el.querySelector('[data-dtype="Number"]')?.textContent.trim(),10);if(left<0||!el.classList.contains("spontaneous")&&left>0)el.classList.add("lil-warning")}let clss=shared.tabs.summary?.tab;if(clss){let fcb=0;for(let cls of shared.items.byType.class?.all??[]){let{alt,hp,skill}=cls.system.fc;fcb+=alt.value+hp.value+skill.value}if(fcb===0)clss.querySelector(".classes-body .item-list-header .item-name").append(createNode("label","No FCB on any class.",["lil-warning","lil-box","lil-fcb-notification"]))}let languages=unifyProficiency(actorData.traits.languages);if(languages&&!shared.isMindless){let minLang=actorData.abilities.int.mod+(actorData.skills.lin.rank??0)+1;if(languages.length<minLang){let list=shared.tabs.attributes?.tab?.querySelector('[data-options="languages"]')?.closest(".form-group")?.querySelector(".traits-list");if(list)list.append(constructWarning(i18n.get("LittleHelper.Warning.TooFewLanguages",{granted:minLang,missing:minLang-languages.length}))),list.classList.add("lil-warning"),list.closest(".traits .form-group")?.classList.add("lil-warning")}}if(unifyProficiency(actorData.traits.armorProf).length===0){let aEl=shared.tabs.attributes?.tab?.querySelector('[for="system.traits.armorProf"]')?.closest("form-group")?.querySelector(".traits-list");if(aEl)aEl.append(constructWarning(i18n.get("LittleHelper.Warning.NoArmorProf"))),aEl.classList.add("lil-warning"),aEl.closest(".traits .form-group")?.classList.add("lil-warning")}if(unifyProficiency(actorData.traits.weaponProf).length===0){let wEl=shared.tabs.attributes?.tab?.querySelector('[for="system.traits.weaponProf"]')?.closest("form-group")?.querySelector(".traits-list");if(wEl)wEl.append(constructWarning(i18n.get("LittleHelper.Warning.NoWeaponProf"))),wEl.classList.add("lil-warning"),wEl.closest(".traits .form-group")?.classList.add("lil-warning")}}function enable35(){Ancillary.register("actor",missingBitsWarnings)}function disable34(){Ancillary.unregister("actor",missingBitsWarnings)}new Feature({setting:"missing-bits",category:"actor-sheet",enable:enable35,disable:disable34,stage:"ready"});init_config();init_common();var checkForEmpty=["attributes.hpAbility","attributes.init.ability","attributes.cmbAbility","attributes.attack.meleeAbility","attributes.attack.rangedAbility","attributes.ac.normal.ability","attributes.ac.touch.ability","attributes.cmd.strAbility","attributes.cmd.dexAbility","attributes.savingThrows.fort.ability","attributes.savingThrows.ref.ability","attributes.savingThrows.will.ability"];function warnMissingSettings(sheet,html,options,shared){let actor=sheet.actor,data=shared.systemData,settings=html.querySelector('.sheet-navigation.tabs [data-tab="settings"]'),tab=shared.tabs?.settings?.tab;if(!tab)return;let badAbls=!1,colors=CFG.console.colors;for(let attr of checkForEmpty){let v=foundry.utils.getProperty(data,attr);if(!(v in data.abilities))console.log(`[%cERROR%c] %c${attr}`,colors.error,colors.unset,colors.label,{ability:v},"not found"),tab.querySelector(`[name="system.${attr}"],[data-name="system.${attr}"]`).classList.add("lil-select-value"),badAbls=!0}if(badAbls&&!!settings)settings.classList.add("lil-angry-warning-glow")}function enable36(){Ancillary.register("actor",warnMissingSettings)}function disable35(){Ancillary.unregister("actor",warnMissingSettings)}new Feature({setting:"missing-ability-links",label:"Unlinked Ability Scores",hint:"Add warnings about missing ability score links.",category:"actor-sheet",enable:enable36,disable:disable35,stage:"ready"});init_config();init_common();class BioNotesApp extends FormApplication{constructor(actor,options){super(actor,options);let bio=this.options.type==="bio";this.options.id=actor.uuid+"-"+(bio?"bio-popout":"notes-popout"),this.options.title=actor.name+": "+(bio?"Biography":"Notes"),actor.apps[this.appId]=this}get template(){return`modules/${CFG.id}/templates/bionotes-popout.hbs`}static get defaultOptions(){let options=super.defaultOptions;return{...options,classes:[...options.classes,"koboldworks","bionotes","pf1"],resizable:!0,width:520,height:580,closeOnSubmit:!1,submitOnClose:!0,submitOnChange:!0}}get actor(){return this.object}get document(){return this.object}get isEditable(){let actor=this.actor,editable=this.options.editable&&actor.isOwner;if(actor.pack){if(game.packs.get(actor.pack).locked)editable=!1}return editable}async getData(){let context=super.getData(),actor=this.actor,actorData=actor.system;context.data=actorData;let bio=this.options.type==="bio",rollData=actor.getRollData();return context.raw=bio?actorData.details.biography.value:actorData.details.notes.value,context.target=bio?"system.details.biography.value":"system.details.notes.value",context.enriched=await pf1.utils.enrichHTMLUnrolled(context.raw,{rollData,secrets:actor.isOwner}),context.editable=this.isEditable,context}_updateObject(event2,formData){if(!foundry.utils.isEmpty(formData))this.actor.update(formData)}static open(actor,options){let old=Object.values(actor.apps).find((a)=>a instanceof BioNotesApp&&a.options.type===options.type);if(old)old.render(!0,{focus:!0});else new BioNotesApp(actor,options).render(!0,{focus:!0})}close(...args){delete this.actor.apps[this.appId],super.close(...args)}}function enableTabPopout(sheet,html){let actor=sheet.actor,tabs=html.querySelector('form nav.tabs[data-group="primary"]'),hint="LittleHelper.UI.PopTabHint",bio=tabs?.querySelector('[data-tab="biography"');if(bio)addCoreTooltip(bio,"LittleHelper.UI.PopTabHint"),bio.addEventListener("contextmenu",(event2)=>{event2.preventDefault(),event2.stopPropagation(),BioNotesApp.open(actor,{type:"bio"})});let notes=tabs?.querySelector('[data-tab="notes"]');if(notes)addCoreTooltip(notes,"LittleHelper.UI.PopTabHint"),notes.addEventListener("contextmenu",(event2)=>{event2.preventDefault(),event2.stopPropagation(),BioNotesApp.open(actor,{type:"notes"})})}function enable37(){Ancillary.register("actor",enableTabPopout)}function disable36(){Ancillary.unregister("actor",enableTabPopout)}new Feature({setting:"bionotes-popout",label:"Bio & Notes Popout",hint:"Allow popping out bio and notes with right click on tab header.",category:"actor-sheet",enable:enable37,disable:disable36,stage:"ready"});init_config();init_common();var doKeen=(cr)=>21-(21-cr)*2,sheetKeen=(sheet,html,options,shared)=>{let{item,action}=shared;if(!(item?.flags?.lilhelper?.item?.keen??!1))return;let crEl=html.querySelector('[name="ability.critRange"],[name="system.ability.critRange"]');if(crEl){if(item.system.broken){crEl.after(createNode("span",`${i18n.get("PF1.Broken")}: 20`,["lil-critrange-display","broken"]));return}let cr=action.ability?.critRange??20;crEl.after(createNode("span",`Keen: ${doKeen(cr)} – 20`,["lil-critrange-display","keen"]))}};function keenCritRange(wrapped){let cr=wrapped.call(this),item=this.item??this.action?.item,isBroken=item.system.broken??!1,keen=item?.flags?.lilhelper?.item?.keen??!1;return!isBroken&&keen?doKeen(cr):cr}function enable38(){let C=CFG.console.colors;console.log("%cLittle Helper%c \uD83E\uDD8E | Overriding ChatAttack.critRange",C.main,C.unset),libWrapper.register(CFG.id,"pf1.components.ItemAction.prototype.critRange",keenCritRange,libWrapper.WRAPPER),Ancillary.register("action",sheetKeen)}Hooks.once("setup",enable38);init_config();var POWER_ATTACK_FLAG="autoPowerAttack";function preCreateActionUse(actionUse){let{shared,item}=actionUse;if(item.flags?.lilhelper?.item?.[POWER_ATTACK_FLAG]??!1){let C=CFG.console.colors;console.log("%cLittle Helper%c \uD83E\uDD8E | Auto enabling Power Attack",C.main,C.unset),shared.useOptions.powerAttack??=!0}}var enable39=()=>{Hooks.on("pf1CreateActionUse",preCreateActionUse)};Hooks.once("setup",()=>enable39());var forceRoll=(item,options)=>{if(!options.dice){let roll=item.flags?.lilhelper?.item?.rollOverride??null;if(roll)options.dice=roll}};Hooks.on("little-helper.useAttackWrapper",forceRoll);init_config();var fetchForceModeSetting=(item)=>{let rawRollMode=item.flags?.lilhelper?.item?.rollmodeOverride;if(rawRollMode){let rollMode=Object.keys(CFG.ROLLMODES).includes(rawRollMode)?rawRollMode:null;if(rollMode==="roll")rollMode="publicroll";return rollMode??null}return null},forceRollMode=(item,options)=>{if(!options.rollMode){let mode=fetchForceModeSetting(item);if(mode&&options.rollMode!==mode)options.rollMode=mode}};Hooks.on("little-helper.useAttackWrapper",forceRollMode);var hideAttacks=(cm,html)=>{let item=cm.itemSource;if(!item?.hasAttack)return;if(!(item.flags?.lilhelper?.item?.hideAttacks??!1))return;for(let el of html.querySelectorAll(".chat-attack td[colspan] .inline-roll.inline-result"))el.closest("tr")?.remove()};Ancillary.register("chat",hideAttacks);function sharedItemData(sheet,html,options,shared){}Ancillary.register("item",sharedItemData,{priority:1000});init_config();function useAttackWrapper(wrapped,options={}){return Hooks.call("little-helper.useAttackWrapper",this,options),wrapped.call(this,options)}Hooks.once("setup",()=>{let C=CFG.console.colors;console.log("%cLittle Helper%c \uD83E\uDD8E | Overriding Item#use",C.main,C.unset),libWrapper.register(CFG.id,"pf1.documents.item.ItemPF.prototype.use",useAttackWrapper,libWrapper.WRAPPER)});init_common();function injectActionDisplay(sheet,html,options){if(!sheet.item)return;let h=html.querySelector(".header-details .summary");if(!h)return;let list=createNode("ul",void 0,["lil-entry-info","summary"]);if(Hooks.callAll("little-helper.item.header.properties",sheet,list),list.childNodes.length>0)h.after(list)}function enable40(){Ancillary.register("item",injectActionDisplay)}function disable37(){Ancillary.unregister("item",injectActionDisplay)}new Feature({setting:"item-header-enrichment",label:"Header Enrichment",hint:"Display more info in the item sheet header, such as used action and identified status.",category:"items",enable:enable40,disable:disable37,stage:"ready"});init_common();function clarifyDisabledFeature(sheet,html,opts,shared){if(sheet.document.isActive)return;let disabled=html.querySelector('[name="system.disabled"]'),warning=createNode("i",null,["fa-solid","fa-exclamation-triangle","warning-symbol"]),p=disabled?.parentElement;if(!p)return;p.append(warning),p.classList.add("lil-warning-glow")}Ancillary.register("item",clarifyDisabledFeature);var nameToIconMap={"system.enh":["ra","ra-fairy-wand","lil-icon-enhancement"],"system.armor.enh":["ra","ra-fairy-wand","lil-icon-enhancement"],"system.armor.value":["ra","ra-shield","lil-icon-armor"],"system.armor.acp":["fa-solid","fa-mitten","lil-icon-acp"],"system.target.value":["fa-solid","fa-bullseye","lil-icon-target"],"system.range.units":["fa-solid","fa-ruler","lil-icon-distance"],"system.area":["fa-solid","fa-ruler-combined","lil-icon-area"],"system.duration.units":["fa-solid","fa-hourglass-start","lil-icon-time"],"system.spellDuration":["fa-solid","fa-hourglass-start","lil-icon-time"],"system.uses.per":["fa-solid","fa-battery-half","lil-icon-armor"],"system.attackBonus":["ra","ra-axe-swing","lil-icon-attack"],"system.ability.critRange":["ra","ra-decapitation","lil-icon-critical"]};function compatiblePathName(path){return/^system\./.test(path)?path:`system.${path}`}function extraIcons(sheet,html,options,shared){let inputs=html.querySelectorAll("input[name],select[name]");for(let input of inputs){let iconCss=nameToIconMap[compatiblePathName(input.name)];if(!iconCss)continue;let label=input.closest(".form-group")?.querySelector("label");if(!label)continue;let icon=document.createElement("i");icon.classList.add(...iconCss,"lil-extra-icon"),label.append(icon)}}function enable41(){Ancillary.register("item",extraIcons),Ancillary.register("action",extraIcons)}function disable38(){Ancillary.unregister("item",extraIcons),Ancillary.unregister("action",extraIcons)}new Feature({setting:"extra-icons",label:"Extra Icons",hint:"Add extra icons to help find relevant info faster.",category:"items",enable:enable41,disable:disable38,stage:"ready"});init_common();function hitPointRetrainCapacity(sheet,html,options,shared){let item=sheet.document;if(!item.actor||item.type!=="class")return;let{hitDice:hd,system:itemData}=item,hp=itemData.hp,hdSize=itemData.hd,maxHp=hdSize*hd,missing=maxHp-hp;if(missing<=0)return;let hpEl=html.querySelector('input[name="system.hp"]');if(!hpEl)return;hpEl.after(createNode("label",i18n.get("LittleHelper.Info.RetrainPotential",{missing,max:maxHp}),["lil-retrain-capacity","hit-points"]))}function enable42(){Ancillary.register("item",hitPointRetrainCapacity)}function disable39(){Ancillary.unregister("item",hitPointRetrainCapacity)}new Feature({setting:"class-hitpoint-retrain-capacity",label:"Hit Point Retrain Potential",hint:"Display how much hit points could be retrained.",category:"items",enable:enable42,disable:disable39,stage:"ready"});init_common();var line=(selectors)=>createNode("li",null,["item-detail",...selectors]);async function addBuffDuration(sheet,props){let item=sheet.item;if(!item.isActive)return;if(item.type!=="buff")return;let durLine=line(["lil-property","duration"]),ae=item.effect;if(!ae)return;let s=ae.duration?.seconds??0,ht=getHumanTime(s),tt=s>0?ht.n:"Infinite",tu=s>0?humanTimeUnit[ht.u]?.long:"";if(durLine.append(i18n.get("PF1.EnrichedText.Condition.Duration",{period:tt,unit:tu})),props.append(durLine),s<=0)return;let{n,u}=getHumanTime(ae.duration.remaining),remLine=line(["lil-property","remaining"]);remLine.append(i18n.get("Koboldworks.Missing.PF1.DurationLeft",{time:n,unit:humanTimeUnit[u].long})),props.append(remLine)}function enable43(){Hooks.on("little-helper.item.header.properties",addBuffDuration)}function disable40(){Hooks.off("little-helper.item.header.properties",addBuffDuration)}new Feature({setting:"buff-item-duration-display",label:"Buff Duration Display",hint:"Displays remaining duration in buff item sheet. This is NOT updated except on sheet re-open. Requires header enrichment to be enabled.",category:"items",enable:enable43,disable:disable40,stage:"ready"});init_config();init_common();function addWarning2(el,text){let n=createNode("i",void 0,["fa-solid","fa-exclamation-triangle","lil-warning-icon"]);if(text)hookCoreTooltip(n,{fn:()=>text});el.before(n)}function missingActionBits(doc,html,shared){let data=shared.systemData;if(data.usesAmmo&&!data.ammoType){let type=html.querySelector('select[name="ammoType"],select[name="system.ammoType"]');if(type)addWarning2(type,"Missing selection with ammo usage enabled."),type.classList.add("lil-missing-input")}if(!data.range?.units){let rng=html.querySelector('select[name="range.units"],select[name="system.range.units"]');if(rng)addWarning2(rng,"No range defined."),rng.classList.add("lil-missing-input")}if(data.actionType==="save"&&data.save.dc==0){let dc=html.querySelector('input[name="save.dc"],input[name="system.save.dc"]');if(dc)addWarning2(dc,"Missing saving throw DC."),dc.classList.add("lil-missing-input")}let sdc=data.save?.dc;if(["save","spellsave"].includes(data.actionType)||sdc!==void 0&&sdc!=0){let type=data.save?.type;if(type!==void 0&&type==0){let st=html.querySelector('select[name="save.type"],select[name="system.save.type"]');if(st)addWarning2(st,"No save type selected."),st.classList.add("lil-missing-input")}let desc=data.save?.description;if(desc!==void 0&&desc==0){let sd=html.querySelector('input[name="save.description"],input[name="system.save.description"]');if(sd)addWarning2(sd,"No save effect defined."),sd.classList.add("lil-missing-input")}}if(data.measureTemplate!==void 0&&data.measureTemplate.type!=0){if(data.measureTemplate.size===0){let mts=html.querySelector('input[name="measureTemplate.size"],input[name="system.measureTemplate.size"]');if(mts)addWarning2(mts,"No template size defined."),mts.classList.add("lil-missing-input")}if(data.measureTemplate.customColor==0){let mcc=html.querySelector('input[name="measureTemplate.customColor"],input[name="system.measureTemplate.customColor"]');if(mcc)addWarning2(mcc,"No override color defined."),mcc.classList.add("lil-missing-input")}if(data.measureTemplate.customTexture==0){let mct=html.querySelector('input[name="measureTemplate.customTexture"],input[name="system.measureTemplate.customTexture"]');if(mct)addWarning2(mct,"No override texture defined."),mct.classList.add("lil-missing-input")}}}function missingItemBits(sheet,html,options,shared){let{systemData:data,document:doc}=shared,isRealAction=doc instanceof pf1.components.ItemAction;if(doc instanceof pf1.components.ItemAction)missingActionBits(doc,html,shared);if(!isRealAction){let docData=shared.systemData,tab=shared.tabs.description?.tab;if(!tab)return;if(docData.identified===!1&&game.user.isGM){if((docData.description?.unidentified||"").length===0)tab.querySelector('.sheet-navigation.subtabs [data-tab="unidentified"]')?.append(" ",createNode("span","(n/a)",["lil-not-described","lil-unidentified-warning"]));if((docData.unidentified?.price||0)==0)tab.querySelector('[data-attr-name="system.unidentified.price"]')?.firstElementChild?.classList.add("lil-not-priced","lil-unidentified-warning")}}}function enable44(){Ancillary.register("item",missingItemBits),Ancillary.register("action",missingItemBits)}function disable41(){Ancillary.unregister("item",missingItemBits),Ancillary.unregister("action",missingItemBits)}new Feature({setting:"missing-item-bits",label:"Missing Bits",hint:"Add warnings about missing bits.",category:"items",enable:enable44,disable:disable41,stage:"ready"});init_common();function createValue(value){let c=createNode("label",null,["lil-resolved-value"]);return c.append("=",createNode("span",value,["value"])),c}function resolveActorValues(sheet,html,options,shared){let actor=sheet.actor;if(!["character","npc"].includes(actor.type))return;if(!shared.coreSheet&&!shared.altSheetZenvy)return;let rollData=shared.rollData,bookTab=shared.tabs.spellbook?.tab;if(bookTab)for(let el of bookTab.querySelectorAll(".spellcasting-ability select[name]")){let abl=el.value,mod=rollData.abilities[abl]?.mod;if(Number.isFinite(mod)){let value=createValue(`${signNum(mod)}`);el.after(value)}}}function resolveItemValues(sheet,html,options,shared){if(!shared.systemDocument)return;let data=shared.systemData;if(!shared.actor)return;let rollData=shared.rollData;if(data.ability?.attack){let ablAtk=html.querySelector('[name="ability.attack"],[name="system.ability.attack"]'),mod=rollData.abilities[data.ability?.attack].mod,value=createValue(signNum(mod));ablAtk?.after(value)}if(data.ability?.damage){let ablMult=html.querySelector('[name="ability.damageMult"],[name="system.ability.damageMult"]'),abl=data.ability?.damage,mult=data.ability?.damageMult,mod=rollData.abilities[abl].mod,value=createValue(signNum(Math.floor(mod*mult)));ablMult?.after(value)}let rngUnits=rollData.action?.range?.units??rollData.item.range?.units;if(["melee","reach"].includes(rngUnits))html.querySelector('[name="range.units"],[name="system.range.units"]')?.after(createValue(rollData.range[rngUnits]));let rngMinUnits=rollData.action?.range?.minUnits??rollData.item.range?.minUnits;if(["melee","reach"].includes(rngMinUnits))html.querySelector('[name="range.minUnits"],[name="system.range.minUnits"]')?.after(createValue(rollData.range[rngMinUnits]))}function enable45(){Ancillary.register("action",resolveItemValues),Ancillary.register("item",resolveItemValues),Ancillary.register("actor",resolveActorValues)}function disable42(){Ancillary.unregister("action",resolveItemValues),Ancillary.unregister("item",resolveItemValues),Ancillary.unregister("actor",resolveActorValues)}new Feature({setting:"resolve-values",label:"Resolve Values",hint:"Resolves some indirect values to their actual numbers.",category:"common",enable:enable45,disable:disable42,stage:"ready"});init_config();init_common();function addNoActionWarning(sheet,html,options,shared){let{document:item,systemData:itemData}=shared;if(itemData.actions===void 0)return;if(itemData.actions.length>0)return;html.querySelector(".actions .action-parts")?.append(createNode("div","No Actions",["warning","no-actions"]))}function enable46(){Ancillary.register("item",addNoActionWarning)}enable46();function disableUnusuableDetails(sheet,html,options,shared){let item=sheet.document,inner=html.querySelector("section"),disable43=[];if(item.spellbook){let spellPoints=item.spellbook.spellPoints?.useSystem??!1,isPrepared=item.spellbook.spellPreparationMode!=="spontaneous";disable43.push({enabled:spellPoints,selectors:['[name="system.preparation.preparedAmount"]','[name="system.preparation.maxAmount"]','[name="system.slotCost"]']},{enabled:!spellPoints&&isPrepared,selectors:['[name="system.spellPoints.cost"]']})}disable43.push({enabled:!!item.links.charges,selectors:['[name="system.uses.maxFormula"]','[name="system.uses.per"]','[name="system.uses.value"]']});for(let r of disable43){if(!r.enabled)continue;for(let s of r.selectors){let sel=inner.querySelector(s);if(sel)sel.disabled=!0,sel.readOnly=!0,sel.parentElement.classList.add("lil-disabled")}}}function enable47(){Ancillary.register("item",disableUnusuableDetails)}function disable43(){Ancillary.unregister("item",disableUnusuableDetails)}new Feature({setting:"item-disable-unusable-details",label:"Disable unusable details",hint:"Disables/removes details from item sheet that are not usable with their current configuration.",category:"items",enable:enable47,disable:disable43,stage:"ready"});function skipDialogOnUse(item,options){let skip=item.flags?.lilhelper?.item?.skipDialog??0;if(skip<0)options.skipDialog=!0;else if(skip>0)options.skipDialog=!1}Hooks.on("little-helper.useAttackWrapper",skipDialogOnUse);init_config();init_icons();init_common();function renderItemSheet(sheet,html,options,shared){let button=html.closest(".app[data-appid]")?.querySelector("header > .little-helper-unidentified-view");if(button)addCoreTooltip(button,"Unidentified View")}function addViewToggle(sheet,buttons){if(sheet.item.system.identified)return;if(sheet.item.system.identified===void 0)return;let C=CFG.console.colors;buttons.unshift({class:"little-helper-unidentified-view",icon:FAIcons.eyeSlash,onclick:()=>{let pv=sheet.__littleHelper?.unidentifiedView??!1;if(pv)console.log("%cLittle Helper%c \uD83E\uDD8E | Returning to Normal View",C.main,C.unset),delete sheet.__littleHelper.unidentifiedView;else console.log("%cLittle Helper%c \uD83E\uDD8E | Swapping to unidentified View",C.main,C.unset),sheet.__littleHelper??={},sheet.__littleHelper.unidentifiedView=!0;sheet.render(!1,{__lilUnidentifiedView:!pv})}})}async function getDataWrapper(wrapped,...args){let rv=await wrapped.call(this,...args);if(this.__littleHelper?.unidentifiedView??!1){rv.isGM=!1;let isIdentified=rv.system.identified;rv.showUnidentifiedData=!0,rv.showIdentifyDescription=!1,rv.itemName=rv.system.unidentified.name,rv.descriptionAttributes=rv.descriptionAttributes.filter((d)=>{switch(d.name){case"system.unidentified.price":d.label=i18n.get("PF1.Price");break;case"system.price":return!1}return!0})}return rv}function renderWrapper(wrapped,force,options={}){if(game.user.isGM)this.__littleHelper??={},this.__littleHelper.unidentifiedView=options.__lilUnidentifiedView??!1;return wrapped.call(this,force,options)}function enable48(){if(!game.user.isGM)return;Ancillary.register("item",renderItemSheet),Hooks.on("getItemSheetHeaderButtons",addViewToggle),libWrapper.register(CFG.id,"pf1.applications.item.ItemSheetPF.prototype.render",renderWrapper,libWrapper.WRAPPER),libWrapper.register(CFG.id,"pf1.applications.item.ItemSheetPF.prototype.getData",getDataWrapper,libWrapper.WRAPPER)}function disable44(){if(!game.user.isGM)return;Ancillary.unregister("item",renderItemSheet),Hooks.off("getItemSheetHeaderButtons",addViewToggle),libWrapper.unregister(CFG.id,"pf1.applications.item.ItemSheetPF.prototype.render",renderWrapper),libWrapper.unregister(CFG.id,"pf1.applications.item.ItemSheetPF.prototype.getData",getDataWrapper)}new Feature({setting:"item-unidentified-view",label:"Simulated Unidentified View",hint:"Adds header button to items to toggle partially simulated unidentified view of the item, as player would see it.",category:"items",enable:enable48,disable:disable44,stage:"ready",gm:!0});init_common();class Pricing{static forWand(sl,cl,mcost=0,uses=50){return 750*clampNum(sl,0.5,9)*clampNum(cl,1,100)+mcost*uses}static forWandFormula(){return"750 * @sl * @cl + (@materials * @uses)"}static forPotion(sl,cl,mcost=0){return 50*clampNum(sl,0.5,9)*clampNum(cl,1,100)+mcost}static forPotionFormula(){return"50 * @sl * @cl + @materials"}static forScroll(sl,cl,mcost=0){return 25*clampNum(sl,0.5,9)*clampNum(cl,1,100)+mcost}static forScrollFormula(){return"25 * @sl * @cl + @materials"}static forScribing(sl,_cl){return Math.max(5,Math.pow(sl,2)*10)}static forScribingFormula(){return"@sl ^ 2 * 10"}}function enrichCreateConsumable(app){if(!app.options.classes.includes("create-consumable"))return;let html=app.element.querySelector("form"),allowScribing=!!app.options.buttons.spell,content=html.querySelector(".dialog-content"),buttons=html.querySelector("footer"),d=createNode("div",null,["flexrow","lil-consumable-cost"]),scribeCost=createNode("span","0",["value"]),potionCost=createNode("span","0",["value"]),scrollCost=createNode("span","0",["value"]),wandCost=createNode("span","0",["value"]),bPot=buttons.querySelector('button[data-action="potion"]'),bScrl=buttons.querySelector('button[data-action="scroll"]'),bWand=buttons.querySelector('button[data-action="wand"]'),bSpl=buttons.querySelector('button[data-action="spell"]'),inSL=content?.querySelector('input[name="sl"]'),inCL=content?.querySelector('input[name="cl"]'),itemData=app.options?.itemData??{},mcost=Number(itemData.system?.materials?.gpValue||0),cl=0,sl=0;function updateValues(){if(cl=parseInt(inCL.value)||1,sl=parseInt(inSL.value),!Number.isFinite(sl))sl=1;potionCost.textContent=`${Pricing.forPotion(sl,cl,mcost)}`,scrollCost.textContent=`${Pricing.forScroll(sl,cl,mcost)}`;let wcost=Pricing.forWand(sl,cl,mcost);wandCost.textContent=`${wcost}`,scribeCost.textContent=`${Pricing.forScribing(sl,cl)}`;let notPot=sl>3;bPot.classList.toggle("impossible",notPot)}let scribeCostL=createNode("h4"," gp",["scroll","cost","type"]),potionCostL=createNode("h4"," gp",["potion","cost","type"]),wandCostL=createNode("h4"," gp",["wand","cost","type"]),scrollCostL=createNode("h4"," gp",["scribe","cost","type"]);if(hookCoreTooltip(potionCostL,{fn:()=>Pricing.forPotionFormula()}),allowScribing)hookCoreTooltip(scribeCostL,{fn:()=>i18n.get("LittleHelper.Scribing")+"<br>"+Pricing.forScribingFormula()});let wcostChL=i18n.get("PF1.PricePerCharge");if(hookCoreTooltip(wandCostL,{fn:()=>{let wcost=Pricing.forWand(sl,cl,mcost);return Pricing.forWandFormula()+`<br>${wcostChL}: ${maxPrecision(wcost/50,2)}`}}),hookCoreTooltip(scrollCostL,{fn:()=>Pricing.forScrollFormula()}),scrollCostL.prepend(scrollCost),allowScribing)scribeCostL.prepend(scribeCost);if(potionCostL.prepend(potionCost),wandCostL.prepend(wandCost),mcost>0){let mcostEl=createNode("div",null,["lil-material-cost"]);mcostEl.classList.add("form-group"),mcostEl.append(createNode("label","Material Cost"),createNode("span",`${mcost} gp`,["value"])),content.append(mcostEl)}if(d.append(potionCostL,scrollCostL,wandCostL),allowScribing)d.append(scribeCostL);content.append(d);for(let el of[inSL,inCL])el.addEventListener("change",updateValues,{passive:!0});updateValues(),setTimeout(()=>app.setPosition({height:"auto"}),100)}function enable49(){Hooks.on("renderDialogV2",enrichCreateConsumable)}function disable45(){Hooks.off("renderDialogV2",enrichCreateConsumable)}new Feature({setting:"enrich-create-consumable",label:"Enrich Create Consumable",hint:"Displays expected item cost in the consumable creation dialog.",category:"dialog",enable:enable49,disable:disable45,stage:"ready"});init_common();function getSources(actor,abl){return pf1.documents.actor.changes.getHighestChanges(actor.changes.filter((c)=>c.target===abl),{ignoreTarget:!0}).sort((a,b)=>a.priority-b.priority)}function updateTotal(d){let bonus=0;for(let c of d.sources){if(c.operator!=="add")continue;bonus+=c.value}d.bonus.textContent=signNum(bonus);let total=d.base+bonus;d.total.textContent=`${total}`;let mod=pf1.utils.getAbilityModifier(total);d.mod.textContent=signNum(mod)}function enrichPointBuy(app,html,options){let abilities={},actor=app.document;html=html.querySelector(".window-content"),app.element.classList.add("lil-enriched-pointbuy");for(let el of html.querySelectorAll("li[data-ability]")){let abl=el.dataset.ability,d=abilities[abl]={key:abl,data:actor.system.abilities[abl],get base(){return app.abilities.find((i)=>i.key===abl).value},li:el,bonus:createNode("span","0",["lil-ability-bonus"],{tooltip:"Bonuses"}),total:createNode("span","00",["lil-ability-total"],{tooltip:"Total"}),mod:createNode("span","0",["lil-ability-mod"],{tooltip:"Modifier"}),t:void 0,get sources(){return getSources(actor,abl)}},abs=createNode("div",void 0,["ability-setup"]),v=el.querySelector(".value");if(v.previousElementSibling.before(abs),abs.append(v.previousElementSibling,v,v.nextElementSibling),pf1.config.abilityCost[d.base]===void 0)v.classList.add("lil-out-of-range");let final=createNode("div",void 0,["lil-ability-total-holder"]);final.append(d.total,d.mod),el.append(d.bonus,final),updateTotal(abilities[abl])}}function enable50(){Hooks.on("renderPointBuyCalculator",enrichPointBuy)}function disable46(){Hooks.off("renderPointBuyCalculator",enrichPointBuy)}new Feature({setting:"pointbuy-enricher",label:"Point Buy Enricher",hint:"Enriches point buy calculator with currently active bonuses and displays final ability score and its bonus.",category:"dialog",enable:enable50,disable:disable46,stage:"ready"});init_config();init_common();class XPChartDialog extends Application{constructor(app,options){super(options);this.configDialog=app,this._onRender=this.render.bind(this),Hooks.on("renderExperienceConfig",this._onRender)}close(...args){Hooks.off("renderExperienceConfig",this._onRender),super.close(...args)}get template(){return`modules/${CFG.id}/templates/dialog/xp-chart.hbs`}static get defaultOptions(){let options=super.defaultOptions;return{...options,title:i18n.get("LittleHelper.XPTable.Short"),id:"lil-xp-chart",classes:[...options.classes,"pf1","lil-xp-chart"],height:"auto",width:"auto"}}getData(){let html=this.configDialog.element;if(html instanceof jQuery)html=html[0];let track=html.querySelector('select[name="track"]').value,custom=html.querySelector('input[name="custom.formula"]')?.value||"",trackXp=pf1.config.CHARACTER_EXP_LEVELS[track]?.map((i)=>({total:i}));if(trackXp)for(let i=19;i>=0;i--){let entry=trackXp[i],prev=trackXp[i-1]??{total:0,value:0};entry.value=entry.total-prev.total}else{trackXp=Array.fromRange(20).map((idx)=>({value:RollPF.safeRollSync(custom||"0",{level:idx+1}).total})),trackXp[0].value=0;for(let i=0;i<20;i++){let prev=trackXp[i-1]??{total:0},cur=trackXp[i];cur.total=prev.total+cur.value}}for(let i=1;i<20;i++){let t=trackXp[i];t.level=i+1;let p=trackXp[i-1]??{value:0};if(t.pct=pf1.utils.limitPrecision(t.value/p.value*100-100,1),!Number.isFinite(t.pct))t.pct=null}trackXp.splice(0,1);for(let t of trackXp)t.total=formatNum(t.total),t.value=formatNum(t.value);return{track:trackXp}}}function injectXPChart(app,html){if(html instanceof jQuery)html=html[0];let track=html.querySelector('select[name="track"]'),i=document.createElement("i");i.classList.add("fa-solid","fa-table","fa-fw","lil-xp-chart"),i.dataset.action="open-xp-chart",i.dataset.tooltip="LittleHelper.XPTable.Title",track.before(i),i.addEventListener("click",(ev)=>{ev.preventDefault(),new XPChartDialog(app).render(!0)})}function enable51(){Hooks.on("renderExperienceConfig",injectXPChart)}function disable47(){Hooks.off("renderExperienceConfig",injectXPChart)}new Feature({setting:"xp-chart",category:"dialog",enable:enable51,disable:disable47,stage:"ready"});init_config();init_icons();var STATUS={error:-1,inprogress:1,unlocking:11,locking:12,finished:2,default:0},MSG={[STATUS.error]:"LittleHelper.Action.Migration.Status.Error",[STATUS.inprogress]:"LittleHelper.Action.Migration.Status.InProgress",[STATUS.locking]:"LittleHelper.Action.Migration.Status.Locking",[STATUS.unlocking]:"LittleHelper.Action.Migration.Status.Unlocking",[STATUS.finished]:"LittleHelper.Action.Migration.Status.Finished"},ICON={[STATUS.error]:"✘",[STATUS.inprogress]:"⏲",[STATUS.locking]:"\uD83D\uDD12",[STATUS.unlocking]:"\uD83D\uDD13",[STATUS.finished]:"✔"},{ApplicationV2:ApplicationV22,HandlebarsApplicationMixin:HandlebarsApplicationMixin2}=foundry.applications.api;class MigrationDialog extends HandlebarsApplicationMixin2(ApplicationV22){get pack(){return this.options.pack}static DEFAULT_OPTIONS={id:"lil-compendium-migration-{id}",classes:["lil-compendium-migration"],window:{icon:"fa-solid fa-soap"}};_initializeApplicationOptions(options){return options=super._initializeApplicationOptions(options),options.uniqueId=options.pack.metadata.id,options}get title(){return`Migrating Compendium: ${i18n.get(this.pack.title)}`}static PARTS={main:{template:`modules/${CFG.id}/templates/compendium-migration.hbs`}};#inProgress=!1;status="Initializing...";state="";_prepareContext(options){let status=this.status,type=this.pack.metadata.packageType,packageName;switch(type){case"system":packageName=game.system.title;break;case"module":packageName=game.modules.get(this.pack.metadata.packageName)?.title;break;case"world":packageName="World";break}return{pack:this.pack,packageName,state:{id:foundry.utils.invertObject(STATUS)[status],label:MSG[status],icon:ICON[status]},indexSize:Math.floor(JSON.stringify(this.pack.index).length/100)/10,docTotal:this.docTotal??"n/a",docAvg:this.docAvg??"n/a"}}_statusUpdate(state){let html=this.element;if(html instanceof jQuery)html=html[0];if(!html)return;let status=html.querySelector('.value[name="status"]');switch(this.status=state,status.textContent=ICON[state]+" "+i18n.get(MSG[state]),state){case STATUS.error:status?.classList.add("error"),this.state="error";break;case STATUS.locking:case STATUS.unlocking:case STATUS.inprogress:status?.classList.add("inprogress"),this.state="inprogress";break;case STATUS.finished:status?.classList.add("finished"),this.state="finished";break;default:break}}async _doMigration(){if(this.#migrationState=1,this.#inProgress)return;this.#inProgress=!0;let html=this.element;if(html instanceof jQuery)html=html[0];let pack=this.pack,wasLocked=pack.locked;if(wasLocked)this._statusUpdate(STATUS.unlocking),await pack.configure({locked:!1});if(this._statusUpdate(STATUS.inprogress),["Actor","Item","Scene"].includes(this.pack.metadata.type))await pf1.migrations.migrateCompendium(this.pack).catch((_)=>this._statusUpdate(STATUS.error)).then((_)=>this._statusUpdate(STATUS.finished));else await this.pack.migrate().catch((_)=>this._statusUpdate(STATUS.error)).then((_)=>this._statusUpdate(STATUS.finished));let docs=await pack.getDocuments(),totalDocData=docs.map((d)=>JSON.stringify(d.toObject()).length).reduce((t,o)=>t+o,0),doMB=totalDocData>=700000,divisor=doMB?1e5:100;this.docTotal=Math.floor(totalDocData/divisor)/10+(" "+(doMB?"MB":"kB")),this.docAvg=docs.length>0?Math.floor(totalDocData/docs.length/100)/10+" kB":0;let dt=html.querySelector('.value[name="doc-total"]'),da=html.querySelector('.value[name="doc-avg"]');if(dt.textContent=this.docTotal,da.textContent=this.docAvg,wasLocked)this._statusUpdate(STATUS.locking),await pack.configure({locked:!0}),this._statusUpdate(STATUS.finished);this.#inProgress=!1,this.#migrationState=2}#migrationState=0;_onRender(options){if(super._onRender(options),this.#migrationState===0)this._doMigration()}close(...args){delete this.pack.__lilMD,super.close(...args)}}async function migrateCompendium(html){if(pf1.migrations.isMigrating){ui.notifications.warn("Cancelled due to ongoing migration.");return}let packId=html.dataset.pack,pack=game.packs.get(packId),app=foundry.applications?.instances.get(`lil-compendium-migration-${packId}`);app??=new MigrationDialog({pack}),app.render(!0)}function addCompendiumMigrationContextOption(apphtml,entries){let exportEntry={name:"LittleHelper.Action.Migrate",icon:`<i class='${FAIcons.fileExport}'></i>`,callback:migrateCompendium};entries.push(exportEntry)}function enable52(){Hooks.on("getCompendiumContextOptions",addCompendiumMigrationContextOption)}function disable48(){return Hooks.off("getCompendiumContextOptions",addCompendiumMigrationContextOption),!1}new Feature({setting:"compendium-migration",label:"Compendium Migration",hint:"Allows easy migration of specific compendiums.",category:"foundry-ui",enable:enable52,disable:disable48,stage:"init",gm:!0});var nullText="n/a";function renderTokenHUD(hud,html){if(html instanceof jQuery)html=html[0];let sEl=html.querySelector("div.status-effects");if(!sEl)return;sEl.classList.add("lil-enhanced");let d=document.createElement("div");d.classList.add("status-effects-label"),d.textContent=nullText;let cs=getComputedStyle(sEl);d.style.cssText+=`--lil-width:${cs.width};width:calc(var(--lil-width) + 6px + 2px);`,sEl.before(d);let mouseOver=(ev)=>{let el=ev.target,hovering=el.matches("img.effect-control");d.textContent=hovering?el.dataset.tooltip:nullText,d.classList.toggle("none",!hovering)};sEl.addEventListener("pointerover",mouseOver,{passive:!0})}function enable53(){Hooks.on("renderTokenHUD",renderTokenHUD)}function disable49(){Hooks.off("renderTokenHUD",renderTokenHUD)}new Feature({setting:"tokenhud-effects",label:"Effects Menu Enhancements",hint:"Display labels for token HUD status options, improve layout, and make active effects more obvious.",category:"token-hud",enable:enable53,disable:disable49,stage:"ready"});init_common();function displayMacroOwners(app,html){if(html instanceof jQuery)html=html[0];if(!game.user.isGM)return;let doc=app.document,header=html.querySelector(".sheet-header");if(!header)return;let users=game.users?.players.filter((u)=>doc.testUserPermission(u,"OBSERVER"));if(users.length>0){let uls=createNode("ul",null,["lil-user-access"]);for(let u of users){let owner=doc.isOwner,uel=createNode("li",u.name,[owner?"owner":"observer"]);hookCoreTooltip(uel,{fn:()=>{let template=document.createDocumentFragment();return template.append(`ID: ${u.id}`,document.createElement("br"),`Permission: ${owner?"Owner":"Observer"}`),template},css:"lil-user-access"}),uls.append(uel)}header.after(uls)}if((doc.ownership.default??0)<CONST.DOCUMENT_OWNERSHIP_LEVELS.OBSERVER){let noPlayers=createNode("h3","No players see this macro by default.",["lil-user-warning"]);noPlayers.prepend(createNode("i"," ",["fa-solid","fa-exclamation-triangle"])),header.after(noPlayers)}}function enable54(){Hooks.on("renderMacroConfig",displayMacroOwners)}function disable50(){Hooks.off("renderMacroConfig",displayMacroOwners)}new Feature({setting:"macro-access",label:"User Access",hint:"Display user access to macros in their sheet.",category:"macro",enable:enable54,disable:disable50,stage:"ready",gm:!0});init_common();var makeTag=()=>createNode("span",void 0,["lil-tag"]);function macroDirectory(app,html){let list=html.querySelector(".directory-list");if(!list)return;list.classList.add("lil-enhanced-macro-directory");let isGM=game.user.isGM,userId=game.user.id,permlabels={0:i18n.get("LittleHelper.Macro.None"),1:i18n.get("LittleHelper.Macro.Visible"),2:i18n.get("LittleHelper.Macro.Executable"),3:i18n.get("LittleHelper.Macro.Editable")};for(let el of list.querySelectorAll(".entry[data-entry-id]")){let docId=el.dataset.entryId,macro=game.macros.get(docId);if(!macro)continue;let author=macro.author,name=author?author.name:`[${macro._source.author}]`,nel=el.querySelector(".entry-name");nel.classList.add("macro-name");let md=createNode("div",void 0,["lil-entry-info"]),aTag=makeTag();aTag.append(createNode("label",i18n.get("LittleHelper.Macro.Author")),createNode("span",name,["author-name"]));let defaultPerm=macro.ownership?.default??0,perm=isGM?3:macro.ownership[userId]??defaultPerm,pTag=makeTag();pTag.append(createNode("span",permlabels[perm],["permission"])),md.append(aTag,pTag),el.classList.add("lil-enriched-entry"),nel.append(md)}}function enable55(){Hooks.on("renderMacroDirectory",macroDirectory)}function disable51(){Hooks.off("renderMacroDirectory",macroDirectory)}new Feature({setting:"macro-directory",label:"Directory Enrichment",hint:"Enhance information available in macro directory.",category:"macro",enable:enable55,disable:disable51,stage:"init"});function defaultMacroType(macro,data,options,userId){if(data.command==null)macro.updateSource({type:"script"})}function enable56(){Hooks.on("preCreateMacro",defaultMacroType)}function disable52(){Hooks.off("preCreateMacro",defaultMacroType)}new Feature({setting:"macro-default-script",label:"Default Script Type",hint:"Forces macros to script type by default.",category:"macro",enable:enable56,disable:disable52,stage:"ready"});function injectIDButtonToTitle(app,html,_,context){if(!context.isFirstRender)return;let type;if(app instanceof foundry.applications.sidebar.apps.Compendium)type="pack";let title=html.querySelector(".window-title");if(!title)return;if(title.querySelector(".document-id-link"))return;let idLink=document.createElement("a");idLink.classList.add("document-id-link","lil-helper");let id,label;switch(type){case"pack":{id=app.collection.metadata.id,label="Compendium",idLink.dataset.tooltip=`Copy Compendium ID: ${id}`;break}}if(!id)return;idLink.dataset.tooltipDirection="UP",idLink.innerHTML='<i class="fa-solid fa-passport"></i>',idLink.addEventListener("click",(event2)=>{event2.preventDefault(),game.clipboard.copyPlainText(id),ui.notifications.info(game.i18n.format("DOCUMENT.IdCopiedClipboard",{label,type:"id",id}))}),title.before(idLink)}var renderEvents=["renderCompendium"];function enable57(){for(let ev of renderEvents)Hooks.on(ev,injectIDButtonToTitle)}function disable53(){for(let ev of renderEvents)Hooks.off(ev,injectIDButtonToTitle)}new Feature({setting:"sheet-id",label:"Sheet ID",hint:"Display button on action sheet and compendium header to copy relevant ID to clipboard.",category:"dev",enable:enable57,disable:disable53,stage:"ready"});init_config();init_common();var iconLamp=(title)=>createNode("i",void 0,["far","fa-lightbulb","lil-icon","lil-vision-hint"],{title}),prev=(el)=>{let prevEl=el.previousElementSibling;return prevEl?.classList.add("lil-vision-hint-label"),prevEl};function clarifyTokenSettings(tokenConfig,html,options){let inputs=[];for(let tab of html.querySelectorAll('[data-tab="vision"],[data-tab="light"]'))for(let lvin of tab.querySelectorAll("input"))inputs.push(lvin);for(let node of inputs){let icon;switch(node.name){case"light.dim":icon=iconLamp(i18n.get("LittleHelper.Foundry.Light.Dim.Hint"));break;case"light.bright":icon=iconLamp(i18n.get("LittleHelper.Foundry.Light.Bright.Hint"));break}if(icon)prev(node)?.after(icon)}}function enable58(){Hooks.on("renderTokenConfig",clarifyTokenSettings)}function disable54(){Hooks.off("renderTokenConfig",clarifyTokenSettings)}new Feature({setting:"token-vision-hints",label:"Vision Hints",hint:"Add extra clarity to token vision settings. With PF1 0.80.22 and newer disables brightvision editing in token settings.",category:"token",enable:enable58,disable:disable54,stage:"ready"});init_common();function renderSettingsEvent(settings,html){if(html instanceof jQuery)html=html[0];let gd=html.querySelector("section.info .modules"),world=createNode("div",void 0,["world"]);world.append(createNode("span","World",["label"]),createNode("span",game.world.title,["value"])),gd.after(world)}function enable59(){Hooks.on("renderSettings",renderSettingsEvent)}function disable55(){return Hooks.off("renderSettings",renderSettingsEvent),!1}new Feature({setting:"world-identity",label:"World Identity",hint:"Display world name in settings tab.",category:"foundry-ui",enable:enable59,disable:disable55,stage:"setup"});init_config();init_icons();var autoExpand="autoExpandFolders";Hooks.once("init",()=>{game.settings.register(CFG.id,autoExpand,{config:!1,default:{},type:Object,scope:"client"})});function expandFolders(folders){let C=CFG.console.colors;console.group("%cLittle Helper%c \uD83E\uDD8E",C.main,C.unset,"| Auto-Expand Folders");try{let foldersByType={};for(let f of Object.entries(folders).filter(([_,open])=>open).map(([fid,_])=>game.folders?.get(fid)))foldersByType[f.type]??=[],foldersByType[f.type].push(f);let types=Object.keys(foldersByType);if(types.length===0)return void console.log("No folders configured");for(let type of types){console.group(type);try{for(let folder of foldersByType[type])console.log(folder.name,`[${folder.id}]`)}finally{console.groupEnd()}}}finally{console.groupEnd()}}Hooks.once("ready",()=>{let folders=game.settings.get(CFG.id,autoExpand),update=!1;for(let[uid,_]of Object.entries(folders))if(!game.folders.get(uid))delete folders[uid],update=!0;if(update)game.settings.set(CFG.id,autoExpand,folders);expandFolders(folders)});function toggleFolder(html,expand){if(html instanceof jQuery)html=html[0];let folderId=html.closest("[data-folder-id]")?.dataset.folderId;if(!folderId)return;let cfg=game.settings.get(CFG.id,autoExpand);if(expand)cfg[folderId]=!0;else delete cfg[folderId];return game.settings.set(CFG.id,autoExpand,foundry.utils.deepClone(cfg))}function getToggleState(html){if(html instanceof jQuery)html=html[0];let folderId=html.closest("[data-folder-id]")?.dataset.folderId;if(!folderId)return;return game.settings.get(CFG.id,autoExpand)[folderId]??!1}function folderContext(_jq,contextmenu){contextmenu.unshift({callback:(html)=>toggleFolder(html,!1),condition:(html)=>getToggleState(html),icon:`<i class='${FAIcons.folder}'></i>`,name:"Undo auto-expand"},{callback:(html)=>toggleFolder(html,!0),condition:(html)=>!getToggleState(html),icon:`<i class='${FAIcons.folderOpen}'></i>`,name:"Auto-expand folder"})}function onRenderSidebar(app,html,options){if(html instanceof jQuery)html=html[0];let cfg=game.settings.get(CFG.id,autoExpand);for(let el of html.querySelectorAll("li[data-folder-id]")){let folderId=el.dataset.folderId;if((cfg[folderId]??!1)&&el.classList.contains("collapsed"))el.querySelector("header")?.click()}}function enable60(){return Hooks.on("getDocumentDirectoryFolderContext",folderContext),Hooks.on("renderDocumentDirectory",onRenderSidebar),!0}function disable56(){return Hooks.off("getDocumentDirectoryFolderContext",folderContext),Hooks.off("renderDocumentDirectory",onRenderSidebar),!0}new Feature({setting:"auto-expand-sidebar-folders",label:"Auto-expand Sidebar Folders",hint:"Allows automatically expanding sidebar folders. Toggle the expansion with right click context menu.",category:"foundry-ui",enable:enable60,disable:disable56,stage:"init"});function widenSidebar(){document.body.style.setProperty("--sidebar-width","360px")}function enable61(){widenSidebar()}function disable57(){return!1}new Feature({setting:"widen-sidebar",label:"Widen Sidebar",hint:"Increase sidebar width.",category:"foundry-ui",enable:enable61,disable:disable57,stage:"setup",enabledByDefault:!1});init_common();function getActorType(actor){switch(actor.type){case"character":return"PC";case"npc":return"NPC";case"basic":return"Basic";default:return i18n.get(CONFIG.Actor.typeLabels[actor.type])}}function generateContent(actor){let t=document.createDocumentFragment(),sysData=actor.system,actorType=createNode("span",getActorType(actor),["lil-tag","type",actor.type]);addCoreTooltip(actorType,i18n.get("LittleHelper.Sidebar.ActorType",{type:actor.type})),t.append(actorType);let isPC=actor.hasPlayerOwner,isLinked=actor.prototypeToken.actorLink;if(isPC&&!isLinked||!isPC&&isLinked){let linkState=createNode("span",isLinked?i18n.get("LittleHelper.Linked"):i18n.get("LittleHelper.Unlinked"),["lil-tag","link-state",isPC?"pc":"npc",isLinked?"linked":"unlinked"]),playerOwned=i18n.get(isPC?"Yes":"No"),tokenLinked=i18n.get(isLinked?"Yes":"No");addCoreTooltip(linkState,i18n.get("LittleHelper.Sidebar.ActorType",{type:actor.type})+`<br>Player Owned: ${playerOwned}<br>Linked Token: ${tokenLinked}`),t.append(linkState)}if(isPC&&game.user.isGM){let owners=game.users.players.filter((u)=>actor.testUserPermission(u,"OWNER"));if(owners.length===1)t.append(createNode("span",`Owner: ${owners[0].name}`,["lil-tag","owner","singular"]));else if(owners.length>1||actor.ownership.default>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER)t.append(createNode("span","Multiple Owners",["lil-tag","owner","multiple"],{tooltip:owners.map((u)=>u.name).join(", ")}))}if(!game.user.isGM){let perm=actor.permission,permStr=foundry.utils.invertObject(CONST.DOCUMENT_OWNERSHIP_LEVELS)[perm],label=i18n.get(`OWNERSHIP.${permStr}`);t.append(createNode("span",label,["lil-tag","permission",permStr.toLowerCase()]))}if(typeof actor.getCR==="function"){let cr=actor.getCR();t.append(createNode("span",`CR ${pf1.utils.CR.fromNumber(cr)}`,["lil-tag","cr"]))}return t}function onRenderActorDirectory(app,html,options){for(let el of html.querySelectorAll("li.document.actor")){let actorId=el.dataset.entryId,actor=game.actors.get(actorId);if(actor.permission<CONST.DOCUMENT_OWNERSHIP_LEVELS.OBSERVER)continue;let name=el.querySelector(".entry-name");if(!name)continue;let holder=createNode("div",void 0,["lil-entry-info"]),content=generateContent(actor);if(content)holder.replaceChildren(content);el.classList.add("lil-enriched-entry"),name.append(holder)}}function updateActorEvent(actor,update){if(actor.pack)return;if(actor.collectionName!=="actors")return;let updateElements=[],sidetab=document.getElementById("actors");if(sidetab)updateElements.push(sidetab);let popout=document.getElementById("actors-popout");if(popout)updateElements.push(popout);if(updateElements.length===0)return;let content=generateContent(actor);for(let[index,el]of updateElements.entries()){let ii=el.querySelector(`li.document.actor[data-entry-id="${actor.id}"] .lil-entry-info`);if(!ii)return;let sc=index+1===updateElements.length?content:content.cloneNode(!0);ii.replaceChildren(sc)}}function enable62(){Hooks.on("renderActorDirectory",onRenderActorDirectory),Hooks.on("updateActor",updateActorEvent)}function disable58(){return Hooks.off("renderActorDirectory",onRenderActorDirectory),Hooks.off("updateActor",updateActorEvent),!1}new Feature({setting:"enrich-actors-directory",label:"Enrich Actors Directory",hint:"Add additional information to actors directory.",category:"foundry-ui",enable:enable62,disable:disable58,stage:"setup"});init_common();init_config();var classLevelSorter=(a,b)=>b.system.level-a.system.level,ownership,havePerm=(c)=>c.testUserPermission(game.user,"OBSERVER");async function generateActorTooltip(parent,actor){let ignoreActors=game.settings.get(CFG.id,"ignoreActors");if(Array.isArray(ignoreActors))ignoreActors=new Set(ignoreActors);let ignoreProblems=ignoreActors.has(actor.type),warnUnfinished=feature3.subsettings.unfinished.value??!0,fragment=document.createDocumentFragment(),isNormal=["character","npc"].includes(actor.type),hasPlayerOwner=actor.hasPlayerOwner,isObserver=actor.testUserPermission(game.user,"OBSERVER");if(!actor.testUserPermission(game.user,"LIMITED",{exact:!0})&&!isObserver)return;let nameLabel=createNode("h3",actor.name,["name","span-4"]);fragment.append(nameLabel);let variantHpRules=game.settings.get("pf1","healthConfig").getActorConfig(actor).rules,actorData=actor.system,attributes=actorData.attributes,protoToken=actor.prototypeToken;if(actor.name!==protoToken.name&&isObserver){let tEl=createNode("div",void 0,["token"]);tEl.append(createNode("label","Alias",["label"]),createNode("span",protoToken.name,["simple-value","value","text","span-3"])),fragment.append(tEl)}let unfinished=!1;if(isNormal){let woundsAndVigor=variantHpRules.useWoundsAndVigor===!0,health=woundsAndVigor?attributes.vigor:attributes.hp;if(!ignoreProblems&&warnUnfinished&&(!(health.max>0)||actor.itemTypes.class.length===0)){unfinished=!0;let unfinishedEl=createNode("div",void 0,["unfinished"]);unfinishedEl.append(createNode("span","UNFINISHED",["value","span-4","error"])),fragment.append(unfinishedEl)}let hd=attributes?.hd?.total;if(hd>0){let hdEl=createNode("div",void 0,["hd"]);hdEl.append(createNode("label",i18n.get("PF1.HitDieShort"),["label"]),createNode("span",`${hd}`,["value","span-3"])),fragment.append(hdEl)}if(actorData.details?.cr>0);if(woundsAndVigor){let{wounds,vigor}=attributes,evig=vigor.value+(vigor.temp||0),vigPct=evig/vigor.max,wndPCt=wounds.value/wounds.max,hpEl=createNode("div",void 0,["health"]),wndValueEl=createNode("span",void 0,["health-data","simple-value"]);wndValueEl.append(createNode("span",`${wounds.value}`,["wounds","effective","value"])," / ",createNode("span",`${wounds.max}`,["wounds","max","value"])," (",createNode("span",`${pf1.utils.limitPrecision(wndPCt*100,1)}`,["wounds","percentage","value"]),"%)"),hpEl.append(createNode("label",i18n.get("PF1.Wounds"),["label"]),wndValueEl);let vigValueEl=createNode("span",void 0,["health-data","simple-value"]);vigValueEl.append(createNode("span",`${evig}`,["vigor","effective","value"])," / ",createNode("span",`${vigor.max}`,["vigor","max","value"])," (",createNode("span",`${pf1.utils.limitPrecision(vigPct*100,1)}`,["vigor","percentage","value"]),"%)"),hpEl.append(createNode("label",i18n.get("PF1.Vigor"),["label"]),vigValueEl),fragment.append(hpEl)}else{let health2=attributes.hp,ehp=health2.value+health2.temp,hpPercentage=ehp/health2.max,woundThreshold=clampNum(4-Math.ceil(hpPercentage*4),0,3),hpEl=createNode("div",void 0,["health"]),hpValueEl=createNode("span",void 0,["health-data","simple-value"]);if(hpValueEl.append(createNode("span",`${ehp}`,["health","effective","value"])," / ",createNode("span",`${health2.max}`,["health","max","value"])," (",createNode("span",`${pf1.utils.limitPrecision(hpPercentage*100,1)}`,["health","percentage","value"]),"%)"),hpEl.append(createNode("label","HP",["label"]),hpValueEl),fragment.append(hpEl),health2.max>0){let hpLabel=createNode("div",void 0,["health"]);hpLabel.append(createNode("label","Status",["label"]),createNode("span",`${healthLabels[woundThreshold]}`,["simple-value","value","text","span-3"])),fragment.append(hpLabel)}}let race=actor.race;if(race){let rEl=createNode("div",void 0,["race"]);rEl.append(createNode("label",i18n.get(CONFIG.Item.typeLabels.race),["label"]),createNode("span",race.name,["simple-value","text","value"])),fragment.append(rEl)}let classes=actor.itemTypes.class.filter((i)=>i.system.level>0).sort(classLevelSorter),clsEl=createNode("div",void 0,["classes"]);if(classes.length>0){let clsList=createNode("ul",void 0,["class-list","span-4"]);for(let cls of classes){let clsLiEl=createNode("li",void 0,["class"]);clsLiEl.append(createNode("span",cls.name,["text","value"]),createNode("span",cls.system.level,["number","value"])),clsList.append(clsLiEl)}clsEl.append(createNode("label","Classes",["label","span-4"]),clsList)}else if(!ignoreProblems&&warnUnfinished)clsEl.append(createNode("span","NO CLASSES",["value","span-4","error"]));fragment.append(clsEl)}ownership??={default:i18n.get("OWNERSHIP.DEFAULT"),1:i18n.get("OWNERSHIP.LIMITED"),2:i18n.get("OWNERSHIP.OBSERVER"),3:i18n.get("OWNERSHIP.OWNER")};let owners=game.users.players.filter((u)=>actor.testUserPermission(u,"LIMITED")),defaultOwnership=actor.ownership.default;if(defaultOwnership>0||owners.length>0){let ownerList=createNode("ul",void 0,["owner-list","span-4"]),addOwner=(name,level)=>{let ownerLiEl=createNode("li",void 0,["owner"]);level??="default",ownerLiEl.append(createNode("span",name,["text","value"]),createNode("span",ownership[level],["value","text"])),ownerList.append(ownerLiEl)};if(defaultOwnership>0)addOwner(ownership.default,defaultOwnership);for(let user of owners)addOwner(user.name,actor.ownership[user.id]);let ownerEl=createNode("div",void 0,["ownership"]);ownerEl.append(createNode("label","Permissions",["label","span-4"]),ownerList),fragment.append(ownerEl)}let typeEl=createNode("div",void 0,["type"]);typeEl.append(createNode("label",i18n.get("PF1.Type"),["label"]),createNode("span",i18n.get(CONFIG.Actor.typeLabels[actor.type]),["value","text","span-3"])),fragment.append(typeEl);let linkStatus=protoToken.actorLink,linkStatusExpected=linkStatus?!!hasPlayerOwner:!hasPlayerOwner,linkEl=createNode("div",void 0,["link-status"]),linkStateLabel=linkStatus?i18n.get("LittleHelper.LinkState.Linked.Label"):i18n.get("LittleHelper.LinkState.Unlinked.Label");linkEl.append(createNode("label","Link State"),createNode("span",linkStateLabel,["value","boolean","link-state",linkStatusExpected?"expected":"unexpected",linkStatus?"true":"false","span-3"])),fragment.append(linkEl);let tt=CONFIG.ux.TooltipManager,ttData={html:fragment,cssClass:"lil-directory-tooltip",direction:tt.TOOLTIP_DIRECTIONS.LEFT};game.tooltip.activate(parent,ttData)}function hookActorTooltip(dom,actor){if(actor.type.includes("."))return;if(!havePerm(actor))return;dom.addEventListener("pointerenter",()=>generateActorTooltip(dom,actor),{passive:!0})}function hookActorDirectoryTooltips(app,html){if(html instanceof jQuery)html=html[0];let listing=html.querySelector("ol.directory-list");if(!listing)return;for(let el of listing.querySelectorAll(".entry[data-entry-id]"))hookActorTooltip(el,game.actors.get(el.dataset.entryId))}function enable63(){Hooks.on("renderActorDirectory",hookActorDirectoryTooltips)}function disable59(){return Hooks.off("renderActorDirectory",hookActorDirectoryTooltips),!1}var feature3=new Feature({setting:"actor-list-tooltip",label:"Actors Directory Tooltips",hint:"Actor tooltips for the sidebar directory, providing basic info.",category:"foundry-ui",subsettings:{unfinished:new SubSetting({label:"Unfinished",hint:"Display warnings if the actor appears to lack necessary information.",type:Boolean,fallback:!0})},enable:enable63,disable:disable59,stage:"init"});init_common();function getItemMainTypeLabel(type){return i18n.get(CONFIG.Item.typeLabels[type])}function getFullItemTypeLabel(item,type,subType){let showIdentified=!item.showUnidentifiedData,itemData=item.system;switch(type){case"equipment":if(["armor","shield"].includes(subType)){let subType2=itemData.equipmentSubtype;if(!subType2){if(subType==="armor")subType2||="lightArmor";else if(subType==="shield")subType2||="lightShield"}return pf1.config.equipmentTypes[subType]?.[subType2]}else{if(!showIdentified&&subType!=="clothing")return i18n.get(CONFIG.Item.typeLabels.equipment);let label=pf1.config.equipmentTypes[subType]?._label,slot=item.system.slot||"slotless";if(["wondrous","other"].includes(subType)){let slabel=pf1.config.equipmentSlots[subType][slot];if(slabel)return`${label} (${slabel})`}return label}case"loot":{if(!showIdentified)return i18n.get(CONFIG.Item.typeLabels.loot);let label=pf1.config.lootTypes[subType];if(subType==="ammo"){let subLabel=pf1.config.ammoTypes[itemData.extraType];return subLabel?`${label} [${subLabel}]`:label}return label}case"feat":{let ablType=pf1.config.abilityTypes[itemData.abilityType]?.short,label=pf1.config.featTypes[subType];if(ablType)return`${label} (${ablType})`;if(subType==="misc")return`${i18n.get("PF1.Feature")} [${label}]`;return label}case"consumable":if(showIdentified)return`${i18n.get(CONFIG.Item.typeLabels.consumable)} [${pf1.config.consumableTypes[subType]}]`;else return i18n.get(CONFIG.Item.typeLabels.consumable);case"class":return pf1.config.classTypes[subType];case"race":return i18n.get(CONFIG.Item.typeLabels.race);case"container":return i18n.get(CONFIG.Item.typeLabels.container);default:return i18n.get(CONFIG.Item.typeLabels[type])}}function getItemSubTypeLabel(item,type,subType){let itemData=item.system;switch(type){case"equipment":{let subType2=itemData.equipmentSubtype;return pf1.config.equipmentTypes[subType][subType2]}case"loot":{let label=pf1.config.lootTypes[subType];if(subType==="ammo"){let subLabel=pf1.config.ammoTypes[itemData.extraType];return subLabel?`${label} [${subLabel}]`:label}return label}case"feat":return pf1.config.featTypes[subType];case"consumable":return pf1.config.consumableTypes[subType];case"class":return pf1.config.classTypes[subType];case"buff":return i18n.get(pf1.config.buffTypes[subType]);case"attack":return pf1.config.attackTypes[subType]}}function getItemTags(item){let tags={},type=item.type,subType=item.system.subType;switch(tags.type=getFullItemTypeLabel(item,type,subType),item.type){case"weapon":{switch(item.defaultAction?.actionType){case"mwak":case"msak":case"mcman":tags.range="Melee";break;case"rwak":case"rsak":case"rcman":tags.range="Ranged";break}break}}return tags}function addDetails(el,item){let tags=getItemTags(item),t=document.createDocumentFragment();if(tags.type)t.append(createNode("span",tags.type,["lil-tag","type"]));if(tags.range)t.append(createNode("span",tags.range,["lil-tag","range"]));el.replaceChildren(t)}function onRenderItemDirectory(app,html,options){for(let el of html.querySelectorAll("li.document.item[data-entry-id]")){let itemId=el.dataset.entryId,item=game.items.get(itemId),holder=createNode("div",void 0,["lil-entry-info"]);addDetails(holder,item);let name=el.querySelector(".entry-name");el.classList.add("lil-enriched-entry"),name.append(holder)}}async function onUpdateItem(item){if(item.actor)return;if(item.pack)return;let inItemsDir=item.collectionName==="items";for(let app of item.collection?.apps??[])if(inItemsDir&&app instanceof foundry.applications.sidebar.tabs.ItemDirectory){let html=app.element;if(html instanceof jQuery)html=html[0];let el=html.querySelector(`.item[data-document-id="${item.id}"] .lil-entry-info`);if(el)addDetails(el,item)}}function enable64(){Hooks.on("updateItem",onUpdateItem),Hooks.on("renderItemDirectory",onRenderItemDirectory)}function disable60(){return Hooks.off("updateItem",onUpdateItem),Hooks.off("renderItemDirectory",onRenderItemDirectory),!1}new Feature({setting:"enrich-items-directory",label:"Enrich Items Directory",hint:"Add additional information to items directory.",category:"foundry-ui",enable:enable64,disable:disable60,stage:"setup"});init_common();var ownership2;function addRaceInfo(item,d){let itemData=item.system,type=itemData.creatureType;if(type){let typeEl=createNode("div",void 0,["creature-type"]);typeEl.append(createNode("label",i18n.get("PF1.CreatureType"),["label"]),createNode("span",`${pf1.config.creatureTypes[type]}`,["value","text","span-3"])),d.append(typeEl)}let size=itemData.size;if(itemData.size>0){let typeEl=createNode("div",void 0,["size"]);typeEl.append(createNode("label",i18n.get("PF1.Size"),["label"]),createNode("span",`${pf1.config.actorSizes[size]}`,["value","text","span-3"])),d.append(typeEl)}if(itemData.subTypes?.length){let subtypeList=createNode("ul",void 0,["subtypes-list","span-4"]);for(let type2 of itemData.subTypes){let subtypeLiEl=createNode("li",void 0,["owner"]);subtypeLiEl.append(createNode("span",type2,["value","text"])),subtypeList.append(subtypeLiEl)}let subtypesEl=createNode("div",void 0,["subtypes"]);subtypesEl.append(createNode("label",i18n.get("PF1.RaceSubtypePlural"),["label","span-4"]),subtypeList),d.append(subtypesEl)}}async function generateItemTooltip(parent,item){let fragment=document.createDocumentFragment(),permLevel=item.permission,isGM=game.user.isGM,itemData=item.system,isIdentified=game.user.isGM||(itemData.identified??!0),nameLabel=createNode("h3",item.name,["name","span-4"]);fragment.append(nameLabel);let typeLabel=getItemMainTypeLabel(item.type),typeEl=createNode("div",void 0,["type"]);if(typeEl.append(createNode("label",i18n.get("PF1.Type"),["label"]),createNode("span",i18n.get(typeLabel),["value","text","span-3"])),fragment.append(typeEl),!(!isIdentified&&item.type==="consumable")){let subtype=item.subType,sublabel=getItemSubTypeLabel(item,item.type,subtype);if(sublabel){let subtypeEl=createNode("div",void 0,["subtype"]);subtypeEl.append(createNode("label",i18n.get("PF1.Subtype"),["label"]),createNode("span",sublabel,["value","text","span-3"])),fragment.append(subtypeEl)}}if(item.type==="race")addRaceInfo(item,fragment);if(Number.isFinite(itemData.quantity)&&itemData.quantity!==1){let gpEl=createNode("div",void 0,["quantity"]);gpEl.append(createNode("label",i18n.get("PF1.Quantity"),["label"]),createNode("span",`${itemData.quantity}`,["value","number","span-3"])),fragment.append(gpEl)}let value=item.isPhysical?item.getValue({inLowestDenomination:!0,sellValue:1,single:!0}):Number.NaN;if(!Number.isNaN(value)){let gpEl=createNode("div",void 0,["gold-value"]),gpValueEl=createNode("span",void 0,["simple-value"]);gpValueEl.append(createNode("span",`${formatNum(value/100)}`,["value","number"])," \uD83D\uDF1A"),gpEl.append(createNode("label",i18n.get("PF1.Value"),["label"]),gpValueEl),fragment.append(gpEl)}let weight=itemData.weight;if(Number.isFinite(weight?.total)){let weightEl=createNode("div",void 0,["weight-value"]),weightValueEl=createNode("span",void 0,["simple-value"]),units=pf1.utils.getWeightSystem()==="metric"?"PF1.Kgs":"PF1.Lbs";weightValueEl.append(createNode("span",`${pf1.utils.limitPrecision(weight.converted.total,2)}`,["value","number"]),` ${i18n.get(units)}`),weightEl.append(createNode("label",i18n.get("PF1.Weight"),["label"]),weightValueEl),fragment.append(weightEl)}if(item.type==="spell"){let school=createNode("div",void 0,["school"]),label=pf1.config.spellSchools[itemData.school]||i18n.get("PF1.Undefined");school.append(createNode("label",i18n.get("PF1.School"),["label"]),createNode("span",label,["value","string","span-3"])),fragment.append(school)}ownership2??={default:i18n.get("OWNERSHIP.DEFAULT"),1:i18n.get("OWNERSHIP.LIMITED"),2:i18n.get("OWNERSHIP.OBSERVER"),3:i18n.get("OWNERSHIP.OWNER")};let owners=game.users.players.filter((u)=>item.testUserPermission(u,"LIMITED")).map((u)=>[u,item.ownership[u.id]]),defaultOwnership=item.ownership.default;if(defaultOwnership>0||owners.length>0){let ownerList=createNode("ul",void 0,["owner-list","span-4"]),addOwner=(name,level)=>{let ownerLiEl=createNode("li",void 0,["owner"]);level??="default",ownerLiEl.append(createNode("span",name,["text","value"]),createNode("span",ownership2[level],["value","text"])),ownerList.append(ownerLiEl)};if(defaultOwnership>0)addOwner(ownership2.default,defaultOwnership);for(let user of owners)addOwner(user.name,item.ownership[user.id]);let ownerEl=createNode("div",void 0,["ownership"]);ownerEl.append(createNode("label",i18n.get("Permissions"),["label","span-4"]),ownerList),fragment.append(ownerEl)}if(permLevel>CONST.DOCUMENT_OWNERSHIP_LEVELS.LIMITED&&isIdentified&&itemData.cl>0){let school=itemData.aura.school,schoolLabel=itemData.aura.custom?school:pf1.config.spellSchools[school],auraStrength=pf1.config.auraStrengths[item.auraStrength],auraLabel=i18n.get("LittleHelper.Aura",{school:schoolLabel,strength:auraStrength}),auraEl=createNode("div",void 0,["aura-value"]);auraEl.append(createNode("label","Aura",["label"]),createNode("span",auraLabel,["value","text","span-3"])),fragment.append(auraEl)}if(isGM){let ident=itemData.identified;if(ident!==void 0){let identEl=createNode("div",void 0,["identified"]),identLabel=i18n.get(ident?"Yes":"No");identEl.append(createNode("label",i18n.get("PF1.Identified"),["label"]),createNode("span",identLabel,["value","boolean","identified-state",ident?"identified":"unidentified",ident?"true":"false","span-3"])),fragment.append(identEl)}}let tt=CONFIG.ux.TooltipManager,ttData={html:fragment,cssClass:"lil-directory-tooltip",direction:tt.TOOLTIP_DIRECTIONS.LEFT};game.tooltip.activate(parent,ttData)}function hookItemTooltip(dom,item){if(!item.testUserPermission(game.user,"LIMITED"))return;dom.addEventListener("pointerenter",()=>generateItemTooltip(dom,item),{passive:!0})}function hookItemDirectoryTooltips(app,html){if(html instanceof jQuery)html=html[0];let listing=html.querySelector("ol.directory-list");if(!listing)return;for(let el of listing.querySelectorAll(".entry[data-entry-id]"))hookItemTooltip(el,game.items.get(el.dataset.entryId))}function enable65(){Hooks.on("renderItemDirectory",hookItemDirectoryTooltips)}function disable61(){return Hooks.off("renderItemDirectory",hookItemDirectoryTooltips),!1}new Feature({setting:"item-list-tooltip",label:"Items Directory Tooltips",hint:"Item tooltips for the sidebar directory, providing basic info.",category:"foundry-ui",enable:enable65,disable:disable61,stage:"init"});init_common();var ownership3,generateRollTableTooltip=async(parent,table)=>{let fragment=document.createDocumentFragment(),nameLabel=createNode("h3",table.name,["name","span-4"]);fragment.append(nameLabel),ownership3??={default:i18n.get("OWNERSHIP.DEFAULT"),0:i18n.get("OWNERSHIP.NONE"),1:i18n.get("OWNERSHIP.LIMITED"),2:i18n.get("OWNERSHIP.OBSERVER"),3:i18n.get("OWNERSHIP.OWNER")};let rollFormula=createNode("div",null,["formula"]);rollFormula.append(createNode("label","Formula"),createNode("span",table.formula,["value","string","formula","span-3"]));let results=createNode("div",null,["results"]);results.append(createNode("label","Results"),createNode("span",`${table.results.size}`,["value","number","result-count","span-3"])),fragment.append(rollFormula,results);let owners=game.users?.players.filter((u)=>table.testUserPermission(u,"LIMITED")),defaultOwnership=table.ownership.default,ownerList=createNode("ul",null,["owner-list","span-4"]),addOwner=(name,level)=>{let ownerLiEl=createNode("li",null,["owner"]);level??="default",ownerLiEl.append(createNode("span",name,["text","value"]),createNode("span",ownership3[level],["value","text","ownership",`level-${level}`])),ownerList.append(ownerLiEl)};if(defaultOwnership>0)addOwner(ownership3.default,defaultOwnership);for(let user of owners)addOwner(user.name,table.ownership[user.id]);if(owners.length===0)ownerList.append(createNode("li","No user access",["error"]));let ownerEl=createNode("div",null,["ownership"]);ownerEl.append(createNode("label",i18n.get("Permissions"),["label","span-4"]),ownerList),fragment.append(ownerEl);let tt=CONFIG.ux.TooltipManager,ttData={html:fragment,cssClass:"lil-directory-tooltip",direction:tt.TOOLTIP_DIRECTIONS.LEFT};game.tooltip.activate(parent,ttData)};function hookRollTableTooltip(dom,table){dom.addEventListener("pointerenter",()=>generateRollTableTooltip(dom,table),{passive:!0})}var hookRollTableDirectoryTooltips=(app,html)=>{if(html instanceof jQuery)html=html[0];let listing=html.querySelector("ol.directory-list");if(!listing)return;for(let el of listing.querySelectorAll(".document[data-document-id],.entry[data-entry-id]"))hookRollTableTooltip(el,game.tables.get(el.dataset.entryId||el.dataset.documentId))},enable66=()=>{Hooks.on("renderRollTableDirectory",hookRollTableDirectoryTooltips)},disable62=()=>{return Hooks.off("renderRollTableDirectory",hookRollTableDirectoryTooltips),!1};new Feature({setting:"rolltable-list-tooltip",label:"RollTable List Tooltips",hint:"RollTable tooltips for the sidebar directory, providing basic info.",category:"foundry-ui",enable:enable66,disable:disable62,stage:"init"});function compressSceneDirectory(app,html,options){html.style.setProperty("--sidebar-scene-height","60px")}function enable67(){Hooks.on("renderSceneDirectory",compressSceneDirectory)}function disable63(){return!1}new Feature({setting:"compress-scene-directory",label:"Compress Scene Directory",hint:"Reduces the space each scene takes.",category:"foundry-ui",enable:enable67,disable:disable63,stage:"init",enabledByDefault:!1});init_common();async function generateSceneTooltip(parent,scene){let fragment=document.createDocumentFragment(),nameLabel=createNode("h3",scene.name,["name","span-4"]);fragment.append(nameLabel);let displayName=scene.navName;if(displayName){let nameEl=createNode("div",null,["navigation-name"]);nameEl.append(createNode("h3",displayName,["value","text","span-4"])),fragment.append(nameEl)}let navEl=createNode("div",null,["navigation"]),navLabel=i18n.get(scene.navigation?"Yes":"No");navEl.append(createNode("label",i18n.get("Navigation"),["label"]),createNode("span",navLabel,["value","boolean","navigation-state",scene.navigation?"navigatable":"unnavigatable",scene.navigation?"true":"false","span-3"])),fragment.append(navEl);let visionEl=createNode("div",null,["fog"]),vision=scene.tokenVision,visionLabel=i18n.get(vision?"Yes":"No");visionEl.append(createNode("label",i18n.get("Vision"),["label"]),createNode("span",visionLabel,["value","boolean","vision-state",vision?"token":"universal",vision?"true":"false","span-3"])),fragment.append(visionEl);let fogEl=createNode("div",null,["fog"]),fog=scene.fog?.exploration??scene.fogExploration,fogLabel=i18n.get(fog?"Yes":"No");fogEl.append(createNode("label",i18n.get("Fog"),["label"]),createNode("span",fogLabel,["value","boolean","fog-state",fog?"fogged":"fogless",fog?"true":"false","span-3"])),fragment.append(fogEl);let tt=CONFIG.ux.TooltipManager,ttData={html:fragment,cssClass:"lil-directory-tooltip",direction:tt.TOOLTIP_DIRECTIONS.LEFT};game.tooltip.activate(parent,ttData)}function hookSceneTooltip(scene,dom){dom.addEventListener("pointerenter",()=>generateSceneTooltip(dom,scene),{passive:!0})}function hookSceneDirectoryTooltips(app,html){if(html instanceof jQuery)html=html[0];let listing=html.querySelector("ol.directory-list");if(!listing)return;for(let el of listing.querySelectorAll(".document[data-document-id]"))hookSceneTooltip(game.scenes.get(el.dataset.documentId),el)}function enable68(){Hooks.on("renderSceneDirectory",hookSceneDirectoryTooltips)}function disable64(){return Hooks.off("renderSceneDirectory",hookSceneDirectoryTooltips),!1}new Feature({setting:"scene-list-tooltip",label:"Scene List Tooltips",hint:"Scene tooltips for the sidebar directory, providing basic info.",category:"foundry-ui",enable:enable68,disable:disable64,stage:"init"});init_common();var ownership4;async function generateJournalTooltip(parent,journal){let fragment=document.createDocumentFragment(),nameLabel=createNode("h3",journal.name,["name","span-4"]);fragment.append(nameLabel),ownership4??={default:i18n.get("OWNERSHIP.DEFAULT"),0:i18n.get("OWNERSHIP.NONE"),1:i18n.get("OWNERSHIP.LIMITED"),2:i18n.get("OWNERSHIP.OBSERVER"),3:i18n.get("OWNERSHIP.OWNER")};let pages=journal.pages.size??0,pgEl=createNode("div",null,["page-count"]),pgValueEl=createNode("span",null,["simple-value"]);pgValueEl.append(createNode("span",`${pages}`,["value","number","pages",pages>0?"finite":"empty"])," \uD83D\uDDD0"),pgEl.append(createNode("label",i18n.get("Pages"),["label"]),pgValueEl),fragment.append(pgEl);let owners=game.users.players.filter((u)=>journal.testUserPermission(u,"LIMITED")),ownerList=createNode("ul",null,["owner-list","span-4"]),addOwner=(name,level)=>{let ownerLiEl=createNode("li",null,["owner"]);level??="default",ownerLiEl.append(createNode("span",name,["text","value"]),createNode("span",ownership4[level],["value","text","ownership",`level-${level}`])),ownerList.append(ownerLiEl)},defaultOwnership=journal.ownership.default;if(defaultOwnership>0)addOwner(ownership4.default,defaultOwnership);for(let user of owners)addOwner(user.name,journal.ownership[user.id]);if(owners.length===0)ownerList.append(createNode("li","No user access",["error"]));let ownerEl=createNode("div",null,["ownership"]);ownerEl.append(createNode("label",i18n.get("Permissions"),["label","span-4"]),ownerList),fragment.append(ownerEl);let tt=CONFIG.ux.TooltipManager,ttData={html:fragment,cssClass:"lil-directory-tooltip",direction:tt.TOOLTIP_DIRECTIONS.LEFT};game.tooltip.activate(parent,ttData)}function hookJournalTooltip(dom,table){dom.addEventListener("pointerenter",()=>generateJournalTooltip(dom,table),{passive:!0})}function hookJournalDirectoryTooltips(app,html){if(html instanceof jQuery)html=html[0];let listing=html.querySelector("ol.directory-list");if(!listing)return;for(let el of listing.querySelectorAll(".entry[data-entry-id],.document[data-document-id]"))hookJournalTooltip(el,game.journal.get(el.dataset.entryId||el.dataset.documentId))}var enable69=()=>{Hooks.on("renderJournalDirectory",hookJournalDirectoryTooltips)},disable65=()=>{return Hooks.off("renderJournalDirectory",hookJournalDirectoryTooltips),!1};new Feature({setting:"journal-list-tooltip",label:"Journal List Tooltips",hint:"Journal tooltips for the sidebar directory, providing basic info.",category:"foundry-ui",enable:enable69,disable:disable65,stage:"init"});init_icons();function insertOpenActionSheetContextOption(_,entries){entries.unshift({name:"LittleHelper.UI.OpenActionSheet",icon:`<i class="${FAIcons.fileAlt}"></i>`,condition:(html)=>{if(html instanceof jQuery)html=html[0];let cm=game.messages.get(html.dataset.messageId);return cm.actionSource&&(cm.itemSource?.testUserPermission(game.user,"OBSERVER")??!1)},callback:(html)=>{if(html instanceof jQuery)html=html[0];game.messages.get(html.dataset.messageId).actionSource?.sheet.render(!0,{focus:!0})}})}function enable70(){Hooks.on("getChatLogEntryContext",insertOpenActionSheetContextOption)}function disable66(){Hooks.off("getChatLogEntryContext",insertOpenActionSheetContextOption)}new Feature({setting:"chatlog-open-action",label:"Context Menu Action Sheet",hint:"Adds context menu option to open the relevant action sheet directly.",category:"chat-card",enable:enable70,disable:disable66,stage:"init"});init_icons();function insertOpenItemSheetContextOption(_app,entries){entries.unshift({name:"LittleHelper.UI.OpenItemSheet",icon:`<i class="${FAIcons.fileAlt}"></i>`,condition:function(html){if(html instanceof jQuery)html=html[0];return game.messages.get(html.dataset.messageId).itemSource?.testUserPermission(game.user,"OBSERVER")??!1},callback:function(html){if(html instanceof jQuery)html=html[0];game.messages.get(html.dataset.messageId).itemSource?.sheet.render(!0,{focus:!0})}})}function enable71(){Hooks.on("getChatLogEntryContext",insertOpenItemSheetContextOption)}function disable67(){Hooks.off("getChatLogEntryContext",insertOpenItemSheetContextOption)}new Feature({setting:"chatlog-open-item",label:"Context Menu Item Sheet",hint:"Adds context menu option to open the relevant item sheet directly.",category:"chat-card",enable:enable71,disable:disable67,stage:"init"});init_icons();function insertOpenActorSheetContextOption(_,entries){entries.unshift({name:"LittleHelper.UI.OpenActorSheet",icon:`<i class="${FAIcons.fileAlt}"></i>`,condition:(html)=>{if(html instanceof jQuery)html=html[0];let cm=game.messages.get(html.dataset.messageId);return ChatMessage.getSpeakerActor(cm?.speaker)?.testUserPermission(game.user,"OBSERVER")??!1},callback:(html)=>{if(html instanceof jQuery)html=html[0];let cm=game.messages.get(html.dataset.messageId),actor=ChatMessage.getSpeakerActor(cm?.speaker);actor?.sheet?.render(!0,{focus:!0,token:actor.token})}})}function enable72(){Hooks.on("getChatLogEntryContext",insertOpenActorSheetContextOption)}function disable68(){Hooks.off("getChatLogEntryContext",insertOpenActorSheetContextOption)}new Feature({setting:"chatlog-open-actor",label:"Context Menu Actor Sheet",hint:"Adds context menu option to open the relevant actor sheet directly.",category:"chat-card",enable:enable72,disable:disable68,stage:"init"});init_icons();function injectIDButton(sheet,buttons){buttons.unshift({class:"little-helper-sheet-refresh",icon:FAIcons.syncAlt,onclick:(_)=>sheet.render()})}var events=["getDocumentSheetHeaderButtons","getActorSheetHeaderButtons","getItemSheetHeaderButtons","getCompendiumHeaderButtons","getTokenConfigHeaderButtons"];function enable73(){setTimeout(()=>{for(let ev of events)Hooks.on(ev,injectIDButton)},this.ready?0:2000),this.ready=!0}function disable69(){for(let ev of events)Hooks.off(ev,injectIDButton)}new Feature({setting:"sheet-refresh",label:"Sheet Refresh",hint:"Display button on sheet header to force refresh.",category:"dev",enable:enable73,disable:disable69,stage:"ready",enabledByDefault:!1});function popOutCombatTracker(){if(game.combat?.started)ui.combat?.createPopout()?.render(!0)}function preUpdateCombatEvent(combat,_update,context){context.__littleHelper??={},context.__littleHelper.started=combat.started}function updateCombatEvent(combat,update,context){if(update.round===1||!context.__littleHelper?.started&&combat.started)popOutCombatTracker()}function enable74(){Hooks.on("preUpdateCombat",preUpdateCombatEvent),Hooks.on("updateCombat",updateCombatEvent),Hooks.once("ready",()=>setTimeout(popOutCombatTracker,200))}function disable70(){Hooks.off("preUpdateCombat",preUpdateCombatEvent),Hooks.off("updateCombat",updateCombatEvent)}new Feature({setting:"combat-auto-popout",label:"Combat Auto-Popout",hint:"Automatically pops out the combat tracker when combat starts and on login if combat has already started.",category:"foundry-ui",enable:enable74,disable:disable70,stage:"init",enabledByDefault:!1});init_config();init_common();var tooltipTemplateSource=`modules/${CFG.id}/templates/tooltip/combat-tracker.hbs`,havePerm2=(c)=>c.testUserPermission(game.user,CONST.DOCUMENT_OWNERSHIP_LEVELS.OBSERVER);function collectCombatantData(combatant){let actor=combatant.actor;if(!actor)return;let actorData=actor.system,attributes=actorData.attributes,hp=attributes.hp,ac=attributes.ac,cmd=attributes.cmd;return{actor,combatant,health:{value:hp.value,max:hp.max,temp:hp.temp,get effective(){return this.value+this.temp},get percentage(){return this.effective/this.max},get threshold(){return clampNum(4-Math.ceil(this.percentage*4),0,3)},get label(){let ehp=this.effective;if(ehp<0)return ehp<=evaluateDeathPoint(actor)?healthLabels.dead:healthLabels.dying;return healthLabels[this.threshold]}},defenses:{ac:{value:ac.normal.total,ff:ac.flatFooted?.total},touch:{value:ac.touch.total,ff:ac.touch.total-(ac?.normal.total-ac?.flatFooted.total)},cmd:{value:cmd.total,ff:cmd.flatFootedTotal}},effects:actor.appliedEffects.filter((ae)=>ae.img).map((ae)=>({name:ae.name,id:ae.id,img:ae.img}))}}function generateCombatantTooltip(parent,combatant){let templateData=collectCombatantData(combatant);if(!templateData)return!1;let tooltipTemplate=Handlebars.partials[tooltipTemplateSource],template=document.createElement("template");template.innerHTML=tooltipTemplate(templateData,{allowProtoMethodsByDefault:!0,allowProtoPropertiesByDefault:!0});let tt=CONFIG.ux.TooltipManager,ttData={html:template.content,cssClass:"lil-directory-tooltip",direction:tt.TOOLTIP_DIRECTIONS.LEFT};game.tooltip.activate(parent,ttData)}function hookCombatantTooltip(dom,combatant){if(!dom)return;if(!combatant?.actor||!havePerm2(combatant))return;if(!["character","npc"].includes(combatant.actor?.type))return;dom.addEventListener("pointerenter",()=>generateCombatantTooltip(dom,combatant),{passive:!0})}function hookCombatTrackerTooltips(app,html){if(html instanceof jQuery)html=html[0];let combat=game.combats.viewed;if(!combat)return;let listing=html.querySelector("ol.combat-tracker,ol.directory-list");if(!listing)return;for(let el of listing.querySelectorAll(".combatant[data-combatant-id]")){let combatant=combat.combatants.get(el.dataset.combatantId);hookCombatantTooltip(el,combatant)}}function enable75(){Hooks.on("renderCombatTracker",hookCombatTrackerTooltips),foundry.applications.handlebars.loadTemplates([`modules/${CFG.id}/templates/tooltip/combat-tracker.hbs`])}function disable71(){return Hooks.off("renderCombatTracker",hookCombatTrackerTooltips),!1}new Feature({setting:"combat-tracker-tooltip",label:"Combat Tracker Tooltip",hint:"Basic info tooltip for combat tracker.",category:"foundry-ui",enable:enable75,disable:disable71,stage:"init"});init_config();init_common();function renderCombat(app,html,options){if(html instanceof jQuery)html=html[0];for(let el of html.querySelectorAll(".token-initiative .initiative")){let[main,tiebreaker]=el.textContent.split(".",2);if(tiebreaker===void 0)continue;let tbEl=createNode("span",` ${tiebreaker}`,["lil-tiebreaker"]);el.replaceChildren(main,tbEl),el.classList.add("lil-tiebreaker-restyle")}}function enable76(){Hooks.on("renderCombatTracker",renderCombat)}function disable72(){return Hooks.off("renderCombatTracker",renderCombat),!1}new Feature({setting:"combat-tracker-init-tiebreaker",label:"Combat Tracker Initiative Tiebreaker",hint:"Alters display of initiative tiebreaker.",category:"foundry-ui",enable:enable76,disable:disable72,stage:"init"});function enable77(){document.body.classList.add("lil-boost")}function disable73(){document.body.classList.remove("lil-boost")}new Feature({setting:"boost",label:"Performance Boost",hint:"Add content hints for browser.",category:"experiment",enable:enable77,disable:disable73,stage:"ready",enabledByDefault:!1});function enable78(){document.body.classList.add("lil-chatcard-restyle")}function disable74(){document.body.classList.remove("lil-chatcard-restyle")}new Feature({setting:"chat-restyle",label:"Restyle",hint:"Adds minor restyling to chat cards.",category:"chat-card",enable:enable78,disable:disable74,stage:"init",stream:!0});init_config();init_common();init_config();var unflair=(formula)=>formula.replaceAll(/\[.*?]/g,"").replaceAll(/\s\s+/g," ").replaceAll("+ -","-").replaceAll(/\s*\+\s*/g,"+").trim();function getVariables(formula){let vars=formula.match(/@(\w[\w.]*)\b/g),rv=new Set;if(vars)for(let v of vars)rv.add(v.slice(1));return rv}CFG.API.formula={...CFG.API.formula,getVariables};var hideIdenticalResolution=!0,ignorePaths=[/^formulaicAttacks\.count\.formula$/];var limitedRollData={class:{item:["system.customHD","system.babFormula","system.savingThrows.fort.custom","system.savingThrows.ref.custom","system.savingThrows.will.custom"]}};function getSpecialItemRollData(path,item){switch(path){case"system.customHD":return{item:{level:item.system.level}};case"system.babFormula":case"system.savingThrows.fort.custom":case"system.savingThrows.ref.custom":case"system.savingThrows.will.custom":return{level:item.system.level,hitDice:item.hitDice}}return null}function addSpecialRollData(rollData,path,actor,item,temp){let bookId=/\.spellbooks\.(?<bookId>\w+)\./.exec(path)?.groups.bookId;if(actor&&!!bookId){let bookData=rollData.spells?.[bookId];if(bookData){if(rollData.sl===void 0)rollData.sl=item?.system.level??0,temp.add("sl");if(rollData.cl===void 0)rollData.cl=bookData.cl.total,temp.add("cl");if(rollData.ablMod===void 0)rollData.ablMod=rollData.abilities[bookData.ability]?.mod,temp.add("ablMod")}}}function cleanSpecialRollData(rollData,path,temp){for(let p of temp)foundry.utils.setProperty(rollData,p,void 0),temp.delete(p)}var rules={matchCount:{parenthesis:{open:"(",close:")",warning:"LittleHelper.Warning.MismatchedQuantity"},squareBrackets:{open:"[",close:"]",warning:"LittleHelper.Warning.MismatchedQuantity"},curlyBrackets:{open:"{",close:"}",warning:"LittleHelper.Warning.MismatchedQuantity"}},general:{badVariable:{match:/@[^_\w]/i,warning:"LittleHelper.Warning.BadVariable"},squareBrackets:{match:/[^)\w\d]\[/,warning:"LittleHelper.Warning.OrphanBrackets"},runIn:{match:/\w[*+\-/]/,warning:"LittleHelper.Warning.RunInOperator"},dieParens:{match:/\)d/,warning:"LittleHelper.Warning.DieFunctionPair",error:!0},excessSpace:{match:/\w\s+[([]/,warning:"LittleHelper.Warning.ExcessSpacing"}}};function validateFormula(formula="",issues=[],errors=[]){let error,terms=[];if(formula)try{terms=RollPF.parse(formula)}catch(err){error=!0,errors.push({rule:"parse",message:err.message,error:err})}else errors.push({rule:"empty",message:i18n.get("LittleHelper.Warning.EmptyFormula")});for(let[subrule,rule]of Object.entries(rules.matchCount)){let open=0,close=0;for(let l of formula)if(l===rule.open)open++;else if(l===rule.close)close++;if(open!==close)issues.push({rule:"matchCount",subrule,message:i18n.get(rule.warning,{details:`"${rule.open}" ×${open}, "${rule.close}" ×${close}`})})}for(let[subrule,rule]of Object.entries(rules.general)){let re=rule.match.exec(formula);if(re){if(rule.error&&!error)continue;issues.push({rule:"general",subrule,offset:re.index,message:i18n.get(rule.warning)})}}for(let term of terms??[]){let re=/(\d\.\d|\/)/.exec(term.expression);if(!!re&&!/(?:ceil|floor|round)\(/.test(term.expression))issues.push({rule:"terms",subrule:"rounding",offset:re.index,message:i18n.get("LittleHelper.Warning.MissingRounding")})}return{issues,errors}}var spaceFormula=(iformula)=>iformula.replaceAll(/([)\d\w])\s*([+*\-/])\s*/g,(_,m1,m2)=>`${m1} ${m2} <wbr>`);async function generateTooltip(el,formula,path,actor,item,action,rollData){let content=document.createElement("div");content.append(createNode("h2",i18n.get("LittleHelper.Formula.Base")),createNode("p",spaceFormula(formula),["base-formula"],{isHTML:!0}));let temporary=new Set;rollData=getRollData(item,action,path,rollData),addSpecialRollData(rollData,path,actor,item,temporary);let numformula=Roll.replaceFormulaData(formula,rollData,{missing:0}),vars=[...getVariables(formula)].map((kpath)=>{let value=foundry.utils.getProperty(rollData,kpath),idents=[];if(value===void 0)idents.push("undefined","nullish");else if(value===null)idents.push("null","nullish");else if(typeof value==="object")idents.push("object");return{path:kpath,value,idents}}),issues=[],errors=[],checkVar=(v)=>{if(v.path.startsWith("dFlags")){let[_,tag]=v.path.split(".",2);if(!actor.items.find((i)=>i.system.tag===tag)?.isActive)issues.push({rule:"itemDisabled",message:`Item "${tag}" disabled, @dFlags.${tag}.* set to 0`})}else if(v.path.startsWith("item.dFlags")&&!item.isActive)issues.push({rule:"itemDisabled",message:"Item disabled, @item.dFlags.* set to 0"})};if(vars.length){content.append(createNode("h2",i18n.get("LittleHelper.Formula.Resolved")),createNode("p",spaceFormula(numformula),["numeric-formula"],{isHTML:!0}));let ul=createNode("ul",null,["formula-parts"]);if(ul.append(...vars.map((vdata)=>{let{path:path2,value,idents:extraIdents}=vdata,li=createNode("li",null,["formula-variable"]);return li.append(createNode("span",`@${path2}`,["data-path"])," = ",createNode("span",`${value}`,["data-value",...extraIdents])),li})),content.append(createNode("h2",i18n.get("LittleHelper.Formula.Variables")),ul),actor)for(let v of vars)checkVar(v)}if(validateFormula(formula,issues,errors),cleanSpecialRollData(rollData,path,temporary),issues.length>0)content.append(createNode("h2",`⚠️ ${i18n.get("LittleHelper.Warnings")}`),...issues.map((issue)=>createNode("p",issue.message)));if(errors.length>0)content.append(createNode("h2",`⚠️ ${i18n.get("LittleHelper.Errors")}`),...errors.map((issue)=>createNode("p",issue.message)));game.tooltip.activate(el,{html:content,direction:"UP",cssClass:"lil-resolved-formula"})}function resolveDocumentFormulas(sheet,html,options,shared){if(!shared.coreSheet&&!shared.altSheetZenvy)return;let{action,item,actor}=shared;resolveFormulas(html,{actor,item,action})}function safeResolveInputFormula(el,path,actor,item,action,rollData){let temporary=new Set;addSpecialRollData(rollData,path,actor,item,temporary);try{resolveInputFormula(el,path,actor,item,action,rollData)}finally{cleanSpecialRollData(rollData,path,temporary)}}function getRollData(item,action,path,rollData){if(item){let specialData=limitedRollData[item.type],isSpecial=!1;if(specialData)specialData=action?specialData.action:specialData.item,isSpecial=specialData?.includes(path)??!1;if(isSpecial)rollData=getSpecialItemRollData(path,item)}return rollData}function resolveInputFormula(el,path,actor,item,action,rollData){if(path&&ignorePaths.some((ign)=>ign.test(path)))return;let formula=el.value?.trim(),doc=action??item??actor;if(rollData=getRollData(item,action,path,rollData),/^save\.dc$/.test(path)&&item?.type==="spell"&&actor)formula=[rollData.spells[item?.system.spellbook].baseDCFormula,formula].filter((i)=>i.length).join(" + ");else if(formula.length===0)return;let rf,broken=!1;try{rf=pf1.utils.formula.compress(pf1.utils.formula.simplify(formula,rollData,{errors:!1}))}catch(err){console.error("Bad formula:",formula,`

Document:`,doc.name,doc,`

Data path:`,path,`

Error:`,err),rf="NaN",broken=!0}let issues=[],errors=[];if(validateFormula(formula,issues,errors),errors.length>0)broken=!0;if(hideIdenticalResolution&&rf===pf1.utils.formula.compress(unflair(formula))&&!broken)return;let rv=createNode("label",null,["lil-resolved-formula"]),nr=RollPF.safeRollSync(formula,rollData,void 0,void 0,{minimize:!0});if(nr?.err)broken=!0;let terms=nr?.terms??[];if(rv.append("= ",createNode("span",`${rf}`,["lil-resolved-value"])),terms.length===0)rv.classList.add("lil-broken-formula","NaN");else if(terms.some((t)=>t.constructor.name==="StringTerm"))rv.classList.add("lil-broken-formula");if(broken)rv.classList.add("broken");let numformula=Roll.replaceFormulaData(formula,rollData,{missing:0});if(!broken&&numformula==formula);else rv.addEventListener("pointerenter",(_)=>generateTooltip(rv,formula,path,actor,item,action,rollData),{passive:!0}),rv.addEventListener("pointerleave",()=>game.tooltip.deactivate());if(el.classList.contains("conditional-formula"))el.closest("li[data-conditional]")?.classList.add("lil-conditional-style-correction");if(broken)rv.append(createNode("i",null,["fa-solid","fa-exclamation-triangle","lil-formula-warning"]));el.after(rv)}async function resolveFormulas(html,{actor,item,action}={}){let rollData=(action??item??actor).getRollData();if(!actor)rollData.size=4;for(let el of html.querySelectorAll("input.formula"))safeResolveInputFormula(el,el.name,actor,item,action,rollData)}function resolveChangeFormulas(app){let html=app.element.querySelector(".window-content"),doc=app.document,action=doc instanceof pf1.components.ItemAction?doc:null,item=doc instanceof Item?doc:doc.item,actor=item.actor;resolveFormulas(html,{actor,item,action})}function enable79(){Ancillary.register("item",resolveDocumentFormulas),Ancillary.register("actor",resolveDocumentFormulas),Ancillary.register("action",resolveDocumentFormulas),Hooks.on("renderChangeEditor",resolveChangeFormulas)}function disable75(){Ancillary.unregister("item",resolveDocumentFormulas),Ancillary.unregister("actor",resolveDocumentFormulas),Ancillary.unregister("action",resolveDocumentFormulas),Hooks.off("renderChangeEditor",resolveChangeFormulas)}new Feature({setting:"resolve-formulas",label:"Resolve Formulas",hint:"Resolves and performs basic validation on formulas and displays partially resolved value (no rolls) with tooltip on details about it on actor and item sheets.",category:"common",enable:enable79,disable:disable75,stage:"ready"});CFG.API.formula.validate=validateFormula;init_common();async function exportDocument(doc){return doc.exportToJSON()}function appendExportButton(el,doc){let button=createNode("button",null,["lil-export"]);button.append(createNode("i",null,["fa-solid","fa-save"])," ",i18n.get("LittleHelper.Action.ExportJSON")),button.style.whiteSpace="nowrap",button.type="button",button.addEventListener("click",function(event2){event2.preventDefault(),button.disable=!0,exportDocument(doc).then((_)=>button.disable=!1)}),el.append(button)}function injectExportActorSheet(sheet,html,options,shared){let tab=shared.tabs.settings?.tab;if(!tab)return;let actor=sheet.document,div=createNode("div",null,["form-group"]);div.style.flexDirection="column";let h2=createNode("h2");h2.style.width="100%",h2.append(createNode("i",null,["fa-solid","fa-puzzle-piece"])," ",i18n.get("LittleHelper.Action.Actions")),div.append(h2),appendExportButton(div,actor),tab.append(div)}function injectExportItemSheet(sheet,html,options,shared){let adv=html.querySelector('.tab[data-tab="advanced"] .lil-advanced-options');if(!adv)return;appendExportButton(adv,sheet.document)}function enable80(){Ancillary.register("actor",injectExportActorSheet),Ancillary.register("item",injectExportItemSheet)}function disable76(){Ancillary.unregister("actor",injectExportActorSheet),Ancillary.unregister("item",injectExportItemSheet)}new Feature({setting:"easy-export",label:"Easy Export",hint:"Actor and Item sheets have easy export button in settings or advanced tab.",category:"dev",enable:enable80,disable:disable76,stage:"ready",enabledByDefault:!1});init_config();var addDatalistSource=(el,listId)=>{if(!el.getAttribute("list"))el.setAttribute("list",listId)};function handleInput(el,item){if(el.matches('[name="powerAttack.multiplier"]'))addDatalistSource(el,"lil-power-attack-mult")}function handleFormulaInputs(el,item){if(el.matches('[name="system.formulaicAttacks.count.formula"],[name="formulaicAttacks.count.formula"]'))addDatalistSource(el,"lil-premade-fac-list");else if(el.matches('[name="system.formulaicAttacks.bonus.formula"],[name="formulaicAttacks.bonus.formula"]'))addDatalistSource(el,"lil-premade-fab-list");else if(el.matches('[name="system.attackBonus"],[name="attackBonus"]'))addDatalistSource(el,"lil-premade-ab-list");else if(el.matches('[name="system.critConfirmBonus"],[name="critConfirmBonus"]'))addDatalistSource(el,"lil-premade-cf-list");else if(el.matches(".damage-formula"))addDatalistSource(el,"lil-premade-damage-formula-list");else if(el.matches('[name="system.save.dc"],[name="save.dc"]'))addDatalistSource(el,item.type==="spell"?"lil-premade-spell-dc-list":"lil-premade-dc-list");else if(el.matches('[name="system.customHD"]'))addDatalistSource(el,"lil-class-hd")}function inputQuickAccessInjection(sheet,html,options,shared){let item=shared.document,inputs=html.querySelectorAll("input");for(let f_input of inputs)if(f_input.classList.contains("formula"))handleFormulaInputs(f_input,item);else handleInput(f_input,item)}function inputDialogQuickAccessInjection(dialog,html){if(html instanceof jQuery)html=html[0];if(!dialog.options.subject&&!(dialog instanceof pf1.applications.AttackDialog))return;if(!dialog.options.classes.includes("pf1")&&!dialog.options.classes.includes("pf1-v2"))return;let inputs=html.querySelectorAll("input[name]");for(let el of inputs)switch(el.name){case"d20":addDatalistSource(el,"lil-premade-roll-list");break;case"attack-bonus":addDatalistSource(el,"lil-premade-attack-bonus-list");break;case"bonus":addDatalistSource(el,"lil-premade-roll-bonus-list");break}}var dataSourceTemplate=`modules/${CFG.id}/templates/data-sources.hbs`;async function injectDataSources(){let data={config:pf1.config,registry:{damageTypes:pf1.registry.damageTypes.getLabels()},extra:{damageTypes:["Healing","Bleed"]}},fragment=document.createElement("template"),rt=foundry.applications.handlebars.renderTemplate;fragment.innerHTML=await rt(dataSourceTemplate,data),document.body.append(fragment.content)}Hooks.once("ready",()=>injectDataSources());function enable81(){Ancillary.register("item",inputQuickAccessInjection),Ancillary.register("action",inputQuickAccessInjection),Hooks.on("renderAttackDialog",inputDialogQuickAccessInjection),Hooks.on("renderDialogV2",inputDialogQuickAccessInjection),Hooks.on("renderDialog",inputDialogQuickAccessInjection)}function disable77(){Ancillary.unregister("item",inputQuickAccessInjection),Ancillary.unregister("action",inputQuickAccessInjection),Hooks.off("renderAttackDialog",inputDialogQuickAccessInjection),Hooks.off("renderDialogV2",inputDialogQuickAccessInjection),Hooks.off("renderDialog",inputDialogQuickAccessInjection)}new Feature({setting:"quick-input",label:"Quick Input",hint:"Adds quick access to various common values and formulas to various actor, item and dialog inputs.",category:"common",enable:enable81,disable:disable77,stage:"ready"});async function updateNote(el){let txEl=el.closest("form").querySelector(".lil-take-x");if(el.value.trim().length===0){txEl.textContent="";return}let roll;try{roll=new Roll(el.value),delete txEl.dataset.tooltip}catch(err){txEl.textContent="ERROR!",txEl.dataset.tooltip=err.message;return}let text="";if(roll.isDeterministic)try{await roll.evaluate(),text=i18n.get("PF1.TakeX",{number:roll.total})}catch(err){text="ERROR!",txEl.dataset.tooltip=err.message}txEl.textContent=text}function injectTakeXHint(app,html,options){if(html instanceof jQuery)html=html[0];if(!app.options.subject&&!(app instanceof pf1.applications.AttackDialog))return;let classes=new Set(app.options.classes??[]);if(!classes.has("pf1")&&!classes.has("pf1-v2"))return;let d20=html.querySelector('input[name="d20"]');if(!d20)return;let txEl=document.createElement("span");txEl.classList.add("lil-take-x"),d20.after(txEl),updateNote(d20),d20.addEventListener("change",(ev)=>updateNote(ev.target),{passive:!0}),d20.addEventListener("input",(ev)=>updateNote(ev.target),{passive:!0})}function enable82(){Hooks.on("renderAttackDialog",injectTakeXHint),Hooks.on("renderDialogV2",injectTakeXHint)}function disable78(){Hooks.off("renderAttackDialog",injectTakeXHint),Hooks.off("renderDialogV2",injectTakeXHint)}new Feature({setting:"roll-dialog-take-x",label:"Roll Dialog Take X",hint:"Simple reminder that you're doing Take X roll in some circumstances.",category:"common",enable:enable82,disable:disable78,stage:"ready"});init_config();init_common();var conditionList,buffList,permList,{ApplicationV2:ApplicationV23,HandlebarsApplicationMixin:HandlebarsApplicationMixin3}=foundry.applications.api;class ActiveBuffsDisplay extends HandlebarsApplicationMixin3(ApplicationV23){#actor;#token;static instance;constructor(options){super(options);this.constructor.instance=this}setToken(token){this.#token=token,this.#actor=token.actor,this.render(!0)}get token(){return this.#token}get actor(){return this.#actor}static DEFAULT_OPTIONS={id:"little-helper-active-buffs",window:{frame:!1,positioned:!1},actions:{toggle:{handler:this._onToggle,buttons:[0,2]}}};static PARTS={root:{root:!0,template:"modules/koboldworks-pf1-little-helper/templates/active-buffs/root.hbs"},temp:{template:"modules/koboldworks-pf1-little-helper/templates/active-buffs/entries.hbs"},perm:{template:"modules/koboldworks-pf1-little-helper/templates/active-buffs/entries.hbs"},cond:{template:"modules/koboldworks-pf1-little-helper/templates/active-buffs/entries.hbs"}};_prepareContext(options){return{actor:this.actor,token:this.token,uuid:this.actor.uuid}}_preparePartContext(partId,context,options){switch(context.partId=partId,partId){case"cond":this._prepareConditions(context);break;case"perm":this._prepareBuffs(context,!0);break;case"temp":this._prepareBuffs(context,!1);break}return context}_prepareConditions(context){let token=this.token,actor=this.actor,entries=[];for(let conditionId of token.actor.statuses){let condition=pf1.registry.conditions.get(conditionId),image=condition?.texture,label=condition?.name||conditionId;entries.push({img:image,label,condition,conditionId,css:"condition"})}context.css="conditions",context.empty=entries.length===0,context.entries=entries}_prepareBuffs(context,perm){let showHidden=feature4.subsettings.showHidden.value,buffs=(this.actor.itemTypes.buff??[]).filter((i)=>i.isActive&&(perm?i.subType==="perm":i.subType!=="perm")).sort((a,b)=>b.sort-a.sort),entries=[];for(let item of buffs){if(!showHidden&&item.system.hideFromToken)continue;entries.push({img:item.img,label:item.name,permanent:perm,invalid:!1,css:["buff",perm?"permanent":"temporary"].join(" "),item})}context.css=["buffs",perm?"permanent":"temporary"].join(" "),context.entries=entries,context.empty=entries.length===0}_syncPartState(partId,newEl,oldEl,state){switch(super._syncPartState(partId,newEl,oldEl,state),partId){case"temp":break;case"perm":break;case"cond":newEl.break}}clear(){if(!this.element)return;this.#token=null,this.#actor=null,this.element.classList.remove("active"),buffList?.replaceChildren(),permList?.replaceChildren(),conditionList?.replaceChildren()}_canRender(options){if(!this.actor)return!1}_insertElement(element){document.getElementById("ui-right-column-1").prepend(element),buffList=element.querySelector(".buff-list.temporary"),permList=element.querySelector(".buff-list.permanent"),conditionList=element.querySelector(".buff-list.conditions")}_onRender(...args){super._onRender(...args),this.element.classList.add("active");for(let el of this.element.querySelectorAll("li.buff"))el.addEventListener("pointerenter",this._onHoverStart.bind(this),{passive:!0}),el.addEventListener("pointerleave",this._onHoverEnd.bind(this),{passive:!0})}async _onHoverStart(event2){let el=event2.target,actor=this.actor,itemId=el.dataset.itemId,conditionId=el.dataset.conditionId,label,item,condition;if(itemId)item=actor.items.get(itemId),label=item?.name||itemId;else if(conditionId)condition=pf1.registry.conditions.get(conditionId),label=condition?.name||conditionId;else return void console.error(`What happen?
`,el);game.tooltip.activate(el,{html:await generateTooltip2(el,{actor,label,item,condition}),cssClass:"lil-active-buff-tooltip",direction:foundry.helpers.interaction.TooltipManager.implementation.TOOLTIP_DIRECTIONS.LEFT})}_onHoverEnd(event2){game.tooltip.deactivate()}static _onToggle(event2,button){if(!this.actor)throw Error("Someone broke a leg");let rightClick=feature4.subsettings.rightClick.value??!1,conditionId=button.dataset.conditionId,itemId=button.dataset.itemId,isLeftClick=event2.button===0;if(event2.shiftKey&&isLeftClick)this._onPrintDescription(itemId);else if(rightClick!==isLeftClick){if(conditionId)this._onDisableCondition(conditionId);else if(itemId)this._onDisableItem(itemId)}}_onPrintDescription(itemId){return this.actor.items.get(itemId).displayCard()}_onDisableCondition(conditionId){return this.actor.setCondition(conditionId,!1)}_onDisableItem(itemId){let buff=this.actor.items.get(itemId);if(buff.isActive&&buff.type==="buff"){if(buff.subType==="perm")return ui.notifications.warn("Will not disable permanent buff.");return buff.setActive(!1)}throw Error("Invalid buff selection")}_onClose(){this.#token=null,this.#actor=null}_onTokenControl(_tokens,_controlled){let tokens=canvas.tokens?.controlled??[],token=tokens[0];if(tokens.length===1&&token.actor&&this.token!==token)this.setToken(token);else this.clear()}_onUpdateTime(time){if(!this.actor)return;this.render()}_onAECreate(ae,data,context){if(ae.actor!==this.actor)return;if(!this.actor)return;this.render()}_onAEUpdate(ae,data,context){if(ae.actor!==this.actor)return;if(!this.actor)return;this.render()}_onAEDelete(ae,context){if(ae.actor!==this.actor)return;if(!this.actor)return;this.render()}_onItemCreate(item){if(item.actor!==this.actor)return;if(item.type!=="buff")return;this.render()}_onItemUpdate(item){if(item.actor!==this.actor)return;if(item.type!=="buff")return;if(item?.isActive)this.render();else this._removeItem(item)}_onItemDelete(item){if(item.actor!==this.actor)return;if(item.type!=="buff")return;if(item.isActive)this._removeItem(item)}_onActorUpdate(actor){if(actor!==this.actor)return;this.render()}_removeItem(item){this.element.querySelector(`[data-item-id="${item.id}"]`)?.remove()}_displayExtraInfo(enabled){let root=this.element;if(!root)return;for(let el of root.querySelectorAll(".fast-label"))el.style.setProperty("--width",el.clientWidth);root.classList.toggle("extraInfo",enabled)}#events={controlToken:this._onTokenControl.bind(this),updateWorldTime:this._onUpdateTime.bind(this),createActiveEffect:this._onAECreate.bind(this),updateActiveEffect:this._onAEUpdate.bind(this),deleteActiveEffect:this._onAEDelete.bind(this),createItem:this._onItemCreate.bind(this),updateItem:this._onItemUpdate.bind(this),deleteItem:this._onItemDelete.bind(this),updateActor:this._onActorUpdate.bind(this),"little-helper.extraInfo":this._displayExtraInfo.bind(this)};register(){for(let[hookId,handler]of Object.entries(this.#events))Hooks.on(hookId,handler);this._onTokenControl()}unregister(){for(let[hookId,handler]of Object.entries(this.#events))Hooks.off(hookId,handler)}}function addTooltipTimeInfo(el,{tooltip,actor,item,condition}={}){let ae=getRelevantAE(actor,{item,condition});el.dataset.effectUuid=ae?.getRelativeUUID(actor);let dur=ae?getAEDuration(ae):{},longFormat=feature4.subsettings.longTimeFormat.value;if(Number.isFinite(dur.start)&&dur.passed>=0){el.dataset.start=dur.start;let time=createNode("div",null,["time"]);time.dataset.start=`${dur.start}`;let activeTime=dur.passed;time.dataset.active=`${activeTime}`;let hActive=getHumanTime(activeTime),activeTimeBlock=createNode("div",null,["active-time","time-block"],{children:["Active: ",createNode("span",`${hActive.n??0}`,["active","number"])," ",createNode("span",humanTimeUnit[hActive.u][longFormat?"long":"short"],["remaining","unit"])]});if(time.append(activeTimeBlock),dur.duration>0){time.dataset.duration=`${dur.duration}`;let hRemaining=getHumanTime(dur.remaining),hDuration=getHumanTime(dur.duration),remainingTimeBlock=createNode("div",null,["remaining-time","time-block"],{children:["Remaining: ",createNode("span",hRemaining.n,["remaining","number",hRemaining.n<=0?"expired":"ongoing"])," ",createNode("span",humanTimeUnit[hRemaining.u][longFormat?"long":"short"],["remaining","unit"])]}),maxTimeBlock=createNode("div",null,["max-time","time-block"],{children:["Max duration: ",createNode("span",hDuration.n,["duration","number"])," ",createNode("span",humanTimeUnit[hDuration.u][longFormat?"long":"short"],["duration","unit"])]});time.append(remainingTimeBlock,maxTimeBlock)}tooltip.append(time)}}async function fillTooltipDescription({item,condition}={}){let desc;if(item){let rollData=item?.getRollData()??{};desc=await item?.getDescription();let secrets=feature4.subsettings.secrets.value;desc=await foundry.applications.ux.TextEditor.implementation.enrichHTML(desc,{rollData,documents:!0,rolls:!0,secrets,async:!0})}else if(condition)desc="<p>"+CFG.i18n.conditions[condition.id]||i18n.get("LittleHelper.Conditions._missing");else desc="<p>"+i18n.get("LittleHelper.Conditions._invalid");return desc}async function generateTooltip2(el,{actor,label,item,condition}={}){let tooltip=createNode("section",null,[],{children:[createNode("h4",label,["name"])]}),level=item?.system.level;if(level!=0&&Number.isFinite(level)){let levelEl=createNode("div",null,["level"]),ll=createNode("label",i18n.get("PF1.Level")),lv=createNode("span",level,["value"]);levelEl.append(ll," ",lv),tooltip.append(levelEl)}addTooltipTimeInfo(el,{tooltip,label,actor,item,condition,event});let descEl=createNode("div",null,["description"]);if(tooltip.append(descEl),descEl.innerHTML=await fillTooltipDescription({item,condition}),tooltip.append(createNode("hr")),item&&item.system.buffType==="perm")tooltip.append(createNode("p",i18n.get("PF1.Permanent"),["buff-type"]));else{let clickLabel=feature4.subsettings.rightClick.value?i18n.get("LittleHelper.UI.ClickToEndEffectAlt"):i18n.get("LittleHelper.UI.ClickToEndEffect");tooltip.append(createNode("p",clickLabel,["buff-action","help"]))}return Hooks.callAll("little-helper.hud.tooltip.active",tooltip,{actor,item,condition,event}),tooltip}function enable83(){new ActiveBuffsDisplay().register()}function disable79(){ActiveBuffsDisplay.instance.unregister(),ActiveBuffsDisplay.instance.close(),ActiveBuffsDisplay.instance=null}var feature4=new Feature({setting:"active-buffs",label:"Active Buffs",hint:"Display active buffs and conditions on the side of the chat log, providing quick access to some information and allowing disabling them with a click.",category:"hud",enable:enable83,disable:disable79,stage:"ready",subsettings:{showHidden:new SubSetting({label:"Show Hidden",hint:"Show buffs with Hide from Token enabled.",type:Boolean,fallback:!0}),longTimeFormat:new SubSetting({label:"Long Time Format",hint:"Show time units in long format (hours(s) instead of h(s)).",type:Boolean,fallback:!0}),secrets:new SubSetting({label:"Secrets",hint:"Display contents of secret sections.",type:Boolean,fallback:!0}),rightClick:new SubSetting({label:"Right Click to End",hint:"End buffs with right click instead of left click.",type:Boolean,fallback:!1})}});init_config();function canvasReadyEvent(canvas2){if(!canvas2.scene.tokenVision)return;if(canvas2.tokens.placeables.length===0)return;let unsightedTokens=canvas2.tokens.placeables.filter((t)=>t.actor?.hasPlayerOwner&&t.actor.type==="character").filter((t)=>t.isOwner).filter((t)=>!t.hasSight);if(unsightedTokens.length>0){if(game.user.isGM)ui.notifications.warn(i18n.get("LittleHelper.Scene.LackingVisionGM",{count:unsightedTokens.length}));else if(unsightedTokens.length==1)ui.notifications.warn(i18n.get("LittleHelper.Scene.NoVisionOnToken",{name:unsightedTokens[0].name}));else ui.notifications.warn(i18n.get("LittleHelper.Scene.LackingVision",{count:unsightedTokens.length}));let C=CFG.console.colors;console.log("%cLittle Helper%c \uD83E\uDD8E",C.main,C.unset,"| Unsighted Tokens:",unsightedTokens.map((t)=>t.name))}}function sceneUpdateEvent(scene,update){if(scene.id!==canvas.scene?.id)return;let scrubbedUpdate=foundry.utils.deepClone(update);if(delete scrubbedUpdate._id,delete scrubbedUpdate.flags,foundry.utils.isEmpty(scrubbedUpdate))return;canvasReadyEvent(canvas)}function newTokenOnScene(token,options,userId){if(!canvas.scene.tokenVision)return;if(token.sight.enabled)return;let actor=token.actor;if(!actor?.hasPlayerOwner)return;if(actor.type!=="character")return;if(!actor.isOwner)return;ui.notifications.warn(i18n.get("LittleHelper.Scene.NoVisionOnToken",{name:token.name}))}Hooks.on("createToken",newTokenOnScene);Hooks.on("canvasReady",canvasReadyEvent);Hooks.on("updateScene",sceneUpdateEvent);var lastSceneWarning;function canvasReadyEvent2(canvas2){if(!game.user.isGM){Hooks.off("canvasReady",canvasReadyEvent2);return}if(canvas2.scene.initial===null){if(lastSceneWarning===canvas2.scene.id)return;lastSceneWarning=canvas2.scene.id,ui.notifications.warn(`This scene "${canvas2.scene.name}" lacks initial view. Please consider setting it at bottom of scene settings.`)}}Hooks.on("canvasReady",canvasReadyEvent2);function sceneConfigEvent(app,html){let scene=app.object??app.document;if(!scene.initial||scene.initial?.x===null||scene.initial?.y===null)html.querySelector('[name="initial.x"]')?.closest(".form-group")?.classList.add("lil-warning")}Hooks.on("renderSceneConfig",sceneConfigEvent);var sceneScaleMismatch=(canvas2)=>{let grid=canvas2.scene?.grid;if(!grid)return;let sunits=pf1.utils.getDistanceSystem(),{units,distance}=grid,badUnits=sunits==="metric"?["ft","mi"]:["m","km"],badUnitsi18n=badUnits.map((u)=>pf1.config.measureUnits[u]);if(badUnits.includes(units)||badUnitsi18n.some((ul)=>ul.toLowerCase()==units.toLowerCase()))ui.notifications.warn(i18n.get("LittleHelper.Warning.GM.SceneScaleMismatch",{units,scale:distance}))};Hooks.on("canvasReady",sceneScaleMismatch);init_common();var marker="featureSources",markerId=0,levelConflicting={feat:["level","class"],classFeat:["feat"]};async function featureSourceConflicts(sheet,html,_opts,shared){let cancel=!1,_markerId=markerId++;setSheetMarker(sheet,marker,_markerId,()=>cancel=!0);let actor=sheet.document,feats={};if(actor.itemTypes.feat)for(let i of actor.itemTypes.feat){let subType=i.system.featType;if(feats[subType]===void 0)feats[subType]={items:[],conflicts:[]};feats[subType].items.push(i)}for(let e of Object.entries(levelConflicting)){let[subType,conflicts]=e,items=feats[subType]?.items;if(!(items?.length>1))continue;let levels={};for(let i of items){let type=i.flags?.world?.source_type;if(!conflicts.includes(type))continue;if(levels[type]===void 0)levels[type]={};let level=i.flags?.world?.source_level;if(level===void 0)continue;if(levels[type][level]===void 0)levels[type][level]=[];levels[type][level].push({item:i,type,level})}feats[subType].levels=levels}let majorconflicts=[];for(let e of Object.entries(levelConflicting)){let[subType,conflicts]=e;if(!feats[subType]?.levels)continue;for(let vs of Object.values(feats[subType].levels))for(let vsis of Object.values(vs))if(vsis.length>1)majorconflicts.push(vsis)}if(cancel||majorconflicts.length===0){delSheetMarker(sheet,marker,_markerId);return}let conflictingItems=majorconflicts.flat().map((i)=>i.item),tab=shared.tabs.feats?.tab;if(tab)for(let el of tab.querySelectorAll(".item[data-item-id]")){if(cancel)continue;let id=el.dataset.itemId;if(!conflictingItems.find((i)=>i.id===id))continue;el.classList.add("lil-feature-source-conflict")}delSheetMarker(sheet,marker,_markerId)}function enable84(){if(!game.modules.get("mkah-pf1-feature-sources")?.active)return;Ancillary.register("actor",featureSourceConflicts)}function disable80(){Ancillary.unregister("actor",featureSourceConflicts)}new Feature({setting:"module-feature-sources",label:"Feature Sources",hint:"Attempts to display source conflicts on actor sheet. This is slow procedure and may impact sheet performance.",category:"module",enable:enable84,disable:disable80,stage:"ready",requirements:{module:"mkah-pf1-feature-sources"}});init_config();init_common();var METATYPES={normal:"normal",nonCritical:"nonCrit",criticalOnly:"crit"};class DamageInstance{label;formula;roll;type;metatype;enabled=!0;conditional=!1;verbose=!0;damage={};constructor(label,formula,roll,type="inherit",metatype=METATYPES.normal){this.label=label,this.formula=formula,this.roll=roll,this.type=type,this.metatype=metatype}}class TheoryDialog extends foundry.applications.api.HandlebarsApplicationMixin(foundry.applications.api.DocumentSheetV2){_config={size:void 0,damage:{custom:{formula:"",enabled:!0}},attacks:[],clOffset:0,haste:!1,manyshot:!1,full:!1,action:void 0};rollData;constructor({action,...options}={}){super(options);this.action=action}_initializeApplicationOptions(options){return options=super._initializeApplicationOptions(options),options.uniqueId+="-theory-dialog",options}get title(){return`Theory on ${this.document.name}`}get item(){return this.document}static DEFAULT_OPTIONS={classes:["koboldworks","theory"],window:{icon:"fa-solid fa-chart-line",resizable:!0},form:{closeOnSubmit:!1,submitOnChange:!0},sheetConfig:!1};static PARTS={form:{template:`modules/${CFG.id}/templates/item-theory.hbs`}};getBaseData(){let item=this.item,action=this.action,atkData=action??item.system,held=action.held||item.system.held||"1h",sizes={};for(let[index,v]of Object.values(pf1.config.actorSizes))sizes[index]=v;let context={isSpell:item.type==="spell",isTwoHanded:held==="2h",isRanged:["rwak","rsak","rcman"].includes(atkData.actionType),isOffhand:held==="oh"||!action.primaryAttack&&item.system.attackType==="natural",options:{size:sizes},size:4,hasAttacks:!0,rollData:action.getRollData()};context.size=this._config.size??context.rollData.size??4,context.rollData.size=context.size,this._config.size=context.size;let clOffset=this._config.clOffset??0;context.rollData.cl+=clOffset,context.attacks=this.action.getAttacks({full:!0,resolve:!0,bonuses:!0}).map((atk)=>new DamageInstance(`BAB [${signNum(atk.bonus)}]`,`${atk.bonus}`)),context.full=this._config.full;let hasteAttack={label:"Haste",mod:Number.parseInt(context.attacks[0].formula),enabled:this._config.haste,damage:{}};return context.attacks.splice(1,0,hasteAttack),context}async baseDamageParts(item,action,rollData){let dmg=(action??item.system).damage,allDamage=[],doPart=async(d,metatype)=>{let roll=await RollPF.safeRoll(d.formula,rollData);return[d,roll,metatype]},dmgParts=dmg.parts?.map((d)=>doPart(d,METATYPES.normal))??[],nonCritParts=dmg.nonCritParts?.map((d)=>doPart(d,METATYPES.nonCritical))??[],parts=await Promise.all([...dmgParts,...nonCritParts]);for(let[d,roll,metatype]of parts){let{formula,types}=d;allDamage.push({formula,roll,types,metatype,enabled:!0})}return allDamage}async getDamage(context,rollData){let item=this.item,action=this.action,itemData=item.system,baseDamage=await this.baseDamageParts(item,action,rollData),enhBonus=action.enh?.value??void 0??itemData.enh??0;if(item.actor?.system){let abl=action.ability.damage,mult=action.ability.damageMult;if(abl?.length&&Number.isFinite(mult)){let formula=`floor(@abilities.${abl}.mod * @action.ability.damageMult)`,roll=RollPF.safeRollSync(formula,rollData);baseDamage.push(new DamageInstance(i18n.get(`PF1.Ability${abl.capitalize()}`),formula,roll,"inherit",METATYPES.normal))}}if(enhBonus>0)baseDamage.push(new DamageInstance("Enhancement",`${enhBonus}`,RollPF.safeRollSync(`${enhBonus}`),"inherit",METATYPES.normal));let allDmg=[],condDmg={};for(let cd of action.conditionals)for(let mod of cd.modifiers){if(mod.target!=="damage")return;let store;if(mod.subTarget==="allDamage")store=allDmg;else{let re=/attack\.(?<attack>\d+)/.exec(mod.subTarget);if(!re)return;let attack=Number.parseInt(re.groups.attack);if(!condDmg[attack])condDmg[attack]=[];store=condDmg[attack]}let di=new DamageInstance(cd.name,mod.formula,void 0,mod.type,mod.critical);di.enabled=cd.default,store.push(di)}let extendedDamage=[];for(let d of allDmg){let roll=await RollPF.safeRoll(d.formula,rollData),di=new DamageInstance(d.label,d.formula,roll,d.type,d.metatype);di.conditional=!0,di.enabled=d.enabled,extendedDamage.push(di)}let optionalDamage=[],powerAttackDamage=2;if(context.isOffhand)powerAttackDamage=1;else if(context.isRanged)powerAttackDamage=2;else if(context.isTwoHanded)powerAttackDamage=3;let bab=rollData.attributes?.bab.total;if(bab!==void 0){let powerAttackSteps=(bab+4)/4,formula=`${powerAttackDamage} * floor((@attributes.bab.total + 4) / 4)`,roll=RollPF.safeRollSync(formula,rollData);rollData.powerAttackDamage=roll.total,rollData.powerAttackPenalty=-powerAttackSteps;let di=new DamageInstance("Power Attack/Deadly Aim/Piranha Strike",formula,roll,METATYPES.normal);di.enabled=!1,di.custom=!1,di.verbose=!0,di.powerAttack=!0,di.id="powerAttack",optionalDamage.push(di)}return{baseDamage,optionalDamage,extendedDamage,allDmg,condDmg}}fillAttackData(atk,rollData,stats){if(atk.error=atk.roll?.err??!1,atk.error)atk.verbose=!0;atk.originalFormula=atk.formula;let formula=atk.roll.formula||atk.formula;atk.strippedFormula=unflair(pf1.utils.formula.simplify(formula,rollData)),atk.max=atk.roll.clone().evaluateSync({maximize:!0}),atk.min=atk.roll.clone().evaluateSync({minimize:!0});let l_est=(atk.max.total-atk.min.total)/2+atk.min.total,l_avg=(atk.max.total+atk.min.total)/2;if(atk.avg=maxPrecision(l_avg,2),atk.est=maxPrecision(l_est,2),atk.static=atk.max.total===atk.min.total&&atk.roll.isDeterministic,atk.base)atk.enabled=!0;if(atk.enabled)stats.avg+=l_avg,stats.est+=l_est,stats.min+=atk.min.total,stats.max+=atk.max.total;if(atk.finalFormula=atk.roll.formula,atk.staticFormula=atk.originalFormula==atk.finalFormula,atk.variables=getVariables(atk.formula),atk.variables.length>0)atk.variablesFormatted=atk.variables.map((v)=>`${v} = ${foundry.utils.getProperty(rollData,v)}`).join(`
`),atk.verbose=!0}async getCustom(rollData,stats){let custom=this._config.damage.custom??{formula:"",enabled:!0};if(custom.custom=!0,custom.roll=await RollPF.safeRoll(custom.formula||"0",rollData),custom.formula.length>0)custom.verbose=!!custom.variables;else custom.static=!0,custom.verbose=!1;return custom}async _prepareContext(options){let item=this.item,action=this.action,context=this.getBaseData();context.item=item,context.action=action,context.actions={};for(let act of item.actions)if(act.hasDamage)context.actions[act.id]=act.name;context.selectedAction=action.id;let{isTwoHanded,isRanged,isOffhand}=context;if(this._config.manyshot);let isCritical=!1,damage=await this.getDamage(context,context.rollData),stats={avg:0,est:0,min:0,max:0},custom=await this.getCustom(context.rollData,stats),all=[...damage.baseDamage,...damage.extendedDamage,...damage.optionalDamage,custom];for(let[idx,dmg]of Object.entries(this._config.damage))if(dmg.enabled!==void 0){let _dmg=all[Number(idx)];if(!_dmg)continue;_dmg.enabled=dmg.enabled}let attacks=this._config.attacks;for(let[index,atk]of all.entries())atk.enabled=attacks[0]?.damage?.grouped?.[index]?.enabled??atk.enabled??!1,atk.index=index,this.fillAttackData(atk,context.rollData,stats);let total={avg:maxPrecision(stats.avg,2),est:maxPrecision(stats.est,2),min:stats.min,max:stats.max,static:stats.min===stats.max},derived={damage:{base:damage.baseDamage,extended:damage.extendedDamage,optional:damage.optionalDamage,all,grouped:[{label:void 0,base:!0,conditional:!1,custom:!1,items:damage.baseDamage},{label:"Conditional",base:!1,conditional:!0,custom:!1,items:damage.extendedDamage},{label:"Optional",base:!1,conditional:!1,custom:!1,items:damage.optionalDamage},{label:"Custom",base:!1,conditional:!1,custom:!0,items:[custom]}],hasPerAttack:!foundry.utils.isEmpty(damage.condDmg),perAttack:damage.condDmg,custom,total,stats},attacks:this._config.attacks,config:this._config};for(let atk of context.attacks)atk.damage={groups:derived.damage.grouped,total:derived.damage.total};context.attack=context.attacks[0];let attackCount=context.attacks.length+(this._config.haste?1:0);return context.fullAttack={est:maxPrecision(attackCount*context.attack.damage.total.est,2),static:!1,attackCount,min:maxPrecision(attackCount*context.attack.damage.total.min,2),max:maxPrecision(attackCount*context.attack.damage.total.max,2)},context.d=derived,context.uuid=`${item.uuid}-theory`,context}_onChangeForm(config2,event2){let data=foundry.utils.expandObject(new foundry.applications.ux.FormDataExtended(this.element).object);data.attacks=Object.values(data.attacks),data.damage.custom.enabled=data.attacks[0].damage.custom.enabled;for(let[ai,atk]of this._config.attacks.entries())if(atk.damage?.grouped)for(let[di,dmg]of atk.damage.grouped.entries()){let enabled=data.attacks?.[ai]?.damage?.grouped?.[di]?.enabled;if(enabled!==void 0)dmg.enabled=enabled}for(let[idx,dmg]of Object.entries(data.attacks[0]?.damage))if(dmg.enabled!==void 0)this._config.damage[idx]??={},this._config.damage[idx].enabled=dmg.enabled;if(delete data.attacks,foundry.utils.mergeObject(this._config,data),data.action)this.action=this.item.actions.get(data.action);this.render()}_onRender(context,options){super._onRender(context,options);let html=this.element.querySelector(".window-content"),sliders=html.querySelectorAll('input[type="range"]');for(let slider of sliders){let label=slider.nextElementSibling;slider.addEventListener("input",()=>label.textContent=`${slider.value}%`,{passive:!0})}let actor=this.action.actor;if(!actor)return;let size=actor.system.traits?.size?.value??4;html.querySelector('select[name="size"]')?.querySelector(`option[value="${size}"]`)?.classList.add("current-size");let actionEl=html.querySelector('select[name="action"]'),defaultActionId=this.action.item?.defaultAction?.id;actionEl?.querySelector(`option[value="${defaultActionId}"]`)?.classList.add("default-action")}}init_icons();init_common();function injectTooltip(sheet,html,options,shared){let button=html.closest(".app[data-appid]")?.querySelector("header > .little-helper-theory-button");if(button)addCoreTooltip(button,"Damage Theory")}function theoryHeaderButton(sheet,buttons){let doc=sheet.document??sheet.action,item=doc.item??doc,action=doc instanceof Item?doc.defaultAction:doc;if(!doc.hasDamage)return;let button={label:"",icon:FAIcons.search,class:"little-helper-theory-button",onclick:(_)=>new TheoryDialog({document:item,action}).render({force:!0})};buttons.unshift(button)}function enable85(){Hooks.on("getItemSheetHeaderButtons",theoryHeaderButton),Hooks.on("getItemActionSheetHeaderButtons",theoryHeaderButton),Ancillary.register("item",injectTooltip),Ancillary.register("action",injectTooltip)}function disable81(){Hooks.off("getItemSheetHeaderButtons",theoryHeaderButton),Hooks.off("getItemActionSheetHeaderButtons",theoryHeaderButton),Ancillary.unregister("item",injectTooltip),Ancillary.unregister("action",injectTooltip)}new Feature({setting:"item-theory",label:"Theory",hint:"Adds a dialog button to item sheet header with theoretical data about them.",category:"items",enable:enable85,disable:disable81,stage:"ready"});init_config();init_common();init_icons();var FLAGS={keenFlag:"keen",hideAttacksFlag:"hideAttacks",autoPowerAttack:"autoPowerAttack",skipDialogFlag:"skipDialog",rollModeOverrideFlag:"rollmodeOverride",rollOverrideFlag:"rollOverride"},migrateItemFlags=async(item)=>{if(item.flags?.lilhelper?.item)return;let flags={[FLAGS.rollOverrideFlag]:item.getItemDictionaryFlag(FLAGS.rollOverrideFlag),[FLAGS.rollModeOverrideFlag]:item.getItemDictionaryFlag(FLAGS.rollModeOverrideFlag),[FLAGS.keenFlag]:item.hasItemBooleanFlag(FLAGS.keenFlag),[FLAGS.hideAttacksFlag]:item.hasItemBooleanFlag(FLAGS.hideAttacksFlag),[FLAGS.autoPowerAttack]:item.hasItemBooleanFlag(FLAGS.autoPowerAttack),[FLAGS.skipDialogFlag]:item.getItemDictionaryFlag(FLAGS.skipDialogFlag)};for(let[key,value]of Object.entries(flags))if(value===void 0||value===""||value===!1||value===0)delete flags[key];if(Object.keys(flags).length===0)return;let updateData={flags:{lilhelper:{item:flags}},system:{flags:{boolean:{"-=keen":null,"-=autoPowerAttack":null,"-=hideAttacks":null},dictionary:{"-=rollOverride":null,"-=rollmodeOverride":null,"-=skipDialog":null}}}},C=CFG.console.colors;return console.log("%cLittle Helper%c \uD83E\uDD8E | Migrating Item Flags |",C.main,C.unset,item),item.update(updateData)},sheetTemplateSource=`modules/${CFG.id}/templates/item-config.hbs`;Hooks.once("setup",()=>foundry.applications.handlebars.loadTemplates([sheetTemplateSource]));function itemSheetConfig(sheet,html){let tab=html.querySelector('.tab[data-tab="advanced"]');if(!tab)return;let item=sheet.item;migrateItemFlags(item);let rollModeGuard=(mode)=>{if(mode==null)return"";if(Object.keys(CFG.ROLLMODES).includes(mode))return mode;if(mode=="roll")return"publicroll";return"garbage"},flags=sheet.item.flags?.lilhelper?.item??{},rollModeOverride=rollModeGuard(flags[FLAGS.rollModeOverrideFlag]),rollModes=foundry.utils.deepClone(CFG.ROLLMODES);if(rollModeOverride=="garbage")rollModes.garbage="BAD VALUE";let hasAction=!["class","race","container"].includes(item.type),templateData={...flags,uid:`lil-${item.id}`,type:item.type,hasAction,choices:{rollmodes:rollModes,skipDialog:{0:"LittleHelper.Options.NoOverride",1:"LittleHelper.Options.ForceDisplay","-1":"LittleHelper.Options.ForceSkip"}},libwrapper:game.modules.get("lib-wrapper")?.active??!1,icons:FAIcons},sheetTemplate=Handlebars.partials[sheetTemplateSource],fragment=document.createDocumentFragment(),div=document.createElement("div");div.innerHTML=sheetTemplate(templateData,{allowProtoMethodsByDefault:!0,allowProtoPropertiesByDefault:!0}),fragment.append(...div.childNodes);for(let el of fragment.querySelectorAll("[data-name]"))el.addEventListener("change",(ev)=>{let path=ev.target.dataset.name,value=ev.target.value;item.update({[path]:value})});if(!sheet.isEditable)for(let el of fragment.querySelectorAll("input,select"))el.readOnly=!0,el.disabled=!0;tab.append(fragment)}Ancillary.register("item",itemSheetConfig,{priority:500});init_config();Hooks.once("setup",()=>{game.keybindings.register(CFG.id,"extraInfo",{name:"LittleHelper.Keybindings.ExtraInfo.Hold",editable:[{key:"AltRight"},{key:"AltLeft"}],onDown:()=>{CFG.state.alt=!0,Hooks.callAll("little-helper.extraInfo",!0)},onUp:()=>{CFG.state.alt=!1,Hooks.callAll("little-helper.extraInfo",!1)}})});init_config();function limitPrecision(number,decimals=2){let mult=Math.pow(10,decimals);return Math.floor(number*mult)/mult}Hooks.once("pf1PostReady",async()=>{if(!game.users.activeGM?.isSelf)return;let migration=game.settings.get(CFG.id,"migration"),mod=game.modules.get(CFG.id),C=CFG.console.colors;if(migration===mod.version||foundry.utils.isNewerVersion(migration,mod.version))return void console.debug("%cLittle Helper%c \uD83E\uDD8E | Migration | Not needed",C.main,C.unset);console.log(`%cLittle Helper%c \uD83E\uDD8E | Migration | ${migration} -> ${mod.version}`,C.main,C.unset);let actors=game.actors.filter((a)=>a.isOwner),pct10=Math.max(25,Math.floor(actors.length/10));if(actors.length<50)pct10=100;let i=0,migrated=0;for(let actor of actors){if(i+=1,i%pct10===0)console.log("%cLittle Helper%c \uD83E\uDD8E | Migration |",C.main,C.unset,limitPrecision(i/actors.length*100,1),"% |",i,"out of",actors.length);for(let item of actor.items)if(await migrateItemFlags(item))migrated+=1}if(console.log("%cLittle Helper%c \uD83E\uDD8E | Migration | Complete",C.main,C.unset,"|",migrated,"Items Adjusted"),game.users.activeGM?.isSelf)game.settings.set(CFG.id,"migration",mod.version)});Hooks.once("setup",()=>{foundry.applications.handlebars.loadTemplates([`modules/${CFG.id}/templates/subsettings.hbs`])});Hooks.once("setup",function(){if(!game.modules.get("lib-wrapper")?.active)ui.notifications.error("Little Helper requires libWrapper module to be enabled to function correctly",{permanent:!0});let C=CFG.console.colors;console.debug("%cLittle Helper%c \uD83E\uDD8E | i18n | Calling pre-translation hooks",C.main,C.unset),Hooks.callAll("little-helper.i18n",CFG.i18n),console.debug("%cLittle Helper%c \uD83E\uDD8E | i18n | Pre-translating",C.main,C.unset);for(let category of Object.values(CFG.i18n))for(let[key,value]of Object.entries(category))try{category[key]=i18n.has(value)?i18n.get(value):value,category[key]=category[key].replaceAll(`

`,"<p>").replaceAll(`
`,"<br>")}catch(err){throw console.error(category,key,value),delete category[key],err}});Hooks.once("init",()=>{if(game.modules.get(CFG.id).api=CFG.API,game.modules.get("quench")?.active)Hooks.on("quenchReady",async function(){try{await Promise.resolve().then(() => exports_unit_tests).then((m)=>m.registerTests()).catch((err)=>console.error(err))}catch(err){console.error(err)}})});

//# debugId=DEDD208AE3B7D2EB64756E2164756E21
//# sourceMappingURL=little-helper.mjs.map
